<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Esing的小站</title>
  
  <subtitle>随便写点</subtitle>
  <link href="https://blog.esing.dev/atom.xml" rel="self"/>
  
  <link href="https://blog.esing.dev/"/>
  <updated>2026-01-11T09:55:09.341Z</updated>
  <id>https://blog.esing.dev/</id>
  
  <author>
    <name>Esing</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>从零开始学RISC：第十三篇</title>
    <link href="https://blog.esing.dev/2026/01/11/riscvcod-p13/"/>
    <id>https://blog.esing.dev/2026/01/11/riscvcod-p13/</id>
    <published>2026-01-11T09:07:10.000Z</published>
    <updated>2026-01-11T09:55:09.341Z</updated>
    
    <content type="html"><![CDATA[<h2 id="异常：CSR寄存器">异常：CSR寄存器</h2><p>为了能运行更多的C程序，并且在出现问题时记录下来，CSR寄存器是必不可缺少的。他也是切换特权模式的重要组件。虽然RISCV规范中已经将CSR从I指令集中移除，但是支持一下还是很重要的。</p><p>不多，支持最基础的机器模式相关寄存器即可。</p><p>CSR寄存器和通用寄存器堆类似，也是同步写异步读。但它不放在ID级，而是在EX级，因为我们的异常检测主要放在EX级进行。此外，CSR需要立即响应异常。另一方面，将CSR读写放在关键路径较长的EX级，也可以防止拉长其他级的关键路径。</p><h3 id="CSR寄存器模块-CSR-sv">CSR寄存器模块 <a href="http://CSR.sv">CSR.sv</a></h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CSR（控制和状态寄存器）模块</span></span><br><span class="line"><span class="comment">// 实现 RV32I 的 Zicsr 扩展</span></span><br><span class="line"><span class="comment">// 支持机器级 CSR 和基本的特权模式切换</span></span><br><span class="line"><span class="keyword">module</span> CSR (</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> clk,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> rst_n,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CSR 指令接口</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        csr_we,           <span class="comment">// CSR 写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">11</span>:<span class="number">0</span>] csr_addr,         <span class="comment">// CSR 地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] csr_wdata,        <span class="comment">// 写入 CSR 的数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] csr_op,           <span class="comment">// CSR 操作类型（funct3）</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] csr_rdata,        <span class="comment">// 从 CSR 读取的数据</span></span><br><span class="line">    <span class="comment">// 异常/陷阱接口</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        exception_valid,  <span class="comment">// 异常发生</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] exception_pc,     <span class="comment">// 引发异常的指令的 PC</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] exception_cause,  <span class="comment">// 异常原因代码</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] exception_tval,   <span class="comment">// 异常陷阱值（例如非法指令编码）</span></span><br><span class="line">    <span class="comment">// MRET 接口</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        mret_valid,       <span class="comment">// 执行 MRET 指令</span></span><br><span class="line">    <span class="comment">// 陷阱输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        trap_to_mmode,    <span class="comment">// 信号重定向到陷阱处理程序</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] trap_target,      <span class="comment">// 陷阱处理程序地址（mtvec）</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mret_target       <span class="comment">// 从陷阱返回的地址（mepc）</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 机器级 CSR</span></span><br><span class="line">    <span class="comment">// mstatus - 机器状态寄存器</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mstatus;</span><br><span class="line">    <span class="comment">// mtvec - 机器陷阱向量基地址</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mtvec;</span><br><span class="line">    <span class="comment">// mepc - 机器异常程序计数器</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mepc;</span><br><span class="line">    <span class="comment">// mcause - 机器原因寄存器</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mcause;</span><br><span class="line">    <span class="comment">// mscratch - 机器暂存寄存器</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mscratch;</span><br><span class="line">    <span class="comment">// mtval - 机器陷阱值寄存器</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mtval;</span><br><span class="line">    <span class="comment">// mie - 机器中断使能</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mie;</span><br><span class="line">    <span class="comment">// mip - 机器中断挂起</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] mip;</span><br><span class="line">    <span class="comment">// MISA</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] misa;</span><br><span class="line">    <span class="comment">// mcycle - 机器周期计数器（64 位，分为低位和高位）</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] mcycle;</span><br><span class="line">    <span class="comment">// MISA 硬编码为 RV32I，支持 Zicsr 和 Zmmul</span></span><br><span class="line">    <span class="comment">// always_comb begin</span></span><br><span class="line">    <span class="comment">//     misa = 32&#x27;h4000_0110;  // RV32I（基础 ISA）+ Zicsr + Zmmul</span></span><br><span class="line">    <span class="comment">// end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// mstatus 位位置</span></span><br><span class="line">    <span class="keyword">localparam</span> <span class="keyword">integer</span> MIE_BIT = <span class="number">3</span>;  <span class="comment">// 机器中断使能</span></span><br><span class="line">    <span class="keyword">localparam</span> <span class="keyword">integer</span> MPIE_BIT = <span class="number">7</span>;  <span class="comment">// 机器先前中断使能</span></span><br><span class="line">    <span class="keyword">localparam</span> <span class="keyword">integer</span> MPP_LOW = <span class="number">11</span>;  <span class="comment">// 机器先前特权（低位）</span></span><br><span class="line">    <span class="keyword">localparam</span> <span class="keyword">integer</span> MPP_HIGH = <span class="number">12</span>;  <span class="comment">// 机器先前特权（高位）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// CSR 读取逻辑</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (csr_addr)</span><br><span class="line">            `CSR_MSTATUS:              csr_rdata = mstatus;</span><br><span class="line">            `CSR_MTVEC:                csr_rdata = mtvec;</span><br><span class="line">            `CSR_MEPC:                 csr_rdata = mepc;</span><br><span class="line">            `CSR_MCAUSE:               csr_rdata = mcause;</span><br><span class="line">            `CSR_MIE:                  csr_rdata = mie;</span><br><span class="line">            `CSR_MIP:                  csr_rdata = mip;</span><br><span class="line">            `CSR_MSCRATCH:             csr_rdata = mscratch;  <span class="comment">// mscratch</span></span><br><span class="line">            `CSR_MTVAL:                csr_rdata = mtval;  <span class="comment">// mtval</span></span><br><span class="line">            `CSR_MISA:                 csr_rdata = misa;</span><br><span class="line">            `CSR_MCYCLE, `CSR_CYCLE:   csr_rdata = mcycle[<span class="number">31</span>:<span class="number">0</span>];  <span class="comment">// mcycle 低 32 位</span></span><br><span class="line">            `CSR_MCYCLEH, `CSR_CYCLEH: csr_rdata = mcycle[<span class="number">63</span>:<span class="number">32</span>];  <span class="comment">// mcycle 高 32 位</span></span><br><span class="line">            <span class="keyword">default</span>:                   csr_rdata = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据操作类型计算新的 CSR 值</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] csr_new_value;</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (csr_op)</span><br><span class="line">            `FUNCT3_CSRRW, `FUNCT3_CSRRWI: csr_new_value = csr_wdata;  <span class="comment">// 写入</span></span><br><span class="line">            `FUNCT3_CSRRS, `FUNCT3_CSRRSI: csr_new_value = csr_rdata | csr_wdata;  <span class="comment">// 设置位</span></span><br><span class="line">            `FUNCT3_CSRRC, `FUNCT3_CSRRCI: csr_new_value = csr_rdata &amp; (~csr_wdata);  <span class="comment">// 清除位</span></span><br><span class="line">            <span class="keyword">default</span>:                       csr_new_value = csr_rdata;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// CSR 写入逻辑</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 复位值</span></span><br><span class="line">            mstatus  &lt;= <span class="number">32&#x27;h0000_1800</span>;  <span class="comment">// MPP = 11（机器模式）</span></span><br><span class="line">            mtvec    &lt;= <span class="number">32&#x27;h0114_5140</span>;  <span class="comment">// 默认陷阱处理程序地址 </span></span><br><span class="line">            mepc     &lt;= <span class="number">32&#x27;h0000_0000</span>;</span><br><span class="line">            mcause   &lt;= <span class="number">32&#x27;h0000_0000</span>;</span><br><span class="line">            mscratch &lt;= <span class="number">32&#x27;h0000_0000</span>;</span><br><span class="line">            mtval    &lt;= <span class="number">32&#x27;h0000_0000</span>;</span><br><span class="line">            mie      &lt;= <span class="number">32&#x27;h0000_0000</span>;</span><br><span class="line">            mip      &lt;= <span class="number">32&#x27;h0000_0000</span>;</span><br><span class="line">            misa     &lt;= <span class="number">32&#x27;h4000_0100</span>;  <span class="comment">// RV32I</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (exception_valid) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 异常发生时：保存状态并更新 CSR</span></span><br><span class="line">            mepc                      &lt;= exception_pc;</span><br><span class="line">            mcause                    &lt;= exception_cause;</span><br><span class="line">            <span class="comment">// 保存陷阱值（非法指令编码或地址）</span></span><br><span class="line">            mtval                     &lt;= exception_tval;</span><br><span class="line">            <span class="comment">// 更新 mstatus：保存 MIE 到 MPIE，将 MPP 设置为当前特权（目前始终为 M 模式）</span></span><br><span class="line">            mstatus[MPIE_BIT]         &lt;= mstatus[MIE_BIT];  <span class="comment">// MPIE = MIE</span></span><br><span class="line">            mstatus[MIE_BIT]          &lt;= <span class="number">1&#x27;b0</span>;  <span class="comment">// 禁用中断</span></span><br><span class="line">            mstatus[MPP_HIGH:MPP_LOW] &lt;= <span class="number">2&#x27;b11</span>;  <span class="comment">// MPP = 机器模式</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (mret_valid) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 执行 MRET 时：恢复状态</span></span><br><span class="line">            mstatus[MIE_BIT] &lt;= mstatus[MPIE_BIT];  <span class="comment">// MIE = MPIE</span></span><br><span class="line">            mstatus[MPIE_BIT] &lt;= <span class="number">1&#x27;b1</span>;  <span class="comment">// MPIE = 1</span></span><br><span class="line">            mstatus[MPP_HIGH:MPP_LOW] &lt;=</span><br><span class="line">                <span class="number">2&#x27;b11</span>;  <span class="comment">// MPP = 机器模式（因为我们仅支持 M 模式）</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (csr_we) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 正常 CSR 写入</span></span><br><span class="line">            <span class="keyword">case</span> (csr_addr)</span><br><span class="line">                `CSR_MSTATUS:  mstatus &lt;= csr_new_value &amp; <span class="number">32&#x27;h0000_1888</span>;  <span class="comment">// 屏蔽可写位</span></span><br><span class="line">                `CSR_MTVEC:    mtvec &lt;= &#123;csr_new_value[<span class="number">31</span>:<span class="number">2</span>], <span class="number">2&#x27;b00</span>&#125;;  <span class="comment">// 对齐到 4 字节</span></span><br><span class="line">                `CSR_MEPC:     mepc &lt;= &#123;csr_new_value[<span class="number">31</span>:<span class="number">2</span>], <span class="number">2&#x27;b00</span>&#125;;  <span class="comment">// 对齐到 4 字节</span></span><br><span class="line">                `CSR_MCAUSE:   mcause &lt;= csr_new_value;</span><br><span class="line">                `CSR_MIE:      mie &lt;= csr_new_value;</span><br><span class="line">                `CSR_MSCRATCH: mscratch &lt;= csr_new_value;  <span class="comment">// mscratch</span></span><br><span class="line">                `CSR_MTVAL:    mtval &lt;= csr_new_value;  <span class="comment">// mtval</span></span><br><span class="line">                `CSR_MISA:     misa &lt;= misa;  <span class="comment">// 只读</span></span><br><span class="line">                <span class="keyword">default</span>:       ;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// mcycle 计数器 - 无条件每个时钟周期递增</span></span><br><span class="line">    <span class="comment">// 注意：这是一个简化实现，不支持 mcountinhibit。</span></span><br><span class="line">    <span class="comment">// 计数器始终运行，除非通过 CSR 指令显式写入。</span></span><br><span class="line">    <span class="comment">// mcycle 可通过 CSR 指令（MCYCLE/MCYCLEH）写入</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            mcycle &lt;= <span class="number">64&#x27;h0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (csr_we &amp;&amp; csr_addr == `CSR_MCYCLE) <span class="keyword">begin</span></span><br><span class="line">            mcycle[<span class="number">31</span>:<span class="number">0</span>] &lt;= csr_new_value;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (csr_we &amp;&amp; csr_addr == `CSR_MCYCLEH) <span class="keyword">begin</span></span><br><span class="line">            mcycle[<span class="number">63</span>:<span class="number">32</span>] &lt;= csr_new_value;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            mcycle &lt;= mcycle + <span class="number">64&#x27;h1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 陷阱和返回信号</span></span><br><span class="line">    <span class="keyword">assign</span> trap_to_mmode = exception_valid;</span><br><span class="line">    <span class="keyword">assign</span> trap_target   = &#123;mtvec[<span class="number">31</span>:<span class="number">2</span>], <span class="number">2&#x27;b00</span>&#125;;  <span class="comment">// 使用直接模式（MODE=0）</span></span><br><span class="line">    <span class="keyword">assign</span> mret_target   = mepc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure><div class="note info flat"><p>为什么在RISCV规范内，32位CPU的时钟周期计数器也要设计为64位？</p><p>为了避免计数器频繁溢出、简化软件、性能分析的使用RV32 的时钟/指令计数器也要以 64 位来实现。如果按照32位算，假设主频为100Mhz，只要42秒就会溢出——这也太折磨了。但32位的寄存器最大位宽不够，因此要分两个，一个<code>MCYCLE</code>一个<code>MCYCLEH</code>。</p><p>在读取时，要读三遍：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">csrr   t0, cycleh    # read high</span><br><span class="line">csrr   t1, cycle     # read low</span><br><span class="line">csrr   t2, cycleh    # read high again</span><br></pre></td></tr></table></figure><p>因为这两个 CSR 的读取不是原子的：在读它们的间隙时，低 32 位可能发生溢出并把进位加到高 32 位上。我总不能为这个实现A扩展吧。</p><p>当然，对于64位的就简单多了，读取一遍就行了。</p></div><h3 id="顶层模块修改">顶层模块修改</h3><p>在顶层模块内加上相关的异常判断：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异常处理：</span></span><br><span class="line"><span class="comment">// 异常分为两类：</span></span><br><span class="line"><span class="comment">// 1. ID级异常：非法指令 - 需要提前检测以防止其前面的指令提交</span></span><br><span class="line"><span class="comment">// 2. EX级异常：地址未对齐、ECALL - 在执行阶段检测</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// - 指令地址未对齐：mcause = 0，mtval = 未对齐的地址</span></span><br><span class="line"><span class="comment">// - 非法指令：mcause = 2，mtval = 指令编码</span></span><br><span class="line"><span class="comment">// - 加载地址未对齐：mcause = 4，mtval = 未对齐的地址</span></span><br><span class="line"><span class="comment">// - 存储地址未对齐：mcause = 6，mtval = 未对齐的地址</span></span><br><span class="line"><span class="comment">// - ECALL：mcause = 11，mtval = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 地址未对齐检测（EX级）</span></span><br><span class="line"><span class="comment">// 对于JALR：目标地址必须4字节对齐（对于没有C扩展的RV32I，位1必须为0）</span></span><br><span class="line"><span class="comment">// JALR目标 = (rs1 + imm) &amp; ~1，所以我们检查alu_result的位1（掩码之前）</span></span><br><span class="line"><span class="keyword">logic</span> instr_misaligned_EX;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] jalr_target_EX;</span><br><span class="line"><span class="keyword">assign</span> jalr_target_EX = &#123;alu_result_EX[<span class="number">31</span>:<span class="number">1</span>], <span class="number">1&#x27;b0</span>&#125;;  <span class="comment">// JALR target after masking bit 0</span></span><br><span class="line"><span class="keyword">assign</span> instr_misaligned_EX = (jump_type_EX == `JUMP_JALR) &amp;&amp; (alu_result_EX[<span class="number">1</span>] != <span class="number">1&#x27;b0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载/存储地址未对齐检测（EX级）</span></span><br><span class="line"><span class="comment">// LW/SW：必须4字节对齐（位[1:0] == 00）</span></span><br><span class="line"><span class="comment">// LH/LHU/SH：必须2字节对齐（位[0] == 0）</span></span><br><span class="line"><span class="comment">// LB/LBU/SB：无对齐要求</span></span><br><span class="line"><span class="keyword">logic</span> load_misaligned_EX;</span><br><span class="line"><span class="keyword">logic</span> store_misaligned_EX;</span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    load_misaligned_EX = <span class="number">1&#x27;b0</span>;</span><br><span class="line">    store_misaligned_EX = <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">case</span> (sl_type_EX)</span><br><span class="line">        `MEM_LW:  load_misaligned_EX  = (alu_result_EX[<span class="number">1</span>:<span class="number">0</span>] != <span class="number">2&#x27;b00</span>);</span><br><span class="line">        `MEM_LH,</span><br><span class="line">        `MEM_LHU: load_misaligned_EX  = (alu_result_EX[<span class="number">0</span>] != <span class="number">1&#x27;b0</span>);</span><br><span class="line">        `MEM_SW:  store_misaligned_EX = (alu_result_EX[<span class="number">1</span>:<span class="number">0</span>] != <span class="number">2&#x27;b00</span>);</span><br><span class="line">        `MEM_SH:  store_misaligned_EX = (alu_result_EX[<span class="number">0</span>] != <span class="number">1&#x27;b0</span>);</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">            load_misaligned_EX  = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            store_misaligned_EX = <span class="number">1&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// EX级异常 (不包括非法指令，非法指令在ID级处理)</span></span><br><span class="line"><span class="keyword">logic</span> exception_valid_EX;</span><br><span class="line"><span class="keyword">logic</span> take_branch_normal;</span><br><span class="line"><span class="keyword">assign</span> exception_valid_EX = (instr_misaligned_EX || load_misaligned_EX ||</span><br><span class="line">    store_misaligned_EX || is_ecall_EX) &amp;&amp; valid_EX;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 总异常信号：EX级异常 OR ID级非法指令异常</span></span><br><span class="line"><span class="comment">// 优先级：EX级异常 &gt; ID级异常</span></span><br><span class="line"><span class="comment">// 注意：当EX级有有效的跳转/分支时，ID级的指令将被flush，</span></span><br><span class="line"><span class="comment">// 所以ID级的非法指令异常不应该生效</span></span><br><span class="line"><span class="comment">// 这防止了跳转到数据区域时，数据被误认为非法指令而触发异常</span></span><br><span class="line"><span class="keyword">assign</span> exception_valid = exception_valid_EX ||</span><br><span class="line">    (illegal_instr_exception_ID &amp;&amp; !take_branch_normal);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常PC和原因/值的选择</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (instr_misaligned_EX &amp;&amp; valid_EX) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// EX级地址未对齐异常优先</span></span><br><span class="line">        exception_pc    = pc_EX;</span><br><span class="line">        exception_cause = <span class="number">32&#x27;d0</span>;  <span class="comment">// Instruction address misaligned</span></span><br><span class="line">        exception_tval  = jalr_target_EX;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (load_misaligned_EX &amp;&amp; valid_EX) <span class="keyword">begin</span></span><br><span class="line">        exception_pc    = pc_EX;</span><br><span class="line">        exception_cause = <span class="number">32&#x27;d4</span>;  <span class="comment">// Load address misaligned</span></span><br><span class="line">        exception_tval  = alu_result_EX;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (store_misaligned_EX &amp;&amp; valid_EX) <span class="keyword">begin</span></span><br><span class="line">        exception_pc    = pc_EX;</span><br><span class="line">        exception_cause = <span class="number">32&#x27;d6</span>;  <span class="comment">// Store address misaligned</span></span><br><span class="line">        exception_tval  = alu_result_EX;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (is_ecall_EX &amp;&amp; valid_EX) <span class="keyword">begin</span></span><br><span class="line">        exception_pc    = pc_EX;</span><br><span class="line">        exception_cause = <span class="number">32&#x27;d11</span>;  <span class="comment">// ECALL</span></span><br><span class="line">        exception_tval  = <span class="number">32&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (illegal_instr_exception_ID) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// ID级非法指令异常</span></span><br><span class="line">        exception_pc    = illegal_instr_pc_ID;</span><br><span class="line">        exception_cause = <span class="number">32&#x27;d2</span>;  <span class="comment">// Illegal instruction</span></span><br><span class="line">        exception_tval  = illegal_instr_encoding_ID;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 默认值 (不应该到达这里)</span></span><br><span class="line">        exception_pc    = pc_EX;</span><br><span class="line">        exception_cause = <span class="number">32&#x27;d0</span>;</span><br><span class="line">        exception_tval  = <span class="number">32&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后跑一下riscv-test，一切顺利。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;异常：CSR寄存器&quot;&gt;异常：CSR寄存器&lt;/h2&gt;
&lt;p&gt;为了能运行更多的C程序，并且在出现问题时记录下来，CSR寄存器是必不可缺少的。他也是切换特权模式的重要组件。虽然RISCV规范</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第十二篇</title>
    <link href="https://blog.esing.dev/2026/01/09/riscvcod-p12/"/>
    <id>https://blog.esing.dev/2026/01/09/riscvcod-p12/</id>
    <published>2026-01-09T13:20:30.000Z</published>
    <updated>2026-01-11T09:27:32.499Z</updated>
    
    <content type="html"><![CDATA[<h2 id="乘法器">乘法器</h2><p>非常简单。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> MUL(</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src1,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] out</span><br><span class="line">)</span><br><span class="line">    <span class="keyword">assign</span> out = src1 * src2;</span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure><p>结束。</p><hr><p>我们肯定<strong>不能</strong>这样子实现乘法器——即使这种写法能被综合为DSP模块。为什么？因为乘法实在是太太太长了，时间太久。如果将这么一大坨逻辑塞在EX级，时钟频率一定会非常难看。</p><p>怎么办？我们将乘法拆分开，在每个时钟周期实现一部分。这样子，可以稍微改善一点时序。</p><h2 id="四级流水线乘法器-MUL-sv">四级流水线乘法器 <a href="http://MUL.sv">MUL.sv</a></h2><p>首先思考一下：多周期的流水线乘法器会带来哪些额外的时序控制与竞争冒险？</p><p>首先是模块要给出信号，来表示自己“是否完成当前运算”以及“是否能接受新的运算”。此外，在执行时，需要将乘法指令用到的寄存器与写回的目标寄存器记住，否则当指令在旁流水线的乘法模块执行时，结果尚未算出，但后面一条指令需要用到结果，这样就必须阻塞流水线。再如，计算后写回时，如果写回的目标寄存器与目前执行完毕的指令写回寄存器一致，则应当选择最后的值进行写回。要考虑的还真不少。</p><h3 id="乘法指令拆分">乘法指令拆分</h3><p>对于两个32位的数相乘，我们可以拆成低16位和高16位，再两两相乘，最后将四部分相加。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stage 1</span></span><br><span class="line">pp_ll_comb = src1_signed[<span class="number">15</span>:<span class="number">0</span>] * src2_signed[<span class="number">15</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stage 2</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// A_lo * B_hi (16-bit unsigned * 17-bit signed = 33-bit signed)</span></span><br><span class="line">    pp_lh_comb = <span class="built_in">$signed</span>(&#123;<span class="number">1&#x27;b0</span>, s1_a_lo&#125;) * s1_b_hi;</span><br><span class="line">    <span class="comment">// A_hi * B_lo (17-bit signed * 16-bit unsigned = 33-bit signed)</span></span><br><span class="line">    pp_hl_comb = s1_a_hi * <span class="built_in">$signed</span>(&#123;<span class="number">1&#x27;b0</span>, s1_b_lo&#125;);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Stage 3</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// A_hi * B_hi (17-bit signed * 17-bit signed = 34-bit signed)</span></span><br><span class="line">    pp_hh_comb  = s2_a_hi * s2_b_hi;</span><br><span class="line">    <span class="comment">// Sum of middle partial products (with sign extension)</span></span><br><span class="line">    pp_mid_comb = <span class="built_in">$signed</span>(s2_pp_lh) + <span class="built_in">$signed</span>(s2_pp_hl);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Stage 4</span></span><br><span class="line">product_comb = &#123;<span class="number">32&#x27;b0</span>, s3_pp_ll&#125; + (&#123;&#123;<span class="number">30</span>&#123;s3_pp_mid[<span class="number">33</span>]&#125;&#125;, s3_pp_mid&#125; &lt;&lt; <span class="number">16</span>) +</span><br><span class="line">                 (&#123;&#123;<span class="number">30</span>&#123;s3_pp_hh[<span class="number">33</span>]&#125;&#125;, s3_pp_hh&#125; &lt;&lt; <span class="number">32</span>);</span><br></pre></td></tr></table></figure><h3 id="流水线传递信号">流水线传递信号</h3><p>我们要在内部传递一堆计算值，以及当前乘法计算是否有效的信号。在最后一级时传出，代表准备输出。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">        s1_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        s1_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">        s1_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        s1_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        s1_a_hi     &lt;= <span class="number">17&#x27;b0</span>;</span><br><span class="line">        s1_b_hi     &lt;= <span class="number">17&#x27;b0</span>;</span><br><span class="line">        s1_a_lo     &lt;= <span class="number">16&#x27;b0</span>;</span><br><span class="line">        s1_b_lo     &lt;= <span class="number">16&#x27;b0</span>;</span><br><span class="line">        s1_pp_ll    &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush_i) <span class="keyword">begin</span></span><br><span class="line">        s1_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        s1_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">        s1_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        s1_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        s1_a_hi     &lt;= <span class="number">17&#x27;b0</span>;</span><br><span class="line">        s1_b_hi     &lt;= <span class="number">17&#x27;b0</span>;</span><br><span class="line">        s1_a_lo     &lt;= <span class="number">16&#x27;b0</span>;</span><br><span class="line">        s1_b_lo     &lt;= <span class="number">16&#x27;b0</span>;</span><br><span class="line">        s1_pp_ll    &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        s1_valid    &lt;= mul_valid_i;</span><br><span class="line">        s1_op       &lt;= mul_op_i;</span><br><span class="line">        s1_rd       &lt;= mul_rd_i;</span><br><span class="line">        <span class="comment">// Check if this stage should be canceled (WAW without RAW)</span></span><br><span class="line">        s1_canceled &lt;= (cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == mul_rd_i) &amp;&amp; mul_valid_i;</span><br><span class="line">        <span class="comment">// Store split operands for next stage</span></span><br><span class="line">        s1_a_hi     &lt;= src1_signed[<span class="number">32</span>:<span class="number">16</span>];</span><br><span class="line">        s1_b_hi     &lt;= src2_signed[<span class="number">32</span>:<span class="number">16</span>];</span><br><span class="line">        s1_a_lo     &lt;= src1_signed[<span class="number">15</span>:<span class="number">0</span>];</span><br><span class="line">        s1_b_lo     &lt;= src2_signed[<span class="number">15</span>:<span class="number">0</span>];</span><br><span class="line">        s1_pp_ll    &lt;= pp_ll_comb;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">        s4_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        s4_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">        s4_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        s4_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        s4_product  &lt;= <span class="number">64&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush_i) <span class="keyword">begin</span></span><br><span class="line">        s4_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        s4_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">        s4_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        s4_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        s4_product  &lt;= <span class="number">64&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        s4_valid &lt;= s3_valid;</span><br><span class="line">        s4_op &lt;= s3_op;</span><br><span class="line">        s4_rd &lt;= s3_rd;</span><br><span class="line">        <span class="comment">// Propagate cancel or detect new cancel for this stage</span></span><br><span class="line">        s4_canceled &lt;= s3_canceled ||</span><br><span class="line">        ((cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == s3_rd) &amp;&amp; s3_valid);</span><br><span class="line">        s4_product &lt;= product_comb;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="RegisterF-修改">RegisterF 修改</h2><p>因为我们额外设置了乘法器的计算结果，它不能和主流水线的计算结果一同写入，因为寄存器堆只有一个写端口。如果区分先后写入的话，则又要阻塞一个周期，而我们设置成流水线级的乘法器为的就是尽可能减少阻塞。因此，修改寄存器堆为双端口写回：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写入使用时序逻辑 - 支持双写端口</span></span><br><span class="line"><span class="comment">// 当两个端口同时写入同一寄存器时主流水线端口优先</span></span><br><span class="line"><span class="comment">// 因乘法为长指令 后写回的短指令在时序上更靠后因此结果更新</span></span><br><span class="line"><span class="comment">// 应当采用更新的寄存器值</span></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// 主流水线写端口</span></span><br><span class="line">    <span class="keyword">if</span> (rf_we &amp;&amp; wR != <span class="number">5&#x27;d0</span>) <span class="keyword">begin</span></span><br><span class="line">        rf_in[wR] &lt;= wD;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// 乘法器写端口（优先级更低）</span></span><br><span class="line">    <span class="keyword">if</span> (rf_we2 &amp;&amp; wR2 != <span class="number">5&#x27;d0</span> &amp;&amp; !(rf_we &amp;&amp; wR == wR2)) <span class="keyword">begin</span></span><br><span class="line">        rf_in[wR2] &lt;= wD2;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="HazardUnit-修改">HazardUnit 修改</h2><h3 id="新的冲突，新的分析">新的冲突，新的分析</h3><p>对于双端口的写回寄存器来说，乘法计算结果与主流水线的计算结果独立，因此在写回时，可能出现写到同一个目标寄存器的现象。参考上面的注释，乘法为长指令，后写回的短指令在时序上更靠后，因此计算结果较新。按照ISA规范，<strong>后执行的指令必须最后写入</strong>，否则会破坏程序正确性。</p><p>首先检测所有可能的 WAW 冲突，若乘法器中该级有有效的MUL指令，且ID级要写寄存器并不为<code>x0</code>，以及目标寄存器相同，则存在WAW 冲突。</p><p>如果 ID 指令读取了 MUL 的目标寄存器，说明这是个WAW+RAW的冲突，必须为RAW冲突阻塞流水线，因为乘法结果在<strong>EX级</strong>之后的第四个周期才计算完成：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Cycle 1</span><br><span class="line">MUL  x5, x1, x2   # S1, 将写 x5</span><br><span class="line"></span><br><span class="line"># Cycle 2  </span><br><span class="line">ADD  x6, x5, x7   # ID, 读 x5（RAW依赖）</span><br><span class="line"></span><br><span class="line"># Cycle 3</span><br><span class="line">MUL  x5, x3, x4   # ID, 读 x5，写 x5（WAW + RAW）</span><br><span class="line"># 检测结果：</span><br><span class="line"># mul_waw_conflict[1] = 1  (与S1的第一条MUL冲突)</span><br><span class="line"># id_reads_mul_rd[1] = 1   (ID读取了x5)</span><br><span class="line"># mul_waw_hazard = 1 → 停顿流水线</span><br></pre></td></tr></table></figure><table><thead><tr><th>Cycle</th><th>PC</th><th>IF</th><th>ID</th><th>EX</th><th>MUL S1→S4</th><th>操作</th></tr></thead><tbody><tr><td>1</td><td>0x00</td><td>MUL1</td><td>-</td><td rowspan="2" colspan="2">-</td><td>MUL1进入IF</td></tr><tr><td>2</td><td rowspan="6">0x04</td><td>ADD</td><td>MUL1</td><td>检测WAW+RAW<br><code>mul_waw_hazard=1</code></td></tr><tr><td>3</td><td rowspan="5">MUL2</td><td rowspan="5">ADD</td><td rowspan="5">MUL1</td><td>- (Data In)</td><td><strong>停顿</strong>（保持PC）</td></tr><tr><td>4</td><td>S1</td><td rowspan="3"><strong>停顿</strong></td></tr><tr><td>5</td><td>S2</td></tr><tr><td>6</td><td>S3</td></tr><tr><td>7</td><td>S4 (WriteBack)</td><td>MUL1完成，ADD读到正确x5</td></tr><tr><td>8</td><td>0x08</td><td>…</td><td>MUL2</td><td>ADD</td><td>S1</td><td>ADD进行运算，MUL2进入ID</td></tr></tbody></table><p>此外，还存在纯WAW冲突，即“两个写回端口相同”，但不存在RAW冲突：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Cycle 1</span><br><span class="line">MUL  x5, x1, x2   # S1, 将写 x5</span><br><span class="line"></span><br><span class="line"># Cycle 2</span><br><span class="line">ADD  x5, x3, x4   # ID, 写 x5，但不读 x5（仅WAW）</span><br><span class="line"># 检测结果：</span><br><span class="line"># mul_waw_conflict[1] = 1  (与S1的MUL冲突)</span><br><span class="line"># id_reads_mul_rd[1] = 0   (ID不读x5)</span><br><span class="line"># pure_waw_conflict = 1</span><br><span class="line"># mul_cancel_rd = x5 → 取消第一条MUL的写回</span><br></pre></td></tr></table></figure><p>对于这一种冲突，使用<code>mul_cancel_rd</code>信号来设置取消写回的寄存器地址。</p><table><thead><tr><th>Cycle</th><th>PC</th><th>IF</th><th>ID</th><th>EX</th><th>MEM</th><th>WB</th><th>MUL S1→S4</th><th>操作</th></tr></thead><tbody><tr><td>1</td><td>0x00</td><td>MUL</td><td>-</td><td rowspan="2">-</td><td rowspan="3">-</td><td rowspan="4">-</td><td rowspan="2">-</td><td>MUL进入IF</td></tr><tr><td>2</td><td>0x04</td><td>ADD</td><td>MUL</td><td>检测纯WAW<br/><code>mul_cancel_rd=x5</code></td></tr><tr><td>3</td><td>0x08</td><td rowspan="5">...</td><td>ADD</td><td>MUL</td><td>- (Data In)</td><td>MUL标记为<strong>取消</strong></td></tr><tr><td>4</td><td>0x0C</td><td rowspan="4">...</td><td>ADD</td><td>MUL</td><td>S1 (canceled)</td><td>-</td></tr><tr><td>5</td><td>0x10</td><td rowspan="3">...</td><td>ADD</td><td>MUL</td><td>S2 (canceled)</td><td></td></tr><tr><td>6</td><td>0x14</td><td rowspan="2">...</td><td>ADD</td><td>S3 (canceled)</td><td>ADD写x5</td></tr><tr><td>7</td><td>0x18</td><td>...</td><td>S4 (No WriteBack)</td><td>MUL不写x5</td></tr></tbody></table><div class="note info flat"><p>注意这里的乘法器实际经过的流水线为<code>IF/ID/S1/S2/S3/S4</code></p></div><h3 id="WAW依赖相关逻辑">WAW依赖相关逻辑</h3><p>修改<code>HazardUnit</code>模块内部，加入传出的乘法器内流水线寄存器暂存的信号：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> HazardUnit(</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">    <span class="comment">// 乘法器状态信号 (4级流水线)</span></span><br><span class="line">    <span class="comment">// 约定：mul_stage_busy[0]=S1 ... [3]=S4；mul_rd_s[0]=S1 ... [3]=S4</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>]      mul_stage_busy,      <span class="comment">// 乘法器各级流水线忙状态</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>][<span class="number">4</span>:<span class="number">0</span>] mul_rd_s,            <span class="comment">// 乘法器各级流水线目标寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>             is_mul_instr_ID,     <span class="comment">// ID级是否为乘法指令</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>             is_mul_instr_EX,     <span class="comment">// EX级是否为乘法指令</span></span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">    <span class="comment">// 乘法器写回无效化信号 (WAW冒险时取消MUL写回)</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>]      mul_cancel_rd</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// MUL 冒险判断（RAW + 结构冒险 + WAW处理）</span></span><br><span class="line">    <span class="comment">// 乘法器 4 级流水：S1-&gt;S2-&gt;S3-&gt;S4（结果在S4末尾可用）</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">logic</span> mul_use_hazard;</span><br><span class="line">    <span class="keyword">logic</span> mul_struct_hazard;</span><br><span class="line">    <span class="keyword">logic</span> mul_waw_hazard;</span><br><span class="line">    <span class="keyword">logic</span> pure_waw_conflict;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结构冒险：S1被占用时，新的乘法指令不能进入</span></span><br><span class="line">    <span class="keyword">assign</span> mul_struct_hazard = is_mul_instr_ID &amp;&amp; mul_stage_busy[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 EX + S1..S4 统一成 5 路，便于循环处理</span></span><br><span class="line">    <span class="comment">// mul_rd_all[0]=EX，mul_rd_all[1]=S1 ... mul_rd_all[4]=S4</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>][<span class="number">4</span>:<span class="number">0</span>] mul_rd_all;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>]      mul_vld_all;</span><br><span class="line">    <span class="keyword">assign</span> mul_rd_all  = &#123;mul_rd_s, wR_EX&#125;;</span><br><span class="line">    <span class="keyword">assign</span> mul_vld_all = &#123;mul_stage_busy, is_mul_instr_EX&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Debug/可视化向量（可在波形里直接看每一级是否命中）</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] mul_raw_hit_r1;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] mul_raw_hit_r2;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] id_reads_mul_rd;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] mul_waw_conflict;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        mul_raw_hit_r1   = &#x27;<span class="number">0</span>;</span><br><span class="line">        mul_raw_hit_r2   = &#x27;<span class="number">0</span>;</span><br><span class="line">        id_reads_mul_rd  = &#x27;<span class="number">0</span>;</span><br><span class="line">        mul_waw_conflict = &#x27;<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// RAW：ID读取 rR1/rR2，且命中任一在飞MUL的rd</span></span><br><span class="line">            mul_raw_hit_r1[i] = mul_vld_all[i] &amp;&amp; (mul_rd_all[i] != <span class="number">5&#x27;d0</span>) &amp;&amp; rs1_used_ID &amp;&amp;</span><br><span class="line">            (mul_rd_all[i] == rR1_ID);</span><br><span class="line">            mul_raw_hit_r2[i] = mul_vld_all[i] &amp;&amp; (mul_rd_all[i] != <span class="number">5&#x27;d0</span>) &amp;&amp; rs2_used_ID &amp;&amp;</span><br><span class="line">            (mul_rd_all[i] == rR2_ID);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ID是否读取了该rd（用于区分 WAW 需要停顿 / 仅取消写回）</span></span><br><span class="line">            id_reads_mul_rd[i] = (mul_rd_all[i] != <span class="number">5&#x27;d0</span>) &amp;&amp;</span><br><span class="line">            ((rs1_used_ID &amp;&amp; (rR1_ID == mul_rd_all[i])) ||</span><br><span class="line">             (rs2_used_ID &amp;&amp; (rR2_ID == mul_rd_all[i])));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// WAW冲突：ID将写 wR_ID，且与某级MUL rd 相同</span></span><br><span class="line">            mul_waw_conflict[i] = mul_vld_all[i] &amp;&amp; rf_we_ID &amp;&amp; (wR_ID != <span class="number">5&#x27;d0</span>) &amp;&amp;</span><br><span class="line">            (mul_rd_all[i] == wR_ID);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        mul_use_hazard    = (|mul_raw_hit_r1) || (|mul_raw_hit_r2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// WAW冒险：只有 WAW + 同时存在RAW读依赖 才需要停顿</span></span><br><span class="line">        mul_waw_hazard    = |(mul_waw_conflict &amp; id_reads_mul_rd);</span><br><span class="line">        pure_waw_conflict = |(mul_waw_conflict &amp; ~id_reads_mul_rd);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纯WAW冲突（无RAW依赖）时，取消MUL对该寄存器的写回</span></span><br><span class="line">    <span class="keyword">assign</span> mul_cancel_rd = pure_waw_conflict ? wR_ID : <span class="number">5&#x27;d0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 流水线冲刷与停顿</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">logic</span> any_hazard;</span><br><span class="line">    <span class="keyword">assign</span> any_hazard = load_use_hazard || mul_use_hazard || mul_struct_hazard || mul_waw_hazard;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        keep_pc     = any_hazard;</span><br><span class="line">        stall_IF_ID = any_hazard;</span><br><span class="line">        flush_IF_ID = branch_predicted_result;</span><br><span class="line">        flush_ID_EX = (branch_predicted_result || any_hazard);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure><h2 id="写回数据来源选择">写回数据来源选择</h2><p>还得修改一下位于WB级的写回数据选择MUX：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rf_wd_WB保留用于前递（需要考虑乘法结果）</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rf_wd_WB_final;</span><br><span class="line"><span class="keyword">logic</span> mul_result_forwarded;</span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    mul_result_forwarded = mul_valid_o &amp;&amp; mul_rf_we_o &amp;&amp; (mul_rd_o == rR1 || mul_rd_o == rR2);</span><br><span class="line">    <span class="keyword">if</span> (mul_result_forwarded) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 乘法结果用于前递</span></span><br><span class="line">        rf_wd_WB_final = mul_result;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (wd_sel_WB == `WD_SEL_FROM_DRAM) <span class="keyword">begin</span></span><br><span class="line">        rf_wd_WB_final = load_data_WB;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        rf_wd_WB_final = rf_wd_WB_from_ALU;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>之后再进行时序分析，发现关键路径跑到了MUL上，说明乘法真的<strong>很长</strong>。其实可以再将乘法拆开为六级的。</p><div class="note warning flat"><p>上面的MUX写法一开始为：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mul_valid_o &amp;&amp; mul_rf_we_o) <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// 乘法结果用于前递</span></span><br><span class="line">    rf_wd_WB_final = mul_result;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>但是当乘法器与计算结果同一个时期写回时，前递数据会优先选择乘法器的，而不会判断ID级要读取的源寄存器是否与乘法器一致！</p><p>这个问题在四级乘法器时没有被发现，但是到了六级的时候被发现了。</p></div><h2 id="采用Booth编码与华莱士树的六级乘法器">采用Booth编码与华莱士树的六级乘法器</h2><p>手写是不可能手写的，让AI帮忙吧。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"><span class="comment">// 六级流水线乘法器 - Radix-4 Booth编码 + Wallace Tree</span></span><br><span class="line"><span class="comment">// 使用Booth编码减少部分积数量，Wallace Tree并行归约</span></span><br><span class="line"><span class="comment">// 显著降低关键路径延时</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> MUL (</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> clk,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> rst_n,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 来自 ID 阶段的输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>             mul_valid_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>]      mul_op_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>]      mul_src1_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>]      mul_src2_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>]      mul_rd_i,</span><br><span class="line">    <span class="comment">// 流水线冲刷</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>             flush_i,</span><br><span class="line">    <span class="comment">// WAW 冒险取消写回</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>]      cancel_rd_i,</span><br><span class="line">    <span class="comment">// 输出到 WB 阶段</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>             mul_valid_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>]      mul_result_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>]      mul_rd_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>             mul_rf_we_o,</span><br><span class="line">    <span class="comment">// 流水线状态</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>             mul_busy_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">5</span>:<span class="number">0</span>]      mul_stage_busy_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">5</span>:<span class="number">0</span>][<span class="number">4</span>:<span class="number">0</span>] mul_rd_s_o</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 乘法操作类型</span></span><br><span class="line">    <span class="keyword">localparam</span> MUL_OP_MUL    = <span class="number">2&#x27;b00</span>;</span><br><span class="line">    <span class="keyword">localparam</span> MUL_OP_MULH   = <span class="number">2&#x27;b01</span>;</span><br><span class="line">    <span class="keyword">localparam</span> MUL_OP_MULHSU = <span class="number">2&#x27;b10</span>;</span><br><span class="line">    <span class="keyword">localparam</span> MUL_OP_MULHU  = <span class="number">2&#x27;b11</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Booth编码常量 (使用 localparam 代替 enum)</span></span><br><span class="line">    <span class="keyword">localparam</span> [<span class="number">2</span>:<span class="number">0</span>]  BOOTH_0 = <span class="number">3&#x27;b000</span>;  <span class="comment">// 0</span></span><br><span class="line">    <span class="keyword">localparam</span> [<span class="number">2</span>:<span class="number">0</span>] BOOTH_P1 = <span class="number">3&#x27;b001</span>;  <span class="comment">// +1</span></span><br><span class="line">    <span class="keyword">localparam</span> [<span class="number">2</span>:<span class="number">0</span>] BOOTH_P2 = <span class="number">3&#x27;b010</span>;  <span class="comment">// +2</span></span><br><span class="line">    <span class="keyword">localparam</span> [<span class="number">2</span>:<span class="number">0</span>] BOOTH_N2 = <span class="number">3&#x27;b011</span>;  <span class="comment">// -2</span></span><br><span class="line">    <span class="keyword">localparam</span> [<span class="number">2</span>:<span class="number">0</span>] BOOTH_N1 = <span class="number">3&#x27;b100</span>;  <span class="comment">// -1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =====================================================================</span></span><br><span class="line">    <span class="comment">// 3: 2 CSA 压缩器宏定义</span></span><br><span class="line">    <span class="comment">// =====================================================================</span></span><br><span class="line">    <span class="meta">`<span class="keyword">define</span> CSA_3_2(a, b, c, sum, carry) \</span></span><br><span class="line">        <span class="keyword">assign</span> sum   = (a) ^ (b) ^ (c); \</span><br><span class="line">        <span class="keyword">assign</span> carry = (((a) &amp; (b)) | ((b) &amp; (c)) | ((a) &amp; (c))) &lt;&lt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======================== Stage 1: Booth编码 ========================</span></span><br><span class="line">    <span class="keyword">logic</span>               s1_valid;</span><br><span class="line">    <span class="keyword">logic</span>        [ <span class="number">1</span>:<span class="number">0</span>] s1_op;</span><br><span class="line">    <span class="keyword">logic</span>        [ <span class="number">4</span>:<span class="number">0</span>] s1_rd;</span><br><span class="line">    <span class="keyword">logic</span>               s1_canceled;</span><br><span class="line">    <span class="keyword">logic</span> <span class="keyword">signed</span> [<span class="number">33</span>:<span class="number">0</span>] s1_multiplicand;</span><br><span class="line">    <span class="keyword">logic</span>        [ <span class="number">2</span>:<span class="number">0</span>] s1_booth_enc     [<span class="number">16</span>:<span class="number">0</span>];  <span class="comment">// 使用 logic [2:0] 代替 enum</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 符号扩展逻辑</span></span><br><span class="line">    <span class="keyword">logic</span> <span class="keyword">signed</span> [<span class="number">33</span>:<span class="number">0</span>] multiplicand_ext;</span><br><span class="line">    <span class="keyword">logic</span> <span class="keyword">signed</span> [<span class="number">34</span>:<span class="number">0</span>] multiplier_ext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Booth编码组合逻辑</span></span><br><span class="line">    <span class="keyword">logic</span>        [ <span class="number">2</span>:<span class="number">0</span>] booth_enc_comb   [<span class="number">16</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Booth编码函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">automatic</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] booth_encode(<span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] bits);</span><br><span class="line">        <span class="keyword">case</span> (bits)</span><br><span class="line">            <span class="number">3&#x27;b000</span>:  <span class="keyword">return</span> BOOTH_0;</span><br><span class="line">            <span class="number">3&#x27;b001</span>:  <span class="keyword">return</span> BOOTH_P1;</span><br><span class="line">            <span class="number">3&#x27;b010</span>:  <span class="keyword">return</span> BOOTH_P1;</span><br><span class="line">            <span class="number">3&#x27;b011</span>:  <span class="keyword">return</span> BOOTH_P2;</span><br><span class="line">            <span class="number">3&#x27;b100</span>:  <span class="keyword">return</span> BOOTH_N2;</span><br><span class="line">            <span class="number">3&#x27;b101</span>:  <span class="keyword">return</span> BOOTH_N1;</span><br><span class="line">            <span class="number">3&#x27;b110</span>:  <span class="keyword">return</span> BOOTH_N1;</span><br><span class="line">            <span class="number">3&#x27;b111</span>:  <span class="keyword">return</span> BOOTH_0;</span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">return</span> BOOTH_0;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (mul_op_i)</span><br><span class="line">            MUL_OP_MUL, MUL_OP_MULH: <span class="keyword">begin</span></span><br><span class="line">                multiplicand_ext = &#123;&#123;<span class="number">2</span>&#123;mul_src1_i[<span class="number">31</span>]&#125;&#125;, mul_src1_i&#125;;</span><br><span class="line">                multiplier_ext   = &#123;&#123;<span class="number">3</span>&#123;mul_src2_i[<span class="number">31</span>]&#125;&#125;, mul_src2_i&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            MUL_OP_MULHSU: <span class="keyword">begin</span></span><br><span class="line">                multiplicand_ext = &#123;&#123;<span class="number">2</span>&#123;mul_src1_i[<span class="number">31</span>]&#125;&#125;, mul_src1_i&#125;;</span><br><span class="line">                multiplier_ext   = &#123;<span class="number">3&#x27;b0</span>, mul_src2_i&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            MUL_OP_MULHU: <span class="keyword">begin</span></span><br><span class="line">                multiplicand_ext = &#123;<span class="number">2&#x27;b0</span>, mul_src1_i&#125;;</span><br><span class="line">                multiplier_ext   = &#123;<span class="number">3&#x27;b0</span>, mul_src2_i&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                multiplicand_ext = <span class="number">34&#x27;b0</span>;</span><br><span class="line">                multiplier_ext   = <span class="number">35&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成17个Booth编码</span></span><br><span class="line">        booth_enc_comb[<span class="number">0</span>]  = booth_encode(&#123;multiplier_ext[<span class="number">1</span>:<span class="number">0</span>], <span class="number">1&#x27;b0</span>&#125;);</span><br><span class="line">        booth_enc_comb[<span class="number">1</span>]  = booth_encode(multiplier_ext[<span class="number">3</span>:<span class="number">1</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">2</span>]  = booth_encode(multiplier_ext[<span class="number">5</span>:<span class="number">3</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">3</span>]  = booth_encode(multiplier_ext[<span class="number">7</span>:<span class="number">5</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">4</span>]  = booth_encode(multiplier_ext[<span class="number">9</span>:<span class="number">7</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">5</span>]  = booth_encode(multiplier_ext[<span class="number">11</span>:<span class="number">9</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">6</span>]  = booth_encode(multiplier_ext[<span class="number">13</span>:<span class="number">11</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">7</span>]  = booth_encode(multiplier_ext[<span class="number">15</span>:<span class="number">13</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">8</span>]  = booth_encode(multiplier_ext[<span class="number">17</span>:<span class="number">15</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">9</span>]  = booth_encode(multiplier_ext[<span class="number">19</span>:<span class="number">17</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">10</span>] = booth_encode(multiplier_ext[<span class="number">21</span>:<span class="number">19</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">11</span>] = booth_encode(multiplier_ext[<span class="number">23</span>:<span class="number">21</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">12</span>] = booth_encode(multiplier_ext[<span class="number">25</span>:<span class="number">23</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">13</span>] = booth_encode(multiplier_ext[<span class="number">27</span>:<span class="number">25</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">14</span>] = booth_encode(multiplier_ext[<span class="number">29</span>:<span class="number">27</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">15</span>] = booth_encode(multiplier_ext[<span class="number">31</span>:<span class="number">29</span>]);</span><br><span class="line">        booth_enc_comb[<span class="number">16</span>] = booth_encode(multiplier_ext[<span class="number">33</span>:<span class="number">31</span>]);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n || flush_i) <span class="keyword">begin</span></span><br><span class="line">            s1_valid         &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s1_op            &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            s1_rd            &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">            s1_canceled      &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s1_multiplicand  &lt;= <span class="number">34&#x27;b0</span>;</span><br><span class="line">            s1_booth_enc[<span class="number">0</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">1</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">2</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">3</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">4</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">5</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">6</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">7</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">8</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">9</span>]  &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">10</span>] &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">11</span>] &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">12</span>] &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">13</span>] &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">14</span>] &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">15</span>] &lt;= BOOTH_0;</span><br><span class="line">            s1_booth_enc[<span class="number">16</span>] &lt;= BOOTH_0;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            s1_valid         &lt;= mul_valid_i;</span><br><span class="line">            s1_op            &lt;= mul_op_i;</span><br><span class="line">            s1_rd            &lt;= mul_rd_i;</span><br><span class="line">            s1_canceled      &lt;= (cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == mul_rd_i) &amp;&amp; mul_valid_i;</span><br><span class="line">            s1_multiplicand  &lt;= multiplicand_ext;</span><br><span class="line">            s1_booth_enc[<span class="number">0</span>]  &lt;= booth_enc_comb[<span class="number">0</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">1</span>]  &lt;= booth_enc_comb[<span class="number">1</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">2</span>]  &lt;= booth_enc_comb[<span class="number">2</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">3</span>]  &lt;= booth_enc_comb[<span class="number">3</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">4</span>]  &lt;= booth_enc_comb[<span class="number">4</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">5</span>]  &lt;= booth_enc_comb[<span class="number">5</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">6</span>]  &lt;= booth_enc_comb[<span class="number">6</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">7</span>]  &lt;= booth_enc_comb[<span class="number">7</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">8</span>]  &lt;= booth_enc_comb[<span class="number">8</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">9</span>]  &lt;= booth_enc_comb[<span class="number">9</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">10</span>] &lt;= booth_enc_comb[<span class="number">10</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">11</span>] &lt;= booth_enc_comb[<span class="number">11</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">12</span>] &lt;= booth_enc_comb[<span class="number">12</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">13</span>] &lt;= booth_enc_comb[<span class="number">13</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">14</span>] &lt;= booth_enc_comb[<span class="number">14</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">15</span>] &lt;= booth_enc_comb[<span class="number">15</span>];</span><br><span class="line">            s1_booth_enc[<span class="number">16</span>] &lt;= booth_enc_comb[<span class="number">16</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======================== Stage 2: 部分积生成 ========================</span></span><br><span class="line">    <span class="keyword">logic</span>               s2_valid;</span><br><span class="line">    <span class="keyword">logic</span>        [ <span class="number">1</span>:<span class="number">0</span>] s2_op;</span><br><span class="line">    <span class="keyword">logic</span>        [ <span class="number">4</span>:<span class="number">0</span>] s2_rd;</span><br><span class="line">    <span class="keyword">logic</span>               s2_canceled;</span><br><span class="line">    <span class="keyword">logic</span> <span class="keyword">signed</span> [<span class="number">67</span>:<span class="number">0</span>] s2_pp       [<span class="number">16</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 部分积生成函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">automatic</span> <span class="keyword">logic</span> <span class="keyword">signed</span> [<span class="number">67</span>:<span class="number">0</span>] gen_partial_product(</span><br><span class="line">        <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] enc, <span class="keyword">input</span> <span class="keyword">logic</span> <span class="keyword">signed</span> [<span class="number">33</span>:<span class="number">0</span>] multiplicand, <span class="keyword">input</span> <span class="keyword">int</span> shift);</span><br><span class="line">        <span class="keyword">logic</span> <span class="keyword">signed</span> [<span class="number">67</span>:<span class="number">0</span>] result;</span><br><span class="line">        <span class="keyword">case</span> (enc)</span><br><span class="line">            BOOTH_0:  result = <span class="number">68</span>&#x27;sb0;</span><br><span class="line">            BOOTH_P1: result = &#123;&#123;<span class="number">34</span>&#123;multiplicand[<span class="number">33</span>]&#125;&#125;, multiplicand&#125; &lt;&lt; shift;</span><br><span class="line">            BOOTH_P2: result = &#123;&#123;<span class="number">33</span>&#123;multiplicand[<span class="number">33</span>]&#125;&#125;, multiplicand, <span class="number">1&#x27;b0</span>&#125; &lt;&lt; shift;</span><br><span class="line">            BOOTH_N1: result = (-&#123;&#123;<span class="number">34</span>&#123;multiplicand[<span class="number">33</span>]&#125;&#125;, multiplicand&#125;) &lt;&lt; shift;</span><br><span class="line">            BOOTH_N2: result = (-&#123;&#123;<span class="number">33</span>&#123;multiplicand[<span class="number">33</span>]&#125;&#125;, multiplicand, <span class="number">1&#x27;b0</span>&#125;) &lt;&lt; shift;</span><br><span class="line">            <span class="keyword">default</span>:  result = <span class="number">68</span>&#x27;sb0;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 部分积组合逻辑</span></span><br><span class="line">    <span class="keyword">logic</span> <span class="keyword">signed</span> [<span class="number">67</span>:<span class="number">0</span>] pp_comb[<span class="number">16</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        pp_comb[<span class="number">0</span>]  = gen_partial_product(s1_booth_enc[<span class="number">0</span>], s1_multiplicand, <span class="number">0</span>);</span><br><span class="line">        pp_comb[<span class="number">1</span>]  = gen_partial_product(s1_booth_enc[<span class="number">1</span>], s1_multiplicand, <span class="number">2</span>);</span><br><span class="line">        pp_comb[<span class="number">2</span>]  = gen_partial_product(s1_booth_enc[<span class="number">2</span>], s1_multiplicand, <span class="number">4</span>);</span><br><span class="line">        pp_comb[<span class="number">3</span>]  = gen_partial_product(s1_booth_enc[<span class="number">3</span>], s1_multiplicand, <span class="number">6</span>);</span><br><span class="line">        pp_comb[<span class="number">4</span>]  = gen_partial_product(s1_booth_enc[<span class="number">4</span>], s1_multiplicand, <span class="number">8</span>);</span><br><span class="line">        pp_comb[<span class="number">5</span>]  = gen_partial_product(s1_booth_enc[<span class="number">5</span>], s1_multiplicand, <span class="number">10</span>);</span><br><span class="line">        pp_comb[<span class="number">6</span>]  = gen_partial_product(s1_booth_enc[<span class="number">6</span>], s1_multiplicand, <span class="number">12</span>);</span><br><span class="line">        pp_comb[<span class="number">7</span>]  = gen_partial_product(s1_booth_enc[<span class="number">7</span>], s1_multiplicand, <span class="number">14</span>);</span><br><span class="line">        pp_comb[<span class="number">8</span>]  = gen_partial_product(s1_booth_enc[<span class="number">8</span>], s1_multiplicand, <span class="number">16</span>);</span><br><span class="line">        pp_comb[<span class="number">9</span>]  = gen_partial_product(s1_booth_enc[<span class="number">9</span>], s1_multiplicand, <span class="number">18</span>);</span><br><span class="line">        pp_comb[<span class="number">10</span>] = gen_partial_product(s1_booth_enc[<span class="number">10</span>], s1_multiplicand, <span class="number">20</span>);</span><br><span class="line">        pp_comb[<span class="number">11</span>] = gen_partial_product(s1_booth_enc[<span class="number">11</span>], s1_multiplicand, <span class="number">22</span>);</span><br><span class="line">        pp_comb[<span class="number">12</span>] = gen_partial_product(s1_booth_enc[<span class="number">12</span>], s1_multiplicand, <span class="number">24</span>);</span><br><span class="line">        pp_comb[<span class="number">13</span>] = gen_partial_product(s1_booth_enc[<span class="number">13</span>], s1_multiplicand, <span class="number">26</span>);</span><br><span class="line">        pp_comb[<span class="number">14</span>] = gen_partial_product(s1_booth_enc[<span class="number">14</span>], s1_multiplicand, <span class="number">28</span>);</span><br><span class="line">        pp_comb[<span class="number">15</span>] = gen_partial_product(s1_booth_enc[<span class="number">15</span>], s1_multiplicand, <span class="number">30</span>);</span><br><span class="line">        pp_comb[<span class="number">16</span>] = gen_partial_product(s1_booth_enc[<span class="number">16</span>], s1_multiplicand, <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n || flush_i) <span class="keyword">begin</span></span><br><span class="line">            s2_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s2_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            s2_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">            s2_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">0</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">1</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">2</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">3</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">4</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">5</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">6</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">7</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">8</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">9</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">10</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">11</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">12</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">13</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">14</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">15</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s2_pp[<span class="number">16</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            s2_valid &lt;= s1_valid;</span><br><span class="line">            s2_op &lt;= s1_op;</span><br><span class="line">            s2_rd &lt;= s1_rd;</span><br><span class="line">            s2_canceled &lt;= s1_canceled ||</span><br><span class="line">                ((cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == s1_rd) &amp;&amp; s1_valid);</span><br><span class="line">            s2_pp[<span class="number">0</span>] &lt;= pp_comb[<span class="number">0</span>];</span><br><span class="line">            s2_pp[<span class="number">1</span>] &lt;= pp_comb[<span class="number">1</span>];</span><br><span class="line">            s2_pp[<span class="number">2</span>] &lt;= pp_comb[<span class="number">2</span>];</span><br><span class="line">            s2_pp[<span class="number">3</span>] &lt;= pp_comb[<span class="number">3</span>];</span><br><span class="line">            s2_pp[<span class="number">4</span>] &lt;= pp_comb[<span class="number">4</span>];</span><br><span class="line">            s2_pp[<span class="number">5</span>] &lt;= pp_comb[<span class="number">5</span>];</span><br><span class="line">            s2_pp[<span class="number">6</span>] &lt;= pp_comb[<span class="number">6</span>];</span><br><span class="line">            s2_pp[<span class="number">7</span>] &lt;= pp_comb[<span class="number">7</span>];</span><br><span class="line">            s2_pp[<span class="number">8</span>] &lt;= pp_comb[<span class="number">8</span>];</span><br><span class="line">            s2_pp[<span class="number">9</span>] &lt;= pp_comb[<span class="number">9</span>];</span><br><span class="line">            s2_pp[<span class="number">10</span>] &lt;= pp_comb[<span class="number">10</span>];</span><br><span class="line">            s2_pp[<span class="number">11</span>] &lt;= pp_comb[<span class="number">11</span>];</span><br><span class="line">            s2_pp[<span class="number">12</span>] &lt;= pp_comb[<span class="number">12</span>];</span><br><span class="line">            s2_pp[<span class="number">13</span>] &lt;= pp_comb[<span class="number">13</span>];</span><br><span class="line">            s2_pp[<span class="number">14</span>] &lt;= pp_comb[<span class="number">14</span>];</span><br><span class="line">            s2_pp[<span class="number">15</span>] &lt;= pp_comb[<span class="number">15</span>];</span><br><span class="line">            s2_pp[<span class="number">16</span>] &lt;= pp_comb[<span class="number">16</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======================== Stage 3: Wallace Tree 第一层 ========================</span></span><br><span class="line">    <span class="comment">// 17个部分积 → 12个 (使用5个CSA)</span></span><br><span class="line">    <span class="keyword">logic</span>        s3_valid;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] s3_op;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] s3_rd;</span><br><span class="line">    <span class="keyword">logic</span>        s3_canceled;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] s3_pp       [<span class="number">11</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CSA 第一层输出信号</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w3_sum      [ <span class="number">4</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w3_carry    [ <span class="number">4</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    `CSA_3_2(s2_pp[<span class="number">0</span>], s2_pp[<span class="number">1</span>], s2_pp[<span class="number">2</span>], w3_sum[<span class="number">0</span>], w3_carry[<span class="number">0</span>])</span><br><span class="line">    `CSA_3_2(s2_pp[<span class="number">3</span>], s2_pp[<span class="number">4</span>], s2_pp[<span class="number">5</span>], w3_sum[<span class="number">1</span>], w3_carry[<span class="number">1</span>])</span><br><span class="line">    `CSA_3_2(s2_pp[<span class="number">6</span>], s2_pp[<span class="number">7</span>], s2_pp[<span class="number">8</span>], w3_sum[<span class="number">2</span>], w3_carry[<span class="number">2</span>])</span><br><span class="line">    `CSA_3_2(s2_pp[<span class="number">9</span>], s2_pp[<span class="number">10</span>], s2_pp[<span class="number">11</span>], w3_sum[<span class="number">3</span>], w3_carry[<span class="number">3</span>])</span><br><span class="line">    `CSA_3_2(s2_pp[<span class="number">12</span>], s2_pp[<span class="number">13</span>], s2_pp[<span class="number">14</span>], w3_sum[<span class="number">4</span>], w3_carry[<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n || flush_i) <span class="keyword">begin</span></span><br><span class="line">            s3_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s3_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            s3_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">            s3_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">0</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">1</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">2</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">3</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">4</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">5</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">6</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">7</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">8</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">9</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">10</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s3_pp[<span class="number">11</span>]   &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            s3_valid &lt;= s2_valid;</span><br><span class="line">            s3_op &lt;= s2_op;</span><br><span class="line">            s3_rd &lt;= s2_rd;</span><br><span class="line">            s3_canceled &lt;= s2_canceled ||</span><br><span class="line">                ((cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == s2_rd) &amp;&amp; s2_valid);</span><br><span class="line">            s3_pp[<span class="number">0</span>] &lt;= w3_sum[<span class="number">0</span>];</span><br><span class="line">            s3_pp[<span class="number">1</span>] &lt;= w3_carry[<span class="number">0</span>];</span><br><span class="line">            s3_pp[<span class="number">2</span>] &lt;= w3_sum[<span class="number">1</span>];</span><br><span class="line">            s3_pp[<span class="number">3</span>] &lt;= w3_carry[<span class="number">1</span>];</span><br><span class="line">            s3_pp[<span class="number">4</span>] &lt;= w3_sum[<span class="number">2</span>];</span><br><span class="line">            s3_pp[<span class="number">5</span>] &lt;= w3_carry[<span class="number">2</span>];</span><br><span class="line">            s3_pp[<span class="number">6</span>] &lt;= w3_sum[<span class="number">3</span>];</span><br><span class="line">            s3_pp[<span class="number">7</span>] &lt;= w3_carry[<span class="number">3</span>];</span><br><span class="line">            s3_pp[<span class="number">8</span>] &lt;= w3_sum[<span class="number">4</span>];</span><br><span class="line">            s3_pp[<span class="number">9</span>] &lt;= w3_carry[<span class="number">4</span>];</span><br><span class="line">            s3_pp[<span class="number">10</span>] &lt;= s2_pp[<span class="number">15</span>];</span><br><span class="line">            s3_pp[<span class="number">11</span>] &lt;= s2_pp[<span class="number">16</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======================== Stage 4: Wallace Tree 第二层 ========================</span></span><br><span class="line">    <span class="comment">// 12 → 8 → 6</span></span><br><span class="line">    <span class="keyword">logic</span>        s4_valid;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] s4_op;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] s4_rd;</span><br><span class="line">    <span class="keyword">logic</span>        s4_canceled;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] s4_pp       [<span class="number">5</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一轮:  12 → 8</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w4a_sum     [<span class="number">3</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w4a_carry   [<span class="number">3</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    `CSA_3_2(s3_pp[<span class="number">0</span>], s3_pp[<span class="number">1</span>], s3_pp[<span class="number">2</span>], w4a_sum[<span class="number">0</span>], w4a_carry[<span class="number">0</span>])</span><br><span class="line">    `CSA_3_2(s3_pp[<span class="number">3</span>], s3_pp[<span class="number">4</span>], s3_pp[<span class="number">5</span>], w4a_sum[<span class="number">1</span>], w4a_carry[<span class="number">1</span>])</span><br><span class="line">    `CSA_3_2(s3_pp[<span class="number">6</span>], s3_pp[<span class="number">7</span>], s3_pp[<span class="number">8</span>], w4a_sum[<span class="number">2</span>], w4a_carry[<span class="number">2</span>])</span><br><span class="line">    `CSA_3_2(s3_pp[<span class="number">9</span>], s3_pp[<span class="number">10</span>], s3_pp[<span class="number">11</span>], w4a_sum[<span class="number">3</span>], w4a_carry[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第二轮: 8 → 6</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w4b_sum  [<span class="number">1</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w4b_carry[<span class="number">1</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    `CSA_3_2(w4a_sum[<span class="number">0</span>], w4a_carry[<span class="number">0</span>], w4a_sum[<span class="number">1</span>], w4b_sum[<span class="number">0</span>], w4b_carry[<span class="number">0</span>])</span><br><span class="line">    `CSA_3_2(w4a_carry[<span class="number">1</span>], w4a_sum[<span class="number">2</span>], w4a_carry[<span class="number">2</span>], w4b_sum[<span class="number">1</span>], w4b_carry[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n || flush_i) <span class="keyword">begin</span></span><br><span class="line">            s4_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s4_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            s4_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">            s4_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s4_pp[<span class="number">0</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s4_pp[<span class="number">1</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s4_pp[<span class="number">2</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s4_pp[<span class="number">3</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s4_pp[<span class="number">4</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s4_pp[<span class="number">5</span>]    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            s4_valid &lt;= s3_valid;</span><br><span class="line">            s4_op &lt;= s3_op;</span><br><span class="line">            s4_rd &lt;= s3_rd;</span><br><span class="line">            s4_canceled &lt;= s3_canceled ||</span><br><span class="line">                ((cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == s3_rd) &amp;&amp; s3_valid);</span><br><span class="line">            s4_pp[<span class="number">0</span>] &lt;= w4b_sum[<span class="number">0</span>];</span><br><span class="line">            s4_pp[<span class="number">1</span>] &lt;= w4b_carry[<span class="number">0</span>];</span><br><span class="line">            s4_pp[<span class="number">2</span>] &lt;= w4b_sum[<span class="number">1</span>];</span><br><span class="line">            s4_pp[<span class="number">3</span>] &lt;= w4b_carry[<span class="number">1</span>];</span><br><span class="line">            s4_pp[<span class="number">4</span>] &lt;= w4a_sum[<span class="number">3</span>];</span><br><span class="line">            s4_pp[<span class="number">5</span>] &lt;= w4a_carry[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======================== Stage 5: Wallace Tree 第三层 ========================</span></span><br><span class="line">    <span class="comment">// 6 → 4 → 3 → 2</span></span><br><span class="line">    <span class="keyword">logic</span>        s5_valid;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] s5_op;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] s5_rd;</span><br><span class="line">    <span class="keyword">logic</span>        s5_canceled;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] s5_sum;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] s5_carry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6 → 4</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w5a_sum     [<span class="number">1</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w5a_carry   [<span class="number">1</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    `CSA_3_2(s4_pp[<span class="number">0</span>], s4_pp[<span class="number">1</span>], s4_pp[<span class="number">2</span>], w5a_sum[<span class="number">0</span>], w5a_carry[<span class="number">0</span>])</span><br><span class="line">    `CSA_3_2(s4_pp[<span class="number">3</span>], s4_pp[<span class="number">4</span>], s4_pp[<span class="number">5</span>], w5a_sum[<span class="number">1</span>], w5a_carry[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4 → 3</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w5b_sum;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w5b_carry;</span><br><span class="line"></span><br><span class="line">    `CSA_3_2(w5a_sum[<span class="number">0</span>], w5a_carry[<span class="number">0</span>], w5a_sum[<span class="number">1</span>], w5b_sum, w5b_carry)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3 → 2</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w5c_sum;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">67</span>:<span class="number">0</span>] w5c_carry;</span><br><span class="line"></span><br><span class="line">    `CSA_3_2(w5b_sum, w5b_carry, w5a_carry[<span class="number">1</span>], w5c_sum, w5c_carry)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n || flush_i) <span class="keyword">begin</span></span><br><span class="line">            s5_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s5_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            s5_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">            s5_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s5_sum      &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">            s5_carry    &lt;= <span class="number">68&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            s5_valid &lt;= s4_valid;</span><br><span class="line">            s5_op &lt;= s4_op;</span><br><span class="line">            s5_rd &lt;= s4_rd;</span><br><span class="line">            s5_canceled &lt;= s4_canceled ||</span><br><span class="line">                ((cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == s4_rd) &amp;&amp; s4_valid);</span><br><span class="line">            s5_sum &lt;= w5c_sum;</span><br><span class="line">            s5_carry &lt;= w5c_carry;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======================== Stage 6: 最终CPA加法 ========================</span></span><br><span class="line">    <span class="keyword">logic</span>        s6_valid;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] s6_op;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] s6_rd;</span><br><span class="line">    <span class="keyword">logic</span>        s6_canceled;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] s6_product;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最终64位加法</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] final_product;</span><br><span class="line">    <span class="keyword">assign</span> final_product = s5_sum[<span class="number">63</span>:<span class="number">0</span>] + s5_carry[<span class="number">63</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n || flush_i) <span class="keyword">begin</span></span><br><span class="line">            s6_valid    &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s6_op       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            s6_rd       &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">            s6_canceled &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            s6_product  &lt;= <span class="number">64&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            s6_valid &lt;= s5_valid;</span><br><span class="line">            s6_op &lt;= s5_op;</span><br><span class="line">            s6_rd &lt;= s5_rd;</span><br><span class="line">            s6_canceled &lt;= s5_canceled ||</span><br><span class="line">                ((cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == s5_rd) &amp;&amp; s5_valid);</span><br><span class="line">            s6_product &lt;= final_product;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======================== 输出逻辑 ========================</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (s6_op)</span><br><span class="line">            MUL_OP_MUL:                               mul_result_o = s6_product[<span class="number">31</span>:<span class="number">0</span>];</span><br><span class="line">            MUL_OP_MULH, MUL_OP_MULHSU, MUL_OP_MULHU: mul_result_o = s6_product[<span class="number">63</span>:<span class="number">32</span>];</span><br><span class="line">            <span class="keyword">default</span>:                                  mul_result_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> mul_valid_o = s6_valid &amp;&amp; !s6_canceled;</span><br><span class="line">    <span class="keyword">assign</span> mul_rd_o    = s6_rd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> s6_cancel_current_cycle;</span><br><span class="line">    <span class="keyword">assign</span> s6_cancel_current_cycle = (cancel_rd_i != <span class="number">5&#x27;b0</span>) &amp;&amp; (cancel_rd_i == s6_rd);</span><br><span class="line">    <span class="keyword">assign</span> mul_rf_we_o = s6_valid &amp;&amp; !s6_canceled &amp;&amp; !s6_cancel_current_cycle &amp;&amp; (s6_rd != <span class="number">5&#x27;b0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态信号</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        mul_stage_busy_o = &#123;s6_valid, s5_valid, s4_valid, s3_valid, s2_valid, s1_valid&#125;;</span><br><span class="line">        mul_busy_o       = |mul_stage_busy_o;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> mul_rd_s_o = &#123;s6_rd, s5_rd, s4_rd, s3_rd, s2_rd, s1_rd&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消宏定义</span></span><br><span class="line">    <span class="meta">`<span class="keyword">undef</span> CSA_3_2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后同步修改<code>CPU_TOP.sv</code>：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">localparam</span> <span class="keyword">int</span> <span class="keyword">unsigned</span> MUL_STAGE = <span class="number">6</span>;  <span class="comment">// 乘法器流水线级数</span></span><br><span class="line"><span class="keyword">logic</span> [MUL_STAGE-<span class="number">1</span>:<span class="number">0</span>]            mul_stage_busy;</span><br><span class="line"><span class="keyword">logic</span> [MUL_STAGE-<span class="number">1</span>:<span class="number">0</span>][<span class="number">4</span>:<span class="number">0</span>]       mul_rd_s;</span><br><span class="line"><span class="keyword">logic</span>           [<span class="number">4</span>:<span class="number">0</span>]            mul_cancel_rd;</span><br></pre></td></tr></table></figure><p>再改一下<code>HazardUnit</code>，改成参数化：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> HazardUnit #(</span><br><span class="line">    <span class="keyword">parameter</span> <span class="keyword">integer</span> MUL_STAGE = <span class="number">4</span>  <span class="comment">// 乘法器流水线级数</span></span><br><span class="line">) (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ MUL_STAGE-<span class="number">1</span>:<span class="number">0</span>]      mul_stage_busy,      <span class="comment">// 乘法器各级流水线忙状态</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ MUL_STAGE-<span class="number">1</span>:<span class="number">0</span>][<span class="number">4</span>:<span class="number">0</span>] mul_rd_s,            <span class="comment">// 乘法器各级流水线目标寄存器地址</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">)</span><br><span class="line">    <span class="keyword">logic</span> [MUL_STAGE:<span class="number">0</span>][<span class="number">4</span>:<span class="number">0</span>] mul_rd_all;</span><br><span class="line">    <span class="keyword">logic</span> [MUL_STAGE:<span class="number">0</span>]      mul_vld_all;</span><br><span class="line">    <span class="keyword">assign</span> mul_rd_all  = &#123;mul_rd_s, wR_EX&#125;;</span><br><span class="line">    <span class="keyword">assign</span> mul_vld_all = &#123;mul_stage_busy, is_mul_instr_EX&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Debug/可视化向量（可在波形里直接看每一级是否命中）</span></span><br><span class="line">    <span class="keyword">logic</span> [MUL_STAGE:<span class="number">0</span>] mul_raw_hit_r1;</span><br><span class="line">    <span class="keyword">logic</span> [MUL_STAGE:<span class="number">0</span>] mul_raw_hit_r2;</span><br><span class="line">    <span class="keyword">logic</span> [MUL_STAGE:<span class="number">0</span>] id_reads_mul_rd;</span><br><span class="line">    <span class="keyword">logic</span> [MUL_STAGE:<span class="number">0</span>] mul_waw_conflict;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MUL_STAGE + <span class="number">1</span>; i++) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;乘法器&quot;&gt;乘法器&lt;/h2&gt;
&lt;p&gt;非常简单。&lt;/p&gt;
&lt;figure class=&quot;highlight verilog&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第十一篇</title>
    <link href="https://blog.esing.dev/2026/01/06/riscvcod-p11/"/>
    <id>https://blog.esing.dev/2026/01/06/riscvcod-p11/</id>
    <published>2026-01-06T00:14:30.000Z</published>
    <updated>2026-01-09T13:48:37.548Z</updated>
    
    <content type="html"><![CDATA[<h2 id="存取控制模块：再进化">存取控制模块：再进化</h2><p>在 <a href="/2025/12/12/riscvcod-p10/" title="从零开始学RISC：第十篇">从零开始学RISC：第十篇</a> 中，设计了<code>LoadStoreUnit</code>来处理各类存取指令，但将同一个模块复用了两遍。这样会带来额外的逻辑开销。</p><p>最好的办法是将其拆分为两个模块：一个放在MEM级，负责存储；另一个放在WB级，负责读取。</p><h3 id="存储控制模块-StoreUnit-sv">存储控制模块 <a href="http://StoreUnit.sv">StoreUnit.sv</a></h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StoreUnit模块 - 专门用于MEM级的Store操作</span></span><br><span class="line"><span class="comment">// 负责处理SB/SH/SW的字节对齐和写使能生成</span></span><br><span class="line"><span class="keyword">module</span> StoreUnit (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type,       <span class="comment">// 存取类型</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] addr,          <span class="comment">// 地址（用于计算字节偏移）</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] store_data_i,  <span class="comment">// 要存储的数据（来自rs2）</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] store_data_o,  <span class="comment">// 对齐后的数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        dram_we,       <span class="comment">// 写使能输入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] wstrb          <span class="comment">// 按位写使能</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 默认值</span></span><br><span class="line">        wstrb        = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">        store_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dram_we) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">unique</span> <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                <span class="number">2&#x27;b01</span>: <span class="keyword">begin</span>  <span class="comment">// SB</span></span><br><span class="line">                    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] shift;</span><br><span class="line">                    shift = &#123;addr[<span class="number">1</span>:<span class="number">0</span>], <span class="number">3&#x27;b000</span>&#125;;  <span class="comment">// addr[1:0] * 8</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 写使能</span></span><br><span class="line">                    <span class="keyword">unique</span> <span class="keyword">case</span> (addr[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                        <span class="number">2&#x27;b00</span>:   wstrb = <span class="number">4&#x27;b0001</span>;</span><br><span class="line">                        <span class="number">2&#x27;b01</span>:   wstrb = <span class="number">4&#x27;b0010</span>;</span><br><span class="line">                        <span class="number">2&#x27;b10</span>:   wstrb = <span class="number">4&#x27;b0100</span>;</span><br><span class="line">                        <span class="number">2&#x27;b11</span>:   wstrb = <span class="number">4&#x27;b1000</span>;</span><br><span class="line">                        <span class="keyword">default</span>: wstrb = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 把 byte 放到对应 byte lane</span></span><br><span class="line">                    store_data_o = (&#123;<span class="number">24&#x27;b0</span>, store_data_i[<span class="number">7</span>:<span class="number">0</span>]&#125; &lt;&lt; shift);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="number">2&#x27;b10</span>: <span class="keyword">begin</span>  <span class="comment">// SH</span></span><br><span class="line">                    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] shift;</span><br><span class="line">                    shift = &#123;addr[<span class="number">1</span>], <span class="number">4&#x27;b0000</span>&#125;;  <span class="comment">// addr[1] ? 16 : 0</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 写使能</span></span><br><span class="line">                    <span class="keyword">unique</span> <span class="keyword">case</span> (addr[<span class="number">1</span>])</span><br><span class="line">                        <span class="number">1&#x27;b0</span>:    wstrb = <span class="number">4&#x27;b0011</span>;</span><br><span class="line">                        <span class="number">1&#x27;b1</span>:    wstrb = <span class="number">4&#x27;b1100</span>;</span><br><span class="line">                        <span class="keyword">default</span>: wstrb = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 把 halfword 放到对应位置</span></span><br><span class="line">                    store_data_o = (&#123;<span class="number">16&#x27;b0</span>, store_data_i[<span class="number">15</span>:<span class="number">0</span>]&#125; &lt;&lt; shift);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="number">2&#x27;b11</span>: <span class="keyword">begin</span>  <span class="comment">// SW</span></span><br><span class="line">                    wstrb        = <span class="number">4&#x27;b1111</span>;</span><br><span class="line">                    store_data_o = store_data_i;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                    wstrb        = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    store_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">`<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] sl_type_ascii;</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (sl_type)</span><br><span class="line">            `MEM_SB: sl_type_ascii = <span class="string">&quot;SB  &quot;</span>;</span><br><span class="line">            `MEM_SH: sl_type_ascii = <span class="string">&quot;SH  &quot;</span>;</span><br><span class="line">            `MEM_SW: sl_type_ascii = <span class="string">&quot;SW  &quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>: sl_type_ascii = <span class="string">&quot;----&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure><h3 id="读取控制模块-LoadUnit-sv">读取控制模块 <a href="http://LoadUnit.sv">LoadUnit.sv</a></h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LoadUnit模块 - 专门用于WB级的Load操作</span></span><br><span class="line"><span class="comment">// 负责处理LB/LH/LW/LBU/LHU的字节提取和符号扩展</span></span><br><span class="line"><span class="keyword">module</span> LoadUnit (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type,      <span class="comment">// 存取类型</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] addr,         <span class="comment">// 地址（用于计算字节偏移）</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_i,  <span class="comment">// 从DRAM读取的原始数据</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_o   <span class="comment">// 处理后的数据</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> is_load_unsigned;</span><br><span class="line">    <span class="keyword">assign</span> is_load_unsigned = (sl_type[<span class="number">2</span>] == <span class="number">1&#x27;b1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] raw;</span><br><span class="line">        raw         = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        load_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据 sl_type 和 addr 偏移提取数据</span></span><br><span class="line">        <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">            <span class="number">2&#x27;b01</span>: <span class="keyword">begin</span>  <span class="comment">// byte</span></span><br><span class="line">                raw = (load_data_i &gt;&gt; (addr[<span class="number">1</span>:<span class="number">0</span>] * <span class="number">8</span>)) &amp; <span class="number">32&#x27;h000000FF</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">2&#x27;b10</span>: <span class="keyword">begin</span>  <span class="comment">// half</span></span><br><span class="line">                raw = (load_data_i &gt;&gt; (addr[<span class="number">1</span>] * <span class="number">16</span>)) &amp; <span class="number">32&#x27;h0000FFFF</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">2&#x27;b11</span>: <span class="keyword">begin</span>  <span class="comment">// word</span></span><br><span class="line">                raw = load_data_i;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">default</span>: raw = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 符号扩展或零扩展</span></span><br><span class="line">        <span class="keyword">if</span> (is_load_unsigned) <span class="keyword">begin</span></span><br><span class="line">            load_data_o = raw;  <span class="comment">// 零扩展</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                <span class="number">2&#x27;b01</span>:   load_data_o = &#123;&#123;<span class="number">24</span>&#123;raw[<span class="number">7</span>]&#125;&#125;, raw[<span class="number">7</span>:<span class="number">0</span>]&#125;;  <span class="comment">// LB</span></span><br><span class="line">                <span class="number">2&#x27;b10</span>:   load_data_o = &#123;&#123;<span class="number">16</span>&#123;raw[<span class="number">15</span>]&#125;&#125;, raw[<span class="number">15</span>:<span class="number">0</span>]&#125;;  <span class="comment">// LH</span></span><br><span class="line">                <span class="number">2&#x27;b11</span>:   load_data_o = raw;  <span class="comment">// LW</span></span><br><span class="line">                <span class="keyword">default</span>: load_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">`<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] sl_type_ascii;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] select_bits;</span><br><span class="line">    <span class="keyword">assign</span> select_bits = addr[<span class="number">1</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (sl_type)</span><br><span class="line">            `MEM_LB:  sl_type_ascii = <span class="string">&quot;LB  &quot;</span>;</span><br><span class="line">            `MEM_LH:  sl_type_ascii = <span class="string">&quot;LH  &quot;</span>;</span><br><span class="line">            `MEM_LW:  sl_type_ascii = <span class="string">&quot;LW  &quot;</span>;</span><br><span class="line">            `MEM_LBU: sl_type_ascii = <span class="string">&quot;LBU &quot;</span>;</span><br><span class="line">            `MEM_LHU: sl_type_ascii = <span class="string">&quot;LHU &quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:  sl_type_ascii = <span class="string">&quot;----&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure><p>拆分后的逻辑就清楚多了。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;存取控制模块：再进化&quot;&gt;存取控制模块：再进化&lt;/h2&gt;
&lt;p&gt;在 &lt;a href=&quot;/2025/12/12/riscvcod-p10/&quot; title=&quot;从零开始学RISC：第十篇&quot;&gt;从</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>2025年度回顾</title>
    <link href="https://blog.esing.dev/2025/12/31/review-2025/"/>
    <id>https://blog.esing.dev/2025/12/31/review-2025/</id>
    <published>2025-12-31T12:00:00.000Z</published>
    <updated>2025-12-31T16:01:24.120Z</updated>
    
    <content type="html"><![CDATA[<p>2025年的最后一天，回顾一下这一年吧。</p>    <div id="aplayer-NLNvbVRa" class="aplayer aplayer-tag-marker meting-tag-marker"         data-id="30051452" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ff80ac" data-volume="0.3" data-loop="none"    ></div><div class="timeline undefined"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>目录</p></div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>1月</p></div></div><div class='timeline-item-content'><p>终于考完研了！好好放松一下！岩神启动~</p><p>毕设先研究一下吧。当然，玩好才是最重要的！(^_−)☆</p><p>和好朋友们<strong>过生日</strong>、打麻将、鹅鸭杀</p><p>光速推完《<strong>星之少女与六华的姐妹</strong>》。艺术风格不错，奈何剧情实在不太行。</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2月</p></div></div><div class='timeline-item-content'><p>出发去哈尔滨！南方大土豆的雪国之旅。志愿者很不容易啊。</p><p>推完《<strong>星之终途</strong>》，Key的小短篇很精致。</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>3月</p></div></div><div class='timeline-item-content'><p><strong>初试顺利通过了</strong>！全力冲刺复试。半导体物理好难啊 &gt;_&lt;</p><p>推完《<strong>近月少女的礼仪</strong>》，露娜Sama带我走吧</p><p>《<strong>闰跃之年</strong>》也很有意思，设计独特的跳跳乐。</p><p>来吧，高潮一战就在眼前！</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>4月</p></div></div><div class='timeline-item-content'><p>考完试了可就要让我休息休息了。</p><p>推完《<strong>少女理论及其周边</strong>》，梅丽尔可爱捏~</p><p>推完《<strong>月影魅像—解放之羽</strong>》，抛开立绘不谈，妹药的作品还是一如既往的对味。</p><p>推完《<strong>9-nine-</strong>》系列，超赞的剧本与系统设计。META元素很有特色，后劲 很 大。妹妹是天！</p><p>还和好基友一起打通了《<strong>双影奇境</strong>》。我玩过的最棒的双人合作游戏。</p><p>结果给室友的拯救者清灰时把电脑搞坏了，开不了机 TuT 还好我买了新电脑，可以给他用新的。</p><p>毕设自然也没落下，把Klipper移植完了。现在至少打印机能动了。</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>5月</p></div></div><div class='timeline-item-content'><p>五一去哪玩？</p><p>哪都不去。西安人太多了。</p><p>推完《<strong>青鸟</strong>》，玩的第一部紫社的作品，后劲很大，彻底折服。</p><p>推完《<strong>爱因斯坦携爱敬上</strong>》，新岛夕的剧本也有股异味儿我看。</p><p>第二天出发去<strong>荷兰洛阳</strong>，去看看“三大石窟”的<strong>龙门石窟</strong>。洛阳博物馆的藏品也非常棒，感觉不在陕历博之下。</p><p>回来全力做毕设！之前还奇怪为啥打印出问题，原来是进料管内径太细了。一起更换后正常了，甚至还能多色打（手动换色）</p><p>然后去吃西安<strong>和牛自助</strong>，爽啊，就好这一口大肥油</p><p>买了新的电子文玩——充电宝，越来越像中年男人了 笑</p><p>结果把手环屏幕摔碎了，含泪趁着国补买一个新的</p><p>又去中行陕西省分行办了<strong>莫奈万事达卡</strong>，卡面太好看了</p><p>好朋友要出国了，从他那里<strong>收下5折的拓竹A1</strong>，从此开始折腾3D打印！</p><p>毕设也完工90%了。自己制作出来、能正常工作的毕设，那就是比被课题组带着做的强一百倍啊。</p><p>再玩玩《SHENZHEN I/O》，同学说我疯了，在Steam上还要内卷。</p><p>推完《<strong>绽放★青春全力向前冲</strong>》，青春真好啊 县中出来的根本无法想象</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>6月</p></div></div><div class='timeline-item-content'><p>终于要给这四年时光画上休止符了吗，哈基毕，你这家伙……</p><p>给毕设指导老师做了100%自行设计的<strong>电路板灯</strong>，老师超开心！</p><p>然后就是给身边人打印各种各样的小玩意。尽管每天都要忙到1点才能回去睡觉，还是很开心。</p><p>在学校二手市场收到了<strong>破琵琶的10th演唱会无料</strong>！四角尖尖超赞。</p><p>又来吃和牛了？这次是两个宿舍一起。</p><p>接着闪击<strong>甘肃兰州</strong>，两天玩完甘肃省博物馆+麦积山石窟+品味兰州拉面</p><p>拍毕业照时，才会觉得自己真的毕业了。</p><p>因为7月在西安还有比赛，先在同学家里住了几天。感谢好兄弟</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>7月</p></div></div><div class='timeline-item-content'><p>顺利录取！以后也要在西安度过三年了。</p><p>想了想，还是润回家了。之后的路费就自己掏吧。两个学弟太猛了，自己啥都没咋做，很惭愧。</p><p>去看了<strong>苏超</strong>，人太多了。确实火爆。即使是像我一样对体育不感兴趣的人，坐在人声鼎沸的场馆中，也会不由自主地心潮澎湃起来吧。</p><p>四个月前定的<strong>苍彼原画集</strong>终于到了嘿嘿 明日香可爱捏</p><p><strong>成功挺进全国总决赛</strong>！上海，来了。</p><p>在家里搞了点<strong>云面大壳</strong>，这玩意劲确实大。太香了。</p><p>好基友送了《<strong>Dome Keeper</strong>》，也是肉鸽挖挖，好玩的。</p><p>推完《<strong>爱因斯坦携爱敬上 APOLLOCRISIS</strong>》。两部放在一起看的话，剧本还是不错的。不过新岛夕笔下的男主还是有股异味。这是干什么？就不能给我们看一点正常的男主吗？</p><p>在出发的前一天推完《<strong>永不枯萎的世界与终结之花</strong>》。画风很不错，莲也很可爱</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>8月</p></div></div><div class='timeline-item-content'><p>出发去上海学习！</p><p>第一天就逛了各大<strong>二次元商场</strong>。不愧是上海，好多旮旯谷。接着又是<strong>米哈游园区</strong>、游戏博物馆……好了，该工作了。</p><p>学习了<strong>存算一体芯片</strong>的工作原理、误差来源与调优方式。好难</p><p>集创赛拿下<strong>全国三等奖</strong>。这次只发470，有点垃圾。</p><p>和同学在洛圣都对资本主义重拳出击，又推完了褒贬不一的《<strong>创作少女的恋爱公式</strong>》。身为创作者，应该是能共情的。</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>9月</p></div></div><div class='timeline-item-content'><p>入学啦！</p><p><strong>单人宿舍</strong>确实爽——除了学校地方偏一点没啥缺点。</p><p>配好平板支架，往床上一趟，您猜怎么着，这不就爽起来了吗？</p><p>买了<strong>新显示器</strong>，长时间在宿舍办公就得配显示器啊。</p><p>推完《<strong>女仆咖啡巧克拉</strong>》和《<strong>女仆咖啡帕露菲</strong>》，纯爱战神版的丸户史明还是有操作的，不过总有胃疼的线。</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>10月</p></div></div><div class='timeline-item-content'><p>十一去哪玩？</p><p>哪都不去。西安人太多了。</p><p>所以我选择去<strong>夜之城</strong>。补票了《<strong>赛博朋克2077</strong>》，体验了没玩过的两个开局+各类流派+往日之影DLC，往日之影还是太权威了，凭借一己之力拉高评分。</p><p>去看了看二战的室友，一起吃了顿<strong>郭楠</strong>。愿他成功上岸。</p><p>导师也布置任务了，不过DDL很久。希望能做完。</p><p>推完《<strong>青空下的约定</strong>》，老戏画三部曲的含金量很足，不论是音乐、剧本还是人物塑造都非常棒。我说老版画风比重置版看着顺眼有没有懂的</p><p>推完十二神器之一的《<strong>沙耶之歌</strong>》，很震撼的小短篇。</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>11月</p></div></div><div class='timeline-item-content'><p>O7 开始宣扬<strong>管理式民主</strong>！绝地潜兵2啥都不好，可惜就是好玩。</p><p>&gt;&gt;&gt;阅读本文章3秒视为自愿加入绝地潜兵&lt;&lt;&lt;</p><p><strong>鸭科夫</strong>来了！最好玩的搜打撤游戏！三角洲别联系我了，我怕鸭鸭误会</p><p>推完《<strong>天津罪</strong>》，御影的剧本真神了吧</p><p>还写了一篇人文社科类的论文，文科太难了。</p><p>做了一张没什么用的Galgame照片墙。</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>12月</p></div></div><div class='timeline-item-content'><p>继续在洛圣都打击资本主义、购买大豪斯</p><p>在课上做<strong>演讲汇报</strong>，老师非常满意。大成功！</p><p>推完《<strong>星辰恋曲的白色永恒</strong>》与后日谈。F社的作品质量一向都很高。其实，我早就是一个F批了。</p><p>Typst和Visio不好用，所以写了一个画图的前端网页<strong>CoreCat</strong>并开源了。</p><p>开始推《<strong>仰望夜空的星辰</strong>》，对夜空变得感兴趣了。</p><p>最后，写下本文，做一个总结。</p><p>又维护了整整一年的<strong>博客</strong>呢。今晚，我要卡点拿下萌备的20260721号备案！</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>1月</p></div></div><div class='timeline-item-content'><p>？？？</p></div></div></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;2025年的最后一天，回顾一下这一年吧。&lt;/p&gt;

    &lt;div id=&quot;aplayer-NLNvbVRa&quot; class=&quot;aplayer aplayer-tag-marker meting</summary>
      
    
    
    
    <category term="随笔" scheme="https://blog.esing.dev/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="Galgame" scheme="https://blog.esing.dev/tags/Galgame/"/>
    
    <category term="杂谈" scheme="https://blog.esing.dev/tags/%E6%9D%82%E8%B0%88/"/>
    
    <category term="回顾" scheme="https://blog.esing.dev/tags/%E5%9B%9E%E9%A1%BE/"/>
    
  </entry>
  
  <entry>
    <title>CoreCat：画模块电路的好帮手</title>
    <link href="https://blog.esing.dev/2025/12/28/corecat-drawer/"/>
    <id>https://blog.esing.dev/2025/12/28/corecat-drawer/</id>
    <published>2025-12-27T17:30:51.000Z</published>
    <updated>2025-12-31T06:26:32.097Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>做数字方向的朋友都知道，画电路模块图有多难。</p><p><a href="http://Draw.io">Draw.io</a> 画图容易，但是调整标签太麻烦；Visio功能强大但过于臃肿，而Typst的Circuiteria包……写了1700行的代码才画了五个模块。<strong>精神病人才会用这个。</strong></p><p>于是，我<s>和我的AI朋友</s>们写了一个<strong>纯前端网页</strong>，用于绘制模块级电路图。</p><br><img src="https://webp.esing.dev/img/CoreCat_logo_251231_1051_FHWA.png" style="zoom:25%;" /><br><p align="center">  <object type="image/svg+xml"    data="https://img.shields.io/badge/Fully-AI--Generated-black?logo=github-copilot&amp;style=flat&amp;link=https%3A%2F%2Fgithub.com%2FZxis233%2FCoreCat%2Fgraphs%2Fcontributors&amp;link=https%3A%2F%2Fgithub.com%2FZxis233%2FCoreCat%2Fgraphs%2Fcontributors">    AI  </object>  <a target="_blank" rel="noopener" href="https://github.com/Zxis233/CoreCat/releases">    <object type="image/svg+xml"      data="https://img.shields.io/github/release/Zxis233/CoreCat/all.svg?style=flat&color=blue">      release    </object>  </a>  <object type="image/svg+xml"    data="https://img.shields.io/github/last-commit/Zxis233/CoreCat?style=flat&amp;link=https%3A%2F%2Fgithub.com%2FZxis233%2FCoreCat%2Fcommits&amp;link=https%3A%2F%2Fgithub.com%2FZxis233%2FCoreCat%2Fcommits">    commit  </object>  <object type="image/svg+xml"    data="https://img.shields.io/github/license/Zxis233/CoreCat?style=flat&amp;link=https%3A%2F%2Fgithub.com%2FZxis233%2FCoreCat%3Ftab%3DGPL-3.0-1-ov-file%23readme&amp;link=https%3A%2F%2Fgithub.com%2FZxis233%2FCoreCat%3Ftab%3DGPL-3.0-1-ov-file%23readme">    license  </object>  <object type="image/svg+xml"    data="https://img.shields.io/badge/Online-Demo-F38020?logo=cloudflare&amp;style=flat&amp;link=https%3A%2F%2Fcorecat.esing.dev&amp;link=https%3A%2F%2Fcorecat.esing.dev">    Online Demo  </object></p><table    style='display: table; border-collapse: collapse; margin: auto; background-color: transparent; border-color: transparent; width: auto'>    <tbody>        <tr>            <td style='                    vertical-align: top;                    color: #f7cf74;                    font-size: 36px;                    font-family: "Times New Roman", serif;                    font-weight: bold;                    text-align: left;                    padding: 10px 10px;                    line-height: 100%;                    border: transparent;                ' class='fr-bold-eedb028e'>                “            </td>            <td style='text-align: left; padding: 1em; vertical-align: middle; border: transparent'>                <b class='fr-bold-eedb028e' style='color: #f7cf74;text-shadow: 1px 1px 2px #00000000;'><span lang='ja'                        class='fr-bold-eedb028e'><big class='fr-bold-eedb028e'>Drag modules, edit ports, connect wires, and fxxk Visio.</big></big></b>            </td>            <td style='                    vertical-align: bottom;                    color: #f7cf74;                    font-size: 36px;                    font-family: "Times New Roman", serif;                    font-weight: bold;                    text-align: left;                    padding: 10px 10px;                    line-height: 100%;                    border: transparent;                ' class='fr-bold-eedb028e'>                ”            </td>        </tr>        <tr>        </tr>    </tbody></table><h2 id="功能与预览">功能与预览</h2><p><img src="https://webp.esing.dev/img/image-20251230203800700_251230_2038_fzwd.png" alt="v0.4版本"></p><ul><li><input type="checkbox" id="checkbox0" checked="true"><label for="checkbox0"> 复制粘贴</label></li><li><input type="checkbox" id="checkbox1" checked="true"><label for="checkbox1"> JSON导入导出（便于AI自动化绘制）</label></li><li><input type="checkbox" id="checkbox2" checked="true"><label for="checkbox2"> PNG/SVG导出（可选背景）</label></li><li><input type="checkbox" id="checkbox3" checked="true"><label for="checkbox3"> 丰富的模块自定义</label></li><li><input type="checkbox" id="checkbox4" checked="true"><label for="checkbox4"> 连线标签与位置修改</label></li><li><input type="checkbox" id="checkbox5" checked="true"><label for="checkbox5"> 智能连线（功能有待改进）</label></li><li><input type="checkbox" id="checkbox6" checked="true"><label for="checkbox6"> 常用快捷键</label></li></ul><h3 id="复杂的模块图">复杂的模块图</h3><p><img src="https://opic.esing.dev/img/corecat-diagram_251231_0054_W1AY.png" alt="EsCute_RV 架构图"></p><p>欢迎PR：<a href="https://github.com/Zxis233/CoreCat">Zxis233 - CoreCat: 轻松绘制模块图</a></p><h2 id="后记">后记</h2><p>不会画LOGO，用等宽字体Maple Mono拼出来的猫猫。</p><p>画完才反应过来非阻塞赋值是<code style="font-feature-settings: 'calt' 1, 'cv01' 1, 'cv63' 1 !important;">&lt;=</code>而不是<code>=&gt;</code>，不过懒得改了。意思传达到了就行。</p><p>“你的眼眸，如同夜空中的辇道增七一样美丽呢。”　——《仰望夜空的星辰》</p><div class="timeline undefined"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>目录</p></div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025.12.27</p></div></div><div class='timeline-item-content'><p>v0.1 基础功能</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025.12.28</p></div></div><div class='timeline-item-content'><p>v0.2 更多的模块、精确移动</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025.12.29</p></div></div><div class='timeline-item-content'><p>v0.3 复制粘贴快捷键、智能连线</p></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>2025.12.30</p></div></div><div class='timeline-item-content'><p>v0.4 撤销与历史记录、端口标签</p></div></div></div>]]></content>
    
    
    <summary type="html">Drag modules, edit ports, connect wires, and fxxk Visio.</summary>
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="数字逻辑电路" scheme="https://blog.esing.dev/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91%E7%94%B5%E8%B7%AF/"/>
    
  </entry>
  
  <entry>
    <title>TCP、UDP与拥塞控制算法</title>
    <link href="https://blog.esing.dev/2025/12/22/tcp-congestion-control/"/>
    <id>https://blog.esing.dev/2025/12/22/tcp-congestion-control/</id>
    <published>2025-12-22T12:09:20.000Z</published>
    <updated>2025-12-23T03:50:36.835Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>在 <a href="/2025/12/18/windows-enable-bbr2/" title="Windows11开启BBR2拥塞控制算法">Windows11开启BBR2拥塞控制算法</a> 中，将Windows的TCP拥塞控制算法从CUBIC换成了BBR2。TCP 拥塞控制到底在控制什么？这些算法有什么不同？</p><p>事实上，TCP一直在问自己：我应该同时在网络里“放多少数据”才不会把路堵死？一个名叫“拥塞窗口”（Congestion Window）的参数被设定，用于限制发送端能发送的最大数据量。大的cwnd会使得吞吐更高，但也更容易造成排队和丢包；更小的cwnd则会使得延迟更低，但是链路可能跑不满。</p><p>拥塞控制算法的本质，其实就是<strong>如何动态调整cwnd</strong>。如果看起来网络很空，那就增大一些cwnd，使得吞吐量提高；网络如果太“拥堵”，那就减小一点cwnd，使得延迟降低一点。</p><h2 id="CUBIC：很平庸，也很稳">CUBIC：很平庸，也很稳</h2><p>CUBIC像是“先加速、再减速、再加速”，目标是<strong>让 cwnd 在大窗口区间增长更快</strong>。</p><p>CUBIC 用一个三次函数来控制 cwnd 变化：</p><ul><li>丢包后，cwnd 会降到某个值</li><li>然后增长会逐渐加速</li><li>接近上一次发生丢包时的窗口（Wmax）附近，增长会变慢（更谨慎）</li><li>超过 Wmax 后，再加速探测更高带宽</li></ul><p>那么代价是什么呢？CUBIC是Loss-Based，换句话说，就是将“丢包”作为最主要的拥塞信号来处理。在没有丢包发生时，会默认认为网络还能承受更多流量；一旦出现丢包，就会重新探测增长。如果网络有深缓冲，即暂存数据包的队列容量特别大时，可能把队列顶得很高，导致RTT 上升，交互体验变差。</p><h2 id="NewReno：边缘控制与试探">NewReno：边缘控制与试探</h2><p>Reno家族的策略都是“试探与克制”：</p><ul><li>加性增（Additive Increase）：没看到拥塞就慢慢涨</li><li>乘性减（Multiplicative Decrease）：一旦丢包就狠狠降</li></ul><p>这是一种非常经典、稳定的控制方式（AIMD），能在共享链路上自动形成“公平分配”。而NewReno最大的特点便在其 New 上。当一个窗口里丢了不止一个包，Reno 可能恢复效率很差，而 NewReno 利用 partial ACK（部分确认） ，可以更好地推断“后面还有包丢了”，减少超时与反复降窗。因此，丢包发生后，恢复阶段更聪明一点，但整体仍是典型的 Loss-Based 控制。因此，NewReno的优点是实现成熟、行为可预测、兼容性强，但高带宽与高时延环境下，带宽利用率容易上不去。</p><h2 id="BBRv2：猜拳不如理性分析">BBRv2：猜拳不如理性分析</h2><p>CUBIC/Reno 家族有个共同点：<strong>把丢包当成拥塞信号</strong>，但丢包不总是拥塞导致的——无线干扰、链路误码也会丢。</p><p>BBR家族换了一种策略：根据丢包来估计丢包不可靠，直接估计“瓶颈带宽”和“传播时延”，用模型算出合适的发送速率更为可靠。它使用BtlBw（瓶颈带宽）和RTprop（最小传播 RTT）进行估算。对于BBRv1，在部分场景会与 Loss-Based 流共存时出现公平性问题。BBRv2针对这一点进行了改进，在“模型驱动”的基础上，更认真地把loss/ECN作为拥塞信号纳入控制，变得更温和了（上限也没BBRv1高）。可见，BBRv2是典型的 Model-Based 控制。</p><h2 id="没有拥塞控制的UDP？">没有拥塞控制的UDP？</h2><p>UDP 不是“没有拥塞控制”，而是“协议层不自带拥塞控制”。为什么呢？</p><p>UDP 的设计目标就是“简单、无连接、无状态” 。它只做很少的事，如端口复用、简单校验、狂发包等。拥塞控制本质是控制系统：要测量、要记忆、要调参，<strong>而UDP不建立连接、不维护发送窗口、不追踪 ACK/RTT，也就没有 TCP 那套“反馈回路”来推断拥塞、动态调速。</strong></p><p>此外，UDP的应用场景太多了：视频、实时语音、游戏……都用一种拥塞控制会很麻烦。</p><p>总的来说，UDP 不带拥塞控制，是为了保持协议极简和通用；真正需要的拥塞控制，被放到了 UDP 之上的协议或应用层来实现。比如HTTP3时代的QUIC，虽然底层是 UDP，但 QUIC 自己实现了连接管理、可靠性与拥塞控制。</p><div class="note primary flat"><p>如Hysteria2协议，官方将BBR协议魔改后移植到QUIC上，会根据 RTT 变化估算瓶颈带宽，并动态调整速率。此外，还有自研的Brutal算法，核心是固定速率模型：丢包、RTT 变大 不会像传统算法那样自动降速，甚至在达不到目标速率的时候会根据计算的丢包率“补偿”发更多包。</p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;在 &lt;a href=&quot;/2025/12/18/windows-enable-bbr2/&quot; title=&quot;Windows11开启BBR2拥塞控制算法&quot;&gt;Wi</summary>
      
    
    
    
    <category term="随笔" scheme="https://blog.esing.dev/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="TCP" scheme="https://blog.esing.dev/tags/TCP/"/>
    
    <category term="UDP" scheme="https://blog.esing.dev/tags/UDP/"/>
    
    <category term="BBR" scheme="https://blog.esing.dev/tags/BBR/"/>
    
  </entry>
  
  <entry>
    <title>自用音乐音量均衡脚本</title>
    <link href="https://blog.esing.dev/2025/12/20/script-for-musicvolumebalancing/"/>
    <id>https://blog.esing.dev/2025/12/20/script-for-musicvolumebalancing/</id>
    <published>2025-12-20T03:30:27.000Z</published>
    <updated>2025-12-21T08:10:21.695Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>不同歌曲的音量大小不同，如果直接导入游戏做自定义电台的话很容易出现音乐时大时小的问题。因此，需要先将音量均衡。</p><h2 id="傻瓜脚本">傻瓜脚本</h2><p>需要安装好<code>ffmpeg</code>且添加到<code>PATH</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">TARGET_I = -<span class="number">14</span></span><br><span class="line">TARGET_TP = -<span class="number">1.5</span></span><br><span class="line">TARGET_LRA = <span class="number">12</span></span><br><span class="line"></span><br><span class="line">FFMPEG = <span class="string">&quot;ffmpeg&quot;</span>  <span class="comment"># 或写 &quot;ffmpeg.exe&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">cmd</span>):</span><br><span class="line">    <span class="comment"># ✅ 强制按 UTF-8 解码，避免 GBK 解码炸裂</span></span><br><span class="line">    p = subprocess.run(</span><br><span class="line">        cmd,</span><br><span class="line">        stdout=subprocess.PIPE,</span><br><span class="line">        stderr=subprocess.PIPE,</span><br><span class="line">        text=<span class="literal">True</span>,</span><br><span class="line">        encoding=<span class="string">&quot;utf-8&quot;</span>,</span><br><span class="line">        errors=<span class="string">&quot;replace&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> p.returncode, p.stdout, p.stderr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_loudnorm_json</span>(<span class="params">stderr_text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> stderr_text:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;ffmpeg 没有返回 stderr 文本（可能被解码错误吞掉了）。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ✅ 更稳：只匹配包含 &quot;input_i&quot; 的那段 JSON（避免误匹配别的花括号）</span></span><br><span class="line">    m = re.search(<span class="string">r&#x27;(\&#123;\s*&quot;input_i&quot;[\s\S]*?\&#125;)&#x27;</span>, stderr_text)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> m:</span><br><span class="line">        <span class="comment"># 方便你调试：把 stderr 的尾部打印出来看看</span></span><br><span class="line">        tail = stderr_text[-<span class="number">2000</span>:]</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;没找到 loudnorm JSON 输出。stderr 尾部如下：\n<span class="subst">&#123;tail&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> json.loads(m.group(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">normalize_file</span>(<span class="params">inp: Path, outp: Path</span>):</span><br><span class="line">    outp.parent.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Pass 1: measure</span></span><br><span class="line">    cmd1 = [</span><br><span class="line">        FFMPEG, <span class="string">&quot;-hide_banner&quot;</span>, <span class="string">&quot;-nostats&quot;</span>, <span class="string">&quot;-y&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-i&quot;</span>, <span class="built_in">str</span>(inp),</span><br><span class="line">        <span class="string">&quot;-af&quot;</span>, <span class="string">f&quot;loudnorm=I=<span class="subst">&#123;TARGET_I&#125;</span>:TP=<span class="subst">&#123;TARGET_TP&#125;</span>:LRA=<span class="subst">&#123;TARGET_LRA&#125;</span>:print_format=json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;null&quot;</span>, <span class="string">&quot;NUL&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    rc, _, err = run(cmd1)</span><br><span class="line">    <span class="keyword">if</span> rc != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Pass1 失败：<span class="subst">&#123;inp&#125;</span>\n<span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    info = extract_loudnorm_json(err)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Pass 2: apply</span></span><br><span class="line">    cmd2 = [</span><br><span class="line">        FFMPEG, <span class="string">&quot;-hide_banner&quot;</span>, <span class="string">&quot;-nostats&quot;</span>, <span class="string">&quot;-y&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-i&quot;</span>, <span class="built_in">str</span>(inp),</span><br><span class="line">        <span class="string">&quot;-af&quot;</span>,</span><br><span class="line">        (</span><br><span class="line">            <span class="string">&quot;loudnorm=I=&#123;I&#125;:TP=&#123;TP&#125;:LRA=&#123;LRA&#125;:&quot;</span></span><br><span class="line">            <span class="string">&quot;measured_I=&#123;mI&#125;:measured_TP=&#123;mTP&#125;:measured_LRA=&#123;mLRA&#125;:&quot;</span></span><br><span class="line">            <span class="string">&quot;measured_thresh=&#123;mTH&#125;:offset=&#123;off&#125;:linear=true&quot;</span></span><br><span class="line">        ).<span class="built_in">format</span>(</span><br><span class="line">            I=TARGET_I, TP=TARGET_TP, LRA=TARGET_LRA,</span><br><span class="line">            mI=info[<span class="string">&quot;input_i&quot;</span>], mTP=info[<span class="string">&quot;input_tp&quot;</span>], mLRA=info[<span class="string">&quot;input_lra&quot;</span>],</span><br><span class="line">            mTH=info[<span class="string">&quot;input_thresh&quot;</span>], off=info[<span class="string">&quot;target_offset&quot;</span>]</span><br><span class="line">        ),</span><br><span class="line">        <span class="string">&quot;-c:a&quot;</span>, <span class="string">&quot;libmp3lame&quot;</span>, <span class="string">&quot;-q:a&quot;</span>, <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="built_in">str</span>(outp)</span><br><span class="line">    ]</span><br><span class="line">    rc, _, err2 = run(cmd2)</span><br><span class="line">    <span class="keyword">if</span> rc != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Pass2 失败：<span class="subst">&#123;inp&#125;</span>\n<span class="subst">&#123;err2&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    in_dir = Path(<span class="string">&quot;MP3&quot;</span>)</span><br><span class="line">    out_dir = Path(<span class="string">&quot;test&quot;</span>)</span><br><span class="line"></span><br><span class="line">    mp3s = <span class="built_in">sorted</span>(in_dir.rglob(<span class="string">&quot;*.mp3&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> mp3s:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;没找到 mp3：请把文件放到 input_mp3/ 下 🙂&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> mp3s:</span><br><span class="line">        rel = f.relative_to(in_dir)</span><br><span class="line">        outp = out_dir / rel</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;🔧 <span class="subst">&#123;rel&#125;</span>&quot;</span>)</span><br><span class="line">        normalize_file(f, outp)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;✅ 完成！输出在：<span class="subst">&#123;out_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;不同歌曲的音量大小不同，如果直接导入游戏做自定义电台的话很容易出现音乐时大时小的问题。因此，需要先将音量均衡。&lt;/p&gt;
&lt;h2 id=&quot;傻瓜脚本&quot;&gt;傻瓜脚</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="HiFi" scheme="https://blog.esing.dev/tags/HiFi/"/>
    
    <category term="杂谈" scheme="https://blog.esing.dev/tags/%E6%9D%82%E8%B0%88/"/>
    
    <category term="GTA" scheme="https://blog.esing.dev/tags/GTA/"/>
    
  </entry>
  
  <entry>
    <title>Windows11开启BBR2拥塞控制算法</title>
    <link href="https://blog.esing.dev/2025/12/18/windows-enable-bbr2/"/>
    <id>https://blog.esing.dev/2025/12/18/windows-enable-bbr2/</id>
    <published>2025-12-18T03:31:29.000Z</published>
    <updated>2025-12-23T02:12:17.447Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>群里吹水时看到群友讨论相同配置的Windows网速和Linux网速哪个更快，得出结论是Linux获胜，毕竟Linux的TCP拥塞控制算法更好，采用的是BBR算法，而Windows一直是老古董CUBIC。</p><p>不过，在Windows11 22H2之后，也可以为TCP开启BBR2的拥塞控制算法了——尽管<strong>有一些小小的问题</strong>。</p><h2 id="开启BBR2">开启BBR2</h2><p>首先查看自己电脑的默认控制算法：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">╭──  PowerShell  False                         <span class="number">0</span>ms [<span class="number">21</span>:<span class="number">21</span>]</span><br><span class="line">╰─ ~</span><br><span class="line">❯ <span class="built_in">Get-NetTCPSetting</span> | <span class="built_in">Select</span> SettingName, CongestionProvider</span><br><span class="line"></span><br><span class="line">SettingName      CongestionProvider</span><br><span class="line"><span class="literal">-----------</span>      <span class="literal">------------------</span></span><br><span class="line">Automatic</span><br><span class="line">InternetCustom   CUBIC</span><br><span class="line">DatacenterCustom CUBIC</span><br><span class="line">Compat           NewReno</span><br><span class="line">Datacenter       CUBIC</span><br><span class="line">Internet         CUBIC</span><br></pre></td></tr></table></figure><p>可以看到都是CUBIC，中间还混了个NewReno。记一下默认值，后面还原需要用。</p><p>因为Windows的BBR2有漏洞，尚未完善对环回接口大分段（Large MTU）的处理，会导致本地 TCP 握手或数据收发出现阻塞或超时。因此，要先关闭环回接口大分段。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">╭──  PowerShell  False                         <span class="number">436</span>ms [<span class="number">21</span>:<span class="number">21</span>]</span><br><span class="line">╰─ ~</span><br><span class="line">❯ netsh interface ip show global</span><br><span class="line">查询活动状态...</span><br><span class="line"></span><br><span class="line">常规全局参数</span><br><span class="line"><span class="literal">---------------------------------------------</span></span><br><span class="line">...</span><br><span class="line">环回大 Mtu                  : enable</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>可以看到，这个“环回大MTU”是<code>enable</code>，需要关闭。是<code>disable</code>也执行一遍命令。在管理员模式的Powershell中执行：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netsh int ipv4 <span class="built_in">set</span> global loopbacklargemtu=disable</span><br><span class="line">netsh int ipv6 <span class="built_in">set</span> global loopbacklargemtu=disable</span><br></pre></td></tr></table></figure><p>确保变为<code>disable</code>即可。</p><p>之后，管理员身份下执行BBR2开启代码，并重启电脑：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=InternetCustom   CongestionProvider=bbr2</span><br><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=DatacenterCustom CongestionProvider=bbr2</span><br><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=Compat           CongestionProvider=bbr2</span><br><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=Internet         CongestionProvider=bbr2</span><br><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=Datacenter       CongestionProvider=bbr2</span><br></pre></td></tr></table></figure><p>即可开启BBR2。</p><h2 id="复原">复原</h2><p>根据上面的默认值执行代码即可：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=InternetCustom   CongestionProvider=CUBIC</span><br><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=DatacenterCustom CongestionProvider=CUBIC</span><br><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=Compat           CongestionProvider=NewReno</span><br><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=Internet         CongestionProvider=CUBIC</span><br><span class="line">netsh int tcp <span class="built_in">set</span> supplemental Template=Datacenter       CongestionProvider=CUBIC</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;群里吹水时看到群友讨论相同配置的Windows网速和Linux网速哪个更快，得出结论是Linux获胜，毕竟Linux的TCP拥塞控制算法更好，采用的是BB</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="TCP" scheme="https://blog.esing.dev/tags/TCP/"/>
    
    <category term="BBR" scheme="https://blog.esing.dev/tags/BBR/"/>
    
    <category term="Windows" scheme="https://blog.esing.dev/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>最棒的VCD波形查看器：Surfer</title>
    <link href="https://blog.esing.dev/2025/12/13/vcd-viewer-surfer/"/>
    <id>https://blog.esing.dev/2025/12/13/vcd-viewer-surfer/</id>
    <published>2025-12-12T17:11:00.000Z</published>
    <updated>2025-12-20T10:46:49.200Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><a href="/2025/11/10/gtkwave-fontsize/" title="GTKWave修改字体大小">之前</a> 折腾了半天GTKWave，还是调不好。高分辨率屏幕看没有优化缩放的波形，眼睛都要瞎了。<p><img src="https://webp.esing.dev/img/image-20251211123703587_251211_1237_oVPZ.png" alt="有没有懂我的超绝DPI的"></p><p>直到群友给我推荐了Surfer。居然还有在线Demo：<a href="https://surfer-project.gitlab.io/surfer">Surfer Online</a></p><h2 id="使用效果">使用效果</h2><p>可以看到，界面字体全部采用等宽字体，看信号也更加方便，不会IIlIlIIlIl分不清。</p><p><img src="https://webp.esing.dev/img/image-20251213013439039_251213_0134_lIRb.png" alt="现代化的查看界面"></p><p>你甚至可以参考官方文档，用现成提供的指令集解码器，亦或是自己写，从而解析指令码，这样子就不用在内部引出ASCII：</p><p><img src="https://webp.esing.dev/img/image-20251213014434957_251213_0144_Y69j.png" alt="自动解析指令码,RV32调试开发必备"></p><p>这玩意甚至还有VSCode插件，虽然是WASM编译版。</p><p>真要挑它的缺点，可能就一个不支持模拟波形吧。<strong>还好做数字方向的看不到这些，哈哈。</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;a href=&quot;/2025/11/10/gtkwave-fontsize/&quot; title=&quot;GTKWave修改字体大小&quot;&gt;之前&lt;/a&gt; 折腾了半天GTKWav</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第十篇</title>
    <link href="https://blog.esing.dev/2025/12/12/riscvcod-p10/"/>
    <id>https://blog.esing.dev/2025/12/12/riscvcod-p10/</id>
    <published>2025-12-12T02:50:50.000Z</published>
    <updated>2025-12-20T10:46:49.181Z</updated>
    
    <content type="html"><![CDATA[<h2 id="让我访问！">让我访问！</h2><p>对于L-Type和S-Type，我们只支持了<code>lw/sw</code>，它们的兄弟姐妹<code>lb/lbu/lh/lhu/<b>sb</b>/sh</code>还没支持。</p><p>我们需要准备一个模块专门用来处理这些非字节存取。在前面ID级传出的<code>sl_type</code>信号终于能派上用场了。</p><p>这里有个小技巧：定义存取类型时，用高位来分辨是读还是写，剩下的读写类型一定程度上可以合并。</p><h3 id="存取控制模块-LoadStoreUnit-sv">存取控制模块 LoadStoreUnit.sv</h3><p>考虑到数据的存取都在MEM级完成，我们需要将模块放置在MEM级。我们要传入来自EX级的待存数据，对其进行适当移位，好将数据存放到合适位置，并根据<code>dram_we</code>和<code>sl_type</code>来将1位写使能<code>dram_we</code>转换为4位的按位写使能<code>dram_we_strbe</code>。</p><p>对于读出的数据，还要判断是有符号还是无符号读取。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> LoadStoreUnit (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] addr,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] store_data_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] store_data_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        dram_we,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] wstrb          <span class="comment">// 按位写使能</span></span><br><span class="line">);</span><br><span class="line">    <span class="comment">// [TODO] 不同的访存类型处理</span></span><br><span class="line">    <span class="keyword">logic</span> is_load, is_load_unsigned;</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        is_load          = (sl_type[<span class="number">3</span>] == <span class="number">1&#x27;b0</span>);</span><br><span class="line">        is_load_unsigned = (sl_type[<span class="number">2</span>] == <span class="number">1&#x27;b1</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 默认值，保证所有组合输出都有驱动，避免锁存</span></span><br><span class="line">        wstrb        = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">        load_data_o  = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        store_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_load) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 临时变量（也可以放在模块层）</span></span><br><span class="line">            <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] raw;</span><br><span class="line">            raw = <span class="number">32&#x27;b0</span>;</span><br><span class="line">            <span class="comment">// 提取 raw，根据 sl_type 和 addr 偏移</span></span><br><span class="line">            <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                <span class="number">2&#x27;b01</span>: <span class="keyword">begin</span>  <span class="comment">// byte</span></span><br><span class="line">                    <span class="comment">// 右移到最低位再掩码</span></span><br><span class="line">                    raw = (load_data_i &gt;&gt; (addr[<span class="number">1</span>:<span class="number">0</span>] * <span class="number">8</span>)) &amp; <span class="number">32&#x27;h000000FF</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="number">2&#x27;b10</span>: <span class="keyword">begin</span>  <span class="comment">// half</span></span><br><span class="line">                    raw = (load_data_i &gt;&gt; (addr[<span class="number">1</span>] * <span class="number">16</span>)) &amp; <span class="number">32&#x27;h0000FFFF</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="number">2&#x27;b11</span>: <span class="keyword">begin</span>  <span class="comment">// word</span></span><br><span class="line">                    raw = load_data_i;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">default</span>: raw = <span class="number">32&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 扩展</span></span><br><span class="line">            <span class="keyword">if</span> (is_load_unsigned) <span class="keyword">begin</span></span><br><span class="line">                load_data_o = raw;  <span class="comment">// 零扩展</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                    <span class="number">2&#x27;b01</span>:   load_data_o = &#123;&#123;<span class="number">24</span>&#123;raw[<span class="number">7</span>]&#125;&#125;, raw[<span class="number">7</span>:<span class="number">0</span>]&#125;;  <span class="comment">// LB</span></span><br><span class="line">                    <span class="number">2&#x27;b10</span>:   load_data_o = &#123;&#123;<span class="number">16</span>&#123;raw[<span class="number">15</span>]&#125;&#125;, raw[<span class="number">15</span>:<span class="number">0</span>]&#125;;  <span class="comment">// LH</span></span><br><span class="line">                    <span class="number">2&#x27;b11</span>:   load_data_o = raw;  <span class="comment">// LW</span></span><br><span class="line">                    <span class="keyword">default</span>: load_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (dram_we) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">logic</span> [<span class="number">15</span>:<span class="number">0</span>] half_byte;</span><br><span class="line">            <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] shift;  <span class="comment">// 移位量 0, 8, 16, 24</span></span><br><span class="line">            shift = <span class="number">4&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">unique</span> <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                <span class="number">2&#x27;b01</span>: <span class="keyword">begin</span>  <span class="comment">// SB</span></span><br><span class="line">                    <span class="keyword">logic</span> [<span class="number">7</span>:<span class="number">0</span>] byte_val;</span><br><span class="line"></span><br><span class="line">                    half_byte = store_data_i[<span class="number">7</span>:<span class="number">0</span>];  <span class="comment">// 只关心最低 8 位</span></span><br><span class="line">                    shift     = &#123;addr[<span class="number">1</span>:<span class="number">0</span>], <span class="number">3&#x27;b000</span>&#125;;  <span class="comment">// addr[1:0] * 8</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 写使能</span></span><br><span class="line">                    <span class="keyword">unique</span> <span class="keyword">case</span> (addr[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                        <span class="number">2&#x27;b00</span>:   wstrb = <span class="number">4&#x27;b0001</span>;</span><br><span class="line">                        <span class="number">2&#x27;b01</span>:   wstrb = <span class="number">4&#x27;b0010</span>;</span><br><span class="line">                        <span class="number">2&#x27;b10</span>:   wstrb = <span class="number">4&#x27;b0100</span>;</span><br><span class="line">                        <span class="number">2&#x27;b11</span>:   wstrb = <span class="number">4&#x27;b1000</span>;</span><br><span class="line">                        <span class="keyword">default</span>: wstrb = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 把 byte_val 放到对应 byte lane</span></span><br><span class="line">                    store_data_o = (&#123;<span class="number">24&#x27;b0</span>, half_byte[<span class="number">7</span>:<span class="number">0</span>]&#125; &lt;&lt; shift);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="number">2&#x27;b10</span>: <span class="keyword">begin</span>  <span class="comment">// SH</span></span><br><span class="line">                    <span class="keyword">logic</span> [<span class="number">15</span>:<span class="number">0</span>] half_val;</span><br><span class="line"></span><br><span class="line">                    half_byte = store_data_i[<span class="number">15</span>:<span class="number">0</span>];  <span class="comment">// 只关心最低 16 位</span></span><br><span class="line">                    shift     = &#123;addr[<span class="number">1</span>], <span class="number">4&#x27;b0000</span>&#125;;  <span class="comment">// addr[1] ? 16 : 0</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 写使能</span></span><br><span class="line">                    <span class="keyword">unique</span> <span class="keyword">case</span> (addr[<span class="number">1</span>])</span><br><span class="line">                        <span class="number">1&#x27;b0</span>:    wstrb = <span class="number">4&#x27;b0011</span>;</span><br><span class="line">                        <span class="number">1&#x27;b1</span>:    wstrb = <span class="number">4&#x27;b1100</span>;</span><br><span class="line">                        <span class="keyword">default</span>: wstrb = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 把 half_val 放到低/高 halfword</span></span><br><span class="line">                    store_data_o = (&#123;<span class="number">16&#x27;b0</span>, half_byte&#125; &lt;&lt; shift);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="number">2&#x27;b11</span>: <span class="keyword">begin</span>  <span class="comment">// SW</span></span><br><span class="line">                    wstrb        = <span class="number">4&#x27;b1111</span>;</span><br><span class="line">                    store_data_o = store_data_i;  <span class="comment">// 直接写整个 word</span></span><br><span class="line">                    half_byte    = <span class="number">16&#x27;b0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                    wstrb        = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    store_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line">                    half_byte    = <span class="number">16&#x27;b0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 非 load/非 store：保持默认 wstrb=0, store_data_o 已初始化为 0</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] sl_type_ascii;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] select_bits;</span><br><span class="line">    <span class="keyword">assign</span> select_bits = addr[<span class="number">1</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (sl_type)</span><br><span class="line">            `MEM_LB:  sl_type_ascii = <span class="string">&quot;LB  &quot;</span>;</span><br><span class="line">            `MEM_LH:  sl_type_ascii = <span class="string">&quot;LH  &quot;</span>;</span><br><span class="line">            `MEM_LW:  sl_type_ascii = <span class="string">&quot;LW  &quot;</span>;</span><br><span class="line">            `MEM_LBU: sl_type_ascii = <span class="string">&quot;LBU &quot;</span>;</span><br><span class="line">            `MEM_LHU: sl_type_ascii = <span class="string">&quot;LHU &quot;</span>;</span><br><span class="line">            `MEM_SB:  sl_type_ascii = <span class="string">&quot;SB  &quot;</span>;</span><br><span class="line">            `MEM_SH:  sl_type_ascii = <span class="string">&quot;SH  &quot;</span>;</span><br><span class="line">            `MEM_SW:  sl_type_ascii = <span class="string">&quot;SW  &quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:  sl_type_ascii = <span class="string">&quot;UNKN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之后更新顶层模块，远方的MUX也不要放过：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DRAM模块</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] DRAM_output_data,DRAM_input_data;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">3</span>:<span class="number">0</span>] dram_we_MEM_strbe;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">3</span>:<span class="number">0</span>] wstrb;</span><br><span class="line">DRAM u_DRAM (</span><br><span class="line">    <span class="variable">.clk</span>(clk),</span><br><span class="line">    <span class="variable">.a</span>  (alu_result_MEM[<span class="number">17</span>:<span class="number">2</span>]),  <span class="comment">// 字节地址转换为字地址 (除以4)</span></span><br><span class="line">    <span class="variable">.spo</span>(DRAM_output_data),</span><br><span class="line">    <span class="variable">.we</span> (wstrb),</span><br><span class="line">    <span class="variable">.din</span>(DRAM_input_data)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于同步DRAM，数据将在下一个时钟周期可用</span></span><br><span class="line"><span class="comment">// 将数据传递到WB级，在WB级进行选择</span></span><br><span class="line"><span class="keyword">assign</span> rf_wd_MEM = rf_wd_MEM_PR2MUX;</span><br><span class="line"></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_o; <span class="comment">// LSU输出的最终加载数据</span></span><br><span class="line">LoadStoreUnit u_LoadStoreUnit(</span><br><span class="line">    <span class="variable">.sl_type</span>          (sl_type_MEM),</span><br><span class="line">    <span class="variable">.addr</span>             (alu_result_MEM),</span><br><span class="line">    <span class="variable">.load_data_i</span>      (DRAM_output_data),</span><br><span class="line">    <span class="variable">.load_data_o</span>      (load_data_o),</span><br><span class="line">    <span class="variable">.store_data_i</span>     (rf_rd2_MEM),</span><br><span class="line">    <span class="variable">.store_data_o</span>     (DRAM_input_data),</span><br><span class="line">    <span class="variable">.dram_we</span>          (dram_we_MEM),</span><br><span class="line">    <span class="variable">.wstrb</span>            (wstrb)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> rf_wd_WB = (wd_sel_WB == `WD_SEL_FROM_DRAM) ? load_data_o : rf_wd_WB_from_PR;</span><br></pre></td></tr></table></figure><p>我们的<code>LoadStoreUnit</code>是<strong>组合逻辑模块</strong>，因此，不会打乱同步读写的DRAM时序。让我们测试一下看看：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">li  x1,0x12345678</span><br><span class="line"></span><br><span class="line">sw  x1,0(x0)</span><br><span class="line">lw  x2,0(x0)</span><br><span class="line">lw  x3,0(x0)</span><br><span class="line">lh  x4,4(x0)</span><br><span class="line">lhu x5,4(x0)</span><br><span class="line">lb  x6,0(x0)</span><br><span class="line">lhu x7,2(x0)</span><br></pre></td></tr></table></figure><p><img src="https://webp.esing.dev/img/image-20251212115844253_251212_1158_qMTV.png" alt="lw指令读出错误"></p><p>可以看到，本应该执行<code>lw</code>的指令却错误地读出了下一条的<code>lh</code>指令，而最后一条<code>lhu</code>直接消失了！这是为什么？</p><p>看上面的波形可以知道，用于控制存入数据的<code>sl_type</code>提早了一拍到达。<strong>组合逻辑不会影响时序，因此，应当根据时序来设计组合逻辑。<strong>我们是在MEM级读取出数据并进行处理的，但是写回阶段是在WB级——这导致我们写回时使用的仍然是MEM级的控制信号。<code>DRAM_output_data</code>在 WB 级可用时，应当使用和 DRAM 读取请求相对应的<code>sl_type</code>进行处理，但当前代码中<code>LoadStoreUnit</code>使用的是<code>sl_type_MEM</code>，而此时MEM级可能已经是下一条指令了。换句话说，</strong>“存”与“取”所在的流水级不同，导致“存”正常，“取”异常</strong>。</p><p>我们的<code>LoadStoreUnit</code>模块也成了第二个跨流水级的模块。如何修改呢？最简单的方法，就是直接实例化两个一模一样的模块：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [INFO] LoadStoreUnit模块 - MEM级只处理Store操作</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] DRAM_input_data;  <span class="comment">// LSU处理后数据</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] DRAM_output_data; <span class="comment">// LSU从DRAM得到的数据</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">3</span>:<span class="number">0</span>] dram_we_MEM_strbe;</span><br><span class="line"><span class="comment">// MEM级LSU仅用于Store处理，Load在WB级处理</span></span><br><span class="line">LoadStoreUnit u_LoadStoreUnit_MEM(</span><br><span class="line">    <span class="variable">.sl_type</span>       (sl_type_MEM),</span><br><span class="line">    <span class="variable">.addr</span>          (alu_result_MEM),</span><br><span class="line">    <span class="variable">.load_data_i</span>   (<span class="number">32&#x27;b0</span>),        <span class="comment">// MEM级不使用load处理</span></span><br><span class="line">    <span class="variable">.load_data_o</span>   (),             <span class="comment">// MEM级不使用load输出</span></span><br><span class="line">    <span class="variable">.store_data_i</span>  (rf_rd2_MEM),</span><br><span class="line">    <span class="variable">.store_data_o</span>  (DRAM_input_data),</span><br><span class="line">    <span class="variable">.dram_we</span>       (dram_we_MEM),</span><br><span class="line">    <span class="variable">.wstrb</span>         (dram_we_MEM_strbe)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// DRAM模块</span></span><br><span class="line">DRAM #(</span><br><span class="line">    <span class="variable">.ADDR_WIDTH</span>(<span class="number">15</span>)</span><br><span class="line">) u_DRAM (</span><br><span class="line">    <span class="variable">.clk</span>(clk),</span><br><span class="line">    <span class="variable">.a</span>  (alu_result_MEM[<span class="number">17</span>:<span class="number">2</span>]),  <span class="comment">// 字节地址转换为字地址</span></span><br><span class="line">    <span class="variable">.spo</span>(DRAM_output_data),</span><br><span class="line">    <span class="comment">// .we (&#123;4&#123;dram_we_MEM&#125;&#125;),</span></span><br><span class="line">    <span class="variable">.we</span> (dram_we_MEM_strbe),</span><br><span class="line">    <span class="variable">.din</span>(DRAM_input_data)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [INFO] WB级LoadStoreUnit - 专门处理Load操作</span></span><br><span class="line"><span class="comment">// 使用WB级的sl_type和地址来正确处理DRAM读取的数据</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_WB;</span><br><span class="line">LoadStoreUnit u_LoadStoreUnit_WB(</span><br><span class="line">    <span class="variable">.sl_type</span>       (sl_type_WB),</span><br><span class="line">    <span class="variable">.addr</span>          (alu_result_WB),</span><br><span class="line">    <span class="variable">.load_data_i</span>   (DRAM_output_data),  <span class="comment">// DRAM的spo在WB级稳定可用</span></span><br><span class="line">    <span class="variable">.load_data_o</span>   (load_data_WB),</span><br><span class="line">    <span class="variable">.store_data_i</span>  (<span class="number">32&#x27;b0</span>),             <span class="comment">// WB级不使用store处理</span></span><br><span class="line">    <span class="variable">.store_data_o</span>  (),</span><br><span class="line">    <span class="variable">.dram_we</span>       (<span class="number">1&#x27;b0</span>),              <span class="comment">// WB级不写DRAM</span></span><br><span class="line">    <span class="variable">.wstrb</span>         ()</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>我们再次进行测试：</p><p><img src="https://webp.esing.dev/img/image-20251212135329430_251212_1353_cKJ6.png" alt="修改后的LSU正常工作"></p><h2 id="全自动化测试：解放双手">全自动化测试：解放双手</h2><p>到这里，我们的RV32I CPU 算是彻底完成了。但即使有前面的测试，我们仍不能确保我们的CPU<strong>万无一失</strong>。有什么办法可以证明它一定是符合RV32I标准的CPU呢？最好的办法，自然是使用形式化验证，但那个太烦了，<strong>而且我不会</strong>。使用官方的测试样例进行测试算是最容易的方法了。riscv-software-src设置了一个测试库，专门用于测试各种架构的RV32 CPU是否符合标准，在<a href="https://github.com/riscv-software-src/riscv-tests">riscv-software-src/riscv-tests</a>下。使用官方工具链编译时，必须带上<code>_Zicsr</code>扩展，这是因为其测试指令和初始化指令中用到了<code>CSR</code>寄存器，不过即使不支持也没关系。</p><p>在测试前，还需要修改一下DRAM。<code>lw</code>测试子集会直接从DRAM中读取值，而我们默认是将DRAM全部初始化为<code>32'h00000000</code>。考虑到之前已在IROM模块中指定了内存读取范围<code>$readmemh(testcase, rom_data, 0, (1 &lt;&lt; ADDR_WIDTH) - 1)</code>，这里在DRAM中可不指定。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] ram_data[<span class="number">1</span> &lt;&lt; ADDR_WIDTH];</span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">integer</span> i;</span><br><span class="line">    <span class="keyword">string</span>  testcase;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化所有内存为0</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">1</span> &lt;&lt; ADDR_WIDTH; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">        ram_data[i] = <span class="number">32&#x27;h00000000</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有testcase参数，从hex文件加载数据段</span></span><br><span class="line">    <span class="comment">// hex文件是完整的内存镜像，按字地址索引</span></span><br><span class="line">    <span class="comment">// 数据段从0x2000开始，即hex文件的第0x800行(2048)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">$value$plusargs</span>(<span class="string">&quot;TESTCASE=%s&quot;</span>, testcase)) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 读取整个hex文件到DRAM</span></span><br><span class="line">        <span class="comment">// SystemVerilog的$readmemh会自动处理地址映射</span></span><br><span class="line">        <span class="comment">// 但是最好还是手动指定范围以防万一</span></span><br><span class="line">        <span class="built_in">$readmemh</span>(testcase, ram_data);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;DRAM: Loaded memory image from %s&quot;</span>, testcase);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>写个简单的Makefile进行测试，结果如下：</p><p><img src="https://webp.esing.dev/img/image-20251212144050887_251212_1440_pe1l.png" alt="完美的测试结果!"></p><h2 id="后记">后记</h2><p>我们做完了吗？做完了99%。</p><p>后面，可能会首先完成<code>Zicsr</code>扩展与<code>M</code>扩展，再之后会往自己的项目上靠，研究一下最新的控制流加密扩展<code>Zicfilp</code>和<code>Zicfiss</code>。<code>A</code>、<code>C</code>和<code>F</code>扩展暂不考虑。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;让我访问！&quot;&gt;让我访问！&lt;/h2&gt;
&lt;p&gt;对于L-Type和S-Type，我们只支持了&lt;code&gt;lw/sw&lt;/code&gt;，它们的兄弟姐妹&lt;code&gt;lb/lbu/lh/lhu/&lt;b&gt;</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第九篇</title>
    <link href="https://blog.esing.dev/2025/12/11/riscvcod-p9/"/>
    <id>https://blog.esing.dev/2025/12/11/riscvcod-p9/</id>
    <published>2025-12-11T04:50:52.000Z</published>
    <updated>2025-12-20T10:46:49.185Z</updated>
    
    <content type="html"><![CDATA[<h2 id="综合器说好，那才是真好">综合器说好，那才是真好</h2><h3 id="模块综合">模块综合</h3><p>写出的HDL代码需要送入综合器中，生成实际的门电路。综合器会在这个过程中推测你写的代码，并帮你进行一定的优化，最终生成文件。</p><p>这里选择开源的<a href="https://github.com/YosysHQ/yosys">Yosys</a>进行综合。官方没有发布适用于Windows的二进制可执行文件，但是Python的WASM库有，虽然是给WebAssembly环境准备的，需要电脑上有<code>wasmtime</code>才行。编写一个综合脚本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># 读取所有模块（不需要 -formal）</span><br><span class="line">read_slang ./user/src/include/defines.svh</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PC.sv</span><br><span class="line">read_slang ./user/src/IROM.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PR_IF_ID.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/Decoder.sv</span><br><span class="line">read_slang ./user/src/imm_extender.sv</span><br><span class="line">read_slang ./user/src/RegisterF.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PR_ID_EX.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/ALU.sv</span><br><span class="line">read_slang ./user/src/NextPC_Generator.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PR_EX_MEM.sv</span><br><span class="line">read_slang ./user/src/DRAM.sv</span><br><span class="line">read_slang ./user/src/LoadStoreUnit.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PR_MEM_WB.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/HazardUnit.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/CPU_TOP.sv</span><br><span class="line"></span><br><span class="line"># read_slang ./user/sim/tb_CPU_TOP.sv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 指定顶层模块，并做基础处理</span><br><span class="line">prep -top CPU_TOP</span><br><span class="line"># prep -top CPU_TOP -rdff              # 此处不能将触发器合并到内存读端口</span><br><span class="line"># prep -top tb_CPU_TOP -flatten</span><br><span class="line"></span><br><span class="line"># 写出 JSON</span><br><span class="line">write_json ./prj/netlist/CPU_TOP.json</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之后运行<code>wasmtime --dir . .\yosys.wasm --.\prj\netlist\CPU_TOP.ys</code>即可开始综合。所有的模块（不含IROM）综合结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">=== design hierarchy ===</span><br><span class="line"></span><br><span class="line">        +----------Count including submodules.</span><br><span class="line">        | </span><br><span class="line">      236 CPU_TOP</span><br><span class="line">       29 ALU</span><br><span class="line">        4 DRAM</span><br><span class="line">       49 Decoder</span><br><span class="line">       44 HazardUnit</span><br><span class="line">       15 NextPC_Generator</span><br><span class="line">        4 PC</span><br><span class="line">        9 PR_EX_MEM</span><br><span class="line">       36 PR_ID_EX</span><br><span class="line">       12 PR_IF_ID</span><br><span class="line">        5 PR_MEM_WB</span><br><span class="line">        9 RegisterF</span><br><span class="line">       11 imm_extender</span><br><span class="line"></span><br><span class="line">        +----------Count including submodules.</span><br><span class="line">        | </span><br><span class="line">      416 wires</span><br><span class="line">     4302 wire bits</span><br><span class="line">      262 public wires</span><br><span class="line">     3205 public wire bits</span><br><span class="line">      170 ports</span><br><span class="line">     2027 port bits</span><br><span class="line">        - memories</span><br><span class="line">        - memory bits</span><br><span class="line">        - processes</span><br><span class="line">      236 cells</span><br><span class="line">        3   $add</span><br><span class="line">       37   $aldff</span><br><span class="line">        1   $and</span><br><span class="line">       55   $eq</span><br><span class="line">        1   $ge</span><br><span class="line">       22   $logic_and</span><br><span class="line">        6   $logic_not</span><br><span class="line">       12   $logic_or</span><br><span class="line">        2   $lt</span><br><span class="line">        2   $mem_v2</span><br><span class="line">       59   $mux</span><br><span class="line">        4   $not</span><br><span class="line">        1   $or</span><br><span class="line">       11   $pmux</span><br><span class="line">        5   $reduce_bool</span><br><span class="line">       10   $reduce_or</span><br><span class="line">        1   $shl</span><br><span class="line">        1   $shr</span><br><span class="line">        1   $sshr</span><br><span class="line">        1   $sub</span><br><span class="line">        1   $xor</span><br><span class="line">       12 submodules</span><br><span class="line">        1   ALU</span><br><span class="line">        1   DRAM</span><br><span class="line">        1   Decoder</span><br><span class="line">        1   HazardUnit</span><br><span class="line">        1   NextPC_Generator</span><br><span class="line">        1   PC</span><br><span class="line">        1   PR_EX_MEM</span><br><span class="line">        1   PR_ID_EX</span><br><span class="line">        1   PR_IF_ID</span><br><span class="line">        1   PR_MEM_WB</span><br><span class="line">        1   RegisterF</span><br><span class="line">        1   imm_extender</span><br></pre></td></tr></table></figure><h3 id="同步读、异步读">同步读、异步读</h3><p>对于前面的DRAM，我们也用Yosys综合一下。这里将异步与同步DRAM的综合结果放在一起，左边为异步，右边为同步：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">=== DRAM ===</span><br><span class="line"></span><br><span class="line">        +----------Local Count, excluding submodules.</span><br><span class="line">        | Default                      SDRAM</span><br><span class="line">        | ---------                    ---------</span><br><span class="line">        8 wires                        8 wires</span><br><span class="line">      147 wire bits                  147 wire bits</span><br><span class="line">        5 public wires                 5 public wires</span><br><span class="line">       82 public wire bits            82 public wire bits</span><br><span class="line">        5 ports                        5 ports</span><br><span class="line">       82 port bits                   82 port bits</span><br><span class="line">        4 cells                        4 cells</span><br><span class="line">                                       1   $dff</span><br><span class="line">        1   $mem_v2                    1   $mem_v2</span><br><span class="line">        3   $mux                       2   $mux</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到，区别是一个MUX和一个DFF。</p><p>Yosys很聪明，但是<strong>Xilinx很傻逼</strong>，就不这么想了。对于前面的“同步写异步读”DRAM，Xilinx Vivado会把它综合为<strong>六万个DFF组成的阵列</strong>：</p><p><img src="https://webp.esing.dev/img/image-20251211173426779_251211_1734_YmAO.png" alt="I　　SYNTHESIS　　65,536　　DFFs　　!!!"></p><p>Utilization里则是作为LUTRAM出现：</p><p><img src="https://webp.esing.dev/img/image-20251212150821514_251212_1508_ADar.png" alt="看这一大堆LUTRAM 能忍住不笑的都是神人了"></p><p>综合后的估计功耗直接拉到15w了，很难绷得住。因此，我们必须修改为“同步写同步读”的DRAM——这在工业生产上也是规范。不论是Xilinx还是其他厂商，其FPGA需要使用的BlockRAM IP核都是同步读写的，有的甚至需要两拍。</p><h2 id="DRAM魔改">DRAM魔改</h2><p>我们必须立即马上使用SDRAM。</p><h3 id="时序问题">时序问题</h3><p>我们只需要改动一行即可：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步写</span></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (we) <span class="keyword">begin</span></span><br><span class="line">        ram_data[a] &lt;= din;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    spo &lt;= ram_data[a];  <span class="comment">// 同步读</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后测试一下简单的S-Type和L-Type。不出意外的话，就会出意外：</p><p><img src="https://webp.esing.dev/img/image-20251211154229805_251211_1542_A3if.png" alt="SL大法坏！"></p><p>问题出在<code>wd_sel_MEM</code>。可以看到，在其值为1（选择DRAM输出数据）时，SDRAM压根就没准备好数据。这是因为同步写时数据在count=5时被写入，异步读可以在数值变化的那一刻就开始跟随输出，但同步读只有在时钟沿到来时（count=6）才能读出数据，而这时候<code>wd_sel_MEM</code>已经变为0，选择<code>rf_wd</code>的数据了。</p><p>怎么办？我们需要让<code>wd_sel_MEM</code>打一拍。最简单的方法，就是让它穿过最后一级流水线寄存器，在MEM/WB级的寄存器内被打一拍。同样的，我们的<code>rf_wd</code>数据也需要被打一拍。</p><p>这里有个问题：我们从SDRAM取的数据要不要送进MEM/WB级流水线寄存器？</p><p>答案是不需要。别忘了，我们的问题就是SDRAM的数据在上升沿才被写入读取，同步读取的数据相对原来异步读取的时候<strong>已经被打了一拍</strong>了。</p><h3 id="EX-MEM级流水线寄存器修改">EX/MEM级流水线寄存器修改</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_mem_i,</span><br><span class="line"><span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_wb_o,</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">        wd_sel_wb_o      &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        wd_sel_wb_o      &lt;= wd_sel_mem_i;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="DRAM数据选择MUX">DRAM数据选择MUX</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回写数据来源选择MUX</span></span><br><span class="line"><span class="comment">// 对于同步DRAM DRAM的spo已经是寄存器输出 在WB级直接使用以避免多余延迟</span></span><br><span class="line"><span class="comment">// DRAM_output_data在整个WB周期内保持稳定 可以安全地被寄存器堆采样</span></span><br><span class="line"><span class="keyword">assign</span> rf_wd_WB = (wd_sel_WB == `WD_SEL_FROM_DRAM) ? DRAM_output_data : rf_wd_WB_from_PR;</span><br></pre></td></tr></table></figure><p>再次测试，一切正常。</p><h3 id="再次综合">再次综合</h3><p>在Vivado中进行综合。可以看到，结果很完美：</p><p><img src="https://webp.esing.dev/img/image-20251211173249551_251211_1732_ZRKE.png" alt="被正确识别成RAM的SDRAM"></p><p>在Utilization里可以看到，BRAM被占用了一部分，说明我们的同步读写DRAM被综合为BRAM，不占用原先的LUTRAM了。</p><p><img src="https://webp.esing.dev/img/image-20251212145918732_251212_1459_IVzg.png" alt="正确综合为BRAM的SDRAM"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;综合器说好，那才是真好&quot;&gt;综合器说好，那才是真好&lt;/h2&gt;
&lt;h3 id=&quot;模块综合&quot;&gt;模块综合&lt;/h3&gt;
&lt;p&gt;写出的HDL代码需要送入综合器中，生成实际的门电路。综合器会在这个过程</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第八篇</title>
    <link href="https://blog.esing.dev/2025/12/11/riscvcod-p8/"/>
    <id>https://blog.esing.dev/2025/12/11/riscvcod-p8/</id>
    <published>2025-12-11T01:00:00.000Z</published>
    <updated>2025-12-20T10:46:49.185Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前递：快人一步">前递：快人一步</h2><h3 id="激烈的斗争">激烈的斗争</h3><p>我们做完了吗？还没完。</p><p>在 <a href="/2025/12/10/riscvcod-p7/" title="从零开始学RISC：第七篇">之前</a> 的测试里，程序没有任何数据冒险——在实际运行中这几乎是不可能的。我们简单修改一点：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addi x1,x0,1</span><br><span class="line">addi x2,x0,2</span><br><span class="line">addi x3,x0,3</span><br><span class="line">addi x4,x0,4</span><br><span class="line">addi x1,x0,7</span><br><span class="line">addi x2,x0,21</span><br><span class="line">add  x7,x1,x2 # 加入数据冒险</span><br></pre></td></tr></table></figure><p>然后运行。发生了什么？我们期望看到<code>x7</code>输出的是<code>x1</code>和<code>x2</code>变化后相加的值，应当为<code>28</code>。但是计算结果输出了错误的3！</p><p><img src="https://webp.esing.dev/img/image-20251211084904808_251211_0849_RBUY.png" alt="数据冒险导致的错误输出"></p><p>这就是最经典的“数据冒险”。我们看看发生了什么。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   x1   x2    x7      IF          ID          EX          MEM         WB</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">1   1    2     x      x1=7</span><br><span class="line">2   1    2     x      x2=21       x1=7</span><br><span class="line">3   1    2     x      x7=x1+x2    x2=21       x1=7</span><br><span class="line">4   1    2     x                  x7=x1+x2[R] x2=21       x1=7</span><br><span class="line">5   7    2     x                              x7=x1+x2    x2=21       x1=7 [W]</span><br><span class="line">6   7    21    x                                          x7=x1+x2    x2=21[W]</span><br><span class="line">7   7    21    3                                                      x7=3 [W]</span><br></pre></td></tr></table></figure><p>这是流水线示意图。可以看到，因为写回在WB级才被完成，导致第三条指令在ID级取到了旧的值。直到第六个周期结束，源寄存器的值才更新完毕。</p><h3 id="空泡与阻塞">空泡与阻塞</h3><p>为了不让计算取到错误的值，我们可以等。时间，会给出答案。在前面的计算还没完成时，让译码级一直等待，直到从寄存器堆中读取正确的值就行。我们需要对数据进行判断：如果两条指令之间存在数据关联，则给出一个信号，之后IF级的程序计数器根据信号来决定是否停止、ID/EX级流水线寄存器根据信号进行冲刷。</p><p>从上面的例子可知，只要间隔不超过三条的指令，都有着数据冒险的可能。因此，判断一下即可。记得判断一下写入的目标是否为0，<strong>毕竟0被塞了多少东西也不会吭一声</strong>。之后，再定义一个判断信号，用于控制冲刷：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// 间隔一级流水线 判断下写入的不为x0即可</span></span><br><span class="line">    RAW_1_rD1 = (wR_EX ==  rR1_ID) &amp;&amp;  rf_we_EX &amp;&amp; rs1_used_ID &amp;&amp; (wR_EX != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    RAW_1_rD2 = (wR_EX ==  rR2_ID) &amp;&amp;  rf_we_EX &amp;&amp; rs2_used_ID &amp;&amp; (wR_EX != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    <span class="comment">// 间隔两级流水线</span></span><br><span class="line">    RAW_2_rD1 = (wR_MEM == rR1_ID) &amp;&amp; rf_we_MEM &amp;&amp; rs1_used_ID &amp;&amp; (wR_MEM != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    RAW_2_rD2 = (wR_MEM == rR2_ID) &amp;&amp; rf_we_MEM &amp;&amp; rs2_used_ID &amp;&amp; (wR_MEM != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    <span class="comment">// 间隔三级流水线</span></span><br><span class="line">    RAW_3_rD1 = (wR_WB ==  rR1_ID) &amp;&amp;  rf_we_WB &amp;&amp; rs1_used_ID &amp;&amp; (wR_WB != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    RAW_3_rD2 = (wR_WB ==  rR2_ID) &amp;&amp;  rf_we_WB &amp;&amp; rs2_used_ID &amp;&amp; (wR_WB != <span class="number">5&#x27;b0</span>);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">// 冲刷信号生成</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    RAW_flush_ID = RAW_1_rD1 || RAW_2_rD1 || RAW_3_rD1</span><br><span class="line">                || RAW_1_rD2 || RAW_2_rD2 || RAW_3_rD2;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后接到CPU顶层模块的对应位置。测试一下！</p><p><img src="https://webp.esing.dev/img/image-20251211092606018_251211_0926_7eXs.png" alt="流水线停顿得出正确结果"></p><p>可以看到，流水线被停顿了很久，但是至少结果出来了。</p><h3 id="与其停滞不前，不如大步向前">与其停滞不前，不如大步向前</h3><p>流水线停顿确实能解决数据冒险的问题，但是<strong>效率太低了</strong>。我们直接把EX级算出来的结果送到前面一级用就是了。上面的信号改个名字就可以拿来用了。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前递数据选择</span></span><br><span class="line"><span class="comment">// 优先级：EX &gt; MEM &gt; WB</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// 源操作数1前递数据选择</span></span><br><span class="line">    <span class="keyword">if</span> (RAW_1_rD1)      fwd_rD1_ID = rf_wd_EX;  <span class="comment">// 来自EX级</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RAW_2_rD1) fwd_rD1_ID = rf_wd_MEM; <span class="comment">// 来自MEM级</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RAW_3_rD1) fwd_rD1_ID = rf_wd_WB;  <span class="comment">// 来自WB级</span></span><br><span class="line">    <span class="keyword">else</span>                fwd_rD1_ID = <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 源操作数2前递数据选择</span></span><br><span class="line">    <span class="keyword">if</span> (RAW_1_rD2)      fwd_rD2_ID = rf_wd_EX;  <span class="comment">// 来自EX级</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RAW_2_rD2) fwd_rD2_ID = rf_wd_MEM; <span class="comment">// 来自MEM级</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RAW_3_rD2) fwd_rD2_ID = rf_wd_WB;  <span class="comment">// 来自WB级</span></span><br><span class="line">    <span class="keyword">else</span>                fwd_rD2_ID = <span class="number">32&#x27;b0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后接入前递使能到ID/EX级流水线寄存器：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前递信号与数据</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD1_forwarded, rD2_forwarded;</span><br><span class="line"><span class="comment">// 考虑了前递就不需要冲刷了</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    rD1_forwarded = fwd_rD1e_ID ? fwd_rD1_ID : rD1_i;</span><br><span class="line">    rD2_forwarded = fwd_rD2e_ID ? fwd_rD2_ID : rD2_i;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 寄存器堆数据</span></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">        rD1_o &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        rD2_o &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        rD1_o &lt;= rD1_forwarded;</span><br><span class="line">        rD2_o &lt;= rD2_forwarded;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>再测试一下，可以看到提前了三个周期便算出了结果，这个延时刚好对应上面算出的数据相关性间隔。波形图上<code>x7</code>紧接着<code>x2</code>的变化，和预期的一样！</p><p><img src="https://webp.esing.dev/img/image-20251211095427035_251211_0954_H54D.png" alt="加入数据前递后的正确结果"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   x1   x2    x7      IF          ID          EX          MEM         WB</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">1   1    2     x      x1=7</span><br><span class="line">2   1    2     x      x2=21       x1=7</span><br><span class="line">3   1    2     x      x7=x1+x2    x2=21       x1=7</span><br><span class="line">4   7[F] 21[F] x                  x7=x1+x2[F] x2=21       x1=7</span><br><span class="line">5   7    2     x                              x7=x1+x2    x2=21       x1=7 [W]</span><br><span class="line">6   7    21    x                                          x7=x1+x2    x2=21[W]</span><br><span class="line">7   7    21    28                                                     x7=28[W]</span><br></pre></td></tr></table></figure><h3 id="Load-Use冒险">Load-Use冒险</h3><p>除了常见的依赖冒险之外，还有一种“取数-使用”型冒险。我们举一个简单的例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addi x1,x0,1</span><br><span class="line">addi x2,x0,2</span><br><span class="line">add  x3,x1,x2</span><br><span class="line">sw   x3,0(x0)</span><br><span class="line">lw   x4,0(x0)</span><br><span class="line">addi x5,x4,1 # Load-Use 冒险</span><br><span class="line">addi x6,x0,6</span><br></pre></td></tr></table></figure><p>可以看到，本应当计算出4的<code>x5</code>现在只是1。</p><p><img src="https://webp.esing.dev/img/image-20251211104058363_251211_1040_nM7O.png" alt="取数-使用冒险导致的错误输出"></p><p>原因是要先从DRAM中读出值存入寄存器，之后再读取寄存器值进行计算，但读出的值在送到寄存器之前就需要被使用，怎么办？我们也可以加入前递。</p><p>可以吗？</p><p>L-Type指令在流水线中要经过MEM级才能得到从DRAM返回的数据，而普通的前递是把 EX 级产生的 ALU 结果直接送给后续指令的 EX 阶段使用。换句话说，<strong>L-Type的数据在 EX 之后、MEM 之后才可用</strong>。单靠常规 的EX2EX 转发是无法消除的。</p><p>那我们加一个MEM2EX级的前递路径不就行了？想法是好的，但是流水线执行坏了：</p><ul><li>L-Type的数据往往在 MEM 级的末期才可用（这里是MUX之后输出的结果），而 EX 的操作数通常在该周期早期就要用到，会出现时序错误；</li><li>插入一个气泡更为简单，也更容易控制流水线流动。</li></ul><p>那直接插气泡就行了，何乐而不为呢？</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load_use 冒险判断</span></span><br><span class="line"><span class="keyword">logic</span> load_use_hazard;</span><br><span class="line"><span class="keyword">assign</span> load_use_hazard = (wd_sel_EX == `WD_SEL_FROM_DRAM) &amp;&amp; (RAW_1_rD1 || RAW_1_rD2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 流水线冲刷与停顿</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    keep_pc     = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    stall_IF_ID = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    flush_ID_EX = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><img src="https://webp.esing.dev/img/image-20251211104952833_251211_1049_DgaD.png" alt="停顿一级流水线后得出正确结果"></p><div class="note info flat"><p>事实上，对于Load-Use类冒险，最标准的做法就是插入空泡。这也是几乎教科书中都提及的方法。</p></div><h3 id="分支跳转：Jumpin">分支跳转：Jumpin'</h3>    <div id="aplayer-BjssktsZ" class="aplayer aplayer-tag-marker meting-tag-marker"         data-id="1347247827" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ff80ac" data-volume="0.3" data-loop="none"    ></div><p>B-Type类指令压根不需要写寄存器，只是在EX级计算出是否跳转后更新PC值。我们在 <a href="/2025/12/09/riscvcod-p6/" title="从零开始学RISC：第六篇">执行级</a> 已经写好了下一PC计算模块，其中<code>take_branch</code>输出就是是否跳转。在跳转时，我们需要让程序计数器的下一PC取到跳转目标地址，并冲刷IF/ID级的流水线寄存器。为了分别以后接入分支跳转预测模块，我们预留一个输入端口。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">logic</span> branch_predicted_result;</span><br><span class="line"><span class="comment">// 此处设置为静态不预测 因此获取EX级的跳转结果</span></span><br><span class="line"><span class="comment">// assign branch_predicted_result = branch_predicted_i;</span></span><br><span class="line"><span class="keyword">assign</span> branch_predicted_result = take_branch_NextPC;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 流水线冲刷与停顿</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    keep_pc     = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    stall_IF_ID = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    flush_IF_ID = branch_predicted_result ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    flush_ID_EX = (branch_predicted_result || load_use_hazard) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后写个简单的分支跳转测试：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">addi x1, x0, 5   # x1 = 5</span><br><span class="line">addi x2, x0, 5   # x2 = 5</span><br><span class="line">addi x3, x0, 0   # x3 = 0</span><br><span class="line"></span><br><span class="line">beq  x1, x2, 8   # 跳转到PC+8（跳过下一条），x1==x2时跳转</span><br><span class="line">addi x3, x3, 1   # 未跳转时执行（应被跳过）</span><br><span class="line"></span><br><span class="line">addi x4, x0, 10  # x4 = 10</span><br><span class="line"></span><br><span class="line">addi x5, x0, 7</span><br><span class="line">bne  x1, x5, 8   # 跳转到PC+8（跳过下一条），x1!=x5时跳转</span><br><span class="line">addi x4, x4, 1   # 未跳转时执行（应被跳过）</span><br><span class="line"></span><br><span class="line">addi x6, x0, 3</span><br><span class="line">blt  x6, x1, 8   # 跳转到PC+8（跳过下一条），x6&lt;x1时跳转</span><br><span class="line">addi x4, x4, 2   # 未跳转时执行（应被跳过）</span><br><span class="line"></span><br><span class="line">addi x7, x0, 5</span><br><span class="line">bge  x1, x7, 8   # 跳转到PC+8（跳过下一条），x1&gt;=x7时跳转</span><br><span class="line">addi x4, x4, 3   # 未跳转时执行（应被跳过）</span><br><span class="line"></span><br><span class="line">addi x8, x0, 100 # 跳转后执行</span><br><span class="line"></span><br><span class="line"># 最终寄存器值为：</span><br><span class="line"># x3 = 0 (未执行任何加1操作)</span><br><span class="line"># x4 = 10 (未执行任何加1或加2或加3操作)</span><br></pre></td></tr></table></figure><p>运行一下：</p><p><img src="https://webp.esing.dev/img/image-20251211111927124_251211_1119_kPCt.png" alt="分支跳转正确执行"></p><p>可以看到程序计数器接受了<code>branch_op</code>信号并正确选择了分支跳转结果。</p><p>为什么<code>x3</code>变为0后，过了四个周期，<code>x4</code>才变为10？这是因为我们直接阻塞流水线，<code>x3</code>的值可以通过旁路提前送过去，但是只有在<code>beq</code>执行完毕后才能得知是否跳转。跳转目标的指令<code>addi x4</code>在<code>beq</code>指令 EX 级结束后的下一周期才进入IF级：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   x3  x4      IF          ID          EX          MEM         WB</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">1   x   x      addi  0</span><br><span class="line">2   x   x      beq        addi  0</span><br><span class="line">3   x   x      addi  1    beq          addi  0</span><br><span class="line">4   x   x      addi  1    !==阻塞!==   beq         addi  0</span><br><span class="line">5   0   x      addi 10    &lt;==========得出结果=|                addi  0  -|</span><br><span class="line">6   0   x                 addi 10                                        |</span><br><span class="line">7   0   x                              addi 10                           |- 四个周期</span><br><span class="line">8   0   x                                          addi 10               |</span><br><span class="line">9   0   10                                                     addi 10  -|</span><br></pre></td></tr></table></figure><h2 id="数据冒险控制模块-HazardUnit-sv">数据冒险控制模块 HazardUnit.sv</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> HazardUnit (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// LOAD指令判断</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_EX,</span><br><span class="line">    <span class="comment">// 寄存器使用信号</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rs1_used_ID,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rs2_used_ID,</span><br><span class="line">    <span class="comment">// ID级源寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] rR1_ID,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] rR2_ID,</span><br><span class="line">    <span class="comment">// EX级目的寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wR_EX,</span><br><span class="line">    <span class="comment">// MEM级目的寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wR_MEM,</span><br><span class="line">    <span class="comment">// WB级目的寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wR_WB,</span><br><span class="line">    <span class="comment">// 写入数据使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_EX,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_MEM,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_WB,</span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rf_wd_EX,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rf_wd_MEM,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rf_wd_WB,</span><br><span class="line">    <span class="comment">// 预留的分支预测结果</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        branch_predicted_i,</span><br><span class="line">    <span class="comment">// PC保持信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        keep_pc,</span><br><span class="line">    <span class="comment">// IF/ID停顿信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        stall_IF_ID,</span><br><span class="line">    <span class="comment">// IF/ID冲刷信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        flush_IF_ID,</span><br><span class="line">    <span class="comment">// ID/EX冲刷信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        flush_ID_EX,</span><br><span class="line">    <span class="comment">// 前递使能</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        fwd_rD1e_ID,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        fwd_rD2e_ID,</span><br><span class="line">    <span class="comment">// 前递数据</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] fwd_rD1_ID,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] fwd_rD2_ID</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RAW 冒险判断</span></span><br><span class="line">    <span class="comment">// verilog_format: off</span></span><br><span class="line">    <span class="keyword">logic</span> RAW_1_rD1, RAW_1_rD2;</span><br><span class="line">    <span class="keyword">logic</span> RAW_2_rD1, RAW_2_rD2;</span><br><span class="line">    <span class="keyword">logic</span> RAW_3_rD1, RAW_3_rD2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 间隔一级流水线 判断下写入的不为x0即可</span></span><br><span class="line">        RAW_1_rD1 = (wR_EX ==  rR1_ID) &amp;&amp;  rf_we_EX &amp;&amp; rs1_used_ID &amp;&amp; (wR_EX != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        RAW_1_rD2 = (wR_EX ==  rR2_ID) &amp;&amp;  rf_we_EX &amp;&amp; rs2_used_ID &amp;&amp; (wR_EX != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        <span class="comment">// 间隔两级流水线</span></span><br><span class="line">        RAW_2_rD1 = (wR_MEM == rR1_ID) &amp;&amp; rf_we_MEM &amp;&amp; rs1_used_ID &amp;&amp; (wR_MEM != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        RAW_2_rD2 = (wR_MEM == rR2_ID) &amp;&amp; rf_we_MEM &amp;&amp; rs2_used_ID &amp;&amp; (wR_MEM != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        <span class="comment">// 间隔三级流水线</span></span><br><span class="line">        RAW_3_rD1 = (wR_WB ==  rR1_ID) &amp;&amp;  rf_we_WB &amp;&amp; rs1_used_ID &amp;&amp; (wR_WB != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        RAW_3_rD2 = (wR_WB ==  rR2_ID) &amp;&amp;  rf_we_WB &amp;&amp; rs2_used_ID &amp;&amp; (wR_WB != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前递使能信号生成</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        fwd_rD1e_ID = RAW_1_rD1 || RAW_2_rD1 || RAW_3_rD1;</span><br><span class="line">        fwd_rD2e_ID = RAW_1_rD2 || RAW_2_rD2 || RAW_3_rD2;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前递数据选择</span></span><br><span class="line">    <span class="comment">// 优先级：EX &gt; MEM &gt; WB</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// case-true 语句</span></span><br><span class="line">        <span class="comment">// 源操作数1前递数据选择</span></span><br><span class="line">        <span class="keyword">case</span> (<span class="number">1&#x27;b1</span>)</span><br><span class="line">            RAW_1_rD1: fwd_rD1_ID = rf_wd_EX;  <span class="comment">// 来自EX级</span></span><br><span class="line">            RAW_2_rD1: fwd_rD1_ID = rf_wd_MEM; <span class="comment">// 来自MEM级</span></span><br><span class="line">            RAW_3_rD1: fwd_rD1_ID = rf_wd_WB;</span><br><span class="line">            <span class="keyword">default</span>:   fwd_rD1_ID = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">        <span class="comment">// 源操作数2前递数据选择</span></span><br><span class="line">        <span class="keyword">case</span> (<span class="number">1&#x27;b1</span>)</span><br><span class="line">            RAW_1_rD2: fwd_rD2_ID = rf_wd_EX;  <span class="comment">// 来自EX级</span></span><br><span class="line">            RAW_2_rD2: fwd_rD2_ID = rf_wd_MEM; <span class="comment">// 来自MEM级</span></span><br><span class="line">            RAW_3_rD2: fwd_rD2_ID = rf_wd_WB;</span><br><span class="line">            <span class="keyword">default</span>:   fwd_rD2_ID = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format: on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load_use 冒险判断</span></span><br><span class="line">    <span class="keyword">logic</span> load_use_hazard;</span><br><span class="line">    <span class="keyword">assign</span> load_use_hazard = (wd_sel_EX == `WD_SEL_FROM_DRAM) &amp;&amp; (RAW_1_rD1 || RAW_1_rD2);</span><br><span class="line">    <span class="comment">// assign load_use_hazard = 1&#x27;b0;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [TODO] 静态分支预测</span></span><br><span class="line">    <span class="comment">// [TODO] 动态分支预测</span></span><br><span class="line">    <span class="keyword">logic</span> branch_predicted_result;</span><br><span class="line">    <span class="comment">// 此处设置为静态不预测 因此获取EX级的跳转结果</span></span><br><span class="line">    <span class="keyword">assign</span> branch_predicted_result = branch_predicted_i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 流水线冲刷与停顿</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        keep_pc     = load_use_hazard                              ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">        stall_IF_ID = load_use_hazard                              ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">        flush_IF_ID = branch_predicted_result                      ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">        flush_ID_EX = (branch_predicted_result || load_use_hazard) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="复杂测试">复杂测试</h2><p>到此，我们的CPU已经完成70%了。运行一些复杂的汇编程序，不出意外的话，是不会有问题的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br></pre></td><td class="code"><pre><span class="line"># ========================================</span><br><span class="line"># RV32I Complete Test Suite (No Pseudo Instructions)</span><br><span class="line"># Testing all RV32I instructions without misaligned access</span><br><span class="line"># ========================================</span><br><span class="line"></span><br><span class="line">    .text</span><br><span class="line">    .globl _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line"># ========================================</span><br><span class="line"># 1. Test ADDI - Add Immediate</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x1, x0, 100                   # x1 = 0 + 100 = 100 (0x64)</span><br><span class="line">    addi   x2, x0, 200                   # x2 = 0 + 200 = 200 (0xC8)</span><br><span class="line">    addi   x3, x1, 50                    # x3 = 100 + 50 = 150 (0x96)</span><br><span class="line">    addi   x4, x0, -10                   # x4 = 0 + (-10) = -10 (0xFFFFFFF6)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 2. Test ADD - Add Register</span><br><span class="line"># ========================================</span><br><span class="line">    add    x5, x1, x2                    # x5 = 100 + 200 = 300 (0x12C)</span><br><span class="line">    add    x6, x3, x4                    # x6 = 150 + (-10) = 140 (0x8C)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 3. Test SUB - Subtract</span><br><span class="line"># ========================================</span><br><span class="line">    sub    x7, x2, x1                    # x7 = 200 - 100 = 100 (0x64)</span><br><span class="line">    sub    x8, x1, x2                    # x8 = 100 - 200 = -100 (0xFFFFFF9C)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 4. Test SLTI - Set Less Than Immediate (Signed)</span><br><span class="line"># ========================================</span><br><span class="line">    slti   x9, x1, 101                   # x9 = (100 &lt; 101) = 1</span><br><span class="line">    slti   x10, x1, 99                   # x10 = (100 &lt; 99) = 0</span><br><span class="line">    slti   x11, x4, 0                    # x11 = (-10 &lt; 0) = 1</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 5. Test SLTIU - Set Less Than Immediate (Unsigned)</span><br><span class="line"># ========================================</span><br><span class="line">    sltiu  x12, x1, 101                  # x12 = (100 &lt; 101) = 1</span><br><span class="line">    sltiu  x13, x4, 10                   # x13 = (0xFFFFFFF6 &lt; 10) = 0 (unsigned compare)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 6. Test SLT - Set Less Than (Signed)</span><br><span class="line"># ========================================</span><br><span class="line">    slt    x14, x1, x2                   # x14 = (100 &lt; 200) = 1</span><br><span class="line">    slt    x15, x2, x1                   # x15 = (200 &lt; 100) = 0</span><br><span class="line">    slt    x16, x4, x1                   # x16 = (-10 &lt; 100) = 1</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 7. Test SLTU - Set Less Than (Unsigned)</span><br><span class="line"># ========================================</span><br><span class="line">    sltu   x17, x1, x2                   # x17 = (100 &lt; 200) = 1</span><br><span class="line">    sltu   x18, x4, x1                   # x18 = (0xFFFFFFF6 &lt; 100) = 0 (unsigned)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 8. Test Logical Operations - ANDI, ORI, XORI</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x19, x0, 255                  # x19 = 255 (0xFF)</span><br><span class="line">    andi   x20, x19, 15                  # x20 = 255 &amp; 15 = 15 (0x0F)</span><br><span class="line">    ori    x21, x20, 240                 # x21 = 15 | 240 = 255 (0xFF)</span><br><span class="line">    xori   x22, x21, 170                 # x22 = 255 ^ 170 = 85 (0x55)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 9. Test Logical Operations - AND, OR, XOR</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x23, x0, 60                   # x23 = 60 (0x3C = 0b00111100)</span><br><span class="line">    addi   x24, x0, 51                   # x24 = 51 (0x33 = 0b00110011)</span><br><span class="line">    and    x25, x23, x24                 # x25 = 60 &amp; 51 = 48 (0x30)</span><br><span class="line">    or     x26, x23, x24                 # x26 = 60 | 51 = 63 (0x3F)</span><br><span class="line">    xor    x27, x23, x24                 # x27 = 60 ^ 51 = 15 (0x0F)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 10. Test Shift Operations - SLLI, SRLI, SRAI</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x28, x0, 8                    # x28 = 8 (0x08)</span><br><span class="line">    slli   x29, x28, 2                   # x29 = 8 &lt;&lt; 2 = 32 (0x20)</span><br><span class="line">    srli   x30, x29, 1                   # x30 = 32 &gt;&gt; 1 = 16 (0x10)</span><br><span class="line">    addi   x31, x0, -8                   # x31 = -8 (0xFFFFFFF8)</span><br><span class="line">    srai   x1, x31, 1                    # x1 = -8 &gt;&gt; 1 = -4 (0xFFFFFFFC, arithmetic shift)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 11. Test Shift Operations - SLL, SRL, SRA</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x2, x0, 16                    # x2 = 16</span><br><span class="line">    addi   x3, x0, 2                     # x3 = 2 (shift amount)</span><br><span class="line">    sll    x4, x2, x3                    # x4 = 16 &lt;&lt; 2 = 64 (0x40)</span><br><span class="line">    srl    x5, x4, x3                    # x5 = 64 &gt;&gt; 2 = 16 (0x10)</span><br><span class="line">    addi   x6, x0, -16                   # x6 = -16 (0xFFFFFFF0)</span><br><span class="line">    sra    x7, x6, x3                    # x7 = -16 &gt;&gt; 2 = -4 (0xFFFFFFFC)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 12. Test LUI - Load Upper Immediate</span><br><span class="line"># ========================================</span><br><span class="line">    lui    x8, 0x12345                   # x8 = 0x12345000</span><br><span class="line">    lui    x9, 0xFFFFF                   # x9 = 0xFFFFF000</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 13. Test AUIPC - Add Upper Immediate to PC</span><br><span class="line"># ========================================</span><br><span class="line">    auipc  x10, 0                        # x10 = current PC + 0</span><br><span class="line">    auipc  x11, 1                        # x11 = current PC + 0x1000</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 14. Test Memory Operations - Store and Load</span><br><span class="line"># Setup memory base address</span><br><span class="line"># ========================================</span><br><span class="line">    lui    x12, 0x10000                  # x12 = 0x10000000 (memory base)</span><br><span class="line"></span><br><span class="line"># Store values</span><br><span class="line">    lui    x15, 0xABCDE                  # x15 = 0xABCDE000</span><br><span class="line">    addi   x15, x15, 0x789               # x15 = 0xABCDE789</span><br><span class="line">    sw     x15, 8(x12)                   # Store word: mem[0x10000008] = 0xABCDE789</span><br><span class="line"></span><br><span class="line"># Load values</span><br><span class="line"></span><br><span class="line">    lw     x26, 8(x12)                   # x26 = 0xABCDE789</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 15. Test Branch Instructions - BEQ</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x27, x0, 10                   # x27 = 10</span><br><span class="line">    addi   x28, x0, 10                   # x28 = 10</span><br><span class="line">    beq    x27, x28, branch_eq_taken     # Should branch (10 == 10)</span><br><span class="line">    addi   x29, x0, 99                   # x29 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_eq_taken:</span><br><span class="line">    addi   x29, x0, 1                    # x29 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line">    addi   x27, x0, 10                   # x27 = 10</span><br><span class="line">    addi   x28, x0, 20                   # x28 = 20</span><br><span class="line">    beq    x27, x28, branch_eq_not_taken # Should not branch</span><br><span class="line">    addi   x30, x0, 1                    # x30 = 1 (not taken marker)</span><br><span class="line"></span><br><span class="line">branch_eq_not_taken:</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 16. Test Branch Instructions - BNE</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x1, x0, 5                     # x1 = 5</span><br><span class="line">    addi   x2, x0, 10                    # x2 = 10</span><br><span class="line">    bne    x1, x2, branch_ne_taken       # Should branch (5 != 10)</span><br><span class="line">    addi   x3, x0, 99                    # x3 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_ne_taken:</span><br><span class="line">    addi   x3, x0, 1                     # x3 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 17. Test Branch Instructions - BLT (Signed)</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x4, x0, 5                     # x4 = 5</span><br><span class="line">    addi   x5, x0, 10                    # x5 = 10</span><br><span class="line">    blt    x4, x5, branch_lt_taken       # Should branch (5 &lt; 10)</span><br><span class="line">    addi   x6, x0, 99                    # x6 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_lt_taken:</span><br><span class="line">    addi   x6, x0, 1                     # x6 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line">    addi   x7, x0, -5                    # x7 = -5</span><br><span class="line">    addi   x8, x0, 3                     # x8 = 3</span><br><span class="line">    blt    x7, x8, branch_lt_neg_taken   # Should branch (-5 &lt; 3)</span><br><span class="line">    addi   x9, x0, 99                    # x9 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_lt_neg_taken:</span><br><span class="line">    addi   x9, x0, 1                     # x9 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 18. Test Branch Instructions - BGE (Signed)</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x10, x0, 10                   # x10 = 10</span><br><span class="line">    addi   x11, x0, 5                    # x11 = 5</span><br><span class="line">    bge    x10, x11, branch_ge_taken     # Should branch (10 &gt;= 5)</span><br><span class="line">    addi   x12, x0, 99                   # x12 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_ge_taken:</span><br><span class="line">    addi   x12, x0, 1                    # x12 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 19. Test Branch Instructions - BLTU (Unsigned)</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x13, x0, 5                    # x13 = 5</span><br><span class="line">    addi   x14, x0, 10                   # x14 = 10</span><br><span class="line">    bltu   x13, x14, branch_ltu_taken    # Should branch (5 &lt; 10 unsigned)</span><br><span class="line">    addi   x15, x0, 99                   # x15 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_ltu_taken:</span><br><span class="line">    addi   x15, x0, 1                    # x15 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 20. Test Branch Instructions - BGEU (Unsigned)</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x16, x0, 10                   # x16 = 10</span><br><span class="line">    addi   x17, x0, 5                    # x17 = 5</span><br><span class="line">    bgeu   x16, x17, branch_geu_taken    # Should branch (10 &gt;= 5 unsigned)</span><br><span class="line">    addi   x18, x0, 99                   # x18 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_geu_taken:</span><br><span class="line">    addi   x18, x0, 1                    # x18 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 21. Test JAL - Jump and Link</span><br><span class="line"># ========================================</span><br><span class="line">    jal    x19, jal_target               # x19 = return address, jump to jal_target</span><br><span class="line">    addi   x20, x0, 99                   # x20 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">jal_target:</span><br><span class="line">    addi   x20, x0, 1                    # x20 = 1 (jump successful)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 22. Test JALR - Jump and Link Register</span><br><span class="line"># ========================================</span><br><span class="line">    auipc  x21, 0                        # x21 = current PC</span><br><span class="line">    addi   x21, x21, 16                  # x21 = PC + 16 (target address)</span><br><span class="line">    jalr   x22, x21, 0                   # x22 = return address, jump to x21</span><br><span class="line">    addi   x23, x0, 99                   # x23 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">jalr_target:</span><br><span class="line">    addi   x23, x0, 1                    # x23 = 1 (jump successful)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 23. Test Complex Data Dependencies</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x24, x0, 1                    # x24 = 1</span><br><span class="line">    addi   x24, x24, 2                   # x24 = 3</span><br><span class="line">    addi   x24, x24, 3                   # x24 = 6</span><br><span class="line">    addi   x24, x24, 4                   # x24 = 10</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 24. Test Edge Cases</span><br><span class="line"># ========================================</span><br><span class="line"># Maximum positive immediate</span><br><span class="line">    addi   x25, x0, 2047                 # x25 = 2047 (0x7FF, max 12-bit signed)</span><br><span class="line"></span><br><span class="line"># Maximum negative immediate</span><br><span class="line">    addi   x26, x0, -2048                # x26 = -2048 (0xFFFFF800)</span><br><span class="line"></span><br><span class="line"># Overflow test</span><br><span class="line">    lui    x27, 0x7FFFF                  # x27 = 0x7FFFF000</span><br><span class="line">    addi   x27, x27, 0x7FF               # x27 = 0x7FFFF7FF (near max positive)</span><br><span class="line">    addi   x28, x0, 1                    # x28 = 1</span><br><span class="line">    add    x29, x27, x28                 # x29 = overflow result</span><br><span class="line"></span><br><span class="line"># Zero register test</span><br><span class="line">    addi   x0, x0, 100                   # x0 should remain 0</span><br><span class="line">    add    x30, x0, x0                   # x30 = 0</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 25. Final Test - Load/Store with Computed Address</span><br><span class="line"># ========================================</span><br><span class="line">    lui    x31, 0x10000                  # x31 = 0x10000000</span><br><span class="line">    addi   x1, x0, 100                   # x1 = 100 (offset)</span><br><span class="line">    add    x2, x31, x1                   # x2 = 0x10000000 + 100</span><br><span class="line">    addi   x3, x0, 0x55A                 # x3 = 0x55AA</span><br><span class="line">    sw     x3, 0(x2)                     # Store at computed address</span><br><span class="line">    lw     x4, 0(x2)                     # x4 = 0x55AA (load back)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># End of Test - Infinite Loop</span><br><span class="line"># ========================================</span><br><span class="line">end_loop:</span><br><span class="line">    beq    x0, x0, end_loop              # Infinite loop</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># Expected Register Values After Test:</span><br><span class="line"># ========================================</span><br><span class="line"># x0 = 0x00000000 (always zero)</span><br><span class="line"># x1 = 100 (0x64)</span><br><span class="line"># x2 = 0x10000064</span><br><span class="line"># x3 = 0x000055AA</span><br><span class="line"># x4 = 0x000055AA</span><br><span class="line"># x5 = 16 (0x10)</span><br><span class="line"># x6 = -16 (0xFFFFFFF0)</span><br><span class="line"># x7 = -4 (0xFFFFFFFC)</span><br><span class="line"># x8 = 0x12345000</span><br><span class="line"># x9 = 0xFFFFF000</span><br><span class="line"># x10 = PC value at AUIPC</span><br><span class="line"># x11 = PC value + 0x1000</span><br><span class="line"># x12 = 0x10000000</span><br><span class="line"># x13 = 127 (0x7F)</span><br><span class="line"># x14 = 0x1234</span><br><span class="line"># x15 = 1 (branch marker)</span><br><span class="line"># x16 = 10</span><br><span class="line"># x17 = 5</span><br><span class="line"># x18 = 1 (branch marker)</span><br><span class="line"># x19 = return address from JAL</span><br><span class="line"># x20 = 1</span><br><span class="line"># x21 = target address</span><br><span class="line"># x22 = return address from JALR</span><br><span class="line"># x23 = 1</span><br><span class="line"># x24 = 10</span><br><span class="line"># x25 = 2047 (0x7FF)</span><br><span class="line"># x26 = -2048 (0xFFFFF800)</span><br><span class="line"># x27 = 0x7FFFF7FF</span><br><span class="line"># x28 = 1</span><br><span class="line"># x29 = 0x7FFFF800 (overflow wrapped)</span><br><span class="line"># x30 = 0</span><br><span class="line"># x31 = 0x10000000</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>效果非常好！</p><p><img src="https://webp.esing.dev/img/image-20251211123703587_251211_1237_oVPZ.png" alt="完整测试"></p><p>为什么才完成70%？那是因为我们还没有支持<code>lb/lh</code>和<code>sb/sh</code>一类指令。在这之前，我们还有一个<strong>历史遗留问题</strong>需要去解决，那就是<strong>无法被综合的同步写异步读DRAM</strong>……</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前递：快人一步&quot;&gt;前递：快人一步&lt;/h2&gt;
&lt;h3 id=&quot;激烈的斗争&quot;&gt;激烈的斗争&lt;/h3&gt;
&lt;p&gt;我们做完了吗？还没完。&lt;/p&gt;
&lt;p&gt;在 &lt;a href=&quot;/2025/12/10</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第七篇</title>
    <link href="https://blog.esing.dev/2025/12/10/riscvcod-p7/"/>
    <id>https://blog.esing.dev/2025/12/10/riscvcod-p7/</id>
    <published>2025-12-10T13:00:00.000Z</published>
    <updated>2025-12-20T10:46:49.184Z</updated>
    
    <content type="html"><![CDATA[<h2 id="访存-MEM级-设计">访存 MEM级 设计</h2><p>访存访存，顾名思义，就是要去访问内存。这个内存是“数据内存”，因为我们写的CPU采用的是<strong>哈佛架构</strong>，指令内存和数据内存分离。</p><h3 id="数据内存-DRAM-sv">数据内存 DRAM.sv</h3><p>首先登场的是数据内存。非常简单，实例化一堆RDFF即可。为什么是RDFF？为了便于测验<s>交作业</s>，我们<strong>暂时</strong>把DRAM写成 <strong>“同步写、异步读”</strong> 的。</p><div class="note danger flat"><p>几乎所有厂商都不支持“同步写、异步读”的DRAM，综合器也无法将其综合为DRAM。对于Xilinx的IP核，其BRAM是同步读写的，有的甚至需要两拍。</p></div><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DRAM 行为模型 - 用于仿真</span></span><br><span class="line"><span class="comment">// 替代 Xilinx IP 核</span></span><br><span class="line"><span class="comment">// [HACK] Vivado无法综合异步读的RAM</span></span><br><span class="line"><span class="keyword">module</span> DRAM (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,  <span class="comment">// 时钟</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">15</span>:<span class="number">0</span>] a,    <span class="comment">// 地址输入 (16位 = 64K words)</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] spo,  <span class="comment">// 数据输出</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        we,   <span class="comment">// 写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] din   <span class="comment">// 数据输入</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据存储器 - 16K x 32bit</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] ram_data[<span class="number">65536</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">integer</span>             i;</span><br><span class="line">        <span class="keyword">reg</span>     [<span class="number">256</span>*<span class="number">8</span>-<span class="number">1</span>:<span class="number">0</span>] ram_file;  <span class="comment">// 字符串缓冲区</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">65536</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            ram_data[i] = <span class="number">32&#x27;h00000000</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            rom_file =</span><br><span class="line">            <span class="comment">// &quot;user/data/hex/sw_lw.hex&quot;</span></span><br><span class="line">            <span class="string">&quot;user/data/hex/addi.hex&quot;</span></span><br><span class="line">            ;</span><br><span class="line">            <span class="built_in">$readmemh</span>(rom_file, rom_data, <span class="number">0</span>, <span class="number">16383</span>);</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;IROM: Loaded instructions from %s&quot;</span>, rom_file);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写操作 (同步)</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (we) <span class="keyword">begin</span></span><br><span class="line">            ram_data[a] &lt;= din;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [HACK] 异步读</span></span><br><span class="line">    <span class="comment">// assign spo = ram_data[a];</span></span><br><span class="line">    <span class="comment">// 确保在写操作时读出未知值</span></span><br><span class="line">    <span class="keyword">assign</span> spo = we ? &#x27;x : ram_data[a];</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="DRAM数据选择MUX">DRAM数据选择MUX</h3><p>来自EX级的数据只有来自ID级的<code>rD2</code>。也不容易了，一路走到这里。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回写数据来源2选择MUX</span></span><br><span class="line"><span class="comment">// 选择是否为DRAM数据</span></span><br><span class="line"><span class="comment">// 对于同步DRAM 将MUX放到WB级</span></span><br><span class="line"><span class="keyword">assign</span> rf_wd_MEM = (wd_sel_MEM == `WD_SEL_FROM_DRAM) ? DRAM_output_data : rf_wd_MEM_PR2MUX;</span><br></pre></td></tr></table></figure><h3 id="MEM-WB级-流水线寄存器-PR-MEM-WB-sv">MEM/WB级 流水线寄存器 PR_MEM_WB.sv</h3><p>已经到最后一级了，信号也被分流的差不多了。</p><p>我们需要将L-Type需要的寄存器写入数据<code>rf_wd</code>传入WB级，准备写回；与之一起进入的还有寄存器堆写使能信号<code>rf_we</code>，和写入目标寄存器地址<code>wr</code>。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PR_MEM_WB (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 寄存器堆写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_mem_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rf_we_wb_o,</span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_mem_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_wb_o,</span><br><span class="line">    <span class="comment">// 写回数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] wd_mem_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] wd_wb_o</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            rf_we_wb_o       &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            wr_wb_o          &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">            wd_wb_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            rf_we_wb_o       &lt;= rf_we_mem_i;</span><br><span class="line">            wr_wb_o          &lt;= wr_mem_i;</span><br><span class="line">            wd_wb_o          &lt;= wd_mem_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="写回-WB级-设计">写回 WB级 设计</h2><p>WB级其实根本不用去设计——因为这一级根本没内容，只需要将要写回的数据送入寄存器堆即可。</p><h2 id="顶层模块封装-CPU-TOP-sv">顶层模块封装 CPU_TOP.sv</h2><p>到此为止，我们已经完成了所有的流水线。接着，就是把它们拼在一起了。</p><p>我们封装后的CPU应当有IROM接口，输出地址、取回指令。此外，还要有时钟输入和低电平有效的复位信号。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> CPU_TOP (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 来自指令存储器IROM的指令</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr,</span><br><span class="line">    <span class="comment">// 输出给指令存储器IROM的地址</span></span><br><span class="line">    <span class="comment">// 这里实际上是PC的高14位</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">13</span>:<span class="number">0</span>] pc</span><br><span class="line">);</span><br></pre></td></tr></table></figure><div class="note info flat"><p>因为指令存储器以“字”（word）为单位寻址，且深度一般为2<sup>14</sup>，对于普通RISCV指令来说占了4字节，且低两位恒为0（必须4字节对齐），所以取高14位即可。</p></div><p>我们从IF级拿的指令，直接取高14位：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> pc = pc_IF[<span class="number">15</span>:<span class="number">2</span>];</span><br></pre></td></tr></table></figure><p>之后对于各级模块，连线连起来即可。比较好的习惯是将信号所处的级做名称结尾。</p><h2 id="仿真测试！">仿真测试！</h2><p>虽然我们写的是SystemVerilog，但是iverilog还是支持一些特性的——或者说，有warning有sorry但是工作正常。能跑就算语法支持，不过实际运行效果肯定是不如verilator的。</p><p>首先要写一个顶层模块，加入一些激励信号，并引出寄存器连线，便于观察：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;../src/CPU_TOP.sv&quot;</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> DEBUG </span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> REG_FILE u_CPU_TOP.u_registerf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> tb_CPU_TOP;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 时钟和复位信号</span></span><br><span class="line">    <span class="keyword">logic</span>        clk;</span><br><span class="line">    <span class="keyword">logic</span>        rst_n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IROM 信号</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">13</span>:<span class="number">0</span>] irom_addr;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] irom_data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化 IROM (指令存储器)</span></span><br><span class="line">    IROM u_IROM (</span><br><span class="line">        <span class="variable">.a</span>  (irom_addr),</span><br><span class="line">        <span class="variable">.spo</span>(irom_data)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化 CPU_TOP</span></span><br><span class="line">    CPU_TOP u_CPU_TOP (</span><br><span class="line">        <span class="variable">.clk</span>  (clk),</span><br><span class="line">        <span class="variable">.rst_n</span>(rst_n),</span><br><span class="line">        <span class="variable">.instr</span>(irom_data),</span><br><span class="line">        <span class="variable">.pc</span>   (irom_addr)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verilog_format: off</span></span><br><span class="line"><span class="comment">// 寄存器堆监控信号</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] x0, x1, <span class="comment">// ...</span></span><br><span class="line">    x31;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        x0  = `REG_FILE<span class="variable">.rf_in</span>[<span class="number">0</span>];</span><br><span class="line">        x1  = `REG_FILE<span class="variable">.rf_in</span>[<span class="number">1</span>];</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">        x31 = `REG_FILE<span class="variable">.rf_in</span>[<span class="number">31</span>];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// verilog_format: on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 时钟生成 (100MHz, 周期 10ns)</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        clk = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">forever</span> #<span class="number">5</span> clk = ~clk;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复位和测试控制</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 波形文件设置</span></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> VCD_FILEPATH</span></span><br><span class="line">        <span class="built_in">$dumpfile</span>(`VCD_FILEPATH);</span><br><span class="line"><span class="meta">`<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">$dumpfile</span>(<span class="string">&quot;wave.vcd&quot;</span>);</span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line">        <span class="built_in">$dumpvars</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化信号</span></span><br><span class="line">        rst_n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 复位 CPU</span></span><br><span class="line">        #<span class="number">5</span>;  <span class="comment">// 保持复位 25ns</span></span><br><span class="line">        rst_n = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;CPU Reset Released at time %0t&quot;</span>, <span class="built_in">$time</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 运行一段时间让 CPU 执行指令</span></span><br><span class="line">        #<span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;Simulation finished at time %0t&quot;</span>, <span class="built_in">$time</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印寄存器堆状态</span></span><br><span class="line">        print_register_file();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">$finish</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监控关键信号</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;Time\t| PC\t| Instruction\t| Stage&quot;</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">            @(<span class="keyword">posedge</span> clk);</span><br><span class="line">            <span class="keyword">if</span> (rst_n) <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// IF 级</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.valid_IF</span>)</span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;%0t\t| %h\t| %h\t| IF&quot;</span>, <span class="built_in">$time</span>, u_CPU_TOP<span class="variable">.pc_IF</span>, u_CPU_TOP<span class="variable">.instr_IF</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ID 级</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.valid_ID</span> &amp;&amp; u_CPU_TOP<span class="variable">.instr_ID</span> != <span class="number">32&#x27;h00000013</span>)  <span class="comment">// 跳过 NOP</span></span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;%0t\t| %h\t| %h\t| ID&quot;</span>, <span class="built_in">$time</span>, u_CPU_TOP<span class="variable">.pc_ID</span>, u_CPU_TOP<span class="variable">.instr_ID</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// EX 级</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.valid_EX</span>)</span><br><span class="line">                    <span class="built_in">$display</span>(</span><br><span class="line">                        <span class="string">&quot;%0t\t| %h\t| --------\t| EX \t (ALU=0x%h)&quot;</span>,</span><br><span class="line">                        <span class="built_in">$time</span>,</span><br><span class="line">                        u_CPU_TOP<span class="variable">.pc_EX</span>,</span><br><span class="line">                        u_CPU_TOP<span class="variable">.alu_result_EX</span></span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                <span class="comment">// MEM 级</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.dram_we_MEM</span>) <span class="keyword">begin</span></span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;%0t\t| 0x%4h &lt;| 0x%h\t|[MEM W]&quot;</span>, <span class="built_in">$time</span>,</span><br><span class="line">                             u_CPU_TOP<span class="variable">.alu_result_MEM</span>[<span class="number">17</span>:<span class="number">2</span>], u_CPU_TOP<span class="variable">.rf_rd2_MEM</span>);</span><br><span class="line">                <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.wd_sel_MEM</span>)</span><br><span class="line">                        <span class="built_in">$display</span>(</span><br><span class="line">                            <span class="string">&quot;%0t\t| 0x%4h |&gt; 0x%h\t|[MEM R]&quot;</span>,</span><br><span class="line">                            <span class="built_in">$time</span>,</span><br><span class="line">                            u_CPU_TOP<span class="variable">.alu_result_MEM</span>[<span class="number">17</span>:<span class="number">2</span>],</span><br><span class="line">                            u_CPU_TOP<span class="variable">.DRAM_output_data</span></span><br><span class="line">                        );</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监控寄存器写回操作</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">            @(<span class="keyword">posedge</span> clk);</span><br><span class="line">            <span class="keyword">if</span> (rst_n &amp;&amp; u_CPU_TOP<span class="variable">.rf_we_WB</span> &amp;&amp; u_CPU_TOP<span class="variable">.wR_WB</span> != <span class="number">0</span>) <span class="keyword">begin</span></span><br><span class="line">                <span class="built_in">$display</span>(<span class="string">&quot;%0t\t|  x%-2d   &lt;= 0x%h \t|[WB]&quot;</span>, <span class="built_in">$time</span>, u_CPU_TOP<span class="variable">.wR_WB</span>,</span><br><span class="line">                         u_CPU_TOP<span class="variable">.rf_wd_WB</span>);</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印寄存器堆内容的任务</span></span><br><span class="line">    <span class="keyword">task</span> <span class="keyword">automatic</span> print_register_file();</span><br><span class="line">        <span class="keyword">integer</span> i;</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;\n========================================&quot;</span>);</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;Register File Contents:&quot;</span>);</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.u_registerf</span><span class="variable">.rf_in</span>[i] != <span class="number">0</span>) <span class="keyword">begin</span></span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;x%0d\t= 0x%h\t(%0d)&quot;</span>, i, u_CPU_TOP<span class="variable">.u_registerf</span><span class="variable">.rf_in</span>[i],</span><br><span class="line">                             <span class="built_in">$signed</span>(u_CPU_TOP<span class="variable">.u_registerf</span><span class="variable">.rf_in</span>[i]));</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;========================================\n&quot;</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 超时保护</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        #<span class="number">5000</span>;  <span class="comment">// 50us 超时</span></span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;ERROR: Simulation timeout!&quot;</span>);</span><br><span class="line">        <span class="built_in">$finish</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新建一个时钟 为clk的两倍周期 便于观察</span></span><br><span class="line">    <span class="keyword">logic</span>        slow_clk;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">unsigned</span> count;</span><br><span class="line">    <span class="keyword">initial</span> slow_clk = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        slow_clk &lt;= ~slow_clk;</span><br><span class="line">        count    &lt;= count + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之后用iverilog编译与仿真，并使用GTKWave看波形。这么多年过去了，还是没有一个现代化的波形查看器吗。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iverilog -g2012 -Wall -I ./user/src -I ./user/src/include -o tb_CPU_TOP.vvp</span><br><span class="line">vvp tb_CPU_TOP.vvp</span><br></pre></td></tr></table></figure><p>我们可以用官方的riscv工具链进行编译，当然也可以写一个Python文件手动将汇编文件转换成机器码。看个人喜好。</p><p>写一个简单的加法测试：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addi x1,x0,1</span><br><span class="line">addi x2,x0,2</span><br><span class="line">addi x3,x0,3</span><br><span class="line">addi x4,x0,4</span><br><span class="line">addi x5,x0,5</span><br><span class="line">addi x6,x0,6</span><br><span class="line">add  x7,x1,x2</span><br></pre></td></tr></table></figure><p>转换成二进制，应该是这样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00100093</span><br><span class="line">00200113</span><br><span class="line">00300193</span><br><span class="line">00400213</span><br><span class="line">00500293</span><br><span class="line">00600313</span><br><span class="line">002083b3</span><br></pre></td></tr></table></figure><div class="note warning flat"><p><code>objdump</code>转换出的<code>.verilog</code>文件，是按照内存小端对齐的格式写的！而<code>elf2hex</code>则是将一个指令字当成一个整体输出，为大端对齐。实际写入逻辑还是按照大端，只是存储格式被认为是小端。</p></div><p>然后运行。</p><p><img src="https://webp.esing.dev/img/image-20251211083638641_251211_0836_VrZp.png" alt="非常简单的加法"></p><p>可以看到结果非常完美。我们成功了 ^_^</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;访存-MEM级-设计&quot;&gt;访存 MEM级 设计&lt;/h2&gt;
&lt;p&gt;访存访存，顾名思义，就是要去访问内存。这个内存是“数据内存”，因为我们写的CPU采用的是&lt;strong&gt;哈佛架构&lt;/str</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第六篇</title>
    <link href="https://blog.esing.dev/2025/12/09/riscvcod-p6/"/>
    <id>https://blog.esing.dev/2025/12/09/riscvcod-p6/</id>
    <published>2025-12-09T14:19:27.000Z</published>
    <updated>2025-12-20T10:46:49.184Z</updated>
    
    <content type="html"><![CDATA[<h2 id="执行-EX级-设计">执行 EX级 设计</h2><p>EX级以负责核心运算功能的<strong>ALU</strong>著称。可以说，它是CPU的灵魂。来一人一句ALU牛逼来。</p><h3 id="算数逻辑单元-ALU-sv">算数逻辑单元 ALU.sv</h3><p>ALU需要完成一系列R-Type、I-Type指令的运算。对于L-Type和S-Type，它们的处理逻辑其实差不多，都是相加——这样才能让ALU输出基地址和偏移量之和，算出目标地址。</p><p>同样地，使用字符串打印的方式来增强可读性，优化Debug体验，并更好的看到指令在流水线中的流动。同样使用<code>DEBUG</code>宏进行包装，在给综合器生成最终电路前取消宏定义即可。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> ALU (</span><br><span class="line">    <span class="comment">// 操作码</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] alu_op,</span><br><span class="line">    <span class="comment">// 操作数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src1,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2,</span><br><span class="line">    <span class="comment">// 来自ID/EX级的立即数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm,</span><br><span class="line">    <span class="comment">// 第二操作数选择 0: src2 1: imm</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_src2_sel,</span><br><span class="line">    <span class="comment">// 结果输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] alu_result,</span><br><span class="line">    <span class="comment">// 标志位输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        zero,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        sign,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        alu_unsigned</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2_inner;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> src2_inner = (alu_src2_sel) ? imm : src2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 运算操作</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : alu_operation</span><br><span class="line">        <span class="keyword">case</span> (alu_op)</span><br><span class="line">            <span class="comment">// 基础运算</span></span><br><span class="line">            `ALU_ADD:   alu_result = src1 + src2_inner;</span><br><span class="line">            `ALU_SUB:   alu_result = src1 - src2_inner;  <span class="comment">// src1 + (~src2 + 1)</span></span><br><span class="line">            `ALU_OR:    alu_result = src1 | src2_inner;</span><br><span class="line">            `ALU_AND:   alu_result = src1 &amp; src2_inner;</span><br><span class="line">            `ALU_XOR:   alu_result = src1 ^ src2_inner;</span><br><span class="line">            `ALU_SLL:   alu_result = src1 &lt;&lt; src2_inner[<span class="number">4</span>:<span class="number">0</span>];</span><br><span class="line">            `ALU_SRL:   alu_result = src1 &gt;&gt; src2_inner[<span class="number">4</span>:<span class="number">0</span>];</span><br><span class="line">            <span class="comment">// 必须显式声明src1为有符号数</span></span><br><span class="line">            `ALU_SRA:   alu_result = <span class="built_in">$signed</span>(src1) &gt;&gt;&gt; src2_inner[<span class="number">4</span>:<span class="number">0</span>];</span><br><span class="line">            `ALU_SLT:   alu_result = (<span class="built_in">$signed</span>(src1) &lt; <span class="built_in">$signed</span>(src2_inner)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            `ALU_SLTU:  alu_result = (src1 &lt; src2_inner) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            `ALU_RIGHT: alu_result = src2_inner;  <span class="comment">// 用于AUIPC指令</span></span><br><span class="line">            <span class="comment">// L-Type</span></span><br><span class="line">            `ALU_LW:    alu_result = src1 + src2_inner;  <span class="comment">// 地址计算</span></span><br><span class="line">            <span class="comment">// [TODO] 非对齐访存</span></span><br><span class="line">            <span class="comment">//S-Type</span></span><br><span class="line">            `ALU_SW:    alu_result = src1 + src2_inner;  <span class="comment">// 地址计算</span></span><br><span class="line">            <span class="keyword">default</span>:    alu_result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load/Store指令使用的地址计算不放在ALU内</span></span><br><span class="line">    <span class="comment">// 拆分为独立模块 LoadStoreUnit</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标志位输出</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        zero         = (alu_result == <span class="number">32&#x27;b0</span>);</span><br><span class="line">        sign         = alu_result[<span class="number">31</span>];</span><br><span class="line">        alu_unsigned = (src1 &lt; src2_inner);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="comment">// 方便调试的 ASCII 指令输出</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">64</span>-<span class="number">1</span>:<span class="number">0</span>] aluop_ascii;</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : aluop_ascii_output</span><br><span class="line">        <span class="keyword">case</span> (alu_op)</span><br><span class="line">            `ALU_ADD:   aluop_ascii = <span class="string">&quot;AADD&quot;</span>;</span><br><span class="line">            `ALU_SUB:   aluop_ascii = <span class="string">&quot;ASUB&quot;</span>;</span><br><span class="line">            `ALU_OR:    aluop_ascii = <span class="string">&quot;AOR&quot;</span>;</span><br><span class="line">            `ALU_AND:   aluop_ascii = <span class="string">&quot;AAND&quot;</span>;</span><br><span class="line">            `ALU_XOR:   aluop_ascii = <span class="string">&quot;AXOR&quot;</span>;</span><br><span class="line">            `ALU_SLL:   aluop_ascii = <span class="string">&quot;ASLL&quot;</span>;</span><br><span class="line">            `ALU_SRL:   aluop_ascii = <span class="string">&quot;ASRL&quot;</span>;</span><br><span class="line">            `ALU_SRA:   aluop_ascii = <span class="string">&quot;ASRA&quot;</span>;</span><br><span class="line">            `ALU_SLT:   aluop_ascii = <span class="string">&quot;ASLT&quot;</span>;</span><br><span class="line">            `ALU_SLTU:  aluop_ascii = <span class="string">&quot;ASLTU&quot;</span>;</span><br><span class="line">            `ALU_RIGHT: aluop_ascii = <span class="string">&quot;ARGHT&quot;</span>;</span><br><span class="line">            `ALU_LW:    aluop_ascii = <span class="string">&quot;ALW&quot;</span>;</span><br><span class="line">            `ALU_SW:    aluop_ascii = <span class="string">&quot;ASW&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:    aluop_ascii = <span class="string">&quot;ANOP&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对于许多CPU，会将ALU运算的源操作数选择列为一个单独的二选一MUX。这里直接合并在ALU内：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ALU (</span><br><span class="line">    <span class="comment">// 操作数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src1,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2,</span><br><span class="line">    <span class="comment">// 来自ID/EX级的立即数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm,</span><br><span class="line">    <span class="comment">// 第二操作数选择 0: src2 1: imm</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_src2_sel,</span><br><span class="line">    ...</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2_inner;</span><br><span class="line">    <span class="keyword">assign</span> src2_inner = (alu_src2_sel) ? imm : src2;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>那为什么后面的MUX不合并呢？这是为了看起来更方便。</p><h3 id="回写数据来源选择MUX">回写数据来源选择MUX</h3><p>这一块实际上没有写成一个单独的模块，而是最终要集成在封装好的CPU模块内。想单独写一个也行，反正最终会被综合成一个多选一MUX。</p><p>我们需要选择哪些数据？看之前的 <a href="/2025/12/08/riscvcod-p5/" title="从零开始学RISC：第五篇">译码级设计</a> ，看<code>Decoder.sv</code>输出的选择信号<code>wd_sel</code>对应哪些指令：</p><ul><li>R-Type和I-Type指令的写回数据来源于ALU；</li><li>B-Type指令不需要选择回写数据，但也得给个默认值；</li><li><code>jal</code>和<code>jalr</code>两个是跳转指令，需要选择<code>pc+4</code>作为数据写入寄存器；</li><li><code>lui</code>和<code>auipc</code>这两个很特殊，是立即数扩展，因此使用扩展后从ID级传入的数据；</li><li>L-Type需要从DRAM中读取数据，因此需要在MEM级选择；</li><li>不应该有其余情况，这里写为<code>unique case</code>可以不写<code>default</code>。不过补一个最好。</li></ul><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回写数据来源选择MUX</span></span><br><span class="line"><span class="comment">// 在EX级完成选择以减少流水线寄存器宽度</span></span><br><span class="line"><span class="comment">// 注意 load 指令的数据在 MEM 级才可用 因此不可能选择 DRAM 作为回写数据来源</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span> : wd_EX_MUX</span><br><span class="line">    <span class="keyword">case</span> (wd_sel_EX)</span><br><span class="line">        `WD_SEL_FROM_ALU:  rf_wd_EX = alu_result_EX;</span><br><span class="line">        <span class="comment">// `WD_SEL_FROM_DRAM在MEM级处理</span></span><br><span class="line">        `WD_SEL_FROM_PC4:  rf_wd_EX = pc4_EX;</span><br><span class="line">        <span class="comment">// 如果回写的是立即数扩展值 则需要判断是否为AUIPC指令</span></span><br><span class="line">        `WD_SEL_FROM_IEXT: rf_wd_EX = (is_auipc_EX) ? branch_target_EX : imm_EX;</span><br><span class="line">        <span class="keyword">default</span>:           rf_wd_EX = <span class="number">32&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="下一PC计算模块-NextPC-Generator-sv">下一PC计算模块 NextPC_Generator.sv</h3><p>我们的指令执行完怎么办？取下一个。那下一个从哪里取呢？</p><p>不是所有的指令地址都是+4+4变化。对于分支跳转指令等，我们在运算并比较后，要根据结果来进行跳转，而运算完成的最早时间便是EX级。此外，在EX作比较还能利用前向数据通路来加快运算，这是好的。</p><p>我们首先要知道，在EX级执行的指令是什么？是分支，还是跳转，或者根本不用去刻意变化<code>pc</code>？我们还需要获取跳转的目标地址，对于<code>jalr</code>还要进行相应的计算。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> NextPC_Generator (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        is_branch_instr,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] branch_type,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] jump_type,</span><br><span class="line">    <span class="comment">// ALU计算结果输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] alu_result,</span><br><span class="line">    <span class="comment">// PC加立即数输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] branch_target_i,</span><br><span class="line">    <span class="comment">// ALU标志位输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_zero,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_sign,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_unsigned,</span><br><span class="line">    <span class="comment">// PC控制输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        take_branch,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] branch_target_NextPC</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (jump_type)        take_branch = <span class="number">1&#x27;b1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (is_branch_instr) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">unique</span> <span class="keyword">case</span> (branch_type)</span><br><span class="line">                `BRANCH_BEQ:  take_branch = alu_zero;</span><br><span class="line">                `BRANCH_BNE:  take_branch = ~alu_zero;</span><br><span class="line">                `BRANCH_BLT:  take_branch = alu_sign;</span><br><span class="line">                `BRANCH_BGE:  take_branch = ~alu_sign;</span><br><span class="line">                `BRANCH_BLTU: take_branch = alu_unsigned;</span><br><span class="line">                `BRANCH_BGEU: take_branch = ~alu_unsigned;</span><br><span class="line">                <span class="keyword">default</span>:      take_branch = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span>              take_branch = <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// JALR 需要将最低位置0</span></span><br><span class="line">    <span class="keyword">assign</span> branch_target_NextPC = (jump_type == `JUMP_JALR) ?</span><br><span class="line">                                  &#123;alu_result[<span class="number">31</span>:<span class="number">1</span>], <span class="number">1&#x27;b0</span>&#125; : branch_target_i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note warning flat"><p>要注意：<code>jalr</code>指令要将<strong>最低位归零</strong>。</p><p>因RISC‑V 要求所有指令地址至少要对齐到 16 位（半字，2 字节），而<code>jalr</code>是寄存器间接跳转，<code>rs1 + imm</code>的值可能是奇数，因此需要手动将低位置为0。</p></div><h2 id="EX-MEM级-流水线寄存器-PR-EX-MEM-sv">EX/MEM级 流水线寄存器 PR_EX_MEM.sv</h2><p>对于EX向MEM级进发，我们需要传递来自MUX的回写数据<code>wd</code>，以及DRAM的写使能信号<code>dram_we</code>。MEM级的回写数据来源MUX控制信号<code>wd_sel</code>和EX级的是一个，直接复用即可。此外，ALU的计算结果也不能忽略，因为对于L-Type指令，需要作为地址传入MEM级。来自ID/EX级的<code>rD2</code>数据也需要传入，作为DRAM的写入数据。此外，对于S-Type指令，寄存器堆写使能信号<code>wr</code>也需要继续传递。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PR_EX_MEM (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// EX级输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_ex_i,</span><br><span class="line">    <span class="comment">// EX级输出 给MEM级输入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_mem_o,</span><br><span class="line">    <span class="comment">// 判断指令是否有效</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        instr_valid_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        instr_valid_mem_o,</span><br><span class="line">    <span class="comment">// 写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        dram_we_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        dram_we_mem_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rf_we_mem_o,</span><br><span class="line">    <span class="comment">// 写回数据来源</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_mem_o,</span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_mem_o,</span><br><span class="line">    <span class="comment">// ALU计算结果</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] alu_result_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] alu_result_mem_o,</span><br><span class="line">    <span class="comment">// MUX数据 控制写回数据来源</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] wd_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] wd_mem_o,</span><br><span class="line">    <span class="comment">// 回写数据 来自ID/EX级</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD2_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD2_mem_o</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            pc_mem_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_mem_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            dram_we_mem_o     &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            rf_we_mem_o       &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            wd_sel_mem_o      &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            alu_result_mem_o  &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            wd_mem_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            rD2_mem_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            pc_mem_o          &lt;= pc_ex_i;</span><br><span class="line">            instr_valid_mem_o &lt;= instr_valid_ex_i;</span><br><span class="line">            dram_we_mem_o     &lt;= dram_we_ex_i;</span><br><span class="line">            rf_we_mem_o       &lt;= rf_we_ex_i;</span><br><span class="line">            wd_sel_mem_o      &lt;= wd_sel_ex_i;</span><br><span class="line">            alu_result_mem_o  &lt;= alu_result_ex_i;</span><br><span class="line">            wd_mem_o          &lt;= wd_ex_i;</span><br><span class="line">            rD2_mem_o         &lt;= rD2_ex_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            wr_mem_o &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            wr_mem_o &lt;= wr_ex_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>写到这里，已经完成30%了，可喜可贺！</p><p>为什么已经写了三级，才完成30%？</p><p><strong>因为大的在后面呢。</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;执行-EX级-设计&quot;&gt;执行 EX级 设计&lt;/h2&gt;
&lt;p&gt;EX级以负责核心运算功能的&lt;strong&gt;ALU&lt;/strong&gt;著称。可以说，它是CPU的灵魂。来一人一句ALU牛逼来。&lt;/</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第五篇</title>
    <link href="https://blog.esing.dev/2025/12/08/riscvcod-p5/"/>
    <id>https://blog.esing.dev/2025/12/08/riscvcod-p5/</id>
    <published>2025-12-08T12:16:34.000Z</published>
    <updated>2025-12-20T10:46:49.183Z</updated>
    
    <content type="html"><![CDATA[<h2 id="译码-ID级-设计">译码 ID级 设计</h2><p>提到译码级，那就得是译码器啊。纯组合逻辑，包你写到爽。</p><p>译码级还有什么？立即数移位也需要放在ID级，以减轻EX级的压力。</p><h3 id="指令译码器-Decoder-sv">指令译码器 Decoder.sv</h3><p>指令译码器为<strong>组合逻辑模块</strong>。我们需要哪些信号？</p><p>首先要把31位的指令分类：是RIBJSU的哪一种？之后，要根据分类，将寄存器地址拆分出来，准备送进同一级的寄存器堆来读取数据；要提取指令的<code>funct3</code>和<code>funct7</code>，以便在EX级告诉ALU“长的像的指令如何区分”；要根据指令类型，区分跳转类型和读取/写入类型，给后面的流水级进行处理；还要生成对应位的寄存器读信号，和分支指令判断信号，为后面处理数据冒险准备……要干的事情真不少。</p><p>一步一步全写上即可。推荐使用宏定义，大幅度提升可读性。</p><p>在模块内使用``ifdef DEBUG`配合上ASCII字符进行Debug是另一个小技巧。在综合时取消宏定义即可。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> Decoder (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] alu_op,</span><br><span class="line">    <span class="comment">// ALU 第一操作数来源</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        is_auipc,</span><br><span class="line">    <span class="comment">// ALU 第二操作数来源</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        alu_src,</span><br><span class="line">    <span class="comment">// 写使能</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        dram_we,          <span class="comment">// 高电平为写使能 低电平为读</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rf_we,</span><br><span class="line">    <span class="comment">// 写回数据来源</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel,</span><br><span class="line">    <span class="comment">// 分支相关</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        is_branch_instr,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] branch_type,</span><br><span class="line">    <span class="comment">// 跳转相关</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] jump_type,</span><br><span class="line">    <span class="comment">// 数据读取类型</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type,</span><br><span class="line">    <span class="comment">// 源寄存器是否在使用</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rs1_used,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rs2_used</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提取指令字段</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] opcode;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] funct3;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] funct7;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        opcode = instr[<span class="number">6</span>:<span class="number">0</span>];</span><br><span class="line">        funct3 = instr[<span class="number">14</span>:<span class="number">12</span>];</span><br><span class="line">        funct7 = instr[<span class="number">31</span>:<span class="number">25</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳转类型判断</span></span><br><span class="line">    <span class="comment">// assign jump_type = (opcode == `OPCODE_JAL) ?</span></span><br><span class="line">    <span class="comment">//     `JUMP_JAL : (opcode == `OPCODE_JALR) ? `JUMP_JALR : `JUMP_NOP;</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_JAL:  jump_type = `JUMP_JAL;</span><br><span class="line">            `OPCODE_JALR: jump_type = `JUMP_JALR;</span><br><span class="line">            <span class="keyword">default</span>:      jump_type = `JUMP_NOP;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 源寄存器读取判断</span></span><br><span class="line">    <span class="comment">// 反向判断简化逻辑 记得去除ERROR</span></span><br><span class="line">    <span class="comment">// rs1：除了 LUI/AUIPC/JAL 之外都用到</span></span><br><span class="line">    <span class="keyword">assign</span> rs1_used = ~((opcode == `OPCODE_LUI) || (opcode == `OPCODE_AUIPC) ||</span><br><span class="line">                        (opcode == `OPCODE_JAL) || (opcode == `OPCODE_ZERO));</span><br><span class="line">    <span class="comment">// // rs2：只有 R-type / B-type / S-type 用到</span></span><br><span class="line">    <span class="keyword">assign</span> rs2_used = (opcode == `OPCODE_RTYPE) || (opcode == `OPCODE_BTYPE) ||</span><br><span class="line">        (opcode == `OPCODE_STYPE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [HACK] Icarus Verilog 不支持 inside 语法糖 :(</span></span><br><span class="line">    <span class="comment">// assign rs1_used = !(opcode inside &#123;</span></span><br><span class="line">    <span class="comment">//     `OPCODE_LUI,</span></span><br><span class="line">    <span class="comment">//     `OPCODE_AUIPC,</span></span><br><span class="line">    <span class="comment">//     `OPCODE_JAL</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="comment">// assign rs2_used = (opcode inside &#123;</span></span><br><span class="line">    <span class="comment">//     `OPCODE_RTYPE,</span></span><br><span class="line">    <span class="comment">//     `OPCODE_BTYPE,</span></span><br><span class="line">    <span class="comment">//     `OPCODE_STYPE</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分支类型判断</span></span><br><span class="line">    <span class="comment">// 看funct3决定具体的分支类型</span></span><br><span class="line">    <span class="comment">// assign is_branch_instr = (opcode == `OPCODE_BTYPE);</span></span><br><span class="line">    <span class="comment">// assign branch_type = funct3;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALU 第一操作数来源</span></span><br><span class="line">    <span class="comment">// 判断是否为 AUIPC 指令即可</span></span><br><span class="line">    <span class="keyword">assign</span> is_auipc = (opcode == `OPCODE_AUIPC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALU 第二操作数来源</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : alu_src_selection</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_RTYPE,</span><br><span class="line">            `OPCODE_BTYPE:  alu_src = `ALUSRC_RS2;  <span class="comment">// 来自寄存器 rs2</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_ITYPE,</span><br><span class="line">            `OPCODE_LTYPE,</span><br><span class="line">            `OPCODE_STYPE,</span><br><span class="line">            `OPCODE_AUIPC,</span><br><span class="line">            `OPCODE_JALR:</span><br><span class="line">                            alu_src = `ALUSRC_IMM;  <span class="comment">// 来自立即数</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:        alu_src = `ALUSRC_RS2;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回写数据来源选择</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : wb_source_selection</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_RTYPE,</span><br><span class="line">            `OPCODE_ITYPE:  wd_sel = `WD_SEL_FROM_ALU;</span><br><span class="line"></span><br><span class="line">            `OPCODE_LTYPE:  wd_sel = `WD_SEL_FROM_DRAM;</span><br><span class="line"></span><br><span class="line">            `OPCODE_JAL,</span><br><span class="line">            `OPCODE_JALR:   wd_sel = `WD_SEL_FROM_PC4;</span><br><span class="line"></span><br><span class="line">            `OPCODE_LUI,</span><br><span class="line">            `OPCODE_AUIPC:  wd_sel = `WD_SEL_FROM_IEXT;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:        wd_sel = <span class="number">2&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寄存器堆写使能</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : rf_write_enable</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_RTYPE,</span><br><span class="line">            `OPCODE_ITYPE,</span><br><span class="line">            `OPCODE_LTYPE,</span><br><span class="line">            `OPCODE_LUI,</span><br><span class="line">            `OPCODE_AUIPC,</span><br><span class="line">            `OPCODE_JAL,</span><br><span class="line">            `OPCODE_JALR:   rf_we = <span class="number">1&#x27;b1</span>;</span><br><span class="line"></span><br><span class="line">            `OPCODE_BTYPE,</span><br><span class="line">            `OPCODE_STYPE:  rf_we = <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:        rf_we = <span class="number">1&#x27;b0</span>;  <span class="comment">// 考虑异常情况 默认不写</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据存储器写使能</span></span><br><span class="line">    <span class="keyword">assign</span> dram_we = (opcode == `OPCODE_STYPE) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALU 操作码生成</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : ALUOp_selection</span><br><span class="line">        <span class="comment">// 默认值</span></span><br><span class="line">        alu_op          = `ALU_NOP;</span><br><span class="line">        branch_type     = `BRANCH_NOP;</span><br><span class="line">        is_branch_instr = <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line"></span><br><span class="line">            `OPCODE_RTYPE, `OPCODE_ITYPE: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_ADD_SUB_MUL:</span><br><span class="line">                    <span class="comment">// 使用 case-true 结构</span></span><br><span class="line">                        <span class="keyword">case</span> (<span class="number">1&#x27;b1</span>)</span><br><span class="line">                            (opcode == `OPCODE_RTYPE) &amp;&amp;        <span class="comment">// R-Type SUB</span></span><br><span class="line">                            (funct7 == `FUNCT7_SUB):</span><br><span class="line">                                            alu_op = `ALU_SUB;</span><br><span class="line"></span><br><span class="line">                            (opcode == `OPCODE_RTYPE):          <span class="comment">// R-Type 其它（默认为 ADD）</span></span><br><span class="line">                                            alu_op = `ALU_ADD;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">default</span>:                            <span class="comment">// 非 R-type（同样默认 ADD）</span></span><br><span class="line">                                            alu_op = `ALU_ADD;</span><br><span class="line">                        <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                    `FUNCT3_SLL_MULH:       alu_op = `ALU_SLL;</span><br><span class="line">                    `FUNCT3_SLT_MULHSU:     alu_op = `ALU_SLT;</span><br><span class="line">                    `FUNCT3_SLTU_MULHU:     alu_op = `ALU_SLTU;</span><br><span class="line">                    `FUNCT3_XOR_DIV:        alu_op = `ALU_XOR;</span><br><span class="line">                    `FUNCT3_SRL_SRA_DIVU:   alu_op = (funct7 == `FUNCT7_SRA) ?</span><br><span class="line">                                                     `ALU_SRA : `ALU_SRL;</span><br><span class="line">                    `FUNCT3_OR_REM:         alu_op = `ALU_OR;</span><br><span class="line">                    `FUNCT3_AND_REMU:       alu_op = `ALU_AND;</span><br><span class="line">                    <span class="keyword">default</span>:                alu_op = `ALU_NOP;  <span class="comment">// 默认为空</span></span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_BTYPE: <span class="keyword">begin</span></span><br><span class="line">                alu_op = (funct3 == `FUNCT3_BLTU || funct3 == `FUNCT3_BGEU) ? `ALU_SLTU :</span><br><span class="line">                    `ALU_SUB;  <span class="comment">// 用于比较是否为有符号/无符号</span></span><br><span class="line">                <span class="comment">// 判断分支类型</span></span><br><span class="line">                <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_BEQ:  branch_type = `BRANCH_BEQ;</span><br><span class="line">                    `FUNCT3_BNE:  branch_type = `BRANCH_BNE;</span><br><span class="line">                    `FUNCT3_BLT:  branch_type = `BRANCH_BLT;</span><br><span class="line">                    `FUNCT3_BGE:  branch_type = `BRANCH_BGE;</span><br><span class="line">                    `FUNCT3_BLTU: branch_type = `BRANCH_BLTU;</span><br><span class="line">                    `FUNCT3_BGEU: branch_type = `BRANCH_BGEU;</span><br><span class="line">                    <span class="keyword">default</span>:      branch_type = `BRANCH_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                is_branch_instr = <span class="number">1&#x27;b1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_JAL,</span><br><span class="line">            `OPCODE_LUI:            alu_op = `ALU_RIGHT;  <span class="comment">// 特殊指令</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_JALR,</span><br><span class="line">            `OPCODE_AUIPC:          alu_op = `ALU_ADD;</span><br><span class="line"></span><br><span class="line">            `OPCODE_LTYPE: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_LB:     alu_op = `ALU_LB;</span><br><span class="line">                    `FUNCT3_LBU:    alu_op = `ALU_LBU;</span><br><span class="line">                    `FUNCT3_LH:     alu_op = `ALU_LH;</span><br><span class="line">                    `FUNCT3_LHU:    alu_op = `ALU_LHU;</span><br><span class="line">                    `FUNCT3_LW:     alu_op = `ALU_LW;</span><br><span class="line">                    <span class="keyword">default</span>:        alu_op = `ALU_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_STYPE: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_SB:     alu_op = `ALU_SB;</span><br><span class="line">                    `FUNCT3_SH:     alu_op = `ALU_SH;</span><br><span class="line">                    `FUNCT3_SW:     alu_op = `ALU_SW;</span><br><span class="line">                    <span class="keyword">default</span>:        alu_op = `ALU_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:                alu_op = `ALU_NOP;  <span class="comment">// 默认加法</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据存取类型判断</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : sl_selection</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_LTYPE: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_LB:     sl_type = `MEM_LB;</span><br><span class="line">                    `FUNCT3_LBU:    sl_type = `MEM_LBU;</span><br><span class="line">                    `FUNCT3_LH:     sl_type = `MEM_LH;</span><br><span class="line">                    `FUNCT3_LHU:    sl_type = `MEM_LHU;</span><br><span class="line">                    `FUNCT3_LW:     sl_type = `MEM_LW;</span><br><span class="line">                    <span class="keyword">default</span>:        sl_type = `MEM_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_STYPE:<span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_SB:     sl_type = `MEM_SB;</span><br><span class="line">                    `FUNCT3_SH:     sl_type = `MEM_SH;</span><br><span class="line">                    `FUNCT3_SW:     sl_type = `MEM_SW;</span><br><span class="line">                    <span class="keyword">default</span>:        sl_type = `MEM_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">default</span>:                sl_type = `MEM_NOP;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可视化输出判断</span></span><br><span class="line">    <span class="comment">//verilog_format:off</span></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">  <span class="comment">// 方便调试的 ASCII 指令输出</span></span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">256</span>-<span class="number">1</span>:<span class="number">0</span>] instr_ascii;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">256</span>-<span class="number">1</span>:<span class="number">0</span>] branch_type_ascii;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always_comb</span> <span class="keyword">begin</span> : ascii_output</span><br><span class="line">    <span class="keyword">unique</span> <span class="keyword">case</span> (branch_type)</span><br><span class="line">      `BRANCH_NOP:        branch_type_ascii = <span class="string">&quot;BRANCH_NOP&quot;</span>;</span><br><span class="line">      `BRANCH_BEQ:        branch_type_ascii = <span class="string">&quot;BRANCH_BEQ&quot;</span>;</span><br><span class="line">      `BRANCH_BNE:        branch_type_ascii = <span class="string">&quot;BRANCH_BNE&quot;</span>;</span><br><span class="line">      `BRANCH_BLT:        branch_type_ascii = <span class="string">&quot;BRANCH_BLT&quot;</span>;</span><br><span class="line">      `BRANCH_BGE:        branch_type_ascii = <span class="string">&quot;BRANCH_BGE&quot;</span>;</span><br><span class="line">      `BRANCH_BLTU:       branch_type_ascii = <span class="string">&quot;BRANCH_BLTU&quot;</span>;</span><br><span class="line">      `BRANCH_BGEU:       branch_type_ascii = <span class="string">&quot;BRANCH_BGEU&quot;</span>;</span><br><span class="line">      `BRANCH_JALR:       branch_type_ascii = <span class="string">&quot;BRANCH_JALR&quot;</span>;</span><br><span class="line">      <span class="keyword">default</span>:            branch_type_ascii = <span class="string">&quot;BRANCH_UNKNOWN&quot;</span>;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line">    <span class="comment">// 判断当前具体为32条基本指令的哪一条</span></span><br><span class="line">    <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">      `OPCODE_LUI:              instr_ascii = <span class="string">&quot;LUI&quot;</span>;</span><br><span class="line">      `OPCODE_AUIPC:            instr_ascii = <span class="string">&quot;AUIPC&quot;</span>;</span><br><span class="line">      `OPCODE_JAL:              instr_ascii = <span class="string">&quot;JAL&quot;</span>;</span><br><span class="line">      `OPCODE_JALR:             instr_ascii = <span class="string">&quot;JALR&quot;</span>;</span><br><span class="line"></span><br><span class="line">      `OPCODE_BTYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_BEQ:          instr_ascii = <span class="string">&quot;BEQ&quot;</span>;</span><br><span class="line">          `FUNCT3_BNE:          instr_ascii = <span class="string">&quot;BNE&quot;</span>;</span><br><span class="line">          `FUNCT3_BLT:          instr_ascii = <span class="string">&quot;BLT&quot;</span>;</span><br><span class="line">          `FUNCT3_BGE:          instr_ascii = <span class="string">&quot;BGE&quot;</span>;</span><br><span class="line">          `FUNCT3_BLTU:         instr_ascii = <span class="string">&quot;BLTU&quot;</span>;</span><br><span class="line">          `FUNCT3_BGEU:         instr_ascii = <span class="string">&quot;BGEU&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;B_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      `OPCODE_LTYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_LB:           instr_ascii = <span class="string">&quot;LB&quot;</span>;</span><br><span class="line">          `FUNCT3_LH:           instr_ascii = <span class="string">&quot;LH&quot;</span>;</span><br><span class="line">          `FUNCT3_LW:           instr_ascii = <span class="string">&quot;LW&quot;</span>;</span><br><span class="line">          `FUNCT3_LBU:          instr_ascii = <span class="string">&quot;LBU&quot;</span>;</span><br><span class="line">          `FUNCT3_LHU:          instr_ascii = <span class="string">&quot;LHU&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;L_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      `OPCODE_STYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_SB:           instr_ascii = <span class="string">&quot;SB&quot;</span>;</span><br><span class="line">          `FUNCT3_SH:           instr_ascii = <span class="string">&quot;SH&quot;</span>;</span><br><span class="line">          `FUNCT3_SW:           instr_ascii = <span class="string">&quot;SW&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;S_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      `OPCODE_ITYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_ADD_SUB_MUL:  instr_ascii = <span class="string">&quot;ADDI&quot;</span>;</span><br><span class="line">          `FUNCT3_SLL_MULH:     instr_ascii = <span class="string">&quot;SLLI&quot;</span>;</span><br><span class="line">          `FUNCT3_SLT_MULHSU:   instr_ascii = <span class="string">&quot;SLTI&quot;</span>;</span><br><span class="line">          `FUNCT3_SLTU_MULHU:   instr_ascii = <span class="string">&quot;SLTIU&quot;</span>;</span><br><span class="line">          `FUNCT3_XOR_DIV:      instr_ascii = <span class="string">&quot;XORI&quot;</span>;</span><br><span class="line">          `FUNCT3_SRL_SRA_DIVU: instr_ascii = (funct7 == `FUNCT7_SRAI) ? <span class="string">&quot;SRAI&quot;</span> : <span class="string">&quot;SRLI&quot;</span>;</span><br><span class="line">          `FUNCT3_OR_REM:       instr_ascii = <span class="string">&quot;ORI&quot;</span>;</span><br><span class="line">          `FUNCT3_AND_REMU:     instr_ascii = <span class="string">&quot;ANDI&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;I_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      `OPCODE_RTYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_ADD_SUB_MUL: <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span> (funct7 == `FUNCT7_SUB)</span><br><span class="line">                                instr_ascii = <span class="string">&quot;SUB&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (funct7 == `FUNCT7_ADD)</span><br><span class="line">                                instr_ascii = <span class="string">&quot;ADD&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span>                instr_ascii = <span class="string">&quot;R_UNKNOWN&quot;</span>;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          `FUNCT3_SLL_MULH:     instr_ascii = <span class="string">&quot;SLL&quot;</span>;</span><br><span class="line">          `FUNCT3_SLT_MULHSU:   instr_ascii = <span class="string">&quot;SLT&quot;</span>;</span><br><span class="line">          `FUNCT3_SLTU_MULHU:   instr_ascii = <span class="string">&quot;SLTU&quot;</span>;</span><br><span class="line">          `FUNCT3_XOR_DIV:      instr_ascii = <span class="string">&quot;XOR&quot;</span>;</span><br><span class="line">          `FUNCT3_SRL_SRA_DIVU: <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span> (funct7 == `FUNCT7_SRA)</span><br><span class="line">                                instr_ascii = <span class="string">&quot;SRA&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (funct7 == `FUNCT7_SRL)</span><br><span class="line">                                instr_ascii = <span class="string">&quot;SRL&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span>                instr_ascii = <span class="string">&quot;R_UNKNOWN&quot;</span>;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          `FUNCT3_OR_REM:       instr_ascii = <span class="string">&quot;OR&quot;</span>;</span><br><span class="line">          `FUNCT3_AND_REMU:     instr_ascii = <span class="string">&quot;AND&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;R_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:                  instr_ascii = <span class="string">&quot;ERROR&quot;</span>;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="立即数扩展模块-imm-extener-sv">立即数扩展模块 imm_extener.sv</h3><p>立即数扩展模块也是<strong>组合逻辑模块</strong>。不需要接受译码器传出的信号，而是和译码器并行工作，同样接受32位指令<code>instr</code>后进行分类处理。当然可以写在<code>Decoder.v</code>，但是那样子有点乱。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> imm_extender (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm_out</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] opcode;</span><br><span class="line">    <span class="keyword">assign</span> opcode = instr[<span class="number">6</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : imm_classifier</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_ITYPE, `OPCODE_LTYPE, `OPCODE_JALR: <span class="keyword">begin</span>  <span class="comment">// I-type</span></span><br><span class="line">                <span class="comment">// 先输出立即数</span></span><br><span class="line">                <span class="comment">// 之后再根据 instr[30] 区分 SLLI/SRLI和SRAI</span></span><br><span class="line">                imm_out = &#123;&#123;<span class="number">20</span>&#123;instr[<span class="number">31</span>]&#125;&#125;, instr[<span class="number">31</span>:<span class="number">20</span>]&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            `OPCODE_BTYPE: <span class="keyword">begin</span>  <span class="comment">// B-type</span></span><br><span class="line">                imm_out = &#123;&#123;<span class="number">20</span>&#123;instr[<span class="number">31</span>]&#125;&#125;, instr[<span class="number">7</span>], instr[<span class="number">30</span>:<span class="number">25</span>], instr[<span class="number">11</span>:<span class="number">8</span>], <span class="number">1&#x27;b0</span>&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            `OPCODE_JAL: <span class="keyword">begin</span>  <span class="comment">// J-type</span></span><br><span class="line">                imm_out = &#123;&#123;<span class="number">12</span>&#123;instr[<span class="number">31</span>]&#125;&#125;, instr[<span class="number">19</span>:<span class="number">12</span>], instr[<span class="number">20</span>], instr[<span class="number">30</span>:<span class="number">21</span>], <span class="number">1&#x27;b0</span>&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            `OPCODE_STYPE: <span class="keyword">begin</span>  <span class="comment">// S-type</span></span><br><span class="line">                imm_out = &#123;&#123;<span class="number">20</span>&#123;instr[<span class="number">31</span>]&#125;&#125;, instr[<span class="number">31</span>:<span class="number">25</span>], instr[<span class="number">11</span>:<span class="number">7</span>]&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            `OPCODE_AUIPC, `OPCODE_LUI: <span class="keyword">begin</span>  <span class="comment">// U-type</span></span><br><span class="line">                imm_out = &#123;instr[<span class="number">31</span>:<span class="number">12</span>], <span class="number">12&#x27;b0</span>&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                imm_out = <span class="number">32&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure><p>当然，你也完全可以只传递PC然后再EX级进行移位，或者干脆合并进ALU。但是，流水线延迟最大的一级往往就是EX级，应当尽可能地减轻其负担。所以，将移位器往前移、未来的存取单元往后移。</p><h2 id="ID-EX级-流水线寄存器-PR-ID-EX-sv">ID/EX级 流水线寄存器 PR_ID_EX.sv</h2><p>终于，要进入下一阶段了。ID/EX级的流水线寄存器可谓是相当重要，重要性仅次于EX/MEM级，因为这一级中转了各类数据以及地址——还有未来的数据前递入口。</p><p>我们要接收译码器传出的各种控制信号，包括ALU的操作数来源<code>is_auipc</code>和<code>alu_src</code>。根据译码器判断，对于S-Type指令，在MEM级还需要写入DRAM，因此还有写使能<code>dram_we</code>，或者是寄存器写使能<code>rf_we</code>。</p><p>还有什么？别忘了判断指令存取类型的<code>sl_type</code>，后面需要在MEM级用到。</p><div class="note warning flat"><p>即使RISC-V不强制要求支持非对齐访存，<code>lb/lh</code>等指令也必须支持！</p></div><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> PR_ID_EX (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 流水线控制信号</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        flush,</span><br><span class="line">    <span class="comment">// ID级输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_id_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_id_i,</span><br><span class="line">    <span class="comment">// input  logic [31:0] instr_id_i,</span></span><br><span class="line">    <span class="comment">// ID级输出 给EX级输入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_ex_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_ex_o,</span><br><span class="line">    <span class="comment">// output logic [31:0] instr_ex_o,</span></span><br><span class="line">    <span class="comment">// 判断指令是否有效</span></span><br><span class="line">    <span class="comment">// 流水线冲刷时需要将指令置为无效</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        instr_valid_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        instr_valid_ex_o,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寄存器堆第一寄存器数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD1_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD1_o,</span><br><span class="line">    <span class="comment">// 寄存器堆第二寄存器数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD2_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD2_o,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALUOp</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] alu_op_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] alu_op_ex_o,</span><br><span class="line">    <span class="comment">// ALU第一操作数来源 判断AUIPC</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        is_auipc_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        is_auipc_ex_o,</span><br><span class="line">    <span class="comment">// ALU第二操作数来源</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_src2_sel_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        alu_src2_sel_ex_o,</span><br><span class="line">    <span class="comment">// 写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        dram_we_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        dram_we_ex_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rf_we_ex_o,</span><br><span class="line">    <span class="comment">// 写回数据来源</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_ex_o,</span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_ex_o,</span><br><span class="line">    <span class="comment">// 分支跳转</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        is_branch_instr_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        is_branch_instr_ex_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] branch_type_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] branch_type_ex_o,</span><br><span class="line">    <span class="comment">// 跳转相关</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] jump_type_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] jump_type_ex_o,</span><br><span class="line">    <span class="comment">// 读取类型</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type_ex_o,</span><br><span class="line">    <span class="comment">// 立即数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm_ex_o,</span><br><span class="line">    <span class="comment">// PC跳转时地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_jump_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_jump_ex_o</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_ff</span>@(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寄存器堆数据</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            rD1_o &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            rD2_o &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> b</span><br><span class="line">            rD1_o &lt;= rD1_i;</span><br><span class="line">            rD2_o &lt;= rD2_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分支跳转相关</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            is_branch_instr_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            branch_type_ex_o     &lt;= <span class="number">3&#x27;b0</span>;</span><br><span class="line">            jump_type_ex_o       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush) <span class="keyword">begin</span></span><br><span class="line">            is_branch_instr_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            branch_type_ex_o     &lt;= <span class="number">3&#x27;b0</span>;</span><br><span class="line">            jump_type_ex_o       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            is_branch_instr_ex_o &lt;= is_branch_instr_id_i;</span><br><span class="line">            branch_type_ex_o     &lt;= branch_type_id_i;</span><br><span class="line">            jump_type_ex_o       &lt;= jump_type_id_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALUOp相关</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            alu_op_ex_o       &lt;= <span class="number">4&#x27;b0</span>;</span><br><span class="line">            is_auipc_ex_o     &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            alu_src2_sel_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            dram_we_ex_o      &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            sl_type_ex_o      &lt;= <span class="number">3&#x27;b0</span>;</span><br><span class="line">            imm_ex_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush) <span class="keyword">begin</span></span><br><span class="line">            alu_op_ex_o       &lt;= <span class="number">4&#x27;b0</span>;</span><br><span class="line">            is_auipc_ex_o     &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            alu_src2_sel_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            dram_we_ex_o      &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            sl_type_ex_o      &lt;= sl_type_id_i;</span><br><span class="line">            imm_ex_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            alu_op_ex_o       &lt;= alu_op_id_i;</span><br><span class="line">            is_auipc_ex_o     &lt;= is_auipc_id_i;</span><br><span class="line">            alu_src2_sel_ex_o &lt;= alu_src2_sel_id_i;</span><br><span class="line">            dram_we_ex_o      &lt;= dram_we_id_i;</span><br><span class="line">            sl_type_ex_o      &lt;= sl_type_id_i;</span><br><span class="line">            imm_ex_o          &lt;= imm_id_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写回来源</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            pc_ex_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            pc4_ex_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">            rf_we_ex_o       &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            wd_sel_ex_o      &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            pc_jump_ex_o     &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush &amp;&amp; pc_id_i) <span class="keyword">begin</span>  <span class="comment">// 确保不是因为流水线暂停引起的冲刷</span></span><br><span class="line">            pc_ex_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            pc4_ex_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">            rf_we_ex_o       &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            wd_sel_ex_o      &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            pc_jump_ex_o     &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            pc_ex_o          &lt;= pc_id_i;</span><br><span class="line">            pc4_ex_o         &lt;= pc4_id_i;</span><br><span class="line">            instr_valid_ex_o &lt;= instr_valid_id_i;</span><br><span class="line"></span><br><span class="line">            rf_we_ex_o       &lt;= rf_we_id_i;</span><br><span class="line">            wd_sel_ex_o      &lt;= wd_sel_id_i;</span><br><span class="line">            pc_jump_ex_o     &lt;= pc_jump_id_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            wr_ex_o &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush) <span class="keyword">begin</span></span><br><span class="line">            wr_ex_o &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            wr_ex_o &lt;= wr_id_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>至此，ID级也构建完成了。后面的，就是复杂的计算、疯狂的前递、吉列的<s>数据</s>斗争了。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;译码-ID级-设计&quot;&gt;译码 ID级 设计&lt;/h2&gt;
&lt;p&gt;提到译码级，那就得是译码器啊。纯组合逻辑，包你写到爽。&lt;/p&gt;
&lt;p&gt;译码级还有什么？立即数移位也需要放在ID级，以减轻EX级</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第四篇</title>
    <link href="https://blog.esing.dev/2025/12/05/riscvcod-p4/"/>
    <id>https://blog.esing.dev/2025/12/05/riscvcod-p4/</id>
    <published>2025-12-05T15:02:05.000Z</published>
    <updated>2025-12-20T10:46:49.183Z</updated>
    
    <content type="html"><![CDATA[<h2 id="从零构建前的准备">从零构建前的准备</h2><h3 id="设计思路">设计思路</h3><p>理论知识已经准备好了，接下来该开始实践了。</p><p>如何从零开始写一个CPU？</p><p>首先要明确ISA架构：我们需要支持哪些指令？RV32的拓展很多很多，比如<code>MIAFD</code>等等。我们可以实现一个“精简版”的<code>RV32I</code>指令集CPU——连里面的<code>ecall</code>和<code>ebreak</code>都不实现。只要满足基础的38条（甚至只支持<code>lw/sw</code>，不考虑非对齐访存），就能运行80%的C语言程序。至于<code>Zicsr</code>扩展和<code>M</code>扩展等，在构建完毕后再考虑。</p><p>然后，是微架构设计：是做单周期还是多周期，亦或者流水线？是做顺序还是乱序？单发射还是多发射？饭要一口口吃，步子迈太大了容易扯着蛋。因此，做一个经典的五级流水线、顺序单发射的CPU即可。</p><p>然后，保持一个清醒的头脑。即使是一个最简单的<code>RV32I</code>CPU，也需要不下于10个模块。所有的代码加起来可能连3000行都不到，但是其中的连线无比复杂。如果不在写之前就想好，很容易莫名其妙地丢掉一条连线、一个端口，然后看波形debug半天。</p><p>时刻要记住：切不可“只见树木、不见森林”——不建议一个一个模块写，而是创建好文件后问自己：</p><ul><li>这个模块的功能是什么？</li><li>这个模块是组合逻辑电路还是时序逻辑电路？</li><li>这个模块需要哪些控制信号？</li><li>这个模块需要输出什么数据？输出给谁？</li></ul><p>边考虑这些问题边创建文件，然后，类似参考书上的指导，构建数据通路。可以不写出来，但要想清楚，哪些数据会在寄存器之间流动，并被传递到下一级流水线。等每个文件的大体框架搭建完毕，再从易到难、从组合逻辑到时序逻辑完成。一级一级流水线向前推进，写完某一级后继续完成两级之间的流水线寄存器设计。</p><h3 id="参考资料">参考资料</h3><p><a href="https://github.com/xuanhao44/HITSZ-miniRVCPU">xuanhao44 - HITSZ-miniRVCPU</a></p><h3 id="开发环境">开发环境</h3><p>参考 <a href="/2024/01/18/vscode-verilog-setup/" title="VSCode配置Verilog开发环境">VSCode配置Verilog开发环境</a> 即可。</p><div class="note primary flat"><p>这里安利一下一个超级棒的的VSCode插件：<a href="https://marketplace.visualstudio.com/items?itemName=sterben.fpga-support">Digital IDE</a></p><p>内部集成了一件模块测试、代码高亮与格式化、快速跳转等。虽然生成模块图的功能有些BUG，但是依旧非常强，瑕不掩瑜！</p><p>现在写Verilog都用它了。绝赞！</p></div><h2 id="取指-IF级-设计">取指 IF级 设计</h2><p>IF级取出指令，因此模块很少，只要实现PC程序计数器和IROM即可。</p><h3 id="程序计数器-PC-sv">程序计数器 PC.sv</h3><p>显然，程序计数器是<strong>时序逻辑模块</strong>。这里将<code>PC+4</code>的计算也合并到PC模块内。</p><p>程序计数器要干什么？既要计算出下一时刻的PC，还要考虑是否发生分支跳转——这里要接受来自<code>EX</code>级的跳转发生信号，因为B-Type类指令到<code>EX</code>级才能得出结果。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PC (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 是否要打一拍 保持PC </span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        keep_pc,</span><br><span class="line">    <span class="comment">// 进行分支跳转</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        branch_op,</span><br><span class="line">    <span class="comment">// 分支跳转目标地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] branch_target,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_if,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_if</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] npc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        pc4_if = pc_if + <span class="number">4</span>;</span><br><span class="line">        npc    = branch_op ? branch_target : pc4_if;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n)       pc_if &lt;= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (keep_pc) pc_if &lt;= pc_if;</span><br><span class="line">        <span class="keyword">else</span>              pc_if &lt;= npc;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="指令存储器-IROM-sv">指令存储器 IROM.sv</h3><p>IROM即存放程序代码的Flash，只读，不依赖任何时钟信号，因此是<strong>组合逻辑模块</strong>。通常来说，IROM（指令存储器）会被放在译码级，但不自行封装时，我们也会给CPU接出<code>instr</code>和<code>pc</code>到厂商的 IROM IP核。为了方便思考，此处放在IF级即可。为了便于仿真，这里自己实现一个支持加载hex文件的IROM。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IROM 行为模型 - 用于仿真</span></span><br><span class="line"><span class="comment">// 替代 Xilinx IP 核</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> IROM (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">wire</span> [<span class="number">13</span>:<span class="number">0</span>] a,   <span class="comment">// 地址输入 (14位 = 16K words)</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span>  [<span class="number">31</span>:<span class="number">0</span>] spo  <span class="comment">// 数据输出</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指令存储器 - 16K x 32bit</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] rom_data[<span class="number">16384</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文件加载指令</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">integer</span> i;</span><br><span class="line">        <span class="keyword">string</span>  rom_file;  <span class="comment">// 字符串缓冲区</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">16384</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// rom_data[i] = 32&#x27;h00000013;  // NOP</span></span><br><span class="line">            rom_data[i] = <span class="number">32&#x27;h0d000721</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尝试从文件加载指令</span></span><br><span class="line">        <span class="comment">// if ($value$plusargs(&quot;IROM=%s&quot;, rom_file)) begin</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            rom_file =</span><br><span class="line">            <span class="comment">// &quot;user/data/hex/simple_test.hex&quot;</span></span><br><span class="line">            <span class="string">&quot;user/data/hex/jalr.hex&quot;</span></span><br><span class="line">            <span class="comment">// &quot;user/data/hex/myFirstTest.hex&quot;</span></span><br><span class="line">            <span class="comment">// &quot;user/data/hex/no_hazard.hex&quot;</span></span><br><span class="line">            <span class="comment">// &quot;user/data/hex/loaduse_test.hex&quot;</span></span><br><span class="line">            <span class="comment">// &quot;user/data/hex/hazard12.hex&quot;</span></span><br><span class="line">            ;</span><br><span class="line">            <span class="built_in">$readmemh</span>(rom_file, rom_data);</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;IROM: Loaded instructions from %s&quot;</span>, rom_file);</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 如果没有指定文件,加载默认的测试程序</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;IROM: Loading default test program&quot;</span>);</span><br><span class="line">            load_default_program();</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取数据 (组合逻辑)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        spo = rom_data[a];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载默认测试程序</span></span><br><span class="line">    <span class="keyword">task</span> <span class="keyword">automatic</span> load_default_program;</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 更复杂的测试程序 - 测试算术、逻辑、移位指令和数据冒险</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;IROM: Default test program loaded&quot;</span>);</span><br><span class="line">            rom_data[<span class="number">0</span>] = <span class="number">32&#x27;h00500093</span>;  <span class="comment">// addi x1, x0, 5      x1 = 5</span></span><br><span class="line">            rom_data[<span class="number">1</span>] = <span class="number">32&#x27;h00300113</span>;  <span class="comment">// addi x2, x0, 3      x2 = 3</span></span><br><span class="line">            rom_data[<span class="number">2</span>] = <span class="number">32&#x27;h002081b3</span>;  <span class="comment">// add  x3, x1, x2     x3 = x1 + x2 = 8</span></span><br><span class="line">            rom_data[<span class="number">3</span>] = <span class="number">32&#x27;h40208233</span>;  <span class="comment">// sub  x4, x1, x2     x4 = x1 - x2 = 2</span></span><br><span class="line">            rom_data[<span class="number">4</span>] = <span class="number">32&#x27;h0020f2b3</span>;  <span class="comment">// and  x5, x1, x2     x5 = x1 &amp; x2 = 1</span></span><br><span class="line">            rom_data[<span class="number">5</span>] = <span class="number">32&#x27;h0020e333</span>;  <span class="comment">// or   x6, x1, x2     x6 = x1 | x2 = 7</span></span><br><span class="line">            rom_data[<span class="number">6</span>] = <span class="number">32&#x27;h002093b3</span>;  <span class="comment">// sll  x7, x1, x2     x7 = x1 &lt;&lt; x2 = 40</span></span><br><span class="line">            rom_data[<span class="number">7</span>] = <span class="number">32&#x27;h0020c433</span>;  <span class="comment">// xor  x8, x1, x2     x8 = x1 ^ x2 = 6</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>hex文件加载方式可以选择手动指定路径，也可以选择编译时传入，后者配合Makefile文件很方便，不过我选择DIDE的一键仿真。</p><h2 id="IF-ID级-流水线寄存器-PR-IF-ID-sv">IF/ID级 流水线寄存器 PR_IF_ID.sv</h2><p>终于到了第一道坎：两级之间的流水线寄存器。</p><p>流水线寄存器起到一个承上启下的作用，在两个阶段之间保存数据，使得指令可以连续执行。</p><p>都寄存器了，那肯定是<strong>时序逻辑模块</strong>了。</p><p>我们需要哪些信号？</p><p>首先是<code>PC</code>和<code>PC+4</code>，其中<code>PC+4</code>因为分支跳转和<code>jal/jalr</code>指令的需求，要一直送到<code>EX</code>级。接着是当前的指令，要送入下一级的译码器。</p><p>还有什么？我们肯定需要处理流水线的竞争冒险，而不能简单打一拍——就算打一拍，也要有相应的控制信号。因此，还需要<code>flush</code>和<code>stall</code>这两个控制信号，来控制IF级是否冲刷、是否停顿。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;./<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> PR_IF_ID (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 流水线控制信号</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        flush,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        stall,</span><br><span class="line">    <span class="comment">// IF级输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_if_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_if_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr_if_i,</span><br><span class="line">    <span class="comment">// IF级输出 给ID级输入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_id_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_id_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr_id_o,</span><br><span class="line">    <span class="comment">// 判断指令是否有效</span></span><br><span class="line">    <span class="comment">// 流水线冲刷时需要将指令置为无效</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        instr_valid_if_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        instr_valid_id_o</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            pc_id_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            pc4_id_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_id_o       &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_id_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush) <span class="keyword">begin</span></span><br><span class="line">            pc_id_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            pc4_id_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_id_o       &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_id_o &lt;= <span class="number">1&#x27;b0</span>;  <span class="comment">// 冲刷时指令无效</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (stall) <span class="keyword">begin</span></span><br><span class="line">            pc_id_o          &lt;= pc_id_o;</span><br><span class="line">            pc4_id_o         &lt;= pc4_id_o;</span><br><span class="line">            instr_id_o       &lt;= instr_id_o;</span><br><span class="line">            instr_valid_id_o &lt;= instr_valid_id_o;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            pc_id_o          &lt;= pc_if_i;</span><br><span class="line">            pc4_id_o         &lt;= pc4_if_i;</span><br><span class="line">            instr_id_o       &lt;= instr_if_i;</span><br><span class="line">            instr_valid_id_o &lt;= instr_valid_if_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>至此，IF级完毕。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;从零构建前的准备&quot;&gt;从零构建前的准备&lt;/h2&gt;
&lt;h3 id=&quot;设计思路&quot;&gt;设计思路&lt;/h3&gt;
&lt;p&gt;理论知识已经准备好了，接下来该开始实践了。&lt;/p&gt;
&lt;p&gt;如何从零开始写一个CPU</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
  </entry>
  
  <entry>
    <title>Cloudflare、睡覺——大规模宕机后的随想</title>
    <link href="https://blog.esing.dev/2025/11/18/cloudflare-offline-oneday/"/>
    <id>https://blog.esing.dev/2025/11/18/cloudflare-offline-oneday/</id>
    <published>2025-11-18T14:45:37.000Z</published>
    <updated>2025-11-19T02:56:36.593Z</updated>
    
    <content type="html"><![CDATA[<div class="note orange icon-padding flat"><i class="note-icon fab fa-cloudflare"></i><p>写于2025.11.18，纪念 Cloudflare 发生的大规模故障。</p></div><p>今年真是个多事之年啊。</p><p>开着组会呢，网站突然就打不开了，接着就是熟悉的小黄云500。还以为是源站挂了，随即关了浏览器再开。好家伙，GPT也卡在前面的Cloudflare Challenge 认证界面。这才意识到：Cloudflare，大抵是又<strong>炸</strong>了。而这，已经是今年的第三次了。</p><p><strong>网络菩萨、赛博义父，终究要顶不住这泼天的“流量”了吗。</strong></p><hr><p>翻了下Telegram，几乎所有群组都炸锅了：“Cloudflare” “宕机” “攻击” 的字样层出不穷。谁也不知道，究竟是一个员工的无心之举，还是一个部门的一次部署失误，亦或是什么组织的大规模网络攻击，导致了这一场灾难。微信群里同样炸了锅：同学嚷嚷着自己看文献的网站打不开、ChatGPT进不去……就连我的博客和一系列Cloudflare Workers服务也没能幸免于难，只剩下了前几天新搭建的 <a href="/2025/10/31/onelastkiss-image/" title="One Last Kiss 风格图片生成">OneLastKiss生成器</a> 还活着 TuT</p><p>看着<a href="https://www.cloudflarestatus.com/">Cloudflare Status</a>那色彩缤纷的<span style="color:#DA304C;">三</span><span style="color:#FBAE40;">色</span><span style="color:#2C7CB0;">条</span>，我不由得希望，今年结束之前不要再见到它。</p><img src="https://webp.esing.dev/img/-6116001428162677917_119_251118_2311_fD5D.jpg" alt="MJJ最不想看见的颜色（笑）" style="zoom:25%;" /><p>过了几分钟，就连监控Cloudflare状态的<a href="https://www.cloudflarestatus.com/">Cloudflare Status</a>也炸了。</p><img src="https://webp.esing.dev/img/-6116318431108861140_119_251118_2307_bqC2.jpg" alt="彻底爆炸的Cloudflare Status" style="zoom:25%;" /><p>不过还有一部分企业网站幸免于难，比如<a href="https://csgo.com/">CSGO国际官网</a>，可能是Enterprise有着不同线路？毕竟ChatGPT挂掉的也只是人机验证部分。这么算来，粗略估算的话，世界上有<strong>五分之一</strong>的网站应该都受到了影响——从DNS到静态页面托管，再到反向代理。不愧是你，Cloudflare。</p><hr><p>在两个小时后，22:50，官方终于发消息称修复完毕。<a href="https://t.me/vps_xhq/766">VPS信号旗播报</a>也给到了<span style="color:#FBAE40;">Level B</span>的重要等级。只能说小老弟还得多练，想达到你谷哥<a href="https://t.me/vps_xhq/161">以前</a>的<span style="color:#DA304C;">Level A</span>还有很长的路呢。</p><hr><p>我想到了《球状闪电》。</p><p><em><strong>“摧毁芯片的宏聚变可以使地球这块大硬盘被格式化，越先进的国家受到的打击就越大。而在向信息时代的恢复过程中，将出现一个不确定的全新的世界格局。”</strong></em></p><p>倘若真有一日，互联网全部瘫痪——或是更严重，如同《全频段阻塞干扰》那样——人类的生活会怎么样？<strong>是于废墟中携手重建往日的信息时代，还是借混乱之时重建各自渴望的世界格局？</strong></p><hr><p>一觉醒来，Cloudflare也发了<a href="https://blog.cloudflare.com/18-november-2025-outage/">官方声明</a>，解释本次故障原因：</p><blockquote><p>故障是由于工程师更改了一个数据库系统的权限所引发的。该设置会导致数据库向 Bot 管理系统所使用的“特征文件（feature file）”中输出多重条目，进而导致该特征文件的大小翻了一番。随后，有问题的特征文件被分发到了网络中的所有机器上。</p><p>网络中的设备软件对特征文件的大小设定了上限，而翻倍后的文件超过了这一限制，导致软件崩溃。</p></blockquote><p>Cloudflare 一度怀疑这是由超大规模 DDoS 攻击引起的，但很快锁定了核心问题，成功阻止了体积异常的特征文件进一步传播。将其替换为该文件的早期版本后核心流量基本恢复正常流转。但随着流量重新涌入，Cloudflare 最终耗费了数小时来缓解网络各部分增加的负载。</p><p>果然是工程师的误操作导致的，唉草台班子 ^__^。不知道工程师是不是被拉去祭天了？这每秒损失可不是挖断国防光缆能比的。</p>]]></content>
    
    
    <summary type="html">写于2025.11.18，纪念 Cloudflare 发生的大规模故障。</summary>
    
    
    
    <category term="随笔" scheme="https://blog.esing.dev/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="Cloudflare" scheme="https://blog.esing.dev/tags/Cloudflare/"/>
    
    <category term="代理" scheme="https://blog.esing.dev/tags/%E4%BB%A3%E7%90%86/"/>
    
    <category term="Workers" scheme="https://blog.esing.dev/tags/Workers/"/>
    
  </entry>
  
  <entry>
    <title>更适合Powershell体质的ln</title>
    <link href="https://blog.esing.dev/2025/11/17/powershell-ln/"/>
    <id>https://blog.esing.dev/2025/11/17/powershell-ln/</id>
    <published>2025-11-17T06:13:32.000Z</published>
    <updated>2025-11-17T06:22:14.360Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>在<a href="/2025/10/20/powershell-grep/" title="更适合Powershell体质的grep">更适合Powershell体质的grep</a>中重定义了<code>grep</code>。Linux中的<code>ln</code>命令也非常好用，创建软链接，可以省下很多需要复用的文件空间。</p><p>没想到Powershell中没办法使用cmd的<code>mklink</code>，自带的创建软连接命令比我命还长。自己写一个脚本重定向！</p><h2 id="代码">代码</h2><p>因为不能执行cmd命令，只能使用Powershell函数，因此新建一个<code>ln.psm1</code>模块，并保存到<code>C:\Users\UserName\Documents\PowerShell\Modules\ln</code>，在Powershell初始化时导入即可。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ln</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">param</span>(</span><br><span class="line">        [<span class="type">switch</span>]<span class="variable">$d</span>,      <span class="comment"># -d: 强制目录链接</span></span><br><span class="line">        [<span class="type">switch</span>]<span class="variable">$h</span>,      <span class="comment"># -h: 显示帮助</span></span><br><span class="line">        [<span class="built_in">string</span>]<span class="variable">$target</span>,</span><br><span class="line">        [<span class="built_in">string</span>]<span class="variable">$link</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ======== 彩色帮助 ========</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$h</span> <span class="operator">-or</span> <span class="operator">-not</span> <span class="variable">$target</span> <span class="operator">-or</span> <span class="operator">-not</span> <span class="variable">$link</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span>  <span class="comment"># 空行</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;ln: create symbolic link &quot;</span> <span class="literal">-ForegroundColor</span> Cyan <span class="literal">-NoNewline</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;(PowerShell version)&quot;</span> <span class="literal">-ForegroundColor</span> DarkGray</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Usage:&quot;</span> <span class="literal">-ForegroundColor</span> Yellow</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  ln [-d] &lt;target&gt; &lt;link&gt;&quot;</span> <span class="literal">-ForegroundColor</span> White</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Options:&quot;</span> <span class="literal">-ForegroundColor</span> Yellow</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  -d        create directory symbolic link&quot;</span> <span class="literal">-ForegroundColor</span> White</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  -h        display this help&quot;</span> <span class="literal">-ForegroundColor</span> White</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Examples:&quot;</span> <span class="literal">-ForegroundColor</span> Yellow</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  ln C:\real\file.txt C:\link\file.txt&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  ln C:\realDir C:\linkDir&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  ln -d C:\realDir C:\linkDir&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ======== 参数检查 ========</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">-not</span> (<span class="built_in">Test-Path</span> <span class="variable">$target</span>)) &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;ln: target &#x27;<span class="variable">$target</span>&#x27; not found&quot;</span> <span class="literal">-ForegroundColor</span> Red</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ======== 设置类型（SymbolicLink）========</span></span><br><span class="line">    <span class="variable">$itemType</span> = <span class="string">&quot;SymbolicLink&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ======== 创建符号链接 ========</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">New-Item</span> <span class="literal">-ItemType</span> <span class="variable">$itemType</span> <span class="literal">-Path</span> <span class="variable">$link</span> <span class="literal">-Target</span> <span class="variable">$target</span> | <span class="built_in">Out-Null</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;ln: created symbolic link &quot;</span> <span class="literal">-ForegroundColor</span> Cyan <span class="literal">-NoNewline</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&#x27;<span class="variable">$link</span>&#x27;&quot;</span> <span class="literal">-ForegroundColor</span> Green <span class="literal">-NoNewline</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot; → &quot;</span> <span class="literal">-ForegroundColor</span> DarkGray <span class="literal">-NoNewline</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&#x27;<span class="variable">$target</span>&#x27;&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;ln: failed to create link: <span class="variable">$</span>(<span class="variable">$_</span>.Exception.Message)&quot;</span> <span class="literal">-ForegroundColor</span> Red</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在Powershell里执行<code>$PROFILE</code>即可看到配置文件位置，一般在<code>C:\Users\UserName\Documents\PowerShell\Microsoft.PowerShell_profile.ps1</code>。</p><p>在末尾加上<code>Import-Module ln</code>即可。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;在&lt;a href=&quot;/2025/10/20/powershell-grep/&quot; title=&quot;更适合Powershell体质的grep&quot;&gt;更适合Power</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="Powershell" scheme="https://blog.esing.dev/tags/Powershell/"/>
    
  </entry>
  
  <entry>
    <title>降低腾讯ACE反作弊扫盘优先级并提升游戏性能</title>
    <link href="https://blog.esing.dev/2025/11/15/fuckoff-aceguard/"/>
    <id>https://blog.esing.dev/2025/11/15/fuckoff-aceguard/</id>
    <published>2025-11-15T12:53:32.000Z</published>
    <updated>2025-11-15T12:56:53.818Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>打大乱斗动不动就卡，太烦了。这B反作弊跟小蓝熊坐一桌去。</p><h2 id="注册表修改">注册表修改</h2><p>参考：<a href="https://www.bilibili.com/video/av115529217998860">解决英雄联盟LOL卡顿掉帧问题很多方法都没用的试下这个 - 哔哩哔哩</a></p><p>新建一个注册表文件<code>1.reg</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\DeltaForceClient-Win64-Shipping.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000003</span><br><span class="line">&quot;IoPriority&quot;=dword:00000003</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\League of Legends.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000003</span><br><span class="line">&quot;IoPriority&quot;=dword:00000003</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LeagueClient.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000003</span><br><span class="line">&quot;IoPriority&quot;=dword:00000003</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\ACE-Tray.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000001</span><br><span class="line">&quot;IoPriority&quot;=dword:00000001</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\SGuard64.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000001</span><br><span class="line">&quot;IoPriority&quot;=dword:00000001</span><br></pre></td></tr></table></figure><p>然后双击导入即可。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;打大乱斗动不动就卡，太烦了。这B反作弊跟小蓝熊坐一桌去。&lt;/p&gt;
&lt;h2 id=&quot;注册表修改&quot;&gt;注册表修改&lt;/h2&gt;
&lt;p&gt;参考：&lt;a href=&quot;htt</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
  </entry>
  
  <entry>
    <title>学银在线解除粘贴限制</title>
    <link href="https://blog.esing.dev/2025/11/12/fuckoff-xueyinonline/"/>
    <id>https://blog.esing.dev/2025/11/12/fuckoff-xueyinonline/</id>
    <published>2025-11-12T11:41:03.000Z</published>
    <updated>2025-11-12T12:27:28.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><div class="note primary flat"><p>懒得看的直接跳转<a href="#%E8%84%9A%E6%9C%AC%E6%BA%90%E7%A0%81">脚本源码</a></p></div><p><strong>AI开课还要布置作业，你无敌了。我寻思这课不是考察吗？</strong></p><p>学银在线提交作业界面甚至无法粘贴，会提示“只能录入不能粘贴！”</p><p>什么垃圾玩意？看我干不干你就完事了。</p><h2 id="破解">破解</h2><h3 id="定位代码-修改">定位代码&amp;修改</h3><p>这种禁止粘贴100%是JS+前端拦截。直接进控制台搜源代码，定位到：</p><img src="https://webp.esing.dev/img/image-20251112200416938_251112_2004_AQoQ.png" alt="监听函数" style="zoom:80%;" /><p>然后直接写脚本替换：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         学银在线允许粘贴</span></span><br><span class="line"><span class="comment">// @namespace    https://blog.esing.dev/</span></span><br><span class="line"><span class="comment">// @version      0.7.2.1</span></span><br><span class="line"><span class="comment">// @description  移除学银在线的编辑器限制，允许粘贴</span></span><br><span class="line"><span class="comment">// @match        https://mooc1.xueyinonline.com/mooc-ans/*</span></span><br><span class="line"><span class="comment">// @run-at       document-end</span></span><br><span class="line"><span class="comment">// @grant        unsafeWindow</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">overrideEditorPaste</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> unsafeWindow.<span class="property">editorPaste</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                unsafeWindow.<span class="property">editorPaste</span> = <span class="keyword">function</span>(<span class="params">o, html</span>) &#123;</span><br><span class="line">                    <span class="comment">// 不清空 html.html，让编辑器正常插入粘贴内容</span></span><br><span class="line">                    <span class="comment">// 也不再弹“只能录入不能粘贴！”</span></span><br><span class="line">                    <span class="comment">// 一般返回 true/不返回都可以，看编辑器实现习惯</span></span><br><span class="line">                    <span class="comment">// 这里返回 true，表示允许粘贴</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[Tampermonkey] editorPaste overridden, paste is now allowed.&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;[Tampermonkey] Failed to override editorPaste:&#x27;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试覆盖一次</span></span><br><span class="line">    <span class="title function_">overrideEditorPaste</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有些站点会晚一点才定义 editorPaste，这里每隔 1 秒再尝试一下</span></span><br><span class="line">    <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">overrideEditorPaste</span>()) &#123;</span><br><span class="line">            <span class="built_in">clearInterval</span>(timer); <span class="comment">// 覆盖成功后就不用再重复尝试了</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>塞进油猴测试。</p><p>没有效果？那继续。</p><h3 id="分析输入框代码">分析输入框代码</h3><p>继续检查元素，定位到输入框代码。检查一下可以发现，这里有个奇怪的script：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;stem_answer&quot;</span> <span class="attr">style</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;eidtDiv&quot;</span> <span class="attr">style</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;edui-default&quot;</span> <span class="attr">style</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;answer1919810&quot;</span> <span class="attr">name</span>=<span class="string">&quot;answer1919810&quot;</span> <span class="attr">_initadjustheight</span>=<span class="string">&quot;36&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 72px; display: none&quot;</span>&gt;</span>FUCKOFF<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> wordNum = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (wordNum == <span class="string">&quot;&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                wordNum = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> wordMinNum = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (wordMinNum == <span class="string">&quot;&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                wordMinNum = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> qtype = <span class="string">&quot;4&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// var wordCount = false;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// if (qtype == 4) &#123;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// wordCount = true;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">UEDITOR_CONFIG</span>.<span class="property">initialFrameHeight</span> = <span class="number">150</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> wordCount = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (<span class="built_in">parseInt</span>(wordNum) == <span class="number">0</span> &amp;&amp; <span class="built_in">parseInt</span>(wordMinNum) == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                wordCount = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">UEDITOR_CONFIG</span>.<span class="property">wordCount</span> = wordCount;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">UEDITOR_CONFIG</span>.<span class="property">wordCountTimer</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// window.UEDITOR_CONFIG.maximumWords = wordNum;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// window.UEDITOR_CONFIG.minimumWords = wordMinNum;</span></span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            &lt;!-- 编辑器定义代码 --&gt;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> editor1 = <span class="variable constant_">UE</span>.<span class="title function_">getEditor</span>(<span class="string">&quot;answer1919810&quot;</span>, &#123; <span class="attr">pasteplain</span>: <span class="literal">true</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="property">options</span>.<span class="property">maximumWords</span> = wordNum;</span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="property">options</span>.<span class="property">minimumWords</span> = wordMinNum;</span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="title function_">addListener</span>(<span class="string">&quot;blur&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> count = <span class="variable constant_">UE</span>.<span class="title function_">getEditor</span>(<span class="string">&quot;answer1919810&quot;</span>).<span class="title function_">pureWordCount</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> max = <span class="built_in">parseInt</span>(<span class="variable constant_">UE</span>.<span class="title function_">getEditor</span>(<span class="string">&quot;answer1919810&quot;</span>).<span class="property">options</span>.<span class="property">maximumWords</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> min = <span class="built_in">parseInt</span>(<span class="variable constant_">UE</span>.<span class="title function_">getEditor</span>(<span class="string">&quot;answer1919810&quot;</span>).<span class="property">options</span>.<span class="property">minimumWords</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borblue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borred&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((max &gt; <span class="number">0</span> &amp;&amp; count &gt; max) || (min &gt; <span class="number">0</span> &amp;&amp; min &gt; count)) &#123;</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borblue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">addClass</span>(<span class="string">&quot;borred&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borblue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borred&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="title function_">addListener</span>(<span class="string">&quot;focus&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">addClass</span>(<span class="string">&quot;borblue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borred&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            &lt;!-- 粘贴许可相关 --&gt;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> allowPaste = <span class="string">&quot;1&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (<span class="built_in">parseInt</span>(allowPaste) == <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                editor1.<span class="title function_">addListener</span>(<span class="string">&quot;beforepaste&quot;</span>, editorPaste);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            &lt;!-- 一个奇怪的监听器 --&gt;</span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="title function_">addListener</span>(<span class="string">&quot;contentChange&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">loadEditorAnswerd</span>(<span class="number">1919810</span>, <span class="number">4</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">answerContentChange</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            &lt;!-- 应该就是你了 --&gt;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">UEDITOR_CONFIG</span>.<span class="property">wordCount</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可知：这个编辑器是百度的<strong>UEditor</strong>，且在<code>beforepaste</code>事件上面挂了<code>editorPaste</code>这个回调函数。因此，真正要干掉的是所有的<code>UEditor</code>上面挂的<code>beforepaste</code>监视器。</p><h3 id="修改脚本">修改脚本</h3><p>把UEditor上面挂的<code>beforepaste</code>监视器拿掉即可。注意看函数上面有个<code>addListener(&quot;beforepaste&quot;, editorPaste)</code>，这是挂上去的代码。那我<code>removeListener</code>你不炸了吗？</p><p>直接把需求告诉AI让它修改就行了。AI太好用了你们知道吗</p><h3 id="脚本源码">脚本源码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         学银在线允许粘贴</span></span><br><span class="line"><span class="comment">// @namespace    https://blog.esing.dev/</span></span><br><span class="line"><span class="comment">// @version      0.7.2.1</span></span><br><span class="line"><span class="comment">// @description  移除学银在线的编辑器限制，允许粘贴</span></span><br><span class="line"><span class="comment">// @match        https://mooc1.xueyinonline.com/mooc-ans/*</span></span><br><span class="line"><span class="comment">// @run-at       document-end</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试对所有 UEditor 实例移除 beforepaste 的 editorPaste 监听</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">unlockPaste</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// UEditor 全局对象一般叫 UE</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">UE</span> || !<span class="variable constant_">UE</span>.<span class="property">instants</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> done = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="variable constant_">UE</span>.<span class="property">instants</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(<span class="variable constant_">UE</span>.<span class="property">instants</span>, key)) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">const</span> ed = <span class="variable constant_">UE</span>.<span class="property">instants</span>[key];</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 如果全局有 editorPaste 函数，并且这个编辑器有 removeListener 方法</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">editorPaste</span> === <span class="string">&quot;function&quot;</span> &amp;&amp; ed.<span class="property">removeListener</span>) &#123;</span><br><span class="line">                    ed.<span class="title function_">removeListener</span>(<span class="string">&quot;beforepaste&quot;</span>, <span class="variable language_">window</span>.<span class="property">editorPaste</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Userscript] removed beforepaste listener from editor:&quot;</span>, key);</span><br><span class="line">                    done = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[Userscript] removeListener error:&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初次尝试</span></span><br><span class="line">    <span class="title function_">unlockPaste</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有时候编辑器是异步初始化的，这里轮询几次，确保挂到实例上之后再移除</span></span><br><span class="line">    <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">unlockPaste</span>()) &#123;</span><br><span class="line">            <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;paste-unlock-indicator&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">        div.<span class="property">id</span> = <span class="string">&quot;paste-unlock-indicator&quot;</span>;</span><br><span class="line">        div.<span class="property">textContent</span> = <span class="string">&quot;粘贴已解锁😋&quot;</span>;</span><br><span class="line">        div.<span class="property">style</span>.<span class="property">cssText</span> =</span><br><span class="line">            <span class="string">&quot;position:fixed;bottom:10px;right:10px;padding:4px 8px;font-size:12px;background:#4caf50;color:#fff;z-index:99999;border-radius:4px;opacity:0.7;&quot;</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>收工。</p>]]></content>
    
    
    <summary type="html">防君子、不防小人也。</summary>
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="JavaScript" scheme="https://blog.esing.dev/tags/JavaScript/"/>
    
  </entry>
  
</feed>
