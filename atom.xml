<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Esing的小站</title>
  
  <subtitle>随便写点</subtitle>
  <link href="https://blog.esing.dev/atom.xml" rel="self"/>
  
  <link href="https://blog.esing.dev/"/>
  <updated>2025-12-12T06:55:52.315Z</updated>
  <id>https://blog.esing.dev/</id>
  
  <author>
    <name>Esing</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>从零开始学RISC：第十篇</title>
    <link href="https://blog.esing.dev/2025/12/12/riscvcod-p10/"/>
    <id>https://blog.esing.dev/2025/12/12/riscvcod-p10/</id>
    <published>2025-12-12T02:50:50.000Z</published>
    <updated>2025-12-12T06:55:52.315Z</updated>
    
    <content type="html"><![CDATA[<h2 id="让我访问！">让我访问！</h2><p>对于L-Type和S-Type，我们只支持了<code>lw/sw</code>，它们的兄弟姐妹<code>lb/lbu/lh/lhu/<b>sb</b>/sh</code>还没支持。</p><p>我们需要准备一个模块专门用来处理这些非字节存取。在前面ID级传出的<code>sl_type</code>信号终于能派上用场了。</p><p>这里有个小技巧：定义存取类型时，用高位来分辨是读还是写，剩下的读写类型一定程度上可以合并。</p><h3 id="存取控制模块-LoadStoreUnit-sv">存取控制模块 LoadStoreUnit.sv</h3><p>考虑到数据的存取都在MEM级完成，我们需要将模块放置在MEM级。我们要传入来自EX级的待存数据，对其进行适当移位，好将数据存放到合适位置，并根据<code>dram_we</code>和<code>sl_type</code>来将1位写使能<code>dram_we</code>转换为4位的按位写使能<code>dram_we_strbe</code>。</p><p>对于读出的数据，还要判断是有符号还是无符号读取。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> LoadStoreUnit (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] addr,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] store_data_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] store_data_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        dram_we,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] wstrb          <span class="comment">// 按位写使能</span></span><br><span class="line">);</span><br><span class="line">    <span class="comment">// [TODO] 不同的访存类型处理</span></span><br><span class="line">    <span class="keyword">logic</span> is_load, is_load_unsigned;</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        is_load          = (sl_type[<span class="number">3</span>] == <span class="number">1&#x27;b0</span>);</span><br><span class="line">        is_load_unsigned = (sl_type[<span class="number">2</span>] == <span class="number">1&#x27;b1</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 默认值，保证所有组合输出都有驱动，避免锁存</span></span><br><span class="line">        wstrb        = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">        load_data_o  = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        store_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_load) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 临时变量（也可以放在模块层）</span></span><br><span class="line">            <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] raw;</span><br><span class="line">            raw = <span class="number">32&#x27;b0</span>;</span><br><span class="line">            <span class="comment">// 提取 raw，根据 sl_type 和 addr 偏移</span></span><br><span class="line">            <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                <span class="number">2&#x27;b01</span>: <span class="keyword">begin</span>  <span class="comment">// byte</span></span><br><span class="line">                    <span class="comment">// 右移到最低位再掩码</span></span><br><span class="line">                    raw = (load_data_i &gt;&gt; (addr[<span class="number">1</span>:<span class="number">0</span>] * <span class="number">8</span>)) &amp; <span class="number">32&#x27;h000000FF</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="number">2&#x27;b10</span>: <span class="keyword">begin</span>  <span class="comment">// half</span></span><br><span class="line">                    raw = (load_data_i &gt;&gt; (addr[<span class="number">1</span>] * <span class="number">16</span>)) &amp; <span class="number">32&#x27;h0000FFFF</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="number">2&#x27;b11</span>: <span class="keyword">begin</span>  <span class="comment">// word</span></span><br><span class="line">                    raw = load_data_i;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">default</span>: raw = <span class="number">32&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 扩展</span></span><br><span class="line">            <span class="keyword">if</span> (is_load_unsigned) <span class="keyword">begin</span></span><br><span class="line">                load_data_o = raw;  <span class="comment">// 零扩展</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                    <span class="number">2&#x27;b01</span>:   load_data_o = &#123;&#123;<span class="number">24</span>&#123;raw[<span class="number">7</span>]&#125;&#125;, raw[<span class="number">7</span>:<span class="number">0</span>]&#125;;  <span class="comment">// LB</span></span><br><span class="line">                    <span class="number">2&#x27;b10</span>:   load_data_o = &#123;&#123;<span class="number">16</span>&#123;raw[<span class="number">15</span>]&#125;&#125;, raw[<span class="number">15</span>:<span class="number">0</span>]&#125;;  <span class="comment">// LH</span></span><br><span class="line">                    <span class="number">2&#x27;b11</span>:   load_data_o = raw;  <span class="comment">// LW</span></span><br><span class="line">                    <span class="keyword">default</span>: load_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (dram_we) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">logic</span> [<span class="number">15</span>:<span class="number">0</span>] half_byte;</span><br><span class="line">            <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] shift;  <span class="comment">// 移位量 0, 8, 16, 24</span></span><br><span class="line">            shift = <span class="number">4&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">unique</span> <span class="keyword">case</span> (sl_type[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                <span class="number">2&#x27;b01</span>: <span class="keyword">begin</span>  <span class="comment">// SB</span></span><br><span class="line">                    <span class="keyword">logic</span> [<span class="number">7</span>:<span class="number">0</span>] byte_val;</span><br><span class="line"></span><br><span class="line">                    half_byte = store_data_i[<span class="number">7</span>:<span class="number">0</span>];  <span class="comment">// 只关心最低 8 位</span></span><br><span class="line">                    shift     = &#123;addr[<span class="number">1</span>:<span class="number">0</span>], <span class="number">3&#x27;b000</span>&#125;;  <span class="comment">// addr[1:0] * 8</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 写使能</span></span><br><span class="line">                    <span class="keyword">unique</span> <span class="keyword">case</span> (addr[<span class="number">1</span>:<span class="number">0</span>])</span><br><span class="line">                        <span class="number">2&#x27;b00</span>:   wstrb = <span class="number">4&#x27;b0001</span>;</span><br><span class="line">                        <span class="number">2&#x27;b01</span>:   wstrb = <span class="number">4&#x27;b0010</span>;</span><br><span class="line">                        <span class="number">2&#x27;b10</span>:   wstrb = <span class="number">4&#x27;b0100</span>;</span><br><span class="line">                        <span class="number">2&#x27;b11</span>:   wstrb = <span class="number">4&#x27;b1000</span>;</span><br><span class="line">                        <span class="keyword">default</span>: wstrb = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 把 byte_val 放到对应 byte lane</span></span><br><span class="line">                    store_data_o = (&#123;<span class="number">24&#x27;b0</span>, half_byte[<span class="number">7</span>:<span class="number">0</span>]&#125; &lt;&lt; shift);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="number">2&#x27;b10</span>: <span class="keyword">begin</span>  <span class="comment">// SH</span></span><br><span class="line">                    <span class="keyword">logic</span> [<span class="number">15</span>:<span class="number">0</span>] half_val;</span><br><span class="line"></span><br><span class="line">                    half_byte = store_data_i[<span class="number">15</span>:<span class="number">0</span>];  <span class="comment">// 只关心最低 16 位</span></span><br><span class="line">                    shift     = &#123;addr[<span class="number">1</span>], <span class="number">4&#x27;b0000</span>&#125;;  <span class="comment">// addr[1] ? 16 : 0</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 写使能</span></span><br><span class="line">                    <span class="keyword">unique</span> <span class="keyword">case</span> (addr[<span class="number">1</span>])</span><br><span class="line">                        <span class="number">1&#x27;b0</span>:    wstrb = <span class="number">4&#x27;b0011</span>;</span><br><span class="line">                        <span class="number">1&#x27;b1</span>:    wstrb = <span class="number">4&#x27;b1100</span>;</span><br><span class="line">                        <span class="keyword">default</span>: wstrb = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 把 half_val 放到低/高 halfword</span></span><br><span class="line">                    store_data_o = (&#123;<span class="number">16&#x27;b0</span>, half_byte&#125; &lt;&lt; shift);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="number">2&#x27;b11</span>: <span class="keyword">begin</span>  <span class="comment">// SW</span></span><br><span class="line">                    wstrb        = <span class="number">4&#x27;b1111</span>;</span><br><span class="line">                    store_data_o = store_data_i;  <span class="comment">// 直接写整个 word</span></span><br><span class="line">                    half_byte    = <span class="number">16&#x27;b0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                    wstrb        = <span class="number">4&#x27;b0000</span>;</span><br><span class="line">                    store_data_o = <span class="number">32&#x27;b0</span>;</span><br><span class="line">                    half_byte    = <span class="number">16&#x27;b0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 非 load/非 store：保持默认 wstrb=0, store_data_o 已初始化为 0</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] sl_type_ascii;</span><br><span class="line">    <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] select_bits;</span><br><span class="line">    <span class="keyword">assign</span> select_bits = addr[<span class="number">1</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (sl_type)</span><br><span class="line">            `MEM_LB:  sl_type_ascii = <span class="string">&quot;LB  &quot;</span>;</span><br><span class="line">            `MEM_LH:  sl_type_ascii = <span class="string">&quot;LH  &quot;</span>;</span><br><span class="line">            `MEM_LW:  sl_type_ascii = <span class="string">&quot;LW  &quot;</span>;</span><br><span class="line">            `MEM_LBU: sl_type_ascii = <span class="string">&quot;LBU &quot;</span>;</span><br><span class="line">            `MEM_LHU: sl_type_ascii = <span class="string">&quot;LHU &quot;</span>;</span><br><span class="line">            `MEM_SB:  sl_type_ascii = <span class="string">&quot;SB  &quot;</span>;</span><br><span class="line">            `MEM_SH:  sl_type_ascii = <span class="string">&quot;SH  &quot;</span>;</span><br><span class="line">            `MEM_SW:  sl_type_ascii = <span class="string">&quot;SW  &quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:  sl_type_ascii = <span class="string">&quot;UNKN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之后更新顶层模块，远方的MUX也不要放过：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DRAM模块</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] DRAM_output_data,DRAM_input_data;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">3</span>:<span class="number">0</span>] dram_we_MEM_strbe;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">3</span>:<span class="number">0</span>] wstrb;</span><br><span class="line">DRAM u_DRAM (</span><br><span class="line">    <span class="variable">.clk</span>(clk),</span><br><span class="line">    <span class="variable">.a</span>  (alu_result_MEM[<span class="number">17</span>:<span class="number">2</span>]),  <span class="comment">// 字节地址转换为字地址 (除以4)</span></span><br><span class="line">    <span class="variable">.spo</span>(DRAM_output_data),</span><br><span class="line">    <span class="variable">.we</span> (wstrb),</span><br><span class="line">    <span class="variable">.din</span>(DRAM_input_data)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于同步DRAM，数据将在下一个时钟周期可用</span></span><br><span class="line"><span class="comment">// 将数据传递到WB级，在WB级进行选择</span></span><br><span class="line"><span class="keyword">assign</span> rf_wd_MEM = rf_wd_MEM_PR2MUX;</span><br><span class="line"></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_o; <span class="comment">// LSU输出的最终加载数据</span></span><br><span class="line">LoadStoreUnit u_LoadStoreUnit(</span><br><span class="line">    <span class="variable">.sl_type</span>          (sl_type_MEM),</span><br><span class="line">    <span class="variable">.addr</span>             (alu_result_MEM),</span><br><span class="line">    <span class="variable">.load_data_i</span>      (DRAM_output_data),</span><br><span class="line">    <span class="variable">.load_data_o</span>      (load_data_o),</span><br><span class="line">    <span class="variable">.store_data_i</span>     (rf_rd2_MEM),</span><br><span class="line">    <span class="variable">.store_data_o</span>     (DRAM_input_data),</span><br><span class="line">    <span class="variable">.dram_we</span>          (dram_we_MEM),</span><br><span class="line">    <span class="variable">.wstrb</span>            (wstrb)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> rf_wd_WB = (wd_sel_WB == `WD_SEL_FROM_DRAM) ? load_data_o : rf_wd_WB_from_PR;</span><br></pre></td></tr></table></figure><p>我们的<code>LoadStoreUnit</code>是<strong>组合逻辑模块</strong>，因此，不会打乱同步读写的DRAM时序。让我们测试一下看看：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">li  x1,0x12345678</span><br><span class="line"></span><br><span class="line">sw  x1,0(x0)</span><br><span class="line">lw  x2,0(x0)</span><br><span class="line">lw  x3,0(x0)</span><br><span class="line">lh  x4,4(x0)</span><br><span class="line">lhu x5,4(x0)</span><br><span class="line">lb  x6,0(x0)</span><br><span class="line">lhu x7,2(x0)</span><br></pre></td></tr></table></figure><p><img src="https://webp.esing.dev/img/image-20251212115844253_251212_1158_qMTV.png" alt="lw指令读出错误"></p><p>可以看到，本应该执行<code>lw</code>的指令却错误地读出了下一条的<code>lh</code>指令，而最后一条<code>lhu</code>直接消失了！这是为什么？</p><p>看上面的波形可以知道，用于控制存入数据的<code>sl_type</code>提早了一拍到达。<strong>组合逻辑不会影响时序，因此，应当根据时序来设计组合逻辑。<strong>我们是在MEM级读取出数据并进行处理的，但是写回阶段是在WB级——这导致我们写回时使用的仍然是MEM级的控制信号。<code>DRAM_output_data</code>在 WB 级可用时，应当使用和 DRAM 读取请求相对应的<code>sl_type</code>进行处理，但当前代码中<code>LoadStoreUnit</code>使用的是<code>sl_type_MEM</code>，而此时MEM级可能已经是下一条指令了。换句话说，</strong>“存”与“取”所在的流水级不同，导致“存”正常，“取”异常</strong>。</p><p>我们的<code>LoadStoreUnit</code>模块也成了第二个跨流水级的模块。如何修改呢？最简单的方法，就是直接实例化两个一模一样的模块：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [INFO] LoadStoreUnit模块 - MEM级只处理Store操作</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] DRAM_input_data;  <span class="comment">// LSU处理后数据</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] DRAM_output_data; <span class="comment">// LSU从DRAM得到的数据</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">3</span>:<span class="number">0</span>] dram_we_MEM_strbe;</span><br><span class="line"><span class="comment">// MEM级LSU仅用于Store处理，Load在WB级处理</span></span><br><span class="line">LoadStoreUnit u_LoadStoreUnit_MEM(</span><br><span class="line">    <span class="variable">.sl_type</span>       (sl_type_MEM),</span><br><span class="line">    <span class="variable">.addr</span>          (alu_result_MEM),</span><br><span class="line">    <span class="variable">.load_data_i</span>   (<span class="number">32&#x27;b0</span>),        <span class="comment">// MEM级不使用load处理</span></span><br><span class="line">    <span class="variable">.load_data_o</span>   (),             <span class="comment">// MEM级不使用load输出</span></span><br><span class="line">    <span class="variable">.store_data_i</span>  (rf_rd2_MEM),</span><br><span class="line">    <span class="variable">.store_data_o</span>  (DRAM_input_data),</span><br><span class="line">    <span class="variable">.dram_we</span>       (dram_we_MEM),</span><br><span class="line">    <span class="variable">.wstrb</span>         (dram_we_MEM_strbe)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// DRAM模块</span></span><br><span class="line">DRAM #(</span><br><span class="line">    <span class="variable">.ADDR_WIDTH</span>(<span class="number">15</span>)</span><br><span class="line">) u_DRAM (</span><br><span class="line">    <span class="variable">.clk</span>(clk),</span><br><span class="line">    <span class="variable">.a</span>  (alu_result_MEM[<span class="number">17</span>:<span class="number">2</span>]),  <span class="comment">// 字节地址转换为字地址</span></span><br><span class="line">    <span class="variable">.spo</span>(DRAM_output_data),</span><br><span class="line">    <span class="comment">// .we (&#123;4&#123;dram_we_MEM&#125;&#125;),</span></span><br><span class="line">    <span class="variable">.we</span> (dram_we_MEM_strbe),</span><br><span class="line">    <span class="variable">.din</span>(DRAM_input_data)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [INFO] WB级LoadStoreUnit - 专门处理Load操作</span></span><br><span class="line"><span class="comment">// 使用WB级的sl_type和地址来正确处理DRAM读取的数据</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] load_data_WB;</span><br><span class="line">LoadStoreUnit u_LoadStoreUnit_WB(</span><br><span class="line">    <span class="variable">.sl_type</span>       (sl_type_WB),</span><br><span class="line">    <span class="variable">.addr</span>          (alu_result_WB),</span><br><span class="line">    <span class="variable">.load_data_i</span>   (DRAM_output_data),  <span class="comment">// DRAM的spo在WB级稳定可用</span></span><br><span class="line">    <span class="variable">.load_data_o</span>   (load_data_WB),</span><br><span class="line">    <span class="variable">.store_data_i</span>  (<span class="number">32&#x27;b0</span>),             <span class="comment">// WB级不使用store处理</span></span><br><span class="line">    <span class="variable">.store_data_o</span>  (),</span><br><span class="line">    <span class="variable">.dram_we</span>       (<span class="number">1&#x27;b0</span>),              <span class="comment">// WB级不写DRAM</span></span><br><span class="line">    <span class="variable">.wstrb</span>         ()</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>我们再次进行测试：</p><p><img src="https://webp.esing.dev/img/image-20251212135329430_251212_1353_cKJ6.png" alt="修改后的LSU正常工作"></p><h2 id="全自动化测试：解放双手">全自动化测试：解放双手</h2><p>到这里，我们的RV32I CPU 算是彻底完成了。但即使有前面的测试，我们仍不能确保我们的CPU<strong>万无一失</strong>。有什么办法可以证明它一定是符合RV32I标准的CPU呢？最好的办法，自然是使用形式化验证，但那个太烦了，<strong>而且我不会</strong>。使用官方的测试样例进行测试算是最容易的方法了。riscv-software-src设置了一个测试库，专门用于测试各种架构的RV32 CPU是否符合标准，在<a href="https://github.com/riscv-software-src/riscv-tests">riscv-software-src/riscv-tests</a>下。使用官方工具链编译时，必须带上<code>_Zicsr</code>扩展，这是因为其测试指令和初始化指令中用到了<code>CSR</code>寄存器，不过即使不支持也没关系。</p><p>在测试前，还需要修改一下DRAM。<code>lw</code>测试子集会直接从DRAM中读取值，而我们默认是将DRAM全部初始化为<code>32'h00000000</code>。考虑到之前已在IROM模块中指定了内存读取范围<code>$readmemh(testcase, rom_data, 0, (1 &lt;&lt; ADDR_WIDTH) - 1)</code>，这里在DRAM中可不指定。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] ram_data[<span class="number">1</span> &lt;&lt; ADDR_WIDTH];</span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">integer</span> i;</span><br><span class="line">    <span class="keyword">string</span>  testcase;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化所有内存为0</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">1</span> &lt;&lt; ADDR_WIDTH; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">        ram_data[i] = <span class="number">32&#x27;h00000000</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有testcase参数，从hex文件加载数据段</span></span><br><span class="line">    <span class="comment">// hex文件是完整的内存镜像，按字地址索引</span></span><br><span class="line">    <span class="comment">// 数据段从0x2000开始，即hex文件的第0x800行(2048)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">$value$plusargs</span>(<span class="string">&quot;TESTCASE=%s&quot;</span>, testcase)) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 读取整个hex文件到DRAM</span></span><br><span class="line">        <span class="comment">// SystemVerilog的$readmemh会自动处理地址映射</span></span><br><span class="line">        <span class="comment">// 但是最好还是手动指定范围以防万一</span></span><br><span class="line">        <span class="built_in">$readmemh</span>(testcase, ram_data);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;DRAM: Loaded memory image from %s&quot;</span>, testcase);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>写个简单的Makefile进行测试，结果如下：</p><p><img src="https://webp.esing.dev/img/image-20251212144050887_251212_1440_pe1l.png" alt="完美的测试结果!"></p><h2 id="后记">后记</h2><p>我们做完了吗？做完了99%。</p><p>后面，可能会首先完成<code>Zicsr</code>扩展与<code>M</code>扩展，再之后会往自己的项目上靠，研究一下最新的控制流加密扩展<code>Zicfilp</code>和<code>Zicfiss</code>。<code>A</code>、<code>C</code>和<code>F</code>扩展暂不考虑。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;让我访问！&quot;&gt;让我访问！&lt;/h2&gt;
&lt;p&gt;对于L-Type和S-Type，我们只支持了&lt;code&gt;lw/sw&lt;/code&gt;，它们的兄弟姐妹&lt;code&gt;lb/lbu/lh/lhu/&lt;b&gt;</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第九篇</title>
    <link href="https://blog.esing.dev/2025/12/11/riscvcod-p9/"/>
    <id>https://blog.esing.dev/2025/12/11/riscvcod-p9/</id>
    <published>2025-12-11T04:50:52.000Z</published>
    <updated>2025-12-12T07:10:58.517Z</updated>
    
    <content type="html"><![CDATA[<h2 id="综合器说好，那才是真好">综合器说好，那才是真好</h2><h3 id="模块综合">模块综合</h3><p>写出的HDL代码需要送入综合器中，生成实际的门电路。综合器会在这个过程中推测你写的代码，并帮你进行一定的优化，最终生成文件。</p><p>这里选择开源的<a href="https://github.com/YosysHQ/yosys">Yosys</a>进行综合。官方没有发布适用于Windows的二进制可执行文件，但是Python的WASM库有，虽然是给WebAssembly环境准备的，需要电脑上有<code>wasmtime</code>才行。编写一个综合脚本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># 读取所有模块（不需要 -formal）</span><br><span class="line">read_slang ./user/src/include/defines.svh</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PC.sv</span><br><span class="line">read_slang ./user/src/IROM.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PR_IF_ID.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/Decoder.sv</span><br><span class="line">read_slang ./user/src/imm_extender.sv</span><br><span class="line">read_slang ./user/src/RegisterF.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PR_ID_EX.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/ALU.sv</span><br><span class="line">read_slang ./user/src/NextPC_Generator.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PR_EX_MEM.sv</span><br><span class="line">read_slang ./user/src/DRAM.sv</span><br><span class="line">read_slang ./user/src/LoadStoreUnit.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/PR_MEM_WB.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/HazardUnit.sv</span><br><span class="line"></span><br><span class="line">read_slang ./user/src/CPU_TOP.sv</span><br><span class="line"></span><br><span class="line"># read_slang ./user/sim/tb_CPU_TOP.sv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 指定顶层模块，并做基础处理</span><br><span class="line">prep -top CPU_TOP</span><br><span class="line"># prep -top CPU_TOP -rdff              # 此处不能将触发器合并到内存读端口</span><br><span class="line"># prep -top tb_CPU_TOP -flatten</span><br><span class="line"></span><br><span class="line"># 写出 JSON</span><br><span class="line">write_json ./prj/netlist/CPU_TOP.json</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之后运行<code>wasmtime --dir . .\yosys.wasm --.\prj\netlist\CPU_TOP.ys</code>即可开始综合。所有的模块（不含IROM）综合结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">=== design hierarchy ===</span><br><span class="line"></span><br><span class="line">        +----------Count including submodules.</span><br><span class="line">        | </span><br><span class="line">      236 CPU_TOP</span><br><span class="line">       29 ALU</span><br><span class="line">        4 DRAM</span><br><span class="line">       49 Decoder</span><br><span class="line">       44 HazardUnit</span><br><span class="line">       15 NextPC_Generator</span><br><span class="line">        4 PC</span><br><span class="line">        9 PR_EX_MEM</span><br><span class="line">       36 PR_ID_EX</span><br><span class="line">       12 PR_IF_ID</span><br><span class="line">        5 PR_MEM_WB</span><br><span class="line">        9 RegisterF</span><br><span class="line">       11 imm_extender</span><br><span class="line"></span><br><span class="line">        +----------Count including submodules.</span><br><span class="line">        | </span><br><span class="line">      416 wires</span><br><span class="line">     4302 wire bits</span><br><span class="line">      262 public wires</span><br><span class="line">     3205 public wire bits</span><br><span class="line">      170 ports</span><br><span class="line">     2027 port bits</span><br><span class="line">        - memories</span><br><span class="line">        - memory bits</span><br><span class="line">        - processes</span><br><span class="line">      236 cells</span><br><span class="line">        3   $add</span><br><span class="line">       37   $aldff</span><br><span class="line">        1   $and</span><br><span class="line">       55   $eq</span><br><span class="line">        1   $ge</span><br><span class="line">       22   $logic_and</span><br><span class="line">        6   $logic_not</span><br><span class="line">       12   $logic_or</span><br><span class="line">        2   $lt</span><br><span class="line">        2   $mem_v2</span><br><span class="line">       59   $mux</span><br><span class="line">        4   $not</span><br><span class="line">        1   $or</span><br><span class="line">       11   $pmux</span><br><span class="line">        5   $reduce_bool</span><br><span class="line">       10   $reduce_or</span><br><span class="line">        1   $shl</span><br><span class="line">        1   $shr</span><br><span class="line">        1   $sshr</span><br><span class="line">        1   $sub</span><br><span class="line">        1   $xor</span><br><span class="line">       12 submodules</span><br><span class="line">        1   ALU</span><br><span class="line">        1   DRAM</span><br><span class="line">        1   Decoder</span><br><span class="line">        1   HazardUnit</span><br><span class="line">        1   NextPC_Generator</span><br><span class="line">        1   PC</span><br><span class="line">        1   PR_EX_MEM</span><br><span class="line">        1   PR_ID_EX</span><br><span class="line">        1   PR_IF_ID</span><br><span class="line">        1   PR_MEM_WB</span><br><span class="line">        1   RegisterF</span><br><span class="line">        1   imm_extender</span><br></pre></td></tr></table></figure><h3 id="同步读、异步读">同步读、异步读</h3><p>对于前面的DRAM，我们也用Yosys综合一下。这里将异步与同步DRAM的综合结果放在一起，左边为异步，右边为同步：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">=== DRAM ===</span><br><span class="line"></span><br><span class="line">        +----------Local Count, excluding submodules.</span><br><span class="line">        | Default                      SDRAM</span><br><span class="line">        | ---------                    ---------</span><br><span class="line">        8 wires                        8 wires</span><br><span class="line">      147 wire bits                  147 wire bits</span><br><span class="line">        5 public wires                 5 public wires</span><br><span class="line">       82 public wire bits            82 public wire bits</span><br><span class="line">        5 ports                        5 ports</span><br><span class="line">       82 port bits                   82 port bits</span><br><span class="line">        4 cells                        4 cells</span><br><span class="line">                                       1   $dff</span><br><span class="line">        1   $mem_v2                    1   $mem_v2</span><br><span class="line">        3   $mux                       2   $mux</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到，区别是一个MUX和一个DFF。</p><p>Yosys很聪明，但是<strong>Xilinx很傻逼</strong>，就不这么想了。对于前面的“同步写异步读”DRAM，Xilinx Vivado会把它综合为<strong>六万个DFF组成的阵列</strong>：</p><p><img src="https://webp.esing.dev/img/image-20251211173426779_251211_1734_YmAO.png" alt="I　　SYNTHESIS　　65,536　　DFFs　　!!!"></p><p>Utilization里则是作为LUTRAM出现：</p><p><img src="https://webp.esing.dev/img/image-20251212150821514_251212_1508_ADar.png" alt="看这一大堆LUTRAM 能忍住不笑的都是神人了"></p><p>综合后的估计功耗直接拉到15w了，很难绷得住。因此，我们必须修改为“同步写同步读”的DRAM——这在工业生产上也是规范。不论是Xilinx还是其他厂商，其FPGA需要使用的BlockRAM IP核都是同步读写的，有的甚至需要两拍。</p><h2 id="DRAM魔改">DRAM魔改</h2><p>我们必须立即马上使用SDRAM。</p><h3 id="时序问题">时序问题</h3><p>我们只需要改动一行即可：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步写</span></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (we) <span class="keyword">begin</span></span><br><span class="line">        ram_data[a] &lt;= din;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    spo &lt;= ram_data[a];  <span class="comment">// 同步读</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后测试一下简单的S-Type和L-Type。不出意外的话，就会出意外：</p><p><img src="https://webp.esing.dev/img/image-20251211154229805_251211_1542_A3if.png" alt="SL大法坏！"></p><p>问题出在<code>wd_sel_MEM</code>。可以看到，在其值为1（选择DRAM输出数据）时，SDRAM压根就没准备好数据。这是因为同步写时数据在count=5时被写入，异步读可以在数值变化的那一刻就开始跟随输出，但同步读只有在时钟沿到来时（count=6）才能读出数据，而这时候<code>wd_sel_MEM</code>已经变为0，选择<code>rf_wd</code>的数据了。</p><p>怎么办？我们需要让<code>wd_sel_MEM</code>打一拍。最简单的方法，就是让它穿过最后一级流水线寄存器，在MEM/WB级的寄存器内被打一拍。同样的，我们的<code>rf_wd</code>数据也需要被打一拍。</p><p>这里有个问题：我们从SDRAM取的数据要不要送进MEM/WB级流水线寄存器？</p><p>答案是不需要。别忘了，我们的问题就是SDRAM的数据在上升沿才被写入读取，同步读取的数据相对原来异步读取的时候<strong>已经被打了一拍</strong>了。</p><h3 id="EX-MEM级流水线寄存器修改">EX/MEM级流水线寄存器修改</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_mem_i,</span><br><span class="line"><span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_wb_o,</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">        wd_sel_wb_o      &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        wd_sel_wb_o      &lt;= wd_sel_mem_i;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="DRAM数据选择MUX">DRAM数据选择MUX</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回写数据来源选择MUX</span></span><br><span class="line"><span class="comment">// 对于同步DRAM DRAM的spo已经是寄存器输出 在WB级直接使用以避免多余延迟</span></span><br><span class="line"><span class="comment">// DRAM_output_data在整个WB周期内保持稳定 可以安全地被寄存器堆采样</span></span><br><span class="line"><span class="keyword">assign</span> rf_wd_WB = (wd_sel_WB == `WD_SEL_FROM_DRAM) ? DRAM_output_data : rf_wd_WB_from_PR;</span><br></pre></td></tr></table></figure><p>再次测试，一切正常。</p><h3 id="再次综合">再次综合</h3><p>在Vivado中进行综合。可以看到，结果很完美：</p><p><img src="https://webp.esing.dev/img/image-20251211173249551_251211_1732_ZRKE.png" alt="被正确识别成RAM的SDRAM"></p><p>在Utilization里可以看到，BRAM被占用了一部分，说明我们的同步读写DRAM被综合为BRAM，不占用原先的LUTRAM了。</p><p><img src="https://webp.esing.dev/img/image-20251212145918732_251212_1459_IVzg.png" alt="正确综合为BRAM的SDRAM"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;综合器说好，那才是真好&quot;&gt;综合器说好，那才是真好&lt;/h2&gt;
&lt;h3 id=&quot;模块综合&quot;&gt;模块综合&lt;/h3&gt;
&lt;p&gt;写出的HDL代码需要送入综合器中，生成实际的门电路。综合器会在这个过程</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第八篇</title>
    <link href="https://blog.esing.dev/2025/12/11/riscvcod-p8/"/>
    <id>https://blog.esing.dev/2025/12/11/riscvcod-p8/</id>
    <published>2025-12-11T01:00:00.000Z</published>
    <updated>2025-12-11T10:41:42.148Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前递：快人一步">前递：快人一步</h2><h3 id="激烈的斗争">激烈的斗争</h3><p>我们做完了吗？还没完。</p><p>在 <a href="/2025/12/10/riscvcod-p7/" title="从零开始学RISC：第七篇">之前</a> 的测试里，程序没有任何数据冒险——在实际运行中这几乎是不可能的。我们简单修改一点：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addi x1,x0,1</span><br><span class="line">addi x2,x0,2</span><br><span class="line">addi x3,x0,3</span><br><span class="line">addi x4,x0,4</span><br><span class="line">addi x1,x0,7</span><br><span class="line">addi x2,x0,21</span><br><span class="line">add  x7,x1,x2 # 加入数据冒险</span><br></pre></td></tr></table></figure><p>然后运行。发生了什么？我们期望看到<code>x7</code>输出的是<code>x1</code>和<code>x2</code>变化后相加的值，应当为<code>28</code>。但是计算结果输出了错误的3！</p><p><img src="https://webp.esing.dev/img/image-20251211084904808_251211_0849_RBUY.png" alt="数据冒险导致的错误输出"></p><p>这就是最经典的“数据冒险”。我们看看发生了什么。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   x1   x2    x7      IF          ID          EX          MEM         WB</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">1   1    2     x      x1=7</span><br><span class="line">2   1    2     x      x2=21       x1=7</span><br><span class="line">3   1    2     x      x7=x1+x2    x2=21       x1=7</span><br><span class="line">4   1    2     x                  x7=x1+x2[R] x2=21       x1=7</span><br><span class="line">5   7    2     x                              x7=x1+x2    x2=21       x1=7 [W]</span><br><span class="line">6   7    21    x                                          x7=x1+x2    x2=21[W]</span><br><span class="line">7   7    21    3                                                      x7=3 [W]</span><br></pre></td></tr></table></figure><p>这是流水线示意图。可以看到，因为写回在WB级才被完成，导致第三条指令在ID级取到了旧的值。直到第六个周期结束，源寄存器的值才更新完毕。</p><h3 id="空泡与阻塞">空泡与阻塞</h3><p>为了不让计算取到错误的值，我们可以等。时间，会给出答案。在前面的计算还没完成时，让译码级一直等待，直到从寄存器堆中读取正确的值就行。我们需要对数据进行判断：如果两条指令之间存在数据关联，则给出一个信号，之后IF级的程序计数器根据信号来决定是否停止、ID/EX级流水线寄存器根据信号进行冲刷。</p><p>从上面的例子可知，只要间隔不超过三条的指令，都有着数据冒险的可能。因此，判断一下即可。记得判断一下写入的目标是否为0，<strong>毕竟0被塞了多少东西也不会吭一声</strong>。之后，再定义一个判断信号，用于控制冲刷：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// 间隔一级流水线 判断下写入的不为x0即可</span></span><br><span class="line">    RAW_1_rD1 = (wR_EX ==  rR1_ID) &amp;&amp;  rf_we_EX &amp;&amp; rs1_used_ID &amp;&amp; (wR_EX != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    RAW_1_rD2 = (wR_EX ==  rR2_ID) &amp;&amp;  rf_we_EX &amp;&amp; rs2_used_ID &amp;&amp; (wR_EX != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    <span class="comment">// 间隔两级流水线</span></span><br><span class="line">    RAW_2_rD1 = (wR_MEM == rR1_ID) &amp;&amp; rf_we_MEM &amp;&amp; rs1_used_ID &amp;&amp; (wR_MEM != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    RAW_2_rD2 = (wR_MEM == rR2_ID) &amp;&amp; rf_we_MEM &amp;&amp; rs2_used_ID &amp;&amp; (wR_MEM != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    <span class="comment">// 间隔三级流水线</span></span><br><span class="line">    RAW_3_rD1 = (wR_WB ==  rR1_ID) &amp;&amp;  rf_we_WB &amp;&amp; rs1_used_ID &amp;&amp; (wR_WB != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    RAW_3_rD2 = (wR_WB ==  rR2_ID) &amp;&amp;  rf_we_WB &amp;&amp; rs2_used_ID &amp;&amp; (wR_WB != <span class="number">5&#x27;b0</span>);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">// 冲刷信号生成</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    RAW_flush_ID = RAW_1_rD1 || RAW_2_rD1 || RAW_3_rD1</span><br><span class="line">                || RAW_1_rD2 || RAW_2_rD2 || RAW_3_rD2;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后接到CPU顶层模块的对应位置。测试一下！</p><p><img src="https://webp.esing.dev/img/image-20251211092606018_251211_0926_7eXs.png" alt="流水线停顿得出正确结果"></p><p>可以看到，流水线被停顿了很久，但是至少结果出来了。</p><h3 id="与其停滞不前，不如大步向前">与其停滞不前，不如大步向前</h3><p>流水线停顿确实能解决数据冒险的问题，但是<strong>效率太低了</strong>。我们直接把EX级算出来的结果送到前面一级用就是了。上面的信号改个名字就可以拿来用了。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前递数据选择</span></span><br><span class="line"><span class="comment">// 优先级：EX &gt; MEM &gt; WB</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// 源操作数1前递数据选择</span></span><br><span class="line">    <span class="keyword">if</span> (RAW_1_rD1)      fwd_rD1_ID = rf_wd_EX;  <span class="comment">// 来自EX级</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RAW_2_rD1) fwd_rD1_ID = rf_wd_MEM; <span class="comment">// 来自MEM级</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RAW_3_rD1) fwd_rD1_ID = rf_wd_WB;  <span class="comment">// 来自WB级</span></span><br><span class="line">    <span class="keyword">else</span>                fwd_rD1_ID = <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 源操作数2前递数据选择</span></span><br><span class="line">    <span class="keyword">if</span> (RAW_1_rD2)      fwd_rD2_ID = rf_wd_EX;  <span class="comment">// 来自EX级</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RAW_2_rD2) fwd_rD2_ID = rf_wd_MEM; <span class="comment">// 来自MEM级</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RAW_3_rD2) fwd_rD2_ID = rf_wd_WB;  <span class="comment">// 来自WB级</span></span><br><span class="line">    <span class="keyword">else</span>                fwd_rD2_ID = <span class="number">32&#x27;b0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后接入前递使能到ID/EX级流水线寄存器：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前递信号与数据</span></span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD1_forwarded, rD2_forwarded;</span><br><span class="line"><span class="comment">// 考虑了前递就不需要冲刷了</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    rD1_forwarded = fwd_rD1e_ID ? fwd_rD1_ID : rD1_i;</span><br><span class="line">    rD2_forwarded = fwd_rD2e_ID ? fwd_rD2_ID : rD2_i;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 寄存器堆数据</span></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">        rD1_o &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        rD2_o &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        rD1_o &lt;= rD1_forwarded;</span><br><span class="line">        rD2_o &lt;= rD2_forwarded;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>再测试一下，可以看到提前了三个周期便算出了结果，这个延时刚好对应上面算出的数据相关性间隔。波形图上<code>x7</code>紧接着<code>x2</code>的变化，和预期的一样！</p><p><img src="https://webp.esing.dev/img/image-20251211095427035_251211_0954_H54D.png" alt="加入数据前递后的正确结果"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   x1   x2    x7      IF          ID          EX          MEM         WB</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">1   1    2     x      x1=7</span><br><span class="line">2   1    2     x      x2=21       x1=7</span><br><span class="line">3   1    2     x      x7=x1+x2    x2=21       x1=7</span><br><span class="line">4   7[F] 21[F] x                  x7=x1+x2[F] x2=21       x1=7</span><br><span class="line">5   7    2     x                              x7=x1+x2    x2=21       x1=7 [W]</span><br><span class="line">6   7    21    x                                          x7=x1+x2    x2=21[W]</span><br><span class="line">7   7    21    28                                                     x7=28[W]</span><br></pre></td></tr></table></figure><h3 id="Load-Use冒险">Load-Use冒险</h3><p>除了常见的依赖冒险之外，还有一种“取数-使用”型冒险。我们举一个简单的例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addi x1,x0,1</span><br><span class="line">addi x2,x0,2</span><br><span class="line">add  x3,x1,x2</span><br><span class="line">sw   x3,0(x0)</span><br><span class="line">lw   x4,0(x0)</span><br><span class="line">addi x5,x4,1 # Load-Use 冒险</span><br><span class="line">addi x6,x0,6</span><br></pre></td></tr></table></figure><p>可以看到，本应当计算出4的<code>x5</code>现在只是1。</p><p><img src="https://webp.esing.dev/img/image-20251211104058363_251211_1040_nM7O.png" alt="取数-使用冒险导致的错误输出"></p><p>原因是要先从DRAM中读出值存入寄存器，之后再读取寄存器值进行计算，但读出的值在送到寄存器之前就需要被使用，怎么办？我们也可以加入前递。</p><p>可以吗？</p><p>L-Type指令在流水线中要经过MEM级才能得到从DRAM返回的数据，而普通的前递是把 EX 级产生的 ALU 结果直接送给后续指令的 EX 阶段使用。换句话说，<strong>L-Type的数据在 EX 之后、MEM 之后才可用</strong>。单靠常规 的EX2EX 转发是无法消除的。</p><p>那我们加一个MEM2EX级的前递路径不就行了？想法是好的，但是流水线执行坏了：</p><ul><li>L-Type的数据往往在 MEM 级的末期才可用（这里是MUX之后输出的结果），而 EX 的操作数通常在该周期早期就要用到，会出现时序错误；</li><li>插入一个气泡更为简单，也更容易控制流水线流动。</li></ul><p>那直接插气泡就行了，何乐而不为呢？</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load_use 冒险判断</span></span><br><span class="line"><span class="keyword">logic</span> load_use_hazard;</span><br><span class="line"><span class="keyword">assign</span> load_use_hazard = (wd_sel_EX == `WD_SEL_FROM_DRAM) &amp;&amp; (RAW_1_rD1 || RAW_1_rD2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 流水线冲刷与停顿</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    keep_pc     = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    stall_IF_ID = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    flush_ID_EX = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><img src="https://webp.esing.dev/img/image-20251211104952833_251211_1049_DgaD.png" alt="停顿一级流水线后得出正确结果"></p><div class="note info flat"><p>事实上，对于Load-Use类冒险，最标准的做法就是插入空泡。这也是几乎教科书中都提及的方法。</p></div><h3 id="分支跳转：Jumpin">分支跳转：Jumpin'</h3>    <div id="aplayer-vbpECIgp" class="aplayer aplayer-tag-marker meting-tag-marker"         data-id="1347247827" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ff80ac" data-volume="0.3" data-loop="none"    ></div><p>B-Type类指令压根不需要写寄存器，只是在EX级计算出是否跳转后更新PC值。我们在 <a href="/2025/12/09/riscvcod-p6/" title="从零开始学RISC：第六篇">执行级</a> 已经写好了下一PC计算模块，其中<code>take_branch</code>输出就是是否跳转。在跳转时，我们需要让程序计数器的下一PC取到跳转目标地址，并冲刷IF/ID级的流水线寄存器。为了分别以后接入分支跳转预测模块，我们预留一个输入端口。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">logic</span> branch_predicted_result;</span><br><span class="line"><span class="comment">// 此处设置为静态不预测 因此获取EX级的跳转结果</span></span><br><span class="line"><span class="comment">// assign branch_predicted_result = branch_predicted_i;</span></span><br><span class="line"><span class="keyword">assign</span> branch_predicted_result = take_branch_NextPC;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 流水线冲刷与停顿</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">    keep_pc     = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    stall_IF_ID = load_use_hazard ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    flush_IF_ID = branch_predicted_result ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    flush_ID_EX = (branch_predicted_result || load_use_hazard) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>然后写个简单的分支跳转测试：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">addi x1, x0, 5   # x1 = 5</span><br><span class="line">addi x2, x0, 5   # x2 = 5</span><br><span class="line">addi x3, x0, 0   # x3 = 0</span><br><span class="line"></span><br><span class="line">beq  x1, x2, 8   # 跳转到PC+8（跳过下一条），x1==x2时跳转</span><br><span class="line">addi x3, x3, 1   # 未跳转时执行（应被跳过）</span><br><span class="line"></span><br><span class="line">addi x4, x0, 10  # x4 = 10</span><br><span class="line"></span><br><span class="line">addi x5, x0, 7</span><br><span class="line">bne  x1, x5, 8   # 跳转到PC+8（跳过下一条），x1!=x5时跳转</span><br><span class="line">addi x4, x4, 1   # 未跳转时执行（应被跳过）</span><br><span class="line"></span><br><span class="line">addi x6, x0, 3</span><br><span class="line">blt  x6, x1, 8   # 跳转到PC+8（跳过下一条），x6&lt;x1时跳转</span><br><span class="line">addi x4, x4, 2   # 未跳转时执行（应被跳过）</span><br><span class="line"></span><br><span class="line">addi x7, x0, 5</span><br><span class="line">bge  x1, x7, 8   # 跳转到PC+8（跳过下一条），x1&gt;=x7时跳转</span><br><span class="line">addi x4, x4, 3   # 未跳转时执行（应被跳过）</span><br><span class="line"></span><br><span class="line">addi x8, x0, 100 # 跳转后执行</span><br><span class="line"></span><br><span class="line"># 最终寄存器值为：</span><br><span class="line"># x3 = 0 (未执行任何加1操作)</span><br><span class="line"># x4 = 10 (未执行任何加1或加2或加3操作)</span><br></pre></td></tr></table></figure><p>运行一下：</p><p><img src="https://webp.esing.dev/img/image-20251211111927124_251211_1119_kPCt.png" alt="分支跳转正确执行"></p><p>可以看到程序计数器接受了<code>branch_op</code>信号并正确选择了分支跳转结果。</p><p>为什么<code>x3</code>变为0后，过了四个周期，<code>x4</code>才变为10？这是因为我们直接阻塞流水线，<code>x3</code>的值可以通过旁路提前送过去，但是只有在<code>beq</code>执行完毕后才能得知是否跳转。跳转目标的指令<code>addi x4</code>在<code>beq</code>指令 EX 级结束后的下一周期才进入IF级：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   x3  x4      IF          ID          EX          MEM         WB</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">1   x   x      addi  0</span><br><span class="line">2   x   x      beq        addi  0</span><br><span class="line">3   x   x      addi  1    beq          addi  0</span><br><span class="line">4   x   x      addi  1    !==阻塞!==   beq         addi  0</span><br><span class="line">5   0   x      addi 10    &lt;==========得出结果=|                addi  0  -|</span><br><span class="line">6   0   x                 addi 10                                        |</span><br><span class="line">7   0   x                              addi 10                           |- 四个周期</span><br><span class="line">8   0   x                                          addi 10               |</span><br><span class="line">9   0   10                                                     addi 10  -|</span><br></pre></td></tr></table></figure><h2 id="数据冒险控制模块-HazardUnit-sv">数据冒险控制模块 HazardUnit.sv</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> HazardUnit (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// LOAD指令判断</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_EX,</span><br><span class="line">    <span class="comment">// 寄存器使用信号</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rs1_used_ID,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rs2_used_ID,</span><br><span class="line">    <span class="comment">// ID级源寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] rR1_ID,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] rR2_ID,</span><br><span class="line">    <span class="comment">// EX级目的寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wR_EX,</span><br><span class="line">    <span class="comment">// MEM级目的寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wR_MEM,</span><br><span class="line">    <span class="comment">// WB级目的寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wR_WB,</span><br><span class="line">    <span class="comment">// 写入数据使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_EX,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_MEM,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_WB,</span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rf_wd_EX,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rf_wd_MEM,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rf_wd_WB,</span><br><span class="line">    <span class="comment">// 预留的分支预测结果</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        branch_predicted_i,</span><br><span class="line">    <span class="comment">// PC保持信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        keep_pc,</span><br><span class="line">    <span class="comment">// IF/ID停顿信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        stall_IF_ID,</span><br><span class="line">    <span class="comment">// IF/ID冲刷信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        flush_IF_ID,</span><br><span class="line">    <span class="comment">// ID/EX冲刷信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        flush_ID_EX,</span><br><span class="line">    <span class="comment">// 前递使能</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        fwd_rD1e_ID,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        fwd_rD2e_ID,</span><br><span class="line">    <span class="comment">// 前递数据</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] fwd_rD1_ID,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] fwd_rD2_ID</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RAW 冒险判断</span></span><br><span class="line">    <span class="comment">// verilog_format: off</span></span><br><span class="line">    <span class="keyword">logic</span> RAW_1_rD1, RAW_1_rD2;</span><br><span class="line">    <span class="keyword">logic</span> RAW_2_rD1, RAW_2_rD2;</span><br><span class="line">    <span class="keyword">logic</span> RAW_3_rD1, RAW_3_rD2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 间隔一级流水线 判断下写入的不为x0即可</span></span><br><span class="line">        RAW_1_rD1 = (wR_EX ==  rR1_ID) &amp;&amp;  rf_we_EX &amp;&amp; rs1_used_ID &amp;&amp; (wR_EX != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        RAW_1_rD2 = (wR_EX ==  rR2_ID) &amp;&amp;  rf_we_EX &amp;&amp; rs2_used_ID &amp;&amp; (wR_EX != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        <span class="comment">// 间隔两级流水线</span></span><br><span class="line">        RAW_2_rD1 = (wR_MEM == rR1_ID) &amp;&amp; rf_we_MEM &amp;&amp; rs1_used_ID &amp;&amp; (wR_MEM != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        RAW_2_rD2 = (wR_MEM == rR2_ID) &amp;&amp; rf_we_MEM &amp;&amp; rs2_used_ID &amp;&amp; (wR_MEM != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        <span class="comment">// 间隔三级流水线</span></span><br><span class="line">        RAW_3_rD1 = (wR_WB ==  rR1_ID) &amp;&amp;  rf_we_WB &amp;&amp; rs1_used_ID &amp;&amp; (wR_WB != <span class="number">5&#x27;b0</span>);</span><br><span class="line">        RAW_3_rD2 = (wR_WB ==  rR2_ID) &amp;&amp;  rf_we_WB &amp;&amp; rs2_used_ID &amp;&amp; (wR_WB != <span class="number">5&#x27;b0</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前递使能信号生成</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        fwd_rD1e_ID = RAW_1_rD1 || RAW_2_rD1 || RAW_3_rD1;</span><br><span class="line">        fwd_rD2e_ID = RAW_1_rD2 || RAW_2_rD2 || RAW_3_rD2;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前递数据选择</span></span><br><span class="line">    <span class="comment">// 优先级：EX &gt; MEM &gt; WB</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// case-true 语句</span></span><br><span class="line">        <span class="comment">// 源操作数1前递数据选择</span></span><br><span class="line">        <span class="keyword">case</span> (<span class="number">1&#x27;b1</span>)</span><br><span class="line">            RAW_1_rD1: fwd_rD1_ID = rf_wd_EX;  <span class="comment">// 来自EX级</span></span><br><span class="line">            RAW_2_rD1: fwd_rD1_ID = rf_wd_MEM; <span class="comment">// 来自MEM级</span></span><br><span class="line">            RAW_3_rD1: fwd_rD1_ID = rf_wd_WB;</span><br><span class="line">            <span class="keyword">default</span>:   fwd_rD1_ID = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">        <span class="comment">// 源操作数2前递数据选择</span></span><br><span class="line">        <span class="keyword">case</span> (<span class="number">1&#x27;b1</span>)</span><br><span class="line">            RAW_1_rD2: fwd_rD2_ID = rf_wd_EX;  <span class="comment">// 来自EX级</span></span><br><span class="line">            RAW_2_rD2: fwd_rD2_ID = rf_wd_MEM; <span class="comment">// 来自MEM级</span></span><br><span class="line">            RAW_3_rD2: fwd_rD2_ID = rf_wd_WB;</span><br><span class="line">            <span class="keyword">default</span>:   fwd_rD2_ID = <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format: on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load_use 冒险判断</span></span><br><span class="line">    <span class="keyword">logic</span> load_use_hazard;</span><br><span class="line">    <span class="keyword">assign</span> load_use_hazard = (wd_sel_EX == `WD_SEL_FROM_DRAM) &amp;&amp; (RAW_1_rD1 || RAW_1_rD2);</span><br><span class="line">    <span class="comment">// assign load_use_hazard = 1&#x27;b0;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [TODO] 静态分支预测</span></span><br><span class="line">    <span class="comment">// [TODO] 动态分支预测</span></span><br><span class="line">    <span class="keyword">logic</span> branch_predicted_result;</span><br><span class="line">    <span class="comment">// 此处设置为静态不预测 因此获取EX级的跳转结果</span></span><br><span class="line">    <span class="keyword">assign</span> branch_predicted_result = branch_predicted_i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 流水线冲刷与停顿</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        keep_pc     = load_use_hazard                              ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">        stall_IF_ID = load_use_hazard                              ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">        flush_IF_ID = branch_predicted_result                      ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">        flush_ID_EX = (branch_predicted_result || load_use_hazard) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="复杂测试">复杂测试</h2><p>到此，我们的CPU已经完成70%了。运行一些复杂的汇编程序，不出意外的话，是不会有问题的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br></pre></td><td class="code"><pre><span class="line"># ========================================</span><br><span class="line"># RV32I Complete Test Suite (No Pseudo Instructions)</span><br><span class="line"># Testing all RV32I instructions without misaligned access</span><br><span class="line"># ========================================</span><br><span class="line"></span><br><span class="line">    .text</span><br><span class="line">    .globl _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line"># ========================================</span><br><span class="line"># 1. Test ADDI - Add Immediate</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x1, x0, 100                   # x1 = 0 + 100 = 100 (0x64)</span><br><span class="line">    addi   x2, x0, 200                   # x2 = 0 + 200 = 200 (0xC8)</span><br><span class="line">    addi   x3, x1, 50                    # x3 = 100 + 50 = 150 (0x96)</span><br><span class="line">    addi   x4, x0, -10                   # x4 = 0 + (-10) = -10 (0xFFFFFFF6)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 2. Test ADD - Add Register</span><br><span class="line"># ========================================</span><br><span class="line">    add    x5, x1, x2                    # x5 = 100 + 200 = 300 (0x12C)</span><br><span class="line">    add    x6, x3, x4                    # x6 = 150 + (-10) = 140 (0x8C)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 3. Test SUB - Subtract</span><br><span class="line"># ========================================</span><br><span class="line">    sub    x7, x2, x1                    # x7 = 200 - 100 = 100 (0x64)</span><br><span class="line">    sub    x8, x1, x2                    # x8 = 100 - 200 = -100 (0xFFFFFF9C)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 4. Test SLTI - Set Less Than Immediate (Signed)</span><br><span class="line"># ========================================</span><br><span class="line">    slti   x9, x1, 101                   # x9 = (100 &lt; 101) = 1</span><br><span class="line">    slti   x10, x1, 99                   # x10 = (100 &lt; 99) = 0</span><br><span class="line">    slti   x11, x4, 0                    # x11 = (-10 &lt; 0) = 1</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 5. Test SLTIU - Set Less Than Immediate (Unsigned)</span><br><span class="line"># ========================================</span><br><span class="line">    sltiu  x12, x1, 101                  # x12 = (100 &lt; 101) = 1</span><br><span class="line">    sltiu  x13, x4, 10                   # x13 = (0xFFFFFFF6 &lt; 10) = 0 (unsigned compare)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 6. Test SLT - Set Less Than (Signed)</span><br><span class="line"># ========================================</span><br><span class="line">    slt    x14, x1, x2                   # x14 = (100 &lt; 200) = 1</span><br><span class="line">    slt    x15, x2, x1                   # x15 = (200 &lt; 100) = 0</span><br><span class="line">    slt    x16, x4, x1                   # x16 = (-10 &lt; 100) = 1</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 7. Test SLTU - Set Less Than (Unsigned)</span><br><span class="line"># ========================================</span><br><span class="line">    sltu   x17, x1, x2                   # x17 = (100 &lt; 200) = 1</span><br><span class="line">    sltu   x18, x4, x1                   # x18 = (0xFFFFFFF6 &lt; 100) = 0 (unsigned)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 8. Test Logical Operations - ANDI, ORI, XORI</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x19, x0, 255                  # x19 = 255 (0xFF)</span><br><span class="line">    andi   x20, x19, 15                  # x20 = 255 &amp; 15 = 15 (0x0F)</span><br><span class="line">    ori    x21, x20, 240                 # x21 = 15 | 240 = 255 (0xFF)</span><br><span class="line">    xori   x22, x21, 170                 # x22 = 255 ^ 170 = 85 (0x55)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 9. Test Logical Operations - AND, OR, XOR</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x23, x0, 60                   # x23 = 60 (0x3C = 0b00111100)</span><br><span class="line">    addi   x24, x0, 51                   # x24 = 51 (0x33 = 0b00110011)</span><br><span class="line">    and    x25, x23, x24                 # x25 = 60 &amp; 51 = 48 (0x30)</span><br><span class="line">    or     x26, x23, x24                 # x26 = 60 | 51 = 63 (0x3F)</span><br><span class="line">    xor    x27, x23, x24                 # x27 = 60 ^ 51 = 15 (0x0F)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 10. Test Shift Operations - SLLI, SRLI, SRAI</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x28, x0, 8                    # x28 = 8 (0x08)</span><br><span class="line">    slli   x29, x28, 2                   # x29 = 8 &lt;&lt; 2 = 32 (0x20)</span><br><span class="line">    srli   x30, x29, 1                   # x30 = 32 &gt;&gt; 1 = 16 (0x10)</span><br><span class="line">    addi   x31, x0, -8                   # x31 = -8 (0xFFFFFFF8)</span><br><span class="line">    srai   x1, x31, 1                    # x1 = -8 &gt;&gt; 1 = -4 (0xFFFFFFFC, arithmetic shift)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 11. Test Shift Operations - SLL, SRL, SRA</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x2, x0, 16                    # x2 = 16</span><br><span class="line">    addi   x3, x0, 2                     # x3 = 2 (shift amount)</span><br><span class="line">    sll    x4, x2, x3                    # x4 = 16 &lt;&lt; 2 = 64 (0x40)</span><br><span class="line">    srl    x5, x4, x3                    # x5 = 64 &gt;&gt; 2 = 16 (0x10)</span><br><span class="line">    addi   x6, x0, -16                   # x6 = -16 (0xFFFFFFF0)</span><br><span class="line">    sra    x7, x6, x3                    # x7 = -16 &gt;&gt; 2 = -4 (0xFFFFFFFC)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 12. Test LUI - Load Upper Immediate</span><br><span class="line"># ========================================</span><br><span class="line">    lui    x8, 0x12345                   # x8 = 0x12345000</span><br><span class="line">    lui    x9, 0xFFFFF                   # x9 = 0xFFFFF000</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 13. Test AUIPC - Add Upper Immediate to PC</span><br><span class="line"># ========================================</span><br><span class="line">    auipc  x10, 0                        # x10 = current PC + 0</span><br><span class="line">    auipc  x11, 1                        # x11 = current PC + 0x1000</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 14. Test Memory Operations - Store and Load</span><br><span class="line"># Setup memory base address</span><br><span class="line"># ========================================</span><br><span class="line">    lui    x12, 0x10000                  # x12 = 0x10000000 (memory base)</span><br><span class="line"></span><br><span class="line"># Store values</span><br><span class="line">    lui    x15, 0xABCDE                  # x15 = 0xABCDE000</span><br><span class="line">    addi   x15, x15, 0x789               # x15 = 0xABCDE789</span><br><span class="line">    sw     x15, 8(x12)                   # Store word: mem[0x10000008] = 0xABCDE789</span><br><span class="line"></span><br><span class="line"># Load values</span><br><span class="line"></span><br><span class="line">    lw     x26, 8(x12)                   # x26 = 0xABCDE789</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 15. Test Branch Instructions - BEQ</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x27, x0, 10                   # x27 = 10</span><br><span class="line">    addi   x28, x0, 10                   # x28 = 10</span><br><span class="line">    beq    x27, x28, branch_eq_taken     # Should branch (10 == 10)</span><br><span class="line">    addi   x29, x0, 99                   # x29 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_eq_taken:</span><br><span class="line">    addi   x29, x0, 1                    # x29 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line">    addi   x27, x0, 10                   # x27 = 10</span><br><span class="line">    addi   x28, x0, 20                   # x28 = 20</span><br><span class="line">    beq    x27, x28, branch_eq_not_taken # Should not branch</span><br><span class="line">    addi   x30, x0, 1                    # x30 = 1 (not taken marker)</span><br><span class="line"></span><br><span class="line">branch_eq_not_taken:</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 16. Test Branch Instructions - BNE</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x1, x0, 5                     # x1 = 5</span><br><span class="line">    addi   x2, x0, 10                    # x2 = 10</span><br><span class="line">    bne    x1, x2, branch_ne_taken       # Should branch (5 != 10)</span><br><span class="line">    addi   x3, x0, 99                    # x3 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_ne_taken:</span><br><span class="line">    addi   x3, x0, 1                     # x3 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 17. Test Branch Instructions - BLT (Signed)</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x4, x0, 5                     # x4 = 5</span><br><span class="line">    addi   x5, x0, 10                    # x5 = 10</span><br><span class="line">    blt    x4, x5, branch_lt_taken       # Should branch (5 &lt; 10)</span><br><span class="line">    addi   x6, x0, 99                    # x6 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_lt_taken:</span><br><span class="line">    addi   x6, x0, 1                     # x6 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line">    addi   x7, x0, -5                    # x7 = -5</span><br><span class="line">    addi   x8, x0, 3                     # x8 = 3</span><br><span class="line">    blt    x7, x8, branch_lt_neg_taken   # Should branch (-5 &lt; 3)</span><br><span class="line">    addi   x9, x0, 99                    # x9 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_lt_neg_taken:</span><br><span class="line">    addi   x9, x0, 1                     # x9 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 18. Test Branch Instructions - BGE (Signed)</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x10, x0, 10                   # x10 = 10</span><br><span class="line">    addi   x11, x0, 5                    # x11 = 5</span><br><span class="line">    bge    x10, x11, branch_ge_taken     # Should branch (10 &gt;= 5)</span><br><span class="line">    addi   x12, x0, 99                   # x12 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_ge_taken:</span><br><span class="line">    addi   x12, x0, 1                    # x12 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 19. Test Branch Instructions - BLTU (Unsigned)</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x13, x0, 5                    # x13 = 5</span><br><span class="line">    addi   x14, x0, 10                   # x14 = 10</span><br><span class="line">    bltu   x13, x14, branch_ltu_taken    # Should branch (5 &lt; 10 unsigned)</span><br><span class="line">    addi   x15, x0, 99                   # x15 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_ltu_taken:</span><br><span class="line">    addi   x15, x0, 1                    # x15 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 20. Test Branch Instructions - BGEU (Unsigned)</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x16, x0, 10                   # x16 = 10</span><br><span class="line">    addi   x17, x0, 5                    # x17 = 5</span><br><span class="line">    bgeu   x16, x17, branch_geu_taken    # Should branch (10 &gt;= 5 unsigned)</span><br><span class="line">    addi   x18, x0, 99                   # x18 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">branch_geu_taken:</span><br><span class="line">    addi   x18, x0, 1                    # x18 = 1 (branch taken marker)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 21. Test JAL - Jump and Link</span><br><span class="line"># ========================================</span><br><span class="line">    jal    x19, jal_target               # x19 = return address, jump to jal_target</span><br><span class="line">    addi   x20, x0, 99                   # x20 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">jal_target:</span><br><span class="line">    addi   x20, x0, 1                    # x20 = 1 (jump successful)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 22. Test JALR - Jump and Link Register</span><br><span class="line"># ========================================</span><br><span class="line">    auipc  x21, 0                        # x21 = current PC</span><br><span class="line">    addi   x21, x21, 16                  # x21 = PC + 16 (target address)</span><br><span class="line">    jalr   x22, x21, 0                   # x22 = return address, jump to x21</span><br><span class="line">    addi   x23, x0, 99                   # x23 = 99 (SHOULD NOT EXECUTE)</span><br><span class="line"></span><br><span class="line">jalr_target:</span><br><span class="line">    addi   x23, x0, 1                    # x23 = 1 (jump successful)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 23. Test Complex Data Dependencies</span><br><span class="line"># ========================================</span><br><span class="line">    addi   x24, x0, 1                    # x24 = 1</span><br><span class="line">    addi   x24, x24, 2                   # x24 = 3</span><br><span class="line">    addi   x24, x24, 3                   # x24 = 6</span><br><span class="line">    addi   x24, x24, 4                   # x24 = 10</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 24. Test Edge Cases</span><br><span class="line"># ========================================</span><br><span class="line"># Maximum positive immediate</span><br><span class="line">    addi   x25, x0, 2047                 # x25 = 2047 (0x7FF, max 12-bit signed)</span><br><span class="line"></span><br><span class="line"># Maximum negative immediate</span><br><span class="line">    addi   x26, x0, -2048                # x26 = -2048 (0xFFFFF800)</span><br><span class="line"></span><br><span class="line"># Overflow test</span><br><span class="line">    lui    x27, 0x7FFFF                  # x27 = 0x7FFFF000</span><br><span class="line">    addi   x27, x27, 0x7FF               # x27 = 0x7FFFF7FF (near max positive)</span><br><span class="line">    addi   x28, x0, 1                    # x28 = 1</span><br><span class="line">    add    x29, x27, x28                 # x29 = overflow result</span><br><span class="line"></span><br><span class="line"># Zero register test</span><br><span class="line">    addi   x0, x0, 100                   # x0 should remain 0</span><br><span class="line">    add    x30, x0, x0                   # x30 = 0</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># 25. Final Test - Load/Store with Computed Address</span><br><span class="line"># ========================================</span><br><span class="line">    lui    x31, 0x10000                  # x31 = 0x10000000</span><br><span class="line">    addi   x1, x0, 100                   # x1 = 100 (offset)</span><br><span class="line">    add    x2, x31, x1                   # x2 = 0x10000000 + 100</span><br><span class="line">    addi   x3, x0, 0x55A                 # x3 = 0x55AA</span><br><span class="line">    sw     x3, 0(x2)                     # Store at computed address</span><br><span class="line">    lw     x4, 0(x2)                     # x4 = 0x55AA (load back)</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># End of Test - Infinite Loop</span><br><span class="line"># ========================================</span><br><span class="line">end_loop:</span><br><span class="line">    beq    x0, x0, end_loop              # Infinite loop</span><br><span class="line"></span><br><span class="line"># ========================================</span><br><span class="line"># Expected Register Values After Test:</span><br><span class="line"># ========================================</span><br><span class="line"># x0 = 0x00000000 (always zero)</span><br><span class="line"># x1 = 100 (0x64)</span><br><span class="line"># x2 = 0x10000064</span><br><span class="line"># x3 = 0x000055AA</span><br><span class="line"># x4 = 0x000055AA</span><br><span class="line"># x5 = 16 (0x10)</span><br><span class="line"># x6 = -16 (0xFFFFFFF0)</span><br><span class="line"># x7 = -4 (0xFFFFFFFC)</span><br><span class="line"># x8 = 0x12345000</span><br><span class="line"># x9 = 0xFFFFF000</span><br><span class="line"># x10 = PC value at AUIPC</span><br><span class="line"># x11 = PC value + 0x1000</span><br><span class="line"># x12 = 0x10000000</span><br><span class="line"># x13 = 127 (0x7F)</span><br><span class="line"># x14 = 0x1234</span><br><span class="line"># x15 = 1 (branch marker)</span><br><span class="line"># x16 = 10</span><br><span class="line"># x17 = 5</span><br><span class="line"># x18 = 1 (branch marker)</span><br><span class="line"># x19 = return address from JAL</span><br><span class="line"># x20 = 1</span><br><span class="line"># x21 = target address</span><br><span class="line"># x22 = return address from JALR</span><br><span class="line"># x23 = 1</span><br><span class="line"># x24 = 10</span><br><span class="line"># x25 = 2047 (0x7FF)</span><br><span class="line"># x26 = -2048 (0xFFFFF800)</span><br><span class="line"># x27 = 0x7FFFF7FF</span><br><span class="line"># x28 = 1</span><br><span class="line"># x29 = 0x7FFFF800 (overflow wrapped)</span><br><span class="line"># x30 = 0</span><br><span class="line"># x31 = 0x10000000</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>效果非常好！</p><p><img src="https://webp.esing.dev/img/image-20251211123703587_251211_1237_oVPZ.png" alt="完整测试"></p><p>为什么才完成70%？那是因为我们还没有支持<code>lb/lh</code>和<code>sb/sh</code>一类指令。在这之前，我们还有一个<strong>历史遗留问题</strong>需要去解决，那就是<strong>无法被综合的同步写异步读DRAM</strong>……</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前递：快人一步&quot;&gt;前递：快人一步&lt;/h2&gt;
&lt;h3 id=&quot;激烈的斗争&quot;&gt;激烈的斗争&lt;/h3&gt;
&lt;p&gt;我们做完了吗？还没完。&lt;/p&gt;
&lt;p&gt;在 &lt;a href=&quot;/2025/12/10</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第七篇</title>
    <link href="https://blog.esing.dev/2025/12/10/riscvcod-p7/"/>
    <id>https://blog.esing.dev/2025/12/10/riscvcod-p7/</id>
    <published>2025-12-10T13:00:00.000Z</published>
    <updated>2025-12-11T10:37:58.994Z</updated>
    
    <content type="html"><![CDATA[<h2 id="访存-MEM级-设计">访存 MEM级 设计</h2><p>访存访存，顾名思义，就是要去访问内存。这个内存是“数据内存”，因为我们写的CPU采用的是<strong>哈佛架构</strong>，指令内存和数据内存分离。</p><h3 id="数据内存-DRAM-sv">数据内存 DRAM.sv</h3><p>首先登场的是数据内存。非常简单，实例化一堆RDFF即可。为什么是RDFF？为了便于测验<s>交作业</s>，我们<strong>暂时</strong>把DRAM写成 <strong>“同步写、异步读”</strong> 的。</p><div class="note danger flat"><p>几乎所有厂商都不支持“同步写、异步读”的DRAM，综合器也无法将其综合为DRAM。对于Xilinx的IP核，其BRAM是同步读写的，有的甚至需要两拍。</p></div><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DRAM 行为模型 - 用于仿真</span></span><br><span class="line"><span class="comment">// 替代 Xilinx IP 核</span></span><br><span class="line"><span class="comment">// [HACK] Vivado无法综合异步读的RAM</span></span><br><span class="line"><span class="keyword">module</span> DRAM (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,  <span class="comment">// 时钟</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">15</span>:<span class="number">0</span>] a,    <span class="comment">// 地址输入 (16位 = 64K words)</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] spo,  <span class="comment">// 数据输出</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        we,   <span class="comment">// 写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] din   <span class="comment">// 数据输入</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据存储器 - 16K x 32bit</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] ram_data[<span class="number">65536</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">integer</span>             i;</span><br><span class="line">        <span class="keyword">reg</span>     [<span class="number">256</span>*<span class="number">8</span>-<span class="number">1</span>:<span class="number">0</span>] ram_file;  <span class="comment">// 字符串缓冲区</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">65536</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            ram_data[i] = <span class="number">32&#x27;h00000000</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            rom_file =</span><br><span class="line">            <span class="comment">// &quot;user/data/hex/sw_lw.hex&quot;</span></span><br><span class="line">            <span class="string">&quot;user/data/hex/addi.hex&quot;</span></span><br><span class="line">            ;</span><br><span class="line">            <span class="built_in">$readmemh</span>(rom_file, rom_data, <span class="number">0</span>, <span class="number">16383</span>);</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;IROM: Loaded instructions from %s&quot;</span>, rom_file);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写操作 (同步)</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (we) <span class="keyword">begin</span></span><br><span class="line">            ram_data[a] &lt;= din;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [HACK] 异步读</span></span><br><span class="line">    <span class="comment">// assign spo = ram_data[a];</span></span><br><span class="line">    <span class="comment">// 确保在写操作时读出未知值</span></span><br><span class="line">    <span class="keyword">assign</span> spo = we ? &#x27;x : ram_data[a];</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="DRAM数据选择MUX">DRAM数据选择MUX</h3><p>来自EX级的数据只有来自ID级的<code>rD2</code>。也不容易了，一路走到这里。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回写数据来源2选择MUX</span></span><br><span class="line"><span class="comment">// 选择是否为DRAM数据</span></span><br><span class="line"><span class="comment">// 对于同步DRAM 将MUX放到WB级</span></span><br><span class="line"><span class="keyword">assign</span> rf_wd_MEM = (wd_sel_MEM == `WD_SEL_FROM_DRAM) ? DRAM_output_data : rf_wd_MEM_PR2MUX;</span><br></pre></td></tr></table></figure><h3 id="MEM-WB级-流水线寄存器-PR-MEM-WB-sv">MEM/WB级 流水线寄存器 PR_MEM_WB.sv</h3><p>已经到最后一级了，信号也被分流的差不多了。</p><p>我们需要将L-Type需要的寄存器写入数据<code>rf_wd</code>传入WB级，准备写回；与之一起进入的还有寄存器堆写使能信号<code>rf_we</code>，和写入目标寄存器地址<code>wr</code>。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PR_MEM_WB (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 寄存器堆写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_mem_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rf_we_wb_o,</span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_mem_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_wb_o,</span><br><span class="line">    <span class="comment">// 写回数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] wd_mem_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] wd_wb_o</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            rf_we_wb_o       &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            wr_wb_o          &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">            wd_wb_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            rf_we_wb_o       &lt;= rf_we_mem_i;</span><br><span class="line">            wr_wb_o          &lt;= wr_mem_i;</span><br><span class="line">            wd_wb_o          &lt;= wd_mem_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="写回-WB级-设计">写回 WB级 设计</h2><p>WB级其实根本不用去设计——因为这一级根本没内容，只需要将要写回的数据送入寄存器堆即可。</p><h2 id="顶层模块封装-CPU-TOP-sv">顶层模块封装 CPU_TOP.sv</h2><p>到此为止，我们已经完成了所有的流水线。接着，就是把它们拼在一起了。</p><p>我们封装后的CPU应当有IROM接口，输出地址、取回指令。此外，还要有时钟输入和低电平有效的复位信号。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> CPU_TOP (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 来自指令存储器IROM的指令</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr,</span><br><span class="line">    <span class="comment">// 输出给指令存储器IROM的地址</span></span><br><span class="line">    <span class="comment">// 这里实际上是PC的高14位</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">13</span>:<span class="number">0</span>] pc</span><br><span class="line">);</span><br></pre></td></tr></table></figure><div class="note info flat"><p>因为指令存储器以“字”（word）为单位寻址，且深度一般为2<sup>14</sup>，对于普通RISCV指令来说占了4字节，且低两位恒为0（必须4字节对齐），所以取高14位即可。</p></div><p>我们从IF级拿的指令，直接取高14位：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> pc = pc_IF[<span class="number">15</span>:<span class="number">2</span>];</span><br></pre></td></tr></table></figure><p>之后对于各级模块，连线连起来即可。比较好的习惯是将信号所处的级做名称结尾。</p><h2 id="仿真测试！">仿真测试！</h2><p>虽然我们写的是SystemVerilog，但是iverilog还是支持一些特性的——或者说，有warning有sorry但是工作正常。能跑就算语法支持，不过实际运行效果肯定是不如verilator的。</p><p>首先要写一个顶层模块，加入一些激励信号，并引出寄存器连线，便于观察：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;../src/CPU_TOP.sv&quot;</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> DEBUG </span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> REG_FILE u_CPU_TOP.u_registerf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> tb_CPU_TOP;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 时钟和复位信号</span></span><br><span class="line">    <span class="keyword">logic</span>        clk;</span><br><span class="line">    <span class="keyword">logic</span>        rst_n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IROM 信号</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">13</span>:<span class="number">0</span>] irom_addr;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] irom_data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化 IROM (指令存储器)</span></span><br><span class="line">    IROM u_IROM (</span><br><span class="line">        <span class="variable">.a</span>  (irom_addr),</span><br><span class="line">        <span class="variable">.spo</span>(irom_data)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化 CPU_TOP</span></span><br><span class="line">    CPU_TOP u_CPU_TOP (</span><br><span class="line">        <span class="variable">.clk</span>  (clk),</span><br><span class="line">        <span class="variable">.rst_n</span>(rst_n),</span><br><span class="line">        <span class="variable">.instr</span>(irom_data),</span><br><span class="line">        <span class="variable">.pc</span>   (irom_addr)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verilog_format: off</span></span><br><span class="line"><span class="comment">// 寄存器堆监控信号</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] x0, x1, <span class="comment">// ...</span></span><br><span class="line">    x31;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        x0  = `REG_FILE<span class="variable">.rf_in</span>[<span class="number">0</span>];</span><br><span class="line">        x1  = `REG_FILE<span class="variable">.rf_in</span>[<span class="number">1</span>];</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">        x31 = `REG_FILE<span class="variable">.rf_in</span>[<span class="number">31</span>];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// verilog_format: on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 时钟生成 (100MHz, 周期 10ns)</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        clk = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">forever</span> #<span class="number">5</span> clk = ~clk;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复位和测试控制</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 波形文件设置</span></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> VCD_FILEPATH</span></span><br><span class="line">        <span class="built_in">$dumpfile</span>(`VCD_FILEPATH);</span><br><span class="line"><span class="meta">`<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">$dumpfile</span>(<span class="string">&quot;wave.vcd&quot;</span>);</span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line">        <span class="built_in">$dumpvars</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化信号</span></span><br><span class="line">        rst_n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 复位 CPU</span></span><br><span class="line">        #<span class="number">5</span>;  <span class="comment">// 保持复位 25ns</span></span><br><span class="line">        rst_n = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;CPU Reset Released at time %0t&quot;</span>, <span class="built_in">$time</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 运行一段时间让 CPU 执行指令</span></span><br><span class="line">        #<span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;Simulation finished at time %0t&quot;</span>, <span class="built_in">$time</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印寄存器堆状态</span></span><br><span class="line">        print_register_file();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">$finish</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监控关键信号</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;Time\t| PC\t| Instruction\t| Stage&quot;</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">            @(<span class="keyword">posedge</span> clk);</span><br><span class="line">            <span class="keyword">if</span> (rst_n) <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// IF 级</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.valid_IF</span>)</span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;%0t\t| %h\t| %h\t| IF&quot;</span>, <span class="built_in">$time</span>, u_CPU_TOP<span class="variable">.pc_IF</span>, u_CPU_TOP<span class="variable">.instr_IF</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ID 级</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.valid_ID</span> &amp;&amp; u_CPU_TOP<span class="variable">.instr_ID</span> != <span class="number">32&#x27;h00000013</span>)  <span class="comment">// 跳过 NOP</span></span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;%0t\t| %h\t| %h\t| ID&quot;</span>, <span class="built_in">$time</span>, u_CPU_TOP<span class="variable">.pc_ID</span>, u_CPU_TOP<span class="variable">.instr_ID</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// EX 级</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.valid_EX</span>)</span><br><span class="line">                    <span class="built_in">$display</span>(</span><br><span class="line">                        <span class="string">&quot;%0t\t| %h\t| --------\t| EX \t (ALU=0x%h)&quot;</span>,</span><br><span class="line">                        <span class="built_in">$time</span>,</span><br><span class="line">                        u_CPU_TOP<span class="variable">.pc_EX</span>,</span><br><span class="line">                        u_CPU_TOP<span class="variable">.alu_result_EX</span></span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                <span class="comment">// MEM 级</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.dram_we_MEM</span>) <span class="keyword">begin</span></span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;%0t\t| 0x%4h &lt;| 0x%h\t|[MEM W]&quot;</span>, <span class="built_in">$time</span>,</span><br><span class="line">                             u_CPU_TOP<span class="variable">.alu_result_MEM</span>[<span class="number">17</span>:<span class="number">2</span>], u_CPU_TOP<span class="variable">.rf_rd2_MEM</span>);</span><br><span class="line">                <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.wd_sel_MEM</span>)</span><br><span class="line">                        <span class="built_in">$display</span>(</span><br><span class="line">                            <span class="string">&quot;%0t\t| 0x%4h |&gt; 0x%h\t|[MEM R]&quot;</span>,</span><br><span class="line">                            <span class="built_in">$time</span>,</span><br><span class="line">                            u_CPU_TOP<span class="variable">.alu_result_MEM</span>[<span class="number">17</span>:<span class="number">2</span>],</span><br><span class="line">                            u_CPU_TOP<span class="variable">.DRAM_output_data</span></span><br><span class="line">                        );</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监控寄存器写回操作</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">            @(<span class="keyword">posedge</span> clk);</span><br><span class="line">            <span class="keyword">if</span> (rst_n &amp;&amp; u_CPU_TOP<span class="variable">.rf_we_WB</span> &amp;&amp; u_CPU_TOP<span class="variable">.wR_WB</span> != <span class="number">0</span>) <span class="keyword">begin</span></span><br><span class="line">                <span class="built_in">$display</span>(<span class="string">&quot;%0t\t|  x%-2d   &lt;= 0x%h \t|[WB]&quot;</span>, <span class="built_in">$time</span>, u_CPU_TOP<span class="variable">.wR_WB</span>,</span><br><span class="line">                         u_CPU_TOP<span class="variable">.rf_wd_WB</span>);</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印寄存器堆内容的任务</span></span><br><span class="line">    <span class="keyword">task</span> <span class="keyword">automatic</span> print_register_file();</span><br><span class="line">        <span class="keyword">integer</span> i;</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;\n========================================&quot;</span>);</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;Register File Contents:&quot;</span>);</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (u_CPU_TOP<span class="variable">.u_registerf</span><span class="variable">.rf_in</span>[i] != <span class="number">0</span>) <span class="keyword">begin</span></span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;x%0d\t= 0x%h\t(%0d)&quot;</span>, i, u_CPU_TOP<span class="variable">.u_registerf</span><span class="variable">.rf_in</span>[i],</span><br><span class="line">                             <span class="built_in">$signed</span>(u_CPU_TOP<span class="variable">.u_registerf</span><span class="variable">.rf_in</span>[i]));</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;========================================\n&quot;</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 超时保护</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        #<span class="number">5000</span>;  <span class="comment">// 50us 超时</span></span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">&quot;ERROR: Simulation timeout!&quot;</span>);</span><br><span class="line">        <span class="built_in">$finish</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新建一个时钟 为clk的两倍周期 便于观察</span></span><br><span class="line">    <span class="keyword">logic</span>        slow_clk;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">unsigned</span> count;</span><br><span class="line">    <span class="keyword">initial</span> slow_clk = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        slow_clk &lt;= ~slow_clk;</span><br><span class="line">        count    &lt;= count + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之后用iverilog编译与仿真，并使用GTKWave看波形。这么多年过去了，还是没有一个现代化的波形查看器吗。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iverilog -g2012 -Wall -I ./user/src -I ./user/src/include -o tb_CPU_TOP.vvp</span><br><span class="line">vvp tb_CPU_TOP.vvp</span><br></pre></td></tr></table></figure><p>我们可以用官方的riscv工具链进行编译，当然也可以写一个Python文件手动将汇编文件转换成机器码。看个人喜好。</p><p>写一个简单的加法测试：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addi x1,x0,1</span><br><span class="line">addi x2,x0,2</span><br><span class="line">addi x3,x0,3</span><br><span class="line">addi x4,x0,4</span><br><span class="line">addi x5,x0,5</span><br><span class="line">addi x6,x0,6</span><br><span class="line">add  x7,x1,x2</span><br></pre></td></tr></table></figure><p>转换成二进制，应该是这样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00100093</span><br><span class="line">00200113</span><br><span class="line">00300193</span><br><span class="line">00400213</span><br><span class="line">00500293</span><br><span class="line">00600313</span><br><span class="line">002083b3</span><br></pre></td></tr></table></figure><div class="note warning flat"><p><code>objdump</code>转换出的<code>.verilog</code>文件，是按照内存小端对齐的格式写的！而<code>elf2hex</code>则是将一个指令字当成一个整体输出，为大端对齐。实际写入逻辑还是按照大端，只是存储格式被认为是小端。</p></div><p>然后运行。</p><p><img src="https://webp.esing.dev/img/image-20251211083638641_251211_0836_VrZp.png" alt="非常简单的加法"></p><p>可以看到结果非常完美。我们成功了 ^_^</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;访存-MEM级-设计&quot;&gt;访存 MEM级 设计&lt;/h2&gt;
&lt;p&gt;访存访存，顾名思义，就是要去访问内存。这个内存是“数据内存”，因为我们写的CPU采用的是&lt;strong&gt;哈佛架构&lt;/str</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第六篇</title>
    <link href="https://blog.esing.dev/2025/12/09/riscvcod-p6/"/>
    <id>https://blog.esing.dev/2025/12/09/riscvcod-p6/</id>
    <published>2025-12-09T14:19:27.000Z</published>
    <updated>2025-12-10T13:36:31.084Z</updated>
    
    <content type="html"><![CDATA[<h2 id="执行-EX级-设计">执行 EX级 设计</h2><p>EX级以负责核心运算功能的<strong>ALU</strong>著称。可以说，它是CPU的灵魂。来一人一句ALU牛逼来。</p><h3 id="算数逻辑单元-ALU-sv">算数逻辑单元 ALU.sv</h3><p>ALU需要完成一系列R-Type、I-Type指令的运算。对于L-Type和S-Type，它们的处理逻辑其实差不多，都是相加——这样才能让ALU输出基地址和偏移量之和，算出目标地址。</p><p>同样地，使用字符串打印的方式来增强可读性，优化Debug体验，并更好的看到指令在流水线中的流动。同样使用<code>DEBUG</code>宏进行包装，在给综合器生成最终电路前取消宏定义即可。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> ALU (</span><br><span class="line">    <span class="comment">// 操作码</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] alu_op,</span><br><span class="line">    <span class="comment">// 操作数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src1,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2,</span><br><span class="line">    <span class="comment">// 来自ID/EX级的立即数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm,</span><br><span class="line">    <span class="comment">// 第二操作数选择 0: src2 1: imm</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_src2_sel,</span><br><span class="line">    <span class="comment">// 结果输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] alu_result,</span><br><span class="line">    <span class="comment">// 标志位输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        zero,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        sign,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        alu_unsigned</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2_inner;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> src2_inner = (alu_src2_sel) ? imm : src2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 运算操作</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : alu_operation</span><br><span class="line">        <span class="keyword">case</span> (alu_op)</span><br><span class="line">            <span class="comment">// 基础运算</span></span><br><span class="line">            `ALU_ADD:   alu_result = src1 + src2_inner;</span><br><span class="line">            `ALU_SUB:   alu_result = src1 - src2_inner;  <span class="comment">// src1 + (~src2 + 1)</span></span><br><span class="line">            `ALU_OR:    alu_result = src1 | src2_inner;</span><br><span class="line">            `ALU_AND:   alu_result = src1 &amp; src2_inner;</span><br><span class="line">            `ALU_XOR:   alu_result = src1 ^ src2_inner;</span><br><span class="line">            `ALU_SLL:   alu_result = src1 &lt;&lt; src2_inner[<span class="number">4</span>:<span class="number">0</span>];</span><br><span class="line">            `ALU_SRL:   alu_result = src1 &gt;&gt; src2_inner[<span class="number">4</span>:<span class="number">0</span>];</span><br><span class="line">            <span class="comment">// 必须显式声明src1为有符号数</span></span><br><span class="line">            `ALU_SRA:   alu_result = <span class="built_in">$signed</span>(src1) &gt;&gt;&gt; src2_inner[<span class="number">4</span>:<span class="number">0</span>];</span><br><span class="line">            `ALU_SLT:   alu_result = (<span class="built_in">$signed</span>(src1) &lt; <span class="built_in">$signed</span>(src2_inner)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            `ALU_SLTU:  alu_result = (src1 &lt; src2_inner) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            `ALU_RIGHT: alu_result = src2_inner;  <span class="comment">// 用于AUIPC指令</span></span><br><span class="line">            <span class="comment">// L-Type</span></span><br><span class="line">            `ALU_LW:    alu_result = src1 + src2_inner;  <span class="comment">// 地址计算</span></span><br><span class="line">            <span class="comment">// [TODO] 非对齐访存</span></span><br><span class="line">            <span class="comment">//S-Type</span></span><br><span class="line">            `ALU_SW:    alu_result = src1 + src2_inner;  <span class="comment">// 地址计算</span></span><br><span class="line">            <span class="keyword">default</span>:    alu_result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load/Store指令使用的地址计算不放在ALU内</span></span><br><span class="line">    <span class="comment">// 拆分为独立模块 LoadStoreUnit</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标志位输出</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        zero         = (alu_result == <span class="number">32&#x27;b0</span>);</span><br><span class="line">        sign         = alu_result[<span class="number">31</span>];</span><br><span class="line">        alu_unsigned = (src1 &lt; src2_inner);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="comment">// 方便调试的 ASCII 指令输出</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">64</span>-<span class="number">1</span>:<span class="number">0</span>] aluop_ascii;</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : aluop_ascii_output</span><br><span class="line">        <span class="keyword">case</span> (alu_op)</span><br><span class="line">            `ALU_ADD:   aluop_ascii = <span class="string">&quot;AADD&quot;</span>;</span><br><span class="line">            `ALU_SUB:   aluop_ascii = <span class="string">&quot;ASUB&quot;</span>;</span><br><span class="line">            `ALU_OR:    aluop_ascii = <span class="string">&quot;AOR&quot;</span>;</span><br><span class="line">            `ALU_AND:   aluop_ascii = <span class="string">&quot;AAND&quot;</span>;</span><br><span class="line">            `ALU_XOR:   aluop_ascii = <span class="string">&quot;AXOR&quot;</span>;</span><br><span class="line">            `ALU_SLL:   aluop_ascii = <span class="string">&quot;ASLL&quot;</span>;</span><br><span class="line">            `ALU_SRL:   aluop_ascii = <span class="string">&quot;ASRL&quot;</span>;</span><br><span class="line">            `ALU_SRA:   aluop_ascii = <span class="string">&quot;ASRA&quot;</span>;</span><br><span class="line">            `ALU_SLT:   aluop_ascii = <span class="string">&quot;ASLT&quot;</span>;</span><br><span class="line">            `ALU_SLTU:  aluop_ascii = <span class="string">&quot;ASLTU&quot;</span>;</span><br><span class="line">            `ALU_RIGHT: aluop_ascii = <span class="string">&quot;ARGHT&quot;</span>;</span><br><span class="line">            `ALU_LW:    aluop_ascii = <span class="string">&quot;ALW&quot;</span>;</span><br><span class="line">            `ALU_SW:    aluop_ascii = <span class="string">&quot;ASW&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:    aluop_ascii = <span class="string">&quot;ANOP&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对于许多CPU，会将ALU运算的源操作数选择列为一个单独的二选一MUX。这里直接合并在ALU内：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ALU (</span><br><span class="line">    <span class="comment">// 操作数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src1,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2,</span><br><span class="line">    <span class="comment">// 来自ID/EX级的立即数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm,</span><br><span class="line">    <span class="comment">// 第二操作数选择 0: src2 1: imm</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_src2_sel,</span><br><span class="line">    ...</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] src2_inner;</span><br><span class="line">    <span class="keyword">assign</span> src2_inner = (alu_src2_sel) ? imm : src2;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>那为什么后面的MUX不合并呢？这是为了看起来更方便。</p><h3 id="回写数据来源选择MUX">回写数据来源选择MUX</h3><p>这一块实际上没有写成一个单独的模块，而是最终要集成在封装好的CPU模块内。想单独写一个也行，反正最终会被综合成一个多选一MUX。</p><p>我们需要选择哪些数据？看之前的 <a href="/2025/12/08/riscvcod-p5/" title="从零开始学RISC：第五篇">译码级设计</a> ，看<code>Decoder.sv</code>输出的选择信号<code>wd_sel</code>对应哪些指令：</p><ul><li>R-Type和I-Type指令的写回数据来源于ALU；</li><li>B-Type指令不需要选择回写数据，但也得给个默认值；</li><li><code>jal</code>和<code>jalr</code>两个是跳转指令，需要选择<code>pc+4</code>作为数据写入寄存器；</li><li><code>lui</code>和<code>auipc</code>这两个很特殊，是立即数扩展，因此使用扩展后从ID级传入的数据；</li><li>L-Type需要从DRAM中读取数据，因此需要在MEM级选择；</li><li>不应该有其余情况，这里写为<code>unique case</code>可以不写<code>default</code>。不过补一个最好。</li></ul><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回写数据来源选择MUX</span></span><br><span class="line"><span class="comment">// 在EX级完成选择以减少流水线寄存器宽度</span></span><br><span class="line"><span class="comment">// 注意 load 指令的数据在 MEM 级才可用 因此不可能选择 DRAM 作为回写数据来源</span></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span> : wd_EX_MUX</span><br><span class="line">    <span class="keyword">case</span> (wd_sel_EX)</span><br><span class="line">        `WD_SEL_FROM_ALU:  rf_wd_EX = alu_result_EX;</span><br><span class="line">        <span class="comment">// `WD_SEL_FROM_DRAM在MEM级处理</span></span><br><span class="line">        `WD_SEL_FROM_PC4:  rf_wd_EX = pc4_EX;</span><br><span class="line">        <span class="comment">// 如果回写的是立即数扩展值 则需要判断是否为AUIPC指令</span></span><br><span class="line">        `WD_SEL_FROM_IEXT: rf_wd_EX = (is_auipc_EX) ? branch_target_EX : imm_EX;</span><br><span class="line">        <span class="keyword">default</span>:           rf_wd_EX = <span class="number">32&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="下一PC计算模块-NextPC-Generator-sv">下一PC计算模块 NextPC_Generator.sv</h3><p>我们的指令执行完怎么办？取下一个。那下一个从哪里取呢？</p><p>不是所有的指令地址都是+4+4变化。对于分支跳转指令等，我们在运算并比较后，要根据结果来进行跳转，而运算完成的最早时间便是EX级。此外，在EX作比较还能利用前向数据通路来加快运算，这是好的。</p><p>我们首先要知道，在EX级执行的指令是什么？是分支，还是跳转，或者根本不用去刻意变化<code>pc</code>？我们还需要获取跳转的目标地址，对于<code>jalr</code>还要进行相应的计算。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> NextPC_Generator (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        is_branch_instr,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] branch_type,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] jump_type,</span><br><span class="line">    <span class="comment">// ALU计算结果输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] alu_result,</span><br><span class="line">    <span class="comment">// PC加立即数输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] branch_target_i,</span><br><span class="line">    <span class="comment">// ALU标志位输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_zero,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_sign,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_unsigned,</span><br><span class="line">    <span class="comment">// PC控制输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        take_branch,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] branch_target_NextPC</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (jump_type)        take_branch = <span class="number">1&#x27;b1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (is_branch_instr) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">unique</span> <span class="keyword">case</span> (branch_type)</span><br><span class="line">                `BRANCH_BEQ:  take_branch = alu_zero;</span><br><span class="line">                `BRANCH_BNE:  take_branch = ~alu_zero;</span><br><span class="line">                `BRANCH_BLT:  take_branch = alu_sign;</span><br><span class="line">                `BRANCH_BGE:  take_branch = ~alu_sign;</span><br><span class="line">                `BRANCH_BLTU: take_branch = alu_unsigned;</span><br><span class="line">                `BRANCH_BGEU: take_branch = ~alu_unsigned;</span><br><span class="line">                <span class="keyword">default</span>:      take_branch = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span>              take_branch = <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// JALR 需要将最低位置0</span></span><br><span class="line">    <span class="keyword">assign</span> branch_target_NextPC = (jump_type == `JUMP_JALR) ?</span><br><span class="line">                                  &#123;alu_result[<span class="number">31</span>:<span class="number">1</span>], <span class="number">1&#x27;b0</span>&#125; : branch_target_i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note warning flat"><p>要注意：<code>jalr</code>指令要将<strong>最低位归零</strong>。</p><p>因RISC‑V 要求所有指令地址至少要对齐到 16 位（半字，2 字节），而<code>jalr</code>是寄存器间接跳转，<code>rs1 + imm</code>的值可能是奇数，因此需要手动将低位置为0。</p></div><h2 id="EX-MEM级-流水线寄存器-PR-EX-MEM-sv">EX/MEM级 流水线寄存器 PR_EX_MEM.sv</h2><p>对于EX向MEM级进发，我们需要传递来自MUX的回写数据<code>wd</code>，以及DRAM的写使能信号<code>dram_we</code>。MEM级的回写数据来源MUX控制信号<code>wd_sel</code>和EX级的是一个，直接复用即可。此外，ALU的计算结果也不能忽略，因为对于L-Type指令，需要作为地址传入MEM级。来自ID/EX级的<code>rD2</code>数据也需要传入，作为DRAM的写入数据。此外，对于S-Type指令，寄存器堆写使能信号<code>wr</code>也需要继续传递。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PR_EX_MEM (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// EX级输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_ex_i,</span><br><span class="line">    <span class="comment">// EX级输出 给MEM级输入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_mem_o,</span><br><span class="line">    <span class="comment">// 判断指令是否有效</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        instr_valid_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        instr_valid_mem_o,</span><br><span class="line">    <span class="comment">// 写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        dram_we_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        dram_we_mem_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rf_we_mem_o,</span><br><span class="line">    <span class="comment">// 写回数据来源</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_mem_o,</span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_mem_o,</span><br><span class="line">    <span class="comment">// ALU计算结果</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] alu_result_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] alu_result_mem_o,</span><br><span class="line">    <span class="comment">// MUX数据 控制写回数据来源</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] wd_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] wd_mem_o,</span><br><span class="line">    <span class="comment">// 回写数据 来自ID/EX级</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD2_ex_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD2_mem_o</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            pc_mem_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_mem_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            dram_we_mem_o     &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            rf_we_mem_o       &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            wd_sel_mem_o      &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            alu_result_mem_o  &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            wd_mem_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            rD2_mem_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            pc_mem_o          &lt;= pc_ex_i;</span><br><span class="line">            instr_valid_mem_o &lt;= instr_valid_ex_i;</span><br><span class="line">            dram_we_mem_o     &lt;= dram_we_ex_i;</span><br><span class="line">            rf_we_mem_o       &lt;= rf_we_ex_i;</span><br><span class="line">            wd_sel_mem_o      &lt;= wd_sel_ex_i;</span><br><span class="line">            alu_result_mem_o  &lt;= alu_result_ex_i;</span><br><span class="line">            wd_mem_o          &lt;= wd_ex_i;</span><br><span class="line">            rD2_mem_o         &lt;= rD2_ex_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            wr_mem_o &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            wr_mem_o &lt;= wr_ex_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>写到这里，已经完成30%了，可喜可贺！</p><p>为什么已经写了三级，才完成30%？</p><p><strong>因为大的在后面呢。</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;执行-EX级-设计&quot;&gt;执行 EX级 设计&lt;/h2&gt;
&lt;p&gt;EX级以负责核心运算功能的&lt;strong&gt;ALU&lt;/strong&gt;著称。可以说，它是CPU的灵魂。来一人一句ALU牛逼来。&lt;/</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第五篇</title>
    <link href="https://blog.esing.dev/2025/12/08/riscvcod-p5/"/>
    <id>https://blog.esing.dev/2025/12/08/riscvcod-p5/</id>
    <published>2025-12-08T12:16:34.000Z</published>
    <updated>2025-12-10T13:36:23.535Z</updated>
    
    <content type="html"><![CDATA[<h2 id="译码-ID级-设计">译码 ID级 设计</h2><p>提到译码级，那就得是译码器啊。纯组合逻辑，包你写到爽。</p><p>译码级还有什么？立即数移位也需要放在ID级，以减轻EX级的压力。</p><h3 id="指令译码器-Decoder-sv">指令译码器 Decoder.sv</h3><p>指令译码器为<strong>组合逻辑模块</strong>。我们需要哪些信号？</p><p>首先要把31位的指令分类：是RIBJSU的哪一种？之后，要根据分类，将寄存器地址拆分出来，准备送进同一级的寄存器堆来读取数据；要提取指令的<code>funct3</code>和<code>funct7</code>，以便在EX级告诉ALU“长的像的指令如何区分”；要根据指令类型，区分跳转类型和读取/写入类型，给后面的流水级进行处理；还要生成对应位的寄存器读信号，和分支指令判断信号，为后面处理数据冒险准备……要干的事情真不少。</p><p>一步一步全写上即可。推荐使用宏定义，大幅度提升可读性。</p><p>在模块内使用``ifdef DEBUG`配合上ASCII字符进行Debug是另一个小技巧。在综合时取消宏定义即可。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> Decoder (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] alu_op,</span><br><span class="line">    <span class="comment">// ALU 第一操作数来源</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        is_auipc,</span><br><span class="line">    <span class="comment">// ALU 第二操作数来源</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        alu_src,</span><br><span class="line">    <span class="comment">// 写使能</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        dram_we,          <span class="comment">// 高电平为写使能 低电平为读</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rf_we,</span><br><span class="line">    <span class="comment">// 写回数据来源</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel,</span><br><span class="line">    <span class="comment">// 分支相关</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        is_branch_instr,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] branch_type,</span><br><span class="line">    <span class="comment">// 跳转相关</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] jump_type,</span><br><span class="line">    <span class="comment">// 数据读取类型</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type,</span><br><span class="line">    <span class="comment">// 源寄存器是否在使用</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rs1_used,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rs2_used</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提取指令字段</span></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] opcode;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] funct3;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] funct7;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        opcode = instr[<span class="number">6</span>:<span class="number">0</span>];</span><br><span class="line">        funct3 = instr[<span class="number">14</span>:<span class="number">12</span>];</span><br><span class="line">        funct7 = instr[<span class="number">31</span>:<span class="number">25</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳转类型判断</span></span><br><span class="line">    <span class="comment">// assign jump_type = (opcode == `OPCODE_JAL) ?</span></span><br><span class="line">    <span class="comment">//     `JUMP_JAL : (opcode == `OPCODE_JALR) ? `JUMP_JALR : `JUMP_NOP;</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_JAL:  jump_type = `JUMP_JAL;</span><br><span class="line">            `OPCODE_JALR: jump_type = `JUMP_JALR;</span><br><span class="line">            <span class="keyword">default</span>:      jump_type = `JUMP_NOP;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 源寄存器读取判断</span></span><br><span class="line">    <span class="comment">// 反向判断简化逻辑 记得去除ERROR</span></span><br><span class="line">    <span class="comment">// rs1：除了 LUI/AUIPC/JAL 之外都用到</span></span><br><span class="line">    <span class="keyword">assign</span> rs1_used = ~((opcode == `OPCODE_LUI) || (opcode == `OPCODE_AUIPC) ||</span><br><span class="line">                        (opcode == `OPCODE_JAL) || (opcode == `OPCODE_ZERO));</span><br><span class="line">    <span class="comment">// // rs2：只有 R-type / B-type / S-type 用到</span></span><br><span class="line">    <span class="keyword">assign</span> rs2_used = (opcode == `OPCODE_RTYPE) || (opcode == `OPCODE_BTYPE) ||</span><br><span class="line">        (opcode == `OPCODE_STYPE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [HACK] Icarus Verilog 不支持 inside 语法糖 :(</span></span><br><span class="line">    <span class="comment">// assign rs1_used = !(opcode inside &#123;</span></span><br><span class="line">    <span class="comment">//     `OPCODE_LUI,</span></span><br><span class="line">    <span class="comment">//     `OPCODE_AUIPC,</span></span><br><span class="line">    <span class="comment">//     `OPCODE_JAL</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="comment">// assign rs2_used = (opcode inside &#123;</span></span><br><span class="line">    <span class="comment">//     `OPCODE_RTYPE,</span></span><br><span class="line">    <span class="comment">//     `OPCODE_BTYPE,</span></span><br><span class="line">    <span class="comment">//     `OPCODE_STYPE</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分支类型判断</span></span><br><span class="line">    <span class="comment">// 看funct3决定具体的分支类型</span></span><br><span class="line">    <span class="comment">// assign is_branch_instr = (opcode == `OPCODE_BTYPE);</span></span><br><span class="line">    <span class="comment">// assign branch_type = funct3;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALU 第一操作数来源</span></span><br><span class="line">    <span class="comment">// 判断是否为 AUIPC 指令即可</span></span><br><span class="line">    <span class="keyword">assign</span> is_auipc = (opcode == `OPCODE_AUIPC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALU 第二操作数来源</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : alu_src_selection</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_RTYPE,</span><br><span class="line">            `OPCODE_BTYPE:  alu_src = `ALUSRC_RS2;  <span class="comment">// 来自寄存器 rs2</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_ITYPE,</span><br><span class="line">            `OPCODE_LTYPE,</span><br><span class="line">            `OPCODE_STYPE,</span><br><span class="line">            `OPCODE_AUIPC,</span><br><span class="line">            `OPCODE_JALR:</span><br><span class="line">                            alu_src = `ALUSRC_IMM;  <span class="comment">// 来自立即数</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:        alu_src = `ALUSRC_RS2;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回写数据来源选择</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : wb_source_selection</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_RTYPE,</span><br><span class="line">            `OPCODE_ITYPE:  wd_sel = `WD_SEL_FROM_ALU;</span><br><span class="line"></span><br><span class="line">            `OPCODE_LTYPE:  wd_sel = `WD_SEL_FROM_DRAM;</span><br><span class="line"></span><br><span class="line">            `OPCODE_JAL,</span><br><span class="line">            `OPCODE_JALR:   wd_sel = `WD_SEL_FROM_PC4;</span><br><span class="line"></span><br><span class="line">            `OPCODE_LUI,</span><br><span class="line">            `OPCODE_AUIPC:  wd_sel = `WD_SEL_FROM_IEXT;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:        wd_sel = <span class="number">2&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寄存器堆写使能</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : rf_write_enable</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_RTYPE,</span><br><span class="line">            `OPCODE_ITYPE,</span><br><span class="line">            `OPCODE_LTYPE,</span><br><span class="line">            `OPCODE_LUI,</span><br><span class="line">            `OPCODE_AUIPC,</span><br><span class="line">            `OPCODE_JAL,</span><br><span class="line">            `OPCODE_JALR:   rf_we = <span class="number">1&#x27;b1</span>;</span><br><span class="line"></span><br><span class="line">            `OPCODE_BTYPE,</span><br><span class="line">            `OPCODE_STYPE:  rf_we = <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:        rf_we = <span class="number">1&#x27;b0</span>;  <span class="comment">// 考虑异常情况 默认不写</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据存储器写使能</span></span><br><span class="line">    <span class="keyword">assign</span> dram_we = (opcode == `OPCODE_STYPE) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALU 操作码生成</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : ALUOp_selection</span><br><span class="line">        <span class="comment">// 默认值</span></span><br><span class="line">        alu_op          = `ALU_NOP;</span><br><span class="line">        branch_type     = `BRANCH_NOP;</span><br><span class="line">        is_branch_instr = <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line"></span><br><span class="line">            `OPCODE_RTYPE, `OPCODE_ITYPE: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_ADD_SUB_MUL:</span><br><span class="line">                    <span class="comment">// 使用 case-true 结构</span></span><br><span class="line">                        <span class="keyword">case</span> (<span class="number">1&#x27;b1</span>)</span><br><span class="line">                            (opcode == `OPCODE_RTYPE) &amp;&amp;        <span class="comment">// R-Type SUB</span></span><br><span class="line">                            (funct7 == `FUNCT7_SUB):</span><br><span class="line">                                            alu_op = `ALU_SUB;</span><br><span class="line"></span><br><span class="line">                            (opcode == `OPCODE_RTYPE):          <span class="comment">// R-Type 其它（默认为 ADD）</span></span><br><span class="line">                                            alu_op = `ALU_ADD;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">default</span>:                            <span class="comment">// 非 R-type（同样默认 ADD）</span></span><br><span class="line">                                            alu_op = `ALU_ADD;</span><br><span class="line">                        <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                    `FUNCT3_SLL_MULH:       alu_op = `ALU_SLL;</span><br><span class="line">                    `FUNCT3_SLT_MULHSU:     alu_op = `ALU_SLT;</span><br><span class="line">                    `FUNCT3_SLTU_MULHU:     alu_op = `ALU_SLTU;</span><br><span class="line">                    `FUNCT3_XOR_DIV:        alu_op = `ALU_XOR;</span><br><span class="line">                    `FUNCT3_SRL_SRA_DIVU:   alu_op = (funct7 == `FUNCT7_SRA) ?</span><br><span class="line">                                                     `ALU_SRA : `ALU_SRL;</span><br><span class="line">                    `FUNCT3_OR_REM:         alu_op = `ALU_OR;</span><br><span class="line">                    `FUNCT3_AND_REMU:       alu_op = `ALU_AND;</span><br><span class="line">                    <span class="keyword">default</span>:                alu_op = `ALU_NOP;  <span class="comment">// 默认为空</span></span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_BTYPE: <span class="keyword">begin</span></span><br><span class="line">                alu_op = (funct3 == `FUNCT3_BLTU || funct3 == `FUNCT3_BGEU) ? `ALU_SLTU :</span><br><span class="line">                    `ALU_SUB;  <span class="comment">// 用于比较是否为有符号/无符号</span></span><br><span class="line">                <span class="comment">// 判断分支类型</span></span><br><span class="line">                <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_BEQ:  branch_type = `BRANCH_BEQ;</span><br><span class="line">                    `FUNCT3_BNE:  branch_type = `BRANCH_BNE;</span><br><span class="line">                    `FUNCT3_BLT:  branch_type = `BRANCH_BLT;</span><br><span class="line">                    `FUNCT3_BGE:  branch_type = `BRANCH_BGE;</span><br><span class="line">                    `FUNCT3_BLTU: branch_type = `BRANCH_BLTU;</span><br><span class="line">                    `FUNCT3_BGEU: branch_type = `BRANCH_BGEU;</span><br><span class="line">                    <span class="keyword">default</span>:      branch_type = `BRANCH_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line"></span><br><span class="line">                is_branch_instr = <span class="number">1&#x27;b1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_JAL,</span><br><span class="line">            `OPCODE_LUI:            alu_op = `ALU_RIGHT;  <span class="comment">// 特殊指令</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_JALR,</span><br><span class="line">            `OPCODE_AUIPC:          alu_op = `ALU_ADD;</span><br><span class="line"></span><br><span class="line">            `OPCODE_LTYPE: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_LB:     alu_op = `ALU_LB;</span><br><span class="line">                    `FUNCT3_LBU:    alu_op = `ALU_LBU;</span><br><span class="line">                    `FUNCT3_LH:     alu_op = `ALU_LH;</span><br><span class="line">                    `FUNCT3_LHU:    alu_op = `ALU_LHU;</span><br><span class="line">                    `FUNCT3_LW:     alu_op = `ALU_LW;</span><br><span class="line">                    <span class="keyword">default</span>:        alu_op = `ALU_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_STYPE: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_SB:     alu_op = `ALU_SB;</span><br><span class="line">                    `FUNCT3_SH:     alu_op = `ALU_SH;</span><br><span class="line">                    `FUNCT3_SW:     alu_op = `ALU_SW;</span><br><span class="line">                    <span class="keyword">default</span>:        alu_op = `ALU_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:                alu_op = `ALU_NOP;  <span class="comment">// 默认加法</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据存取类型判断</span></span><br><span class="line">    <span class="comment">// verilog_format:off</span></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : sl_selection</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_LTYPE: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_LB:     sl_type = `MEM_LB;</span><br><span class="line">                    `FUNCT3_LBU:    sl_type = `MEM_LBU;</span><br><span class="line">                    `FUNCT3_LH:     sl_type = `MEM_LH;</span><br><span class="line">                    `FUNCT3_LHU:    sl_type = `MEM_LHU;</span><br><span class="line">                    `FUNCT3_LW:     sl_type = `MEM_LW;</span><br><span class="line">                    <span class="keyword">default</span>:        sl_type = `MEM_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            `OPCODE_STYPE:<span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">case</span> (funct3)</span><br><span class="line">                    `FUNCT3_SB:     sl_type = `MEM_SB;</span><br><span class="line">                    `FUNCT3_SH:     sl_type = `MEM_SH;</span><br><span class="line">                    `FUNCT3_SW:     sl_type = `MEM_SW;</span><br><span class="line">                    <span class="keyword">default</span>:        sl_type = `MEM_NOP;</span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">default</span>:                sl_type = `MEM_NOP;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可视化输出判断</span></span><br><span class="line">    <span class="comment">//verilog_format:off</span></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">  <span class="comment">// 方便调试的 ASCII 指令输出</span></span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">256</span>-<span class="number">1</span>:<span class="number">0</span>] instr_ascii;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">256</span>-<span class="number">1</span>:<span class="number">0</span>] branch_type_ascii;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always_comb</span> <span class="keyword">begin</span> : ascii_output</span><br><span class="line">    <span class="keyword">unique</span> <span class="keyword">case</span> (branch_type)</span><br><span class="line">      `BRANCH_NOP:        branch_type_ascii = <span class="string">&quot;BRANCH_NOP&quot;</span>;</span><br><span class="line">      `BRANCH_BEQ:        branch_type_ascii = <span class="string">&quot;BRANCH_BEQ&quot;</span>;</span><br><span class="line">      `BRANCH_BNE:        branch_type_ascii = <span class="string">&quot;BRANCH_BNE&quot;</span>;</span><br><span class="line">      `BRANCH_BLT:        branch_type_ascii = <span class="string">&quot;BRANCH_BLT&quot;</span>;</span><br><span class="line">      `BRANCH_BGE:        branch_type_ascii = <span class="string">&quot;BRANCH_BGE&quot;</span>;</span><br><span class="line">      `BRANCH_BLTU:       branch_type_ascii = <span class="string">&quot;BRANCH_BLTU&quot;</span>;</span><br><span class="line">      `BRANCH_BGEU:       branch_type_ascii = <span class="string">&quot;BRANCH_BGEU&quot;</span>;</span><br><span class="line">      `BRANCH_JALR:       branch_type_ascii = <span class="string">&quot;BRANCH_JALR&quot;</span>;</span><br><span class="line">      <span class="keyword">default</span>:            branch_type_ascii = <span class="string">&quot;BRANCH_UNKNOWN&quot;</span>;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line">    <span class="comment">// 判断当前具体为32条基本指令的哪一条</span></span><br><span class="line">    <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">      `OPCODE_LUI:              instr_ascii = <span class="string">&quot;LUI&quot;</span>;</span><br><span class="line">      `OPCODE_AUIPC:            instr_ascii = <span class="string">&quot;AUIPC&quot;</span>;</span><br><span class="line">      `OPCODE_JAL:              instr_ascii = <span class="string">&quot;JAL&quot;</span>;</span><br><span class="line">      `OPCODE_JALR:             instr_ascii = <span class="string">&quot;JALR&quot;</span>;</span><br><span class="line"></span><br><span class="line">      `OPCODE_BTYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_BEQ:          instr_ascii = <span class="string">&quot;BEQ&quot;</span>;</span><br><span class="line">          `FUNCT3_BNE:          instr_ascii = <span class="string">&quot;BNE&quot;</span>;</span><br><span class="line">          `FUNCT3_BLT:          instr_ascii = <span class="string">&quot;BLT&quot;</span>;</span><br><span class="line">          `FUNCT3_BGE:          instr_ascii = <span class="string">&quot;BGE&quot;</span>;</span><br><span class="line">          `FUNCT3_BLTU:         instr_ascii = <span class="string">&quot;BLTU&quot;</span>;</span><br><span class="line">          `FUNCT3_BGEU:         instr_ascii = <span class="string">&quot;BGEU&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;B_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      `OPCODE_LTYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_LB:           instr_ascii = <span class="string">&quot;LB&quot;</span>;</span><br><span class="line">          `FUNCT3_LH:           instr_ascii = <span class="string">&quot;LH&quot;</span>;</span><br><span class="line">          `FUNCT3_LW:           instr_ascii = <span class="string">&quot;LW&quot;</span>;</span><br><span class="line">          `FUNCT3_LBU:          instr_ascii = <span class="string">&quot;LBU&quot;</span>;</span><br><span class="line">          `FUNCT3_LHU:          instr_ascii = <span class="string">&quot;LHU&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;L_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      `OPCODE_STYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_SB:           instr_ascii = <span class="string">&quot;SB&quot;</span>;</span><br><span class="line">          `FUNCT3_SH:           instr_ascii = <span class="string">&quot;SH&quot;</span>;</span><br><span class="line">          `FUNCT3_SW:           instr_ascii = <span class="string">&quot;SW&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;S_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      `OPCODE_ITYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_ADD_SUB_MUL:  instr_ascii = <span class="string">&quot;ADDI&quot;</span>;</span><br><span class="line">          `FUNCT3_SLL_MULH:     instr_ascii = <span class="string">&quot;SLLI&quot;</span>;</span><br><span class="line">          `FUNCT3_SLT_MULHSU:   instr_ascii = <span class="string">&quot;SLTI&quot;</span>;</span><br><span class="line">          `FUNCT3_SLTU_MULHU:   instr_ascii = <span class="string">&quot;SLTIU&quot;</span>;</span><br><span class="line">          `FUNCT3_XOR_DIV:      instr_ascii = <span class="string">&quot;XORI&quot;</span>;</span><br><span class="line">          `FUNCT3_SRL_SRA_DIVU: instr_ascii = (funct7 == `FUNCT7_SRAI) ? <span class="string">&quot;SRAI&quot;</span> : <span class="string">&quot;SRLI&quot;</span>;</span><br><span class="line">          `FUNCT3_OR_REM:       instr_ascii = <span class="string">&quot;ORI&quot;</span>;</span><br><span class="line">          `FUNCT3_AND_REMU:     instr_ascii = <span class="string">&quot;ANDI&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;I_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      `OPCODE_RTYPE: <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (funct3)</span><br><span class="line">          `FUNCT3_ADD_SUB_MUL: <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span> (funct7 == `FUNCT7_SUB)</span><br><span class="line">                                instr_ascii = <span class="string">&quot;SUB&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (funct7 == `FUNCT7_ADD)</span><br><span class="line">                                instr_ascii = <span class="string">&quot;ADD&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span>                instr_ascii = <span class="string">&quot;R_UNKNOWN&quot;</span>;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          `FUNCT3_SLL_MULH:     instr_ascii = <span class="string">&quot;SLL&quot;</span>;</span><br><span class="line">          `FUNCT3_SLT_MULHSU:   instr_ascii = <span class="string">&quot;SLT&quot;</span>;</span><br><span class="line">          `FUNCT3_SLTU_MULHU:   instr_ascii = <span class="string">&quot;SLTU&quot;</span>;</span><br><span class="line">          `FUNCT3_XOR_DIV:      instr_ascii = <span class="string">&quot;XOR&quot;</span>;</span><br><span class="line">          `FUNCT3_SRL_SRA_DIVU: <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span> (funct7 == `FUNCT7_SRA)</span><br><span class="line">                                instr_ascii = <span class="string">&quot;SRA&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (funct7 == `FUNCT7_SRL)</span><br><span class="line">                                instr_ascii = <span class="string">&quot;SRL&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span>                instr_ascii = <span class="string">&quot;R_UNKNOWN&quot;</span>;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">          `FUNCT3_OR_REM:       instr_ascii = <span class="string">&quot;OR&quot;</span>;</span><br><span class="line">          `FUNCT3_AND_REMU:     instr_ascii = <span class="string">&quot;AND&quot;</span>;</span><br><span class="line">          <span class="keyword">default</span>:              instr_ascii = <span class="string">&quot;R_UNKNOWN&quot;</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:                  instr_ascii = <span class="string">&quot;ERROR&quot;</span>;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// verilog_format:on</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="立即数扩展模块-imm-extener-sv">立即数扩展模块 imm_extener.sv</h3><p>立即数扩展模块也是<strong>组合逻辑模块</strong>。不需要接受译码器传出的信号，而是和译码器并行工作，同样接受32位指令<code>instr</code>后进行分类处理。当然可以写在<code>Decoder.v</code>，但是那样子有点乱。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> imm_extender (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm_out</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] opcode;</span><br><span class="line">    <span class="keyword">assign</span> opcode = instr[<span class="number">6</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span> : imm_classifier</span><br><span class="line">        <span class="keyword">unique</span> <span class="keyword">case</span> (opcode)</span><br><span class="line">            `OPCODE_ITYPE, `OPCODE_LTYPE, `OPCODE_JALR: <span class="keyword">begin</span>  <span class="comment">// I-type</span></span><br><span class="line">                <span class="comment">// 先输出立即数</span></span><br><span class="line">                <span class="comment">// 之后再根据 instr[30] 区分 SLLI/SRLI和SRAI</span></span><br><span class="line">                imm_out = &#123;&#123;<span class="number">20</span>&#123;instr[<span class="number">31</span>]&#125;&#125;, instr[<span class="number">31</span>:<span class="number">20</span>]&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            `OPCODE_BTYPE: <span class="keyword">begin</span>  <span class="comment">// B-type</span></span><br><span class="line">                imm_out = &#123;&#123;<span class="number">20</span>&#123;instr[<span class="number">31</span>]&#125;&#125;, instr[<span class="number">7</span>], instr[<span class="number">30</span>:<span class="number">25</span>], instr[<span class="number">11</span>:<span class="number">8</span>], <span class="number">1&#x27;b0</span>&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            `OPCODE_JAL: <span class="keyword">begin</span>  <span class="comment">// J-type</span></span><br><span class="line">                imm_out = &#123;&#123;<span class="number">12</span>&#123;instr[<span class="number">31</span>]&#125;&#125;, instr[<span class="number">19</span>:<span class="number">12</span>], instr[<span class="number">20</span>], instr[<span class="number">30</span>:<span class="number">21</span>], <span class="number">1&#x27;b0</span>&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            `OPCODE_STYPE: <span class="keyword">begin</span>  <span class="comment">// S-type</span></span><br><span class="line">                imm_out = &#123;&#123;<span class="number">20</span>&#123;instr[<span class="number">31</span>]&#125;&#125;, instr[<span class="number">31</span>:<span class="number">25</span>], instr[<span class="number">11</span>:<span class="number">7</span>]&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            `OPCODE_AUIPC, `OPCODE_LUI: <span class="keyword">begin</span>  <span class="comment">// U-type</span></span><br><span class="line">                imm_out = &#123;instr[<span class="number">31</span>:<span class="number">12</span>], <span class="number">12&#x27;b0</span>&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                imm_out = <span class="number">32&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure><p>当然，你也完全可以只传递PC然后再EX级进行移位，或者干脆合并进ALU。但是，流水线延迟最大的一级往往就是EX级，应当尽可能地减轻其负担。所以，将移位器往前移、未来的存取单元往后移。</p><h2 id="ID-EX级-流水线寄存器-PR-ID-EX-sv">ID/EX级 流水线寄存器 PR_ID_EX.sv</h2><p>终于，要进入下一阶段了。ID/EX级的流水线寄存器可谓是相当重要，重要性仅次于EX/MEM级，因为这一级中转了各类数据以及地址——还有未来的数据前递入口。</p><p>我们要接收译码器传出的各种控制信号，包括ALU的操作数来源<code>is_auipc</code>和<code>alu_src</code>。根据译码器判断，对于S-Type指令，在MEM级还需要写入DRAM，因此还有写使能<code>dram_we</code>，或者是寄存器写使能<code>rf_we</code>。</p><p>还有什么？别忘了判断指令存取类型的<code>sl_type</code>，后面需要在MEM级用到。</p><div class="note warning flat"><p>即使RISC-V不强制要求支持非对齐访存，<code>lb/lh</code>等指令也必须支持！</p></div><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> PR_ID_EX (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 流水线控制信号</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        flush,</span><br><span class="line">    <span class="comment">// ID级输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_id_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_id_i,</span><br><span class="line">    <span class="comment">// input  logic [31:0] instr_id_i,</span></span><br><span class="line">    <span class="comment">// ID级输出 给EX级输入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_ex_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_ex_o,</span><br><span class="line">    <span class="comment">// output logic [31:0] instr_ex_o,</span></span><br><span class="line">    <span class="comment">// 判断指令是否有效</span></span><br><span class="line">    <span class="comment">// 流水线冲刷时需要将指令置为无效</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        instr_valid_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        instr_valid_ex_o,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寄存器堆第一寄存器数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD1_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD1_o,</span><br><span class="line">    <span class="comment">// 寄存器堆第二寄存器数据</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD2_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] rD2_o,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALUOp</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] alu_op_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] alu_op_ex_o,</span><br><span class="line">    <span class="comment">// ALU第一操作数来源 判断AUIPC</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        is_auipc_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        is_auipc_ex_o,</span><br><span class="line">    <span class="comment">// ALU第二操作数来源</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        alu_src2_sel_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        alu_src2_sel_ex_o,</span><br><span class="line">    <span class="comment">// 写使能</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        dram_we_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        dram_we_ex_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rf_we_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        rf_we_ex_o,</span><br><span class="line">    <span class="comment">// 写回数据来源</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] wd_sel_ex_o,</span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">4</span>:<span class="number">0</span>] wr_ex_o,</span><br><span class="line">    <span class="comment">// 分支跳转</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        is_branch_instr_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        is_branch_instr_ex_o,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] branch_type_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">2</span>:<span class="number">0</span>] branch_type_ex_o,</span><br><span class="line">    <span class="comment">// 跳转相关</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] jump_type_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] jump_type_ex_o,</span><br><span class="line">    <span class="comment">// 读取类型</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [ <span class="number">3</span>:<span class="number">0</span>] sl_type_ex_o,</span><br><span class="line">    <span class="comment">// 立即数</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] imm_ex_o,</span><br><span class="line">    <span class="comment">// PC跳转时地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_jump_id_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_jump_ex_o</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_ff</span>@(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寄存器堆数据</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            rD1_o &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            rD2_o &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> b</span><br><span class="line">            rD1_o &lt;= rD1_i;</span><br><span class="line">            rD2_o &lt;= rD2_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分支跳转相关</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            is_branch_instr_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            branch_type_ex_o     &lt;= <span class="number">3&#x27;b0</span>;</span><br><span class="line">            jump_type_ex_o       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush) <span class="keyword">begin</span></span><br><span class="line">            is_branch_instr_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            branch_type_ex_o     &lt;= <span class="number">3&#x27;b0</span>;</span><br><span class="line">            jump_type_ex_o       &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            is_branch_instr_ex_o &lt;= is_branch_instr_id_i;</span><br><span class="line">            branch_type_ex_o     &lt;= branch_type_id_i;</span><br><span class="line">            jump_type_ex_o       &lt;= jump_type_id_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALUOp相关</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            alu_op_ex_o       &lt;= <span class="number">4&#x27;b0</span>;</span><br><span class="line">            is_auipc_ex_o     &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            alu_src2_sel_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            dram_we_ex_o      &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            sl_type_ex_o      &lt;= <span class="number">3&#x27;b0</span>;</span><br><span class="line">            imm_ex_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush) <span class="keyword">begin</span></span><br><span class="line">            alu_op_ex_o       &lt;= <span class="number">4&#x27;b0</span>;</span><br><span class="line">            is_auipc_ex_o     &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            alu_src2_sel_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            dram_we_ex_o      &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            sl_type_ex_o      &lt;= sl_type_id_i;</span><br><span class="line">            imm_ex_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            alu_op_ex_o       &lt;= alu_op_id_i;</span><br><span class="line">            is_auipc_ex_o     &lt;= is_auipc_id_i;</span><br><span class="line">            alu_src2_sel_ex_o &lt;= alu_src2_sel_id_i;</span><br><span class="line">            dram_we_ex_o      &lt;= dram_we_id_i;</span><br><span class="line">            sl_type_ex_o      &lt;= sl_type_id_i;</span><br><span class="line">            imm_ex_o          &lt;= imm_id_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写回来源</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            pc_ex_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            pc4_ex_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">            rf_we_ex_o       &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            wd_sel_ex_o      &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            pc_jump_ex_o     &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush &amp;&amp; pc_id_i) <span class="keyword">begin</span>  <span class="comment">// 确保不是因为流水线暂停引起的冲刷</span></span><br><span class="line">            pc_ex_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            pc4_ex_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_ex_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">            rf_we_ex_o       &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            wd_sel_ex_o      &lt;= <span class="number">2&#x27;b0</span>;</span><br><span class="line">            pc_jump_ex_o     &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            pc_ex_o          &lt;= pc_id_i;</span><br><span class="line">            pc4_ex_o         &lt;= pc4_id_i;</span><br><span class="line">            instr_valid_ex_o &lt;= instr_valid_id_i;</span><br><span class="line"></span><br><span class="line">            rf_we_ex_o       &lt;= rf_we_id_i;</span><br><span class="line">            wd_sel_ex_o      &lt;= wd_sel_id_i;</span><br><span class="line">            pc_jump_ex_o     &lt;= pc_jump_id_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写回寄存器地址</span></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            wr_ex_o &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush) <span class="keyword">begin</span></span><br><span class="line">            wr_ex_o &lt;= <span class="number">5&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            wr_ex_o &lt;= wr_id_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>至此，ID级也构建完成了。后面的，就是复杂的计算、疯狂的前递、吉列的<s>数据</s>斗争了。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;译码-ID级-设计&quot;&gt;译码 ID级 设计&lt;/h2&gt;
&lt;p&gt;提到译码级，那就得是译码器啊。纯组合逻辑，包你写到爽。&lt;/p&gt;
&lt;p&gt;译码级还有什么？立即数移位也需要放在ID级，以减轻EX级</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
  </entry>
  
  <entry>
    <title>从零开始学RISC：第四篇</title>
    <link href="https://blog.esing.dev/2025/12/05/riscvcod-p4/"/>
    <id>https://blog.esing.dev/2025/12/05/riscvcod-p4/</id>
    <published>2025-12-05T15:02:05.000Z</published>
    <updated>2025-12-10T13:36:19.405Z</updated>
    
    <content type="html"><![CDATA[<h2 id="从零构建前的准备">从零构建前的准备</h2><h3 id="设计思路">设计思路</h3><p>理论知识已经准备好了，接下来该开始实践了。</p><p>如何从零开始写一个CPU？</p><p>首先要明确ISA架构：我们需要支持哪些指令？RV32的拓展很多很多，比如<code>MIAFD</code>等等。我们可以实现一个“精简版”的<code>RV32I</code>指令集CPU——连里面的<code>ecall</code>和<code>ebreak</code>都不实现。只要满足基础的38条（甚至只支持<code>lw/sw</code>，不考虑非对齐访存），就能运行80%的C语言程序。至于<code>Zicsr</code>扩展和<code>M</code>扩展等，在构建完毕后再考虑。</p><p>然后，是微架构设计：是做单周期还是多周期，亦或者流水线？是做顺序还是乱序？单发射还是多发射？饭要一口口吃，步子迈太大了容易扯着蛋。因此，做一个经典的五级流水线、顺序单发射的CPU即可。</p><p>然后，保持一个清醒的头脑。即使是一个最简单的<code>RV32I</code>CPU，也需要不下于10个模块。所有的代码加起来可能连3000行都不到，但是其中的连线无比复杂。如果不在写之前就想好，很容易莫名其妙地丢掉一条连线、一个端口，然后看波形debug半天。</p><p>时刻要记住：切不可“只见树木、不见森林”——不建议一个一个模块写，而是创建好文件后问自己：</p><ul><li>这个模块的功能是什么？</li><li>这个模块是组合逻辑电路还是时序逻辑电路？</li><li>这个模块需要哪些控制信号？</li><li>这个模块需要输出什么数据？输出给谁？</li></ul><p>边考虑这些问题边创建文件，然后，类似参考书上的指导，构建数据通路。可以不写出来，但要想清楚，哪些数据会在寄存器之间流动，并被传递到下一级流水线。等每个文件的大体框架搭建完毕，再从易到难、从组合逻辑到时序逻辑完成。一级一级流水线向前推进，写完某一级后继续完成两级之间的流水线寄存器设计。</p><h3 id="参考资料">参考资料</h3><p><a href="https://github.com/xuanhao44/HITSZ-miniRVCPU">xuanhao44 - HITSZ-miniRVCPU</a></p><h3 id="开发环境">开发环境</h3><p>参考 <a href="/2024/01/18/vscode-verilog-setup/" title="VSCode配置Verilog开发环境">VSCode配置Verilog开发环境</a> 即可。</p><div class="note primary flat"><p>这里安利一下一个超级棒的的VSCode插件：<a href="https://marketplace.visualstudio.com/items?itemName=sterben.fpga-support">Digital IDE</a></p><p>内部集成了一件模块测试、代码高亮与格式化、快速跳转等。虽然生成模块图的功能有些BUG，但是依旧非常强，瑕不掩瑜！</p><p>现在写Verilog都用它了。绝赞！</p></div><h2 id="取指-IF级-设计">取指 IF级 设计</h2><p>IF级取出指令，因此模块很少，只要实现PC程序计数器和IROM即可。</p><h3 id="程序计数器-PC-sv">程序计数器 PC.sv</h3><p>显然，程序计数器是<strong>时序逻辑模块</strong>。这里将<code>PC+4</code>的计算也合并到PC模块内。</p><p>程序计数器要干什么？既要计算出下一时刻的PC，还要考虑是否发生分支跳转——这里要接受来自<code>EX</code>级的跳转发生信号，因为B-Type类指令到<code>EX</code>级才能得出结果。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PC (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 是否要打一拍 保持PC </span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        keep_pc,</span><br><span class="line">    <span class="comment">// 进行分支跳转</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        branch_op,</span><br><span class="line">    <span class="comment">// 分支跳转目标地址</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] branch_target,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_if,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_if</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] npc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        pc4_if = pc_if + <span class="number">4</span>;</span><br><span class="line">        npc    = branch_op ? branch_target : pc4_if;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n)       pc_if &lt;= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (keep_pc) pc_if &lt;= pc_if;</span><br><span class="line">        <span class="keyword">else</span>              pc_if &lt;= npc;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="指令存储器-IROM-sv">指令存储器 IROM.sv</h3><p>IROM即存放程序代码的Flash，只读，不依赖任何时钟信号，因此是<strong>组合逻辑模块</strong>。通常来说，IROM（指令存储器）会被放在译码级，但不自行封装时，我们也会给CPU接出<code>instr</code>和<code>pc</code>到厂商的 IROM IP核。为了方便思考，此处放在IF级即可。为了便于仿真，这里自己实现一个支持加载hex文件的IROM。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IROM 行为模型 - 用于仿真</span></span><br><span class="line"><span class="comment">// 替代 Xilinx IP 核</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> IROM (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">wire</span> [<span class="number">13</span>:<span class="number">0</span>] a,   <span class="comment">// 地址输入 (14位 = 16K words)</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span>  [<span class="number">31</span>:<span class="number">0</span>] spo  <span class="comment">// 数据输出</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指令存储器 - 16K x 32bit</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] rom_data[<span class="number">16384</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文件加载指令</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">integer</span> i;</span><br><span class="line">        <span class="keyword">string</span>  rom_file;  <span class="comment">// 字符串缓冲区</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">16384</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// rom_data[i] = 32&#x27;h00000013;  // NOP</span></span><br><span class="line">            rom_data[i] = <span class="number">32&#x27;h0d000721</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尝试从文件加载指令</span></span><br><span class="line">        <span class="comment">// if ($value$plusargs(&quot;IROM=%s&quot;, rom_file)) begin</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            rom_file =</span><br><span class="line">            <span class="comment">// &quot;user/data/hex/simple_test.hex&quot;</span></span><br><span class="line">            <span class="string">&quot;user/data/hex/jalr.hex&quot;</span></span><br><span class="line">            <span class="comment">// &quot;user/data/hex/myFirstTest.hex&quot;</span></span><br><span class="line">            <span class="comment">// &quot;user/data/hex/no_hazard.hex&quot;</span></span><br><span class="line">            <span class="comment">// &quot;user/data/hex/loaduse_test.hex&quot;</span></span><br><span class="line">            <span class="comment">// &quot;user/data/hex/hazard12.hex&quot;</span></span><br><span class="line">            ;</span><br><span class="line">            <span class="built_in">$readmemh</span>(rom_file, rom_data);</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;IROM: Loaded instructions from %s&quot;</span>, rom_file);</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 如果没有指定文件,加载默认的测试程序</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;IROM: Loading default test program&quot;</span>);</span><br><span class="line">            load_default_program();</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取数据 (组合逻辑)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        spo = rom_data[a];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载默认测试程序</span></span><br><span class="line">    <span class="keyword">task</span> <span class="keyword">automatic</span> load_default_program;</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 更复杂的测试程序 - 测试算术、逻辑、移位指令和数据冒险</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;IROM: Default test program loaded&quot;</span>);</span><br><span class="line">            rom_data[<span class="number">0</span>] = <span class="number">32&#x27;h00500093</span>;  <span class="comment">// addi x1, x0, 5      x1 = 5</span></span><br><span class="line">            rom_data[<span class="number">1</span>] = <span class="number">32&#x27;h00300113</span>;  <span class="comment">// addi x2, x0, 3      x2 = 3</span></span><br><span class="line">            rom_data[<span class="number">2</span>] = <span class="number">32&#x27;h002081b3</span>;  <span class="comment">// add  x3, x1, x2     x3 = x1 + x2 = 8</span></span><br><span class="line">            rom_data[<span class="number">3</span>] = <span class="number">32&#x27;h40208233</span>;  <span class="comment">// sub  x4, x1, x2     x4 = x1 - x2 = 2</span></span><br><span class="line">            rom_data[<span class="number">4</span>] = <span class="number">32&#x27;h0020f2b3</span>;  <span class="comment">// and  x5, x1, x2     x5 = x1 &amp; x2 = 1</span></span><br><span class="line">            rom_data[<span class="number">5</span>] = <span class="number">32&#x27;h0020e333</span>;  <span class="comment">// or   x6, x1, x2     x6 = x1 | x2 = 7</span></span><br><span class="line">            rom_data[<span class="number">6</span>] = <span class="number">32&#x27;h002093b3</span>;  <span class="comment">// sll  x7, x1, x2     x7 = x1 &lt;&lt; x2 = 40</span></span><br><span class="line">            rom_data[<span class="number">7</span>] = <span class="number">32&#x27;h0020c433</span>;  <span class="comment">// xor  x8, x1, x2     x8 = x1 ^ x2 = 6</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>hex文件加载方式可以选择手动指定路径，也可以选择编译时传入，后者配合Makefile文件很方便，不过我选择DIDE的一键仿真。</p><h2 id="IF-ID级-流水线寄存器-PR-IF-ID-sv">IF/ID级 流水线寄存器 PR_IF_ID.sv</h2><p>终于到了第一道坎：两级之间的流水线寄存器。</p><p>流水线寄存器起到一个承上启下的作用，在两个阶段之间保存数据，使得指令可以连续执行。</p><p>都寄存器了，那肯定是<strong>时序逻辑模块</strong>了。</p><p>我们需要哪些信号？</p><p>首先是<code>PC</code>和<code>PC+4</code>，其中<code>PC+4</code>因为分支跳转和<code>jal/jalr</code>指令的需求，要一直送到<code>EX</code>级。接着是当前的指令，要送入下一级的译码器。</p><p>还有什么？我们肯定需要处理流水线的竞争冒险，而不能简单打一拍——就算打一拍，也要有相应的控制信号。因此，还需要<code>flush</code>和<code>stall</code>这两个控制信号，来控制IF级是否冲刷、是否停顿。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;./<span class="keyword">include</span>/defines.svh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> PR_IF_ID (</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        clk,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        rst_n,</span><br><span class="line">    <span class="comment">// 流水线控制信号</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        flush,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        stall,</span><br><span class="line">    <span class="comment">// IF级输入</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_if_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_if_i,</span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr_if_i,</span><br><span class="line">    <span class="comment">// IF级输出 给ID级输入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc_id_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] pc4_id_o,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instr_id_o,</span><br><span class="line">    <span class="comment">// 判断指令是否有效</span></span><br><span class="line">    <span class="comment">// 流水线冲刷时需要将指令置为无效</span></span><br><span class="line">    <span class="keyword">input</span>  <span class="keyword">logic</span>        instr_valid_if_i,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span>        instr_valid_id_o</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (!rst_n) <span class="keyword">begin</span></span><br><span class="line">            pc_id_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            pc4_id_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_id_o       &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_id_o &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (flush) <span class="keyword">begin</span></span><br><span class="line">            pc_id_o          &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            pc4_id_o         &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_id_o       &lt;= <span class="number">32&#x27;b0</span>;</span><br><span class="line">            instr_valid_id_o &lt;= <span class="number">1&#x27;b0</span>;  <span class="comment">// 冲刷时指令无效</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (stall) <span class="keyword">begin</span></span><br><span class="line">            pc_id_o          &lt;= pc_id_o;</span><br><span class="line">            pc4_id_o         &lt;= pc4_id_o;</span><br><span class="line">            instr_id_o       &lt;= instr_id_o;</span><br><span class="line">            instr_valid_id_o &lt;= instr_valid_id_o;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            pc_id_o          &lt;= pc_if_i;</span><br><span class="line">            pc4_id_o         &lt;= pc4_if_i;</span><br><span class="line">            instr_id_o       &lt;= instr_if_i;</span><br><span class="line">            instr_valid_id_o &lt;= instr_valid_if_i;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>至此，IF级完毕。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;从零构建前的准备&quot;&gt;从零构建前的准备&lt;/h2&gt;
&lt;h3 id=&quot;设计思路&quot;&gt;设计思路&lt;/h3&gt;
&lt;p&gt;理论知识已经准备好了，接下来该开始实践了。&lt;/p&gt;
&lt;p&gt;如何从零开始写一个CPU</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="嵌入式" scheme="https://blog.esing.dev/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="计算机原理" scheme="https://blog.esing.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="RISC-V" scheme="https://blog.esing.dev/tags/RISC-V/"/>
    
    <category term="SystemVerilog" scheme="https://blog.esing.dev/tags/SystemVerilog/"/>
    
  </entry>
  
  <entry>
    <title>Cloudflare、睡覺——大规模宕机后的随想</title>
    <link href="https://blog.esing.dev/2025/11/18/cloudflare-offline-oneday/"/>
    <id>https://blog.esing.dev/2025/11/18/cloudflare-offline-oneday/</id>
    <published>2025-11-18T14:45:37.000Z</published>
    <updated>2025-11-19T02:56:36.593Z</updated>
    
    <content type="html"><![CDATA[<div class="note orange icon-padding flat"><i class="note-icon fab fa-cloudflare"></i><p>写于2025.11.18，纪念 Cloudflare 发生的大规模故障。</p></div><p>今年真是个多事之年啊。</p><p>开着组会呢，网站突然就打不开了，接着就是熟悉的小黄云500。还以为是源站挂了，随即关了浏览器再开。好家伙，GPT也卡在前面的Cloudflare Challenge 认证界面。这才意识到：Cloudflare，大抵是又<strong>炸</strong>了。而这，已经是今年的第三次了。</p><p><strong>网络菩萨、赛博义父，终究要顶不住这泼天的“流量”了吗。</strong></p><hr><p>翻了下Telegram，几乎所有群组都炸锅了：“Cloudflare” “宕机” “攻击” 的字样层出不穷。谁也不知道，究竟是一个员工的无心之举，还是一个部门的一次部署失误，亦或是什么组织的大规模网络攻击，导致了这一场灾难。微信群里同样炸了锅：同学嚷嚷着自己看文献的网站打不开、ChatGPT进不去……就连我的博客和一系列Cloudflare Workers服务也没能幸免于难，只剩下了前几天新搭建的 <a href="/2025/10/31/onelastkiss-image/" title="One Last Kiss 风格图片生成">OneLastKiss生成器</a> 还活着 TuT</p><p>看着<a href="https://www.cloudflarestatus.com/">Cloudflare Status</a>那色彩缤纷的<span style="color:#DA304C;">三</span><span style="color:#FBAE40;">色</span><span style="color:#2C7CB0;">条</span>，我不由得希望，今年结束之前不要再见到它。</p><img src="https://webp.esing.dev/img/-6116001428162677917_119_251118_2311_fD5D.jpg" alt="MJJ最不想看见的颜色（笑）" style="zoom:25%;" /><p>过了几分钟，就连监控Cloudflare状态的<a href="https://www.cloudflarestatus.com/">Cloudflare Status</a>也炸了。</p><img src="https://webp.esing.dev/img/-6116318431108861140_119_251118_2307_bqC2.jpg" alt="彻底爆炸的Cloudflare Status" style="zoom:25%;" /><p>不过还有一部分企业网站幸免于难，比如<a href="https://csgo.com/">CSGO国际官网</a>，可能是Enterprise有着不同线路？毕竟ChatGPT挂掉的也只是人机验证部分。这么算来，粗略估算的话，世界上有<strong>五分之一</strong>的网站应该都受到了影响——从DNS到静态页面托管，再到反向代理。不愧是你，Cloudflare。</p><hr><p>在两个小时后，22:50，官方终于发消息称修复完毕。<a href="https://t.me/vps_xhq/766">VPS信号旗播报</a>也给到了<span style="color:#FBAE40;">Level B</span>的重要等级。只能说小老弟还得多练，想达到你谷哥<a href="https://t.me/vps_xhq/161">以前</a>的<span style="color:#DA304C;">Level A</span>还有很长的路呢。</p><hr><p>我想到了《球状闪电》。</p><p><em><strong>“摧毁芯片的宏聚变可以使地球这块大硬盘被格式化，越先进的国家受到的打击就越大。而在向信息时代的恢复过程中，将出现一个不确定的全新的世界格局。”</strong></em></p><p>倘若真有一日，互联网全部瘫痪——或是更严重，如同《全频段阻塞干扰》那样——人类的生活会怎么样？<strong>是于废墟中携手重建往日的信息时代，还是借混乱之时重建各自渴望的世界格局？</strong></p><hr><p>一觉醒来，Cloudflare也发了<a href="https://blog.cloudflare.com/18-november-2025-outage/">官方声明</a>，解释本次故障原因：</p><blockquote><p>故障是由于工程师更改了一个数据库系统的权限所引发的。该设置会导致数据库向 Bot 管理系统所使用的“特征文件（feature file）”中输出多重条目，进而导致该特征文件的大小翻了一番。随后，有问题的特征文件被分发到了网络中的所有机器上。</p><p>网络中的设备软件对特征文件的大小设定了上限，而翻倍后的文件超过了这一限制，导致软件崩溃。</p></blockquote><p>Cloudflare 一度怀疑这是由超大规模 DDoS 攻击引起的，但很快锁定了核心问题，成功阻止了体积异常的特征文件进一步传播。将其替换为该文件的早期版本后核心流量基本恢复正常流转。但随着流量重新涌入，Cloudflare 最终耗费了数小时来缓解网络各部分增加的负载。</p><p>果然是工程师的误操作导致的，唉草台班子 ^__^。不知道工程师是不是被拉去祭天了？这每秒损失可不是挖断国防光缆能比的。</p>]]></content>
    
    
    <summary type="html">写于2025.11.18，纪念 Cloudflare 发生的大规模故障。</summary>
    
    
    
    <category term="随笔" scheme="https://blog.esing.dev/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="Cloudflare" scheme="https://blog.esing.dev/tags/Cloudflare/"/>
    
    <category term="代理" scheme="https://blog.esing.dev/tags/%E4%BB%A3%E7%90%86/"/>
    
    <category term="Workers" scheme="https://blog.esing.dev/tags/Workers/"/>
    
  </entry>
  
  <entry>
    <title>更适合Powershell体质的ln</title>
    <link href="https://blog.esing.dev/2025/11/17/powershell-ln/"/>
    <id>https://blog.esing.dev/2025/11/17/powershell-ln/</id>
    <published>2025-11-17T06:13:32.000Z</published>
    <updated>2025-11-17T06:22:14.360Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>在<a href="/2025/10/20/powershell-grep/" title="更适合Powershell体质的grep">更适合Powershell体质的grep</a>中重定义了<code>grep</code>。Linux中的<code>ln</code>命令也非常好用，创建软链接，可以省下很多需要复用的文件空间。</p><p>没想到Powershell中没办法使用cmd的<code>mklink</code>，自带的创建软连接命令比我命还长。自己写一个脚本重定向！</p><h2 id="代码">代码</h2><p>因为不能执行cmd命令，只能使用Powershell函数，因此新建一个<code>ln.psm1</code>模块，并保存到<code>C:\Users\UserName\Documents\PowerShell\Modules\ln</code>，在Powershell初始化时导入即可。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ln</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">param</span>(</span><br><span class="line">        [<span class="type">switch</span>]<span class="variable">$d</span>,      <span class="comment"># -d: 强制目录链接</span></span><br><span class="line">        [<span class="type">switch</span>]<span class="variable">$h</span>,      <span class="comment"># -h: 显示帮助</span></span><br><span class="line">        [<span class="built_in">string</span>]<span class="variable">$target</span>,</span><br><span class="line">        [<span class="built_in">string</span>]<span class="variable">$link</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ======== 彩色帮助 ========</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$h</span> <span class="operator">-or</span> <span class="operator">-not</span> <span class="variable">$target</span> <span class="operator">-or</span> <span class="operator">-not</span> <span class="variable">$link</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span>  <span class="comment"># 空行</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;ln: create symbolic link &quot;</span> <span class="literal">-ForegroundColor</span> Cyan <span class="literal">-NoNewline</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;(PowerShell version)&quot;</span> <span class="literal">-ForegroundColor</span> DarkGray</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Usage:&quot;</span> <span class="literal">-ForegroundColor</span> Yellow</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  ln [-d] &lt;target&gt; &lt;link&gt;&quot;</span> <span class="literal">-ForegroundColor</span> White</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Options:&quot;</span> <span class="literal">-ForegroundColor</span> Yellow</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  -d        create directory symbolic link&quot;</span> <span class="literal">-ForegroundColor</span> White</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  -h        display this help&quot;</span> <span class="literal">-ForegroundColor</span> White</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Examples:&quot;</span> <span class="literal">-ForegroundColor</span> Yellow</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  ln C:\real\file.txt C:\link\file.txt&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  ln C:\realDir C:\linkDir&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;  ln -d C:\realDir C:\linkDir&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ======== 参数检查 ========</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">-not</span> (<span class="built_in">Test-Path</span> <span class="variable">$target</span>)) &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;ln: target &#x27;<span class="variable">$target</span>&#x27; not found&quot;</span> <span class="literal">-ForegroundColor</span> Red</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ======== 设置类型（SymbolicLink）========</span></span><br><span class="line">    <span class="variable">$itemType</span> = <span class="string">&quot;SymbolicLink&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ======== 创建符号链接 ========</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">New-Item</span> <span class="literal">-ItemType</span> <span class="variable">$itemType</span> <span class="literal">-Path</span> <span class="variable">$link</span> <span class="literal">-Target</span> <span class="variable">$target</span> | <span class="built_in">Out-Null</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;ln: created symbolic link &quot;</span> <span class="literal">-ForegroundColor</span> Cyan <span class="literal">-NoNewline</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&#x27;<span class="variable">$link</span>&#x27;&quot;</span> <span class="literal">-ForegroundColor</span> Green <span class="literal">-NoNewline</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot; → &quot;</span> <span class="literal">-ForegroundColor</span> DarkGray <span class="literal">-NoNewline</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;&#x27;<span class="variable">$target</span>&#x27;&quot;</span> <span class="literal">-ForegroundColor</span> Green</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;ln: failed to create link: <span class="variable">$</span>(<span class="variable">$_</span>.Exception.Message)&quot;</span> <span class="literal">-ForegroundColor</span> Red</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在Powershell里执行<code>$PROFILE</code>即可看到配置文件位置，一般在<code>C:\Users\UserName\Documents\PowerShell\Microsoft.PowerShell_profile.ps1</code>。</p><p>在末尾加上<code>Import-Module ln</code>即可。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;在&lt;a href=&quot;/2025/10/20/powershell-grep/&quot; title=&quot;更适合Powershell体质的grep&quot;&gt;更适合Power</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="Powershell" scheme="https://blog.esing.dev/tags/Powershell/"/>
    
  </entry>
  
  <entry>
    <title>降低腾讯ACE反作弊扫盘优先级并提升游戏性能</title>
    <link href="https://blog.esing.dev/2025/11/15/fuckoff-aceguard/"/>
    <id>https://blog.esing.dev/2025/11/15/fuckoff-aceguard/</id>
    <published>2025-11-15T12:53:32.000Z</published>
    <updated>2025-11-15T12:56:53.818Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>打大乱斗动不动就卡，太烦了。这B反作弊跟小蓝熊坐一桌去。</p><h2 id="注册表修改">注册表修改</h2><p>参考：<a href="https://www.bilibili.com/video/av115529217998860">解决英雄联盟LOL卡顿掉帧问题很多方法都没用的试下这个 - 哔哩哔哩</a></p><p>新建一个注册表文件<code>1.reg</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\DeltaForceClient-Win64-Shipping.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000003</span><br><span class="line">&quot;IoPriority&quot;=dword:00000003</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\League of Legends.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000003</span><br><span class="line">&quot;IoPriority&quot;=dword:00000003</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LeagueClient.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000003</span><br><span class="line">&quot;IoPriority&quot;=dword:00000003</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\ACE-Tray.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000001</span><br><span class="line">&quot;IoPriority&quot;=dword:00000001</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\SGuard64.exe\PerfOptions]</span><br><span class="line">&quot;CpuPriorityClass&quot;=dword:00000001</span><br><span class="line">&quot;IoPriority&quot;=dword:00000001</span><br></pre></td></tr></table></figure><p>然后双击导入即可。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;打大乱斗动不动就卡，太烦了。这B反作弊跟小蓝熊坐一桌去。&lt;/p&gt;
&lt;h2 id=&quot;注册表修改&quot;&gt;注册表修改&lt;/h2&gt;
&lt;p&gt;参考：&lt;a href=&quot;htt</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
  </entry>
  
  <entry>
    <title>学银在线解除粘贴限制</title>
    <link href="https://blog.esing.dev/2025/11/12/fuckoff-xueyinonline/"/>
    <id>https://blog.esing.dev/2025/11/12/fuckoff-xueyinonline/</id>
    <published>2025-11-12T11:41:03.000Z</published>
    <updated>2025-11-12T12:27:28.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><div class="note primary flat"><p>懒得看的直接跳转<a href="#%E8%84%9A%E6%9C%AC%E6%BA%90%E7%A0%81">脚本源码</a></p></div><p><strong>AI开课还要布置作业，你无敌了。我寻思这课不是考察吗？</strong></p><p>学银在线提交作业界面甚至无法粘贴，会提示“只能录入不能粘贴！”</p><p>什么垃圾玩意？看我干不干你就完事了。</p><h2 id="破解">破解</h2><h3 id="定位代码-修改">定位代码&amp;修改</h3><p>这种禁止粘贴100%是JS+前端拦截。直接进控制台搜源代码，定位到：</p><img src="https://webp.esing.dev/img/image-20251112200416938_251112_2004_AQoQ.png" alt="监听函数" style="zoom:80%;" /><p>然后直接写脚本替换：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         学银在线允许粘贴</span></span><br><span class="line"><span class="comment">// @namespace    https://blog.esing.dev/</span></span><br><span class="line"><span class="comment">// @version      0.7.2.1</span></span><br><span class="line"><span class="comment">// @description  移除学银在线的编辑器限制，允许粘贴</span></span><br><span class="line"><span class="comment">// @match        https://mooc1.xueyinonline.com/mooc-ans/*</span></span><br><span class="line"><span class="comment">// @run-at       document-end</span></span><br><span class="line"><span class="comment">// @grant        unsafeWindow</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">overrideEditorPaste</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> unsafeWindow.<span class="property">editorPaste</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                unsafeWindow.<span class="property">editorPaste</span> = <span class="keyword">function</span>(<span class="params">o, html</span>) &#123;</span><br><span class="line">                    <span class="comment">// 不清空 html.html，让编辑器正常插入粘贴内容</span></span><br><span class="line">                    <span class="comment">// 也不再弹“只能录入不能粘贴！”</span></span><br><span class="line">                    <span class="comment">// 一般返回 true/不返回都可以，看编辑器实现习惯</span></span><br><span class="line">                    <span class="comment">// 这里返回 true，表示允许粘贴</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[Tampermonkey] editorPaste overridden, paste is now allowed.&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;[Tampermonkey] Failed to override editorPaste:&#x27;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试覆盖一次</span></span><br><span class="line">    <span class="title function_">overrideEditorPaste</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有些站点会晚一点才定义 editorPaste，这里每隔 1 秒再尝试一下</span></span><br><span class="line">    <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">overrideEditorPaste</span>()) &#123;</span><br><span class="line">            <span class="built_in">clearInterval</span>(timer); <span class="comment">// 覆盖成功后就不用再重复尝试了</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>塞进油猴测试。</p><p>没有效果？那继续。</p><h3 id="分析输入框代码">分析输入框代码</h3><p>继续检查元素，定位到输入框代码。检查一下可以发现，这里有个奇怪的script：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;stem_answer&quot;</span> <span class="attr">style</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;eidtDiv&quot;</span> <span class="attr">style</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;edui-default&quot;</span> <span class="attr">style</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;answer1919810&quot;</span> <span class="attr">name</span>=<span class="string">&quot;answer1919810&quot;</span> <span class="attr">_initadjustheight</span>=<span class="string">&quot;36&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 72px; display: none&quot;</span>&gt;</span>FUCKOFF<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> wordNum = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (wordNum == <span class="string">&quot;&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                wordNum = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> wordMinNum = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (wordMinNum == <span class="string">&quot;&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                wordMinNum = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> qtype = <span class="string">&quot;4&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// var wordCount = false;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// if (qtype == 4) &#123;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// wordCount = true;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">UEDITOR_CONFIG</span>.<span class="property">initialFrameHeight</span> = <span class="number">150</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> wordCount = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (<span class="built_in">parseInt</span>(wordNum) == <span class="number">0</span> &amp;&amp; <span class="built_in">parseInt</span>(wordMinNum) == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                wordCount = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">UEDITOR_CONFIG</span>.<span class="property">wordCount</span> = wordCount;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">UEDITOR_CONFIG</span>.<span class="property">wordCountTimer</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// window.UEDITOR_CONFIG.maximumWords = wordNum;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// window.UEDITOR_CONFIG.minimumWords = wordMinNum;</span></span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            &lt;!-- 编辑器定义代码 --&gt;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> editor1 = <span class="variable constant_">UE</span>.<span class="title function_">getEditor</span>(<span class="string">&quot;answer1919810&quot;</span>, &#123; <span class="attr">pasteplain</span>: <span class="literal">true</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="property">options</span>.<span class="property">maximumWords</span> = wordNum;</span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="property">options</span>.<span class="property">minimumWords</span> = wordMinNum;</span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="title function_">addListener</span>(<span class="string">&quot;blur&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> count = <span class="variable constant_">UE</span>.<span class="title function_">getEditor</span>(<span class="string">&quot;answer1919810&quot;</span>).<span class="title function_">pureWordCount</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> max = <span class="built_in">parseInt</span>(<span class="variable constant_">UE</span>.<span class="title function_">getEditor</span>(<span class="string">&quot;answer1919810&quot;</span>).<span class="property">options</span>.<span class="property">maximumWords</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> min = <span class="built_in">parseInt</span>(<span class="variable constant_">UE</span>.<span class="title function_">getEditor</span>(<span class="string">&quot;answer1919810&quot;</span>).<span class="property">options</span>.<span class="property">minimumWords</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borblue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borred&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((max &gt; <span class="number">0</span> &amp;&amp; count &gt; max) || (min &gt; <span class="number">0</span> &amp;&amp; min &gt; count)) &#123;</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borblue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">addClass</span>(<span class="string">&quot;borred&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borblue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borred&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="title function_">addListener</span>(<span class="string">&quot;focus&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">addClass</span>(<span class="string">&quot;borblue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&quot;#answer1919810&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.edui-editor.edui-default&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;borred&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            &lt;!-- 粘贴许可相关 --&gt;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> allowPaste = <span class="string">&quot;1&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (<span class="built_in">parseInt</span>(allowPaste) == <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                editor1.<span class="title function_">addListener</span>(<span class="string">&quot;beforepaste&quot;</span>, editorPaste);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            &lt;!-- 一个奇怪的监听器 --&gt;</span></span><br><span class="line"><span class="language-javascript">            editor1.<span class="title function_">addListener</span>(<span class="string">&quot;contentChange&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">loadEditorAnswerd</span>(<span class="number">1919810</span>, <span class="number">4</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">answerContentChange</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            &lt;!-- 应该就是你了 --&gt;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">UEDITOR_CONFIG</span>.<span class="property">wordCount</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可知：这个编辑器是百度的<strong>UEditor</strong>，且在<code>beforepaste</code>事件上面挂了<code>editorPaste</code>这个回调函数。因此，真正要干掉的是所有的<code>UEditor</code>上面挂的<code>beforepaste</code>监视器。</p><h3 id="修改脚本">修改脚本</h3><p>把UEditor上面挂的<code>beforepaste</code>监视器拿掉即可。注意看函数上面有个<code>addListener(&quot;beforepaste&quot;, editorPaste)</code>，这是挂上去的代码。那我<code>removeListener</code>你不炸了吗？</p><p>直接把需求告诉AI让它修改就行了。AI太好用了你们知道吗</p><h3 id="脚本源码">脚本源码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         学银在线允许粘贴</span></span><br><span class="line"><span class="comment">// @namespace    https://blog.esing.dev/</span></span><br><span class="line"><span class="comment">// @version      0.7.2.1</span></span><br><span class="line"><span class="comment">// @description  移除学银在线的编辑器限制，允许粘贴</span></span><br><span class="line"><span class="comment">// @match        https://mooc1.xueyinonline.com/mooc-ans/*</span></span><br><span class="line"><span class="comment">// @run-at       document-end</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试对所有 UEditor 实例移除 beforepaste 的 editorPaste 监听</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">unlockPaste</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// UEditor 全局对象一般叫 UE</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">UE</span> || !<span class="variable constant_">UE</span>.<span class="property">instants</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> done = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="variable constant_">UE</span>.<span class="property">instants</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(<span class="variable constant_">UE</span>.<span class="property">instants</span>, key)) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">const</span> ed = <span class="variable constant_">UE</span>.<span class="property">instants</span>[key];</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 如果全局有 editorPaste 函数，并且这个编辑器有 removeListener 方法</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">editorPaste</span> === <span class="string">&quot;function&quot;</span> &amp;&amp; ed.<span class="property">removeListener</span>) &#123;</span><br><span class="line">                    ed.<span class="title function_">removeListener</span>(<span class="string">&quot;beforepaste&quot;</span>, <span class="variable language_">window</span>.<span class="property">editorPaste</span>);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Userscript] removed beforepaste listener from editor:&quot;</span>, key);</span><br><span class="line">                    done = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[Userscript] removeListener error:&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初次尝试</span></span><br><span class="line">    <span class="title function_">unlockPaste</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有时候编辑器是异步初始化的，这里轮询几次，确保挂到实例上之后再移除</span></span><br><span class="line">    <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">unlockPaste</span>()) &#123;</span><br><span class="line">            <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;paste-unlock-indicator&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">        div.<span class="property">id</span> = <span class="string">&quot;paste-unlock-indicator&quot;</span>;</span><br><span class="line">        div.<span class="property">textContent</span> = <span class="string">&quot;粘贴已解锁😋&quot;</span>;</span><br><span class="line">        div.<span class="property">style</span>.<span class="property">cssText</span> =</span><br><span class="line">            <span class="string">&quot;position:fixed;bottom:10px;right:10px;padding:4px 8px;font-size:12px;background:#4caf50;color:#fff;z-index:99999;border-radius:4px;opacity:0.7;&quot;</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>收工。</p>]]></content>
    
    
    <summary type="html">防君子、不防小人也。</summary>
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="JavaScript" scheme="https://blog.esing.dev/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>GTKWave修改字体大小</title>
    <link href="https://blog.esing.dev/2025/11/10/gtkwave-fontsize/"/>
    <id>https://blog.esing.dev/2025/11/10/gtkwave-fontsize/</id>
    <published>2025-11-10T12:47:01.000Z</published>
    <updated>2025-11-11T09:49:22.808Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>目前看波形依旧没有什么现代化的软件，还是得用GTKWave。这玩意本来是给Linux用的，Windows上的界面看起来很奇怪。而且字体太小了，眼睛受不了。如何修改字体和字体大小呢？</p><h2 id="配置文件与启动参数">配置文件与启动参数</h2><p>参考官方文档：<a href="https://gtkwave.sourceforge.net/gtkwave.pdf">GTKWave 3.3 Wave Analyzer User's Guide</a></p><p>编辑用户文件夹下的<code>.gtkwaverc</code>文件（不存在就新建一个）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use_big_fonts 8        //字体字号</span><br><span class="line">highlight_wavewindow 1 //高亮被选择的信号波形</span><br><span class="line">// color_grid feeeed   // 高亮信号颜色</span><br><span class="line">fill_waveform 1        //高值填充</span><br><span class="line">disable_mouseover 0    //鼠标可查看波形</span><br><span class="line">hier_max_level 5       //显示信号归属层级的最大值</span><br><span class="line">left_justify_sigs 1    //信号左对齐</span><br></pre></td></tr></table></figure><p>之后用参数启动：</p><p><code> gtkwave -r path/to/config/.gtkwaverc your_vcdfile</code>即可。</p><p>其实也可以修改字体：</p><p><code>fontname_signals XXX</code>即可。但是显示很奇怪。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;目前看波形依旧没有什么现代化的软件，还是得用GTKWave。这玩意本来是给Linux用的，Windows上的界面看起来很奇怪。而且字体太小了，眼睛受不了。</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
  </entry>
  
  <entry>
    <title>超大规模集成电路设计笔记：第六篇</title>
    <link href="https://blog.esing.dev/2025/11/08/vd-p6/"/>
    <id>https://blog.esing.dev/2025/11/08/vd-p6/</id>
    <published>2025-11-08T15:22:28.000Z</published>
    <updated>2025-11-10T03:53:43.556Z</updated>
    
    <content type="html"><![CDATA[<div class="note info flat"><p>应付一下应试。</p></div><h2 id="缩写">缩写</h2><ul><li><strong>PLA</strong>: Programmable Logic Array</li><li><strong>PAL</strong>: Programmable Array Logic</li><li><strong>PLD</strong>: Programmable Logic Device</li><li><strong>ROM</strong>: Read-Only Memory</li><li><strong>RAM</strong>: Random Access Memory</li><li><strong>ALU</strong>: Arithmetic Logic Unit</li><li><strong>IEEE</strong>: Institute of Electrical and Electronics Engineers</li><li><strong>VHDL</strong>: VHSIC Hardware Description Language</li><li><strong>CMOS</strong>: Complementary Metal Oxide Semiconductor</li><li><strong>FPGA</strong>: Field-Programmable Gate Array</li><li><strong>RISC</strong>: Reduced Instruction Set Computer</li><li><strong>CISC</strong>: Complex Instruction Set Computer</li><li><strong>DSA</strong>: Domain Specific Architecture</li><li><strong>SoC</strong>: System on Chip</li><li><strong>FP</strong>: Float Point</li><li><strong>ISA</strong>: Instruction Set Architecture</li><li><strong>RTC</strong>: Real-Time Clock</li><li><strong>SPI</strong>: Serial Peripheral Interface</li><li><strong>PMC</strong>: Power Management Controller</li><li><strong>DMA</strong>: Direct Memory Access</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;note info flat&quot;&gt;&lt;p&gt;应付一下应试。&lt;/p&gt;
&lt;/div&gt;
&lt;h2 id=&quot;缩写&quot;&gt;缩写&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;PLA&lt;/strong&gt;:</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="复习" scheme="https://blog.esing.dev/tags/%E5%A4%8D%E4%B9%A0/"/>
    
    <category term="数字系统设计" scheme="https://blog.esing.dev/tags/%E6%95%B0%E5%AD%97%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="VLSI" scheme="https://blog.esing.dev/tags/VLSI/"/>
    
  </entry>
  
  <entry>
    <title>One Last Kiss 风格图片生成</title>
    <link href="https://blog.esing.dev/2025/10/31/onelastkiss-image/"/>
    <id>https://blog.esing.dev/2025/10/31/onelastkiss-image/</id>
    <published>2025-10-31T10:57:56.000Z</published>
    <updated>2025-10-31T11:16:30.695Z</updated>
    
    <content type="html"><![CDATA[    <div id="aplayer-ANgRERXS" class="aplayer aplayer-tag-marker meting-tag-marker"         data-id="1824020871" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ff80ac" data-volume="0.3" data-loop="none"    ></div><h2 id="前言">前言</h2><p>在Github上闲逛时看到了这个库：<a href="https://github.com/itorr/one-last-image">「One Last Image」卢浮宫生成器 - itorr/one-last-image</a></p><p>在线试了一下，效果很不错，可惜导出的图片都被重采样到1080P了，于是拉源码自己修改了一版，可以开启高清模式，并随意调整水印位置：</p><p><img src="https://webp.esing.dev/img/image-20251031190219051_251031_1902_tsQn.png" alt="修改版"></p><p>地址在<a href="https://louvre.esing.dev/">louvre.esing.dev</a>。</p><p>效果还行：</p><p><img src="https://opic.esing.dev/img/louvre_251031_1910_J7A1.webp" alt="效果图，原图为p112423002"></p>]]></content>
    
    
    <summary type="html">「　第一次去卢浮宫 并无什么特别的感觉&lt;br&gt;　　因为独属于我的蒙娜丽莎 我早已遇见　」</summary>
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="二次元" scheme="https://blog.esing.dev/tags/%E4%BA%8C%E6%AC%A1%E5%85%83/"/>
    
    <category term="EVA" scheme="https://blog.esing.dev/tags/EVA/"/>
    
  </entry>
  
  <entry>
    <title>超大规模集成电路设计笔记：第五篇</title>
    <link href="https://blog.esing.dev/2025/10/29/vd-p5/"/>
    <id>https://blog.esing.dev/2025/10/29/vd-p5/</id>
    <published>2025-10-29T08:46:50.000Z</published>
    <updated>2025-11-04T04:56:47.097Z</updated>
    
    <content type="html"><![CDATA[<div class="note info flat"><p>这一章不考，至少往年题没有考过。</p></div><h2 id="SoC总线">SoC总线</h2><ul><li>总线提供了系统中<strong>各个设备之间</strong>一种<strong>互连</strong>的<strong>访问共享硬件</strong>机制</li><li>在数字系统中，总线<strong>承担数据传输任务</strong>，如处理器和存储器之间的数据传输</li><li>总线的传输能力由总线的<strong>带宽</strong>和<strong>工作频率</strong>决定</li><li>总线的设计通常要考虑4个因素：<strong>总线宽度、时钟频率、仲裁机制和传输类型</strong></li></ul><p>常见的总线有：</p><ul><li>AMBA：ARM公司定义的总线体系，广泛用于嵌入式SoC，包括 AHB、APB、AXI 等多个子协议</li><li>OCP：开放式核心接口协议，模块化设计，适合IP核集成</li><li>Wishbone：由OpenCores定义的开源SoC总线，简单易用，适合教学或FPGA设计</li><li>Avalon：原Altera公司定义的片上总线协议</li></ul><h3 id="AMBA">AMBA</h3><img src="https://webp.esing.dev/img/image-20251029172831688_251029_1728_zyBZ.png" alt="AMBA-AHB系统" style="zoom: 33%;" /><br><img src="https://webp.esing.dev/img/image-20251029172845655_251029_1728_fIGf.png" alt="AMBA-AXI系统" style="zoom: 67%;" /><h2 id="常见IP">常见IP</h2><p>SoC中的常见IP包括：中断控制器、实时时钟、SPI、定时器、看门狗等。</p><p>一个完整的 SoC 通常包含如下模块（IP）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────┐</span><br><span class="line">│        CPU / DSP         │   ← 控制/计算IP</span><br><span class="line">├──────────────────────────┤</span><br><span class="line">│   Cache / MMU / Memory   │   ← 存储IP</span><br><span class="line">├──────────────────────────┤</span><br><span class="line">│   AXI / AHB Interconnect │   ← 片上总线IP</span><br><span class="line">├──────────────────────────┤</span><br><span class="line">│ UART | SPI | I²C | GPIO  │   ← 外设IP</span><br><span class="line">├──────────────────────────┤</span><br><span class="line">│     DMA / Timer / WDT    │   ← 控制类IP</span><br><span class="line">├──────────────────────────┤</span><br><span class="line">│  USB / PCIe / Ethernet   │   ← 通信接口IP</span><br><span class="line">├──────────────────────────┤</span><br><span class="line">│   Security / Crypto / PM │   ← 安全与电源管理IP</span><br><span class="line">└──────────────────────────┘</span><br></pre></td></tr></table></figure><h3 id="中断控制器">中断控制器</h3><p>中断控制器（Interrupt Controller）是 SoC中用于管理和分发中断请求（IRQ）的关键模块，直接影响系统的<strong>实时性</strong>和<strong>响应能力</strong>。</p><ul><li>RISC-V：CLIN、PLIC</li><li>ARM：NVIC、GIC</li><li>x86：APIC</li></ul><h3 id="实时时钟-RTC">实时时钟 RTC</h3><p>RTC（Real-Time Clock，实时时钟）是SoC中用于提供精确时间和日历功能的独立模块，即使在系统断电时也能持续运行（通常依靠备用电池供电）。RTC拥有报警功能，当达到所需的日期或时间时，可以用来触发中断（唤醒）。</p><h3 id="SPI">SPI</h3><p>SPI（Serial Peripheral Interface，串行外设接口）允许与外围设备的全双工同步串行通信。</p><img src="https://pic.esing.dev/img/OIP_251029_1744_9Mi4.qDQZR6LGNmkKAxd41-dJkQHaFP" alt="SPI总线示意图" style="zoom: 50%;" /><h3 id="定时器与看门狗">定时器与看门狗</h3><p>Timer（定时器）和Watchdog（看门狗）是两种关键的外设模块，分别用于时间管理和系统可靠性保障。它们都基于<strong>计时原理</strong>，但用途完全不同：</p><ul><li>定时器用来“<strong>计时与触发事件</strong>”；</li><li>看门狗用来“<strong>监控系统运行是否卡死</strong>”。</li></ul><h3 id="PMC">PMC</h3><p>PMC（Power Management Controller） 是SoC中负责电源管理、功耗控制、时钟分配和系统唤醒的核心模块，直接影响芯片的能效比和续航能力。主要通过电源管理、时钟管理、软件管理等方式来达到控制功耗的目的。</p><table><thead><tr><th style="text-align:left">模式</th><th style="text-align:left">功耗</th><th style="text-align:left">唤醒延迟</th><th style="text-align:left">典型应用</th></tr></thead><tbody><tr><td style="text-align:left"><strong>Active</strong></td><td style="text-align:left">高</td><td style="text-align:left">无</td><td style="text-align:left">CPU全速运行任务。</td></tr><tr><td style="text-align:left"><strong>Idle</strong></td><td style="text-align:left">中</td><td style="text-align:left">微秒级</td><td style="text-align:left">等待中断（如手机待机）。</td></tr><tr><td style="text-align:left"><strong>Standby</strong></td><td style="text-align:left">低</td><td style="text-align:left">毫秒级</td><td style="text-align:left">仅保留SRAM和RTC（如IoT设备）。</td></tr><tr><td style="text-align:left"><strong>Off</strong></td><td style="text-align:left">极低</td><td style="text-align:left">秒级</td><td style="text-align:left">完全断电，需硬件复位唤醒。</td></tr></tbody></table><h3 id="DMAC">DMAC</h3><p><s>AMD反插</s></p><p>DMAC（Direct Memory Access Controller） 是SoC中用于在不占用CPU资源的情况下，实现外设与内存（或内存与内存）之间高速数据传输的硬件模块。它显著提升系统效率，尤其适用于大数据量、实时性要求高的场景（如音视频处理、网络通信）。</p><p>DMAC一般包括如下模块：</p><ul><li>通道控制器：每个通道独立配置源地址、目标地址、传输长度等参数</li><li>仲裁器：管理多个通道的优先级（固定优先级或轮询）</li><li>数据FIFO：缓冲数据，解决源/目标设备速度不匹配问题</li><li>寄存器组：存储控制参数（如传输模式、中断使能）</li><li>总线接口：连接系统总线（如AXI、AHB），访问内存和外设</li></ul><h2 id="中断与异常">中断与异常</h2><p>中断机制和异常机制即在中断和异常发生时，处理器将暂停当前正在执行的程序，转而执行中断和异常处理程序，返回时处理器恢复之前被执行的程序。对于处理器而言，中断和异常的处理机制基本上一样，因此合称广义异常。</p><p>异常可分为两类：</p><ul><li>同步异常：原因可以精确定位到某一条执行指令，由<strong>当前正在执行的指令本身</strong>直接引起的异常。</li><li>异步异常：每次发生时指令的PC可能不一样，例如中断便是一种异步异常<ul><li>精确异步异常：在响应异常后的处理器状态能够<strong>精确反映</strong>为某一条指令的边界</li><li>非精确异步异常：在响应异常后的处理器状态无法精确反映为某一条指令的边界</li></ul></li></ul><pre class="mermaid">flowchart TD    A[正常执行: <br/>PC 指向当前指令] --> B{是否发生<br/>异常/中断?}    B -- 否 --> A    %% 进入异常    B -- 是 --> C[硬件捕获异常]    C --> D[保存现场到 CSR]    D -->|mepc ← 触发时的 PC<br/>mcause ← 异常原因<br/>mtval ← 异常相关值（可选）<br/>mstatus ← 更新 MIE→MPIE、切换特权级| E    E --> F[PC ← mtvec（陷入入口）]    F --> G[开始执行<br/>异常/中断处理程序]    %% 处理过程    G --> H{处理完成<br/>并准备返回?}    H -- 否 --> G    %% 退出异常（机器模式）    H -- 是 --> I[执行 MRET 指令]    I --> J[硬件恢复状态]    J -->|PC ← mepc<br/>mstatus ← 恢复 MPIE→MIE 等| K[返回到<br/>被中断/异常的程序]    K --> A</pre><h2 id="蜂鸟E203的中断处理">蜂鸟E203的中断处理</h2><p>E203在处理器顶层接口中有4根中断输入信号，分别是软件中断、计时器中断、外部中断和调试中断。CLINT模块产生一根软件中断信号和一根计时器中断信号，通给蜂鸟E203处理器；PLIC模块接入多个外部中断源，将其仲裁后生成一根外部中断信号，通给蜂鸟E203处理器。SoC层面的调试模块生成一根调试中断，通给蜂鸟E203处理器核。所有的中断信号均由E203的<strong>交付模块</strong>进行处理。</p><h3 id="CLINT">CLINT</h3><p>CLINT（Core Local Interrupts Controller，核心本地中断控制器）是一个存储器地址映射的模块，挂载在蜂鸟E203 BIU上，用于产生<strong>软件中断</strong>和<strong>定时器中断</strong>。CLINT计时器根据低速输入节拍信号（来自电源常开域）进行计时，上电后默认一直计数，可通过蜂鸟E203自定义CSR寄存器<code>mcounterstop</code>来关闭。</p><h3 id="PLIC">PLIC</h3><p>PLIC（Platform Level Interrupt Controller，平台级中断控制器）是一个存储器地址映射的模块，挂载在蜂鸟E203 BIU上，专门用来管理<strong>外部中断源</strong>，并将它们统一分发到处理器。</p><h3 id="异常处理实现">异常处理实现</h3><p>蜂鸟E203交付模块对中断和异常的处理：</p><ul><li>优先级：长指令造成的异步异常 &gt; 中断造成的异步异常 &gt; ALU造成的同步异常</li><li>异常一旦发生，便会<strong>冲刷流水线</strong>，重新从新的PC地址开始取指令</li><li><code>mret</code>指令会触发处理器退出异常模式，被<strong>当作一种跳转指令</strong>来执行，跳转PC为<code>mepc</code>寄存器值</li><li>对于同步异常，<code>mepc</code>寄存器更新为当前<strong>正在交付指令</strong>的PC值</li><li>对于精确异步异常（中断），<code>mepc</code>寄存器更新为<strong>下一条待交付指令</strong>的PC值</li><li>对于非精确异步异常（长指令），<code>mepc</code>寄存器更新为<strong>发生异常指令</strong>的PC值</li></ul><h2 id="蜂鸟E203的调试机制">蜂鸟E203的调试机制</h2><p>处理器对于运行于其上的软件程序提供调试能力是至关重要的。调试机制是个非常复杂的软硬件协作机制，软硬件的实现难度很大。对于处理器的调试功能而言，常用的两种是“交互式调试”和“追踪调试”：</p><ul><li>交互式调试（Interactive Debug）是最常见的调试功能。调试器软件（如GDB）能够直接对处理器取得控制权，进而对其以一种交互方式进行调试，缺点是对处理器的运行具有打扰性。</li><li>追踪调试（Trace Debug）只跟踪记录处理器核执行过的所有程序指令，而不会打断干扰处理器的执行过程。相比交互式调试，实现难度更大，硬件开销也更大。</li></ul><h3 id="调试资源">调试资源</h3><p>E203中已有 DTM（Debug Transport Module）将JTAG标准接口转换成为内部的调试总线（Debug Bus），主要是使用状态机对JTAG协议进行解析。由于DTM模块处于JTAG时钟域，与调试总线要访问的调试模块不属于同一个时钟域，因此需要被同步。</p><p>此外，还有调试模块（Debug Module），实现了RISC-V调试文档“0.11版本”中定义的若干寄存器、Debug-ROM和Debug-RAM。这些资源既可以被调试总线访问到，也可以被系统存储总线访问到：</p><ul><li>Debug-ROM包含了处理器进入调试模式下需要执行的异常处理程序；</li><li>Debug-RAM主要在运行Debug-ROM中固定异常处理程序时作为数据段使用，用于存放一些临时数据和中间数据。</li></ul><h3 id="调试流程">调试流程</h3><p>调试机制指令的实现：</p><ul><li>ebreak：触发处理器进入异常模式（调试模式）<ul><li>调试中断一旦被接收，便会冲刷流水线，处理器PC跳转到<code>0x800</code>地址</li><li>CSR寄存器dpc的值更新为当前正在执行的指令PC</li><li>CSR寄存器dcsr的<code>cause</code>域值更新为引发进入调试模式的触发原因</li></ul></li><li>dret：触发处理器退出异常模式（调试模式）<ul><li>被当作一种跳转指令来执行，跳转PC为CSR寄存器dpc的值</li><li>将dcsr寄存器中的<code>cause</code>域清除</li></ul></li></ul><h2 id="未来：超越摩尔定律">未来：超越摩尔定律</h2><p>DSA（Domain-Specific Architecture，领域专用架构）方面：</p><ul><li>使用专用内存以最大限度地减少数据移动</li><li>将资源投入到更多的运算单元或更大的内存中</li><li>使用与域匹配的最简单的并行形式</li><li>将数据大小和类型减少到域所需的最简单程度</li><li>使用域特定的编程语言</li></ul><div class="note primary flat"><p>什么是“域特定的编程语言”？即DSL（Domain-Specific Language，领域专用语言）。比如前两年的<a href="https://www.modular.com/mojo">Mojo</a>和<a href="https://www.taichi-lang.org/">Taichi</a>都算是Python细化的DSL。</p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;note info flat&quot;&gt;&lt;p&gt;这一章不考，至少往年题没有考过。&lt;/p&gt;
&lt;/div&gt;
&lt;h2 id=&quot;SoC总线&quot;&gt;SoC总线&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;总线提供了系</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="复习" scheme="https://blog.esing.dev/tags/%E5%A4%8D%E4%B9%A0/"/>
    
    <category term="数字系统设计" scheme="https://blog.esing.dev/tags/%E6%95%B0%E5%AD%97%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="VLSI" scheme="https://blog.esing.dev/tags/VLSI/"/>
    
  </entry>
  
  <entry>
    <title>LaTeX代码开启连字等特性</title>
    <link href="https://blog.esing.dev/2025/10/23/latex-ligature/"/>
    <id>https://blog.esing.dev/2025/10/23/latex-ligature/</id>
    <published>2025-10-23T11:27:57.000Z</published>
    <updated>2025-10-23T14:53:20.925Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>在 <a href="/2024/11/19/latex-code-highlight/" title="LaTeX插入代码并设置高亮">LaTeX插入代码并设置高亮</a>中，使用<code>minted</code>和<code>listings</code> 为代码块添加了高亮。但许多等宽字体都包含连字（Ligature）特性，可以增强代码的可读性，视觉效果更好。那如何在代码块里也开启连字特性呢？</p><div class="note primary flat"><p>这里安利<a href="https://github.com/subframe7536/maple-font">Maple Mono</a>字体，对中文显示极其友好，完美的中英文2:1比例，还支持Nerd Font。我已经将所有等宽字体都换成<code>Maple Mono Normal NF CN</code>了。</p></div><h2 id="修改样式">修改样式</h2><p>首先要确保使用了<code>fontspec</code>宏包：<code>\RequirePackage&#123;fontspec&#125;</code></p><p>接着指定等宽字体，并添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">\setmonofont[</span><br><span class="line">    AutoFakeBold=true,</span><br><span class="line">    ItalicFont=MapleItalic,     % 指定斜体字体</span><br><span class="line">    Contextuals = Alternate,    % 开启连字</span><br><span class="line">    Ligatures = Common,         % liga</span><br><span class="line">    CharacterVariant=&#123;1,62,63&#125;, % cv特性</span><br><span class="line">    StylisticSet=&#123;3,11&#125;,        % ss特性</span><br><span class="line">    Extension = .ttf,</span><br><span class="line">    Path=fonts/</span><br><span class="line">]&#123;Maple&#125;</span><br></pre></td></tr></table></figure><p>随后重新编译就可以了！</p><p>经过测试，<code>verbatim</code>环境下一切正常，<code>listings</code>环境下仅有部分连字生效，原因不明。</p><img src="https://webp.esing.dev/img/image-20251023214343776_251023_2143_caYa.png" alt="verbatim环境" style="zoom:50%;" />]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;在 &lt;a href=&quot;/2024/11/19/latex-code-highlight/&quot; title=&quot;LaTeX插入代码并设置高亮&quot;&gt;LaTeX插入代</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="LaTeX" scheme="https://blog.esing.dev/tags/LaTeX/"/>
    
  </entry>
  
  <entry>
    <title>超大规模集成电路设计笔记：第四篇</title>
    <link href="https://blog.esing.dev/2025/10/21/vd-p4/"/>
    <id>https://blog.esing.dev/2025/10/21/vd-p4/</id>
    <published>2025-10-21T01:49:28.000Z</published>
    <updated>2025-11-07T02:27:00.310Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Cache">Cache</h2><p>可参考 <a href="/2024/06/12/coae-p6/" title="计算机原理与嵌入式系统笔记：第六篇">计算机原理与嵌入式系统笔记：第六篇</a></p><h3 id="直写与回写">直写与回写</h3><p>Write-Through（直写） 和 Write-Back （回写）是两种 Cache 写策略，用来决定当 CPU 写数据时，数据如何更新到主存的。</p><ul><li>当 CPU 对 cache 写数据时，同时也把数据写入主存，称为直写：<ul><li>数据一致性好（cache 和 主存内容始终同步）</li><li>对系统可靠性高</li><li>简单易实现</li><li><strong>写操作慢，写操作频繁时会增加总线带宽占用</strong></li></ul></li><li>当 CPU 写 cache 时，只更新 cache 中的数据，不立即写入主存，只有当该 cache block 被替换时，才将其写回主存，称为回写：<ul><li>写操作快，节省总线带宽</li><li><strong>数据一致性较差</strong></li><li><strong>实现复杂，需要 dirty 位标记</strong></li><li><strong>系统崩溃时可能丢失尚未写回的数据</strong></li></ul></li></ul><p>写缓冲区可以解决直写写内存慢、回写替换时大量写回的问题，因此均需要写缓冲区。</p><h3 id="性能例子">性能例子</h3><p>假设：</p><ul><li>I-Cache命中缺失率2%</li><li>D-Cahce命中缺失率4%</li><li>未命中惩罚为100周期</li><li>基础CPI为2</li><li>数据存取类指令占总共的36%</li></ul><p>则可计算每次指令的缺失周期数：</p><ul><li>I-Cache: 0.02 x 100 = 2</li><li>D-Cache: 0.36 x 0.04 x 100 = 1.44</li><li>实际CPI为 2 + 2 + 1.44 = 5.44</li></ul><h3 id="平均访问时间">平均访问时间</h3><p>AMAT（Average Memory Access Time，平均内存访问时间）用于衡量 CPU 访问内存系统的平均时间性能。</p><p>如果命中时间是 1ns，未命中率 5%，未命中惩罚 20ns，则 AMAT = 1 + 0.05×20 = 2ns。</p><h3 id="一致性">一致性</h3><p>Cache 一致性是指在多核或多处理器系统中，多个缓存副本之间的数据保持一致的特性或机制。它保证无论处理器在哪个缓存中读取数据，得到的都是最新的、正确的值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># Core 0</span><br><span class="line">    la   t0, x</span><br><span class="line">    li   t1, 1</span><br><span class="line">    sw   t1, 0(t0)            # x = 1</span><br><span class="line"></span><br><span class="line">    fence w, w                # 确保之前的写（x）对外可见后，后续写才对外可见</span><br><span class="line">    la   t2, flag</span><br><span class="line">    sw   t1, 0(t2)            # flag = 1（作为发布动作）</span><br><span class="line">==============================================================================</span><br><span class="line"># Core 1</span><br><span class="line">spin:</span><br><span class="line">    la   t2, flag</span><br><span class="line">    lw   t3, 0(t2)</span><br><span class="line">    beqz t3, spin             # 等 flag = 1</span><br><span class="line"></span><br><span class="line">    fence r, rw               # 获取屏障：确保之后的读不会“越过”对 flag 的读取</span><br><span class="line">    la   t0, x</span><br><span class="line">    lw   t4, 0(t0)            # 现在能可靠读到 x = 1</span><br></pre></td></tr></table></figure><h2 id="并行计算：冲刺♿冲">并行计算：冲刺♿冲</h2><p>我们想要连接多台计算机以获得更高的性能，有以下几种办法：</p><ul><li>任务级（进程级）并行：独立作业的高吞吐量</li><li>并行处理程序：在多个处理器上运行单个程序</li><li>多核微处理器：有多个处理器（内核）的芯片</li></ul><p>参考之前的Amdahl定律：</p><ul><li>单处理器：Time = (10 + 100) × t<sub>add</sub></li><li>10处理器：Time = 10 x t<sub>add</sub> + 100/10 x t<sub>add</sub> = 20 x t<sub>add</sub><ul><li>Speedup = 110/20 = 5.5 (55% of potential)</li></ul></li><li>100处理器：Time = 10 x t<sub>add</sub> + 100/100 x t<sub>add</sub> = 11 x t<sub>add</sub><ul><li>Speedup = 110/11 = 10 (10% of potential)</li></ul></li></ul><p>对于大矩阵来说，加速效果更明显。</p><h3 id="强可扩展性与弱可扩展性">强可扩展性与弱可扩展性</h3><p>测试时<strong>问题规模是否随处理器数变化</strong>是区分可扩展性强弱的依据。</p><ul><li>当<strong>问题规模固定不变</strong>时，随着处理器数量增加，程序的<strong>加速比（Speedup）</strong> 仍能保持较高，这种能力称为<strong>强可扩展性</strong>。</li><li>当<strong>每个处理器的工作量保持不变</strong>（即问题规模随处理器数线性增长）时，程序的性能（例如运行时间）仍能保持近似不变，这种能力称为<strong>弱可扩展性</strong>。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Cache&quot;&gt;Cache&lt;/h2&gt;
&lt;p&gt;可参考 &lt;a href=&quot;/2024/06/12/coae-p6/&quot; title=&quot;计算机原理与嵌入式系统笔记：第六篇&quot;&gt;计算机原理与嵌入式系</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="学习" scheme="https://blog.esing.dev/tags/%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="复习" scheme="https://blog.esing.dev/tags/%E5%A4%8D%E4%B9%A0/"/>
    
    <category term="数字系统设计" scheme="https://blog.esing.dev/tags/%E6%95%B0%E5%AD%97%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="VLSI" scheme="https://blog.esing.dev/tags/VLSI/"/>
    
  </entry>
  
  <entry>
    <title>更适合Powershell体质的grep</title>
    <link href="https://blog.esing.dev/2025/10/20/powershell-grep/"/>
    <id>https://blog.esing.dev/2025/10/20/powershell-grep/</id>
    <published>2025-10-20T02:16:02.000Z</published>
    <updated>2025-11-17T06:15:53.757Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p>Powershell下筛选字符串有<code>findstr</code>指令。但我用<code>grep</code>习惯了，一时半会不想改<s>主要是findstr字太多了</s></p><p>所以自己写一个脚本来模拟<code>grep</code>功能。</p><h2 id="代码">代码</h2><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">setlocal</span> enabledelayedexpansion</span><br><span class="line"></span><br><span class="line">:: 检查参数</span><br><span class="line"><span class="keyword">if</span> &quot;%~<span class="number">1</span>&quot;==&quot;&quot; (</span><br><span class="line">    <span class="built_in">echo</span> 用法: grep 搜索词</span><br><span class="line">    <span class="built_in">echo</span> 示例: command | grep 搜索词</span><br><span class="line">    <span class="keyword">exit</span> /b <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">:: 搜索词是第一个参数</span><br><span class="line"><span class="built_in">set</span> &quot;searchterm=%~<span class="number">1</span>&quot;</span><br><span class="line"></span><br><span class="line">:: 处理标准输入并搜索</span><br><span class="line"><span class="keyword">for</span> /f &quot;usebackq tokens=*&quot; <span class="variable">%%a</span> <span class="keyword">in</span> (`<span class="built_in">findstr</span> /i /L /C:&quot;<span class="variable">%searchterm%</span>&quot; <span class="number">2</span>^&gt;<span class="built_in">nul</span>`) <span class="keyword">do</span> (</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">%%a</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">endlocal</span></span><br><span class="line"><span class="keyword">exit</span> /b <span class="number">0</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;Powershell下筛选字符串有&lt;code&gt;findstr&lt;/code&gt;指令。但我用&lt;code&gt;grep&lt;/code&gt;习惯了，一时半会不想改&lt;s&gt;主要是</summary>
      
    
    
    
    <category term="技术分享" scheme="https://blog.esing.dev/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="Powershell" scheme="https://blog.esing.dev/tags/Powershell/"/>
    
  </entry>
  
  <entry>
    <title>HDLBits刷题之旅鼠冲冲冲</title>
    <link href="https://blog.esing.dev/2025/10/07/hdlbits-lemmings4/"/>
    <id>https://blog.esing.dev/2025/10/07/hdlbits-lemmings4/</id>
    <published>2025-10-07T11:57:39.000Z</published>
    <updated>2025-10-07T15:24:15.092Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言">前言</h2><p><a href="https://zh.wikipedia.org/wiki/%E7%99%BE%E6%88%B0%E5%B0%8F%E6%97%85%E9%BC%A0">百战小旅鼠</a>1991年由DMA Design（今rockstar north，蓝R）开发。</p><p>旅鼠会左右走，还会挖洞。如果下落太久了还会摔得四分五裂<s>坠机了</s></p><h2 id="思路">思路</h2><p>七个状态：左右、下落左右、向下挖时原本朝向左右，以及四分五裂。</p><h2 id="代码">代码</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> top_module (</span><br><span class="line">    <span class="keyword">input</span>  clk,</span><br><span class="line">    <span class="keyword">input</span>  areset,      <span class="comment">// Freshly brainwashed Lemmings walk left.</span></span><br><span class="line">    <span class="keyword">input</span>  bump_left,</span><br><span class="line">    <span class="keyword">input</span>  bump_right,</span><br><span class="line">    <span class="keyword">input</span>  ground,</span><br><span class="line">    <span class="keyword">input</span>  dig,</span><br><span class="line">    <span class="keyword">output</span> walk_left,</span><br><span class="line">    <span class="keyword">output</span> walk_right,</span><br><span class="line">    <span class="keyword">output</span> aaah,</span><br><span class="line">    <span class="keyword">output</span> digging</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">parameter</span> LEFT = <span class="number">0</span>, RIGHT = <span class="number">1</span>, FALLING_LEFT = <span class="number">2</span>, FALLING_RIGHT = <span class="number">3</span>, DIGGING_LEFT = <span class="number">4</span>,</span><br><span class="line">        DIGGING_RIGHT = <span class="number">5</span>, SPLAT = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">2</span>:<span class="number">0</span>] state, next_state;</span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] count, next_count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always</span> @(*) <span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line">        next_count = count;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> (state)</span><br><span class="line"></span><br><span class="line">            LEFT: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (!ground) <span class="keyword">begin</span></span><br><span class="line">                    next_state = FALLING_LEFT;</span><br><span class="line">                    next_count = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (dig) next_state = DIGGING_LEFT;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (bump_left) next_state = RIGHT;</span><br><span class="line">                <span class="keyword">else</span> next_state = LEFT;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            RIGHT: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (!ground) <span class="keyword">begin</span></span><br><span class="line">                    next_state = FALLING_RIGHT;</span><br><span class="line">                    next_count = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (dig) next_state = DIGGING_RIGHT;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (bump_right) next_state = LEFT;</span><br><span class="line">                <span class="keyword">else</span> next_state = RIGHT;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            FALLING_LEFT: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (ground) <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (count &gt;= <span class="number">20</span>) <span class="keyword">begin</span></span><br><span class="line">                        next_state = SPLAT;</span><br><span class="line">                        next_count = count;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                        next_state = LEFT;</span><br><span class="line">                        next_count = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                    next_state = FALLING_LEFT;</span><br><span class="line">                    next_count = count + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            FALLING_RIGHT: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (ground) <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (count &gt;= <span class="number">20</span>) <span class="keyword">begin</span></span><br><span class="line">                        next_state = SPLAT;</span><br><span class="line">                        next_count = count;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                        next_state = RIGHT;</span><br><span class="line">                        next_count = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                    next_state = FALLING_RIGHT;</span><br><span class="line">                    next_count = count + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            DIGGING_LEFT: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (ground) next_state = DIGGING_LEFT;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                    next_state = FALLING_LEFT;</span><br><span class="line">                    next_count = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            DIGGING_RIGHT: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span> (ground) next_state = DIGGING_RIGHT;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                    next_state = FALLING_RIGHT;</span><br><span class="line">                    next_count = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            SPLAT: next_state = SPLAT;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>: next_state = LEFT;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk, <span class="keyword">posedge</span> areset) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (areset) <span class="keyword">begin</span></span><br><span class="line">            state &lt;= LEFT;</span><br><span class="line">            count &lt;= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            state &lt;= next_state;</span><br><span class="line">            count &lt;= next_count;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// assign aaah       = (state == FALLING_LEFT) || (state == FALLING_RIGHT);</span></span><br><span class="line">    <span class="comment">// assign digging    = (state == DIGGING_LEFT) || (state == DIGGING_RIGHT);</span></span><br><span class="line">    <span class="comment">// assign walk_left  = (state == LEFT);</span></span><br><span class="line">    <span class="comment">// assign walk_right = (state == RIGHT);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> &#123;aaah, digging, walk_left, walk_right&#125; = (state == SPLAT) ?</span><br><span class="line">        <span class="number">4&#x27;b0000</span> : &#123;&#123;(state == FALLING_LEFT) || (state == FALLING_RIGHT)&#125;,</span><br><span class="line">                   &#123;(state == DIGGING_LEFT) || (state == DIGGING_RIGHT)&#125;,</span><br><span class="line">                   &#123;(state == LEFT)&#125;, &#123;(state == RIGHT)&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="排查错误">排查错误</h2><p>一开始未设置<code>next_count</code>，直接给<code>count</code>赋值，会报错：Can't resolve multiple constant drivers for net &quot;count[4]&quot;。因此，需要像状态切换那样，设置一个新的<code>next_count</code>。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;前言&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E7%99%BE%E6%88%B0%E5%B0%8F%E6%97%85%E</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="HDLBits" scheme="https://blog.esing.dev/tags/HDLBits/"/>
    
  </entry>
  
  <entry>
    <title>HDLBits刷题之生命游戏</title>
    <link href="https://blog.esing.dev/2025/10/05/hdlbits-conwaylife/"/>
    <id>https://blog.esing.dev/2025/10/05/hdlbits-conwaylife/</id>
    <published>2025-10-05T04:44:18.000Z</published>
    <updated>2025-10-05T10:14:09.164Z</updated>
    
    <content type="html"><![CDATA[<div class="note info flat"><p>纪念<a href="https://zh.wikipedia.org/wiki/%E7%B4%84%E7%BF%B0%C2%B7%E4%BD%95%E9%A0%93%C2%B7%E5%BA%B7%E5%A8%81">约翰·霍顿·康威</a>，他因新冠于2020年4月11日逝世，享年82岁。</p></div><h2 id="前言">前言</h2><p><a href="https://hdlbits.01xz.net/wiki/Conwaylife">Conwaylife - HDLBits</a></p><p>康威的生命游戏在科学美国人上刊登过，小时候还看到过，印象很深。</p><p>简单来说，就是对一个矩阵进行轮次变换，对每个元素的变换规则如下：</p><ul><li>0-1 个邻居：单元格变为 0</li><li>2 个邻居：单元格状态不变</li><li>3 个邻居：单元格变为 1</li><li>4 个及以上邻居：单元格变为 0</li></ul><p>要注意的是矩阵四周是“连续”的，即首尾相接。可以理解成桌面壁纸的平铺。</p><h2 id="思路">思路</h2><p>连续的意思就是说边界处会发生“跳变”。那我整一个四周大一圈的矩阵把它包进去就可以了。</p><p>然后在每个时钟沿进行判断，再赋新的值给寄存器即可。</p><h2 id="代码">代码</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> top_module (</span><br><span class="line">    <span class="keyword">input</span>              clk,</span><br><span class="line">    <span class="keyword">input</span>              load,</span><br><span class="line">    <span class="keyword">input</span>      [<span class="number">255</span>:<span class="number">0</span>] data,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">255</span>:<span class="number">0</span>] q</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">18</span>*<span class="number">18</span>-<span class="number">1</span>:<span class="number">0</span>] temp;</span><br><span class="line">    <span class="keyword">wire</span> [    <span class="number">255</span>:<span class="number">0</span>] out_temp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 区分对待</span></span><br><span class="line">    <span class="keyword">assign</span> temp[<span class="number">17</span>:<span class="number">0</span>]          = &#123;q[<span class="number">240</span>], q[<span class="number">255</span>:<span class="number">240</span>], q[<span class="number">255</span>]&#125;;</span><br><span class="line">    <span class="keyword">assign</span> temp[<span class="number">18</span>*<span class="number">18</span>-<span class="number">1</span>:<span class="number">18</span>*<span class="number">17</span>] = &#123;q[<span class="number">0</span>], q[<span class="number">15</span>:<span class="number">0</span>], q[<span class="number">15</span>]&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">genvar</span> i;</span><br><span class="line">    <span class="keyword">generate</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">17</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span> : origin_mat</span><br><span class="line">            <span class="keyword">assign</span> temp[<span class="number">18</span>*(i+<span class="number">1</span>)-<span class="number">1</span>:<span class="number">18</span>*i] = &#123;q[<span class="number">16</span>*(i-<span class="number">1</span>)], q[<span class="number">16</span>*i-<span class="number">1</span>:<span class="number">16</span>*(i-<span class="number">1</span>)], q[<span class="number">16</span>*i-<span class="number">1</span>]&#125;;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endgenerate</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">genvar</span> j, k;</span><br><span class="line">    <span class="comment">// verilog_format: off</span></span><br><span class="line">    <span class="keyword">generate</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j = j + <span class="number">1</span>) <span class="keyword">begin</span> : temp_row</span><br><span class="line">            <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="number">16</span>; k = k + <span class="number">1</span>) <span class="keyword">begin</span> : temp_col</span><br><span class="line">                <span class="keyword">localparam</span> <span class="keyword">integer</span> idx = <span class="number">18</span> * (j + <span class="number">1</span>) + k + <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 保存最多为 8 的邻居和，4 位足矣</span></span><br><span class="line">                <span class="keyword">wire</span> [<span class="number">3</span>:<span class="number">0</span>] nbr_sum;</span><br><span class="line">                <span class="keyword">wire</span> loc_inst;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">assign</span> nbr_sum =</span><br><span class="line">                    temp[idx-<span class="number">1</span>]   + temp[idx+<span class="number">1</span>] +</span><br><span class="line">                    temp[idx-<span class="number">18</span>]  + temp[idx+<span class="number">18</span>] +</span><br><span class="line">                    temp[idx-<span class="number">18</span>-<span class="number">1</span>]+ temp[idx-<span class="number">18</span>+<span class="number">1</span>] +</span><br><span class="line">                    temp[idx+<span class="number">18</span>-<span class="number">1</span>]+ temp[idx+<span class="number">18</span>+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">assign</span> loc_inst = (nbr_sum &lt;  <span class="number">2</span>)  ? <span class="number">1&#x27;b0</span> :</span><br><span class="line">                                  (nbr_sum == <span class="number">2</span>) ? temp[idx] :</span><br><span class="line">                                  (nbr_sum == <span class="number">3</span>) ? <span class="number">1&#x27;b1</span> :</span><br><span class="line">                                  <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">assign</span> out_temp[<span class="number">16</span>*j + k] = loc_inst;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endgenerate</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (load) <span class="keyword">begin</span></span><br><span class="line">            q &lt;= data;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            q &lt;= out_temp;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="改进">改进</h2><p><a href="https://blog.csdn.net/m0_74101820/article/details/145619118">HDLbits: verilog实现Conwaylife二维元胞自动机 - CSDN</a>简化了数组的表示，采用二维数组：</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不包含testbench</span></span><br><span class="line"><span class="keyword">module</span> top_module(</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">input</span> load,</span><br><span class="line">    <span class="keyword">input</span> [<span class="number">255</span>:<span class="number">0</span>] data,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">255</span>:<span class="number">0</span>] q ); </span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        q = <span class="number">256&#x27;h0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">//填充为18*18</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">17</span>:<span class="number">0</span>] q_t [<span class="number">17</span>:<span class="number">0</span>]; <span class="comment">//填充后的q_table;</span></span><br><span class="line">    <span class="keyword">genvar</span> i;</span><br><span class="line">    <span class="keyword">generate</span> <span class="comment">//利用循环将q_t的每一行依次填充</span></span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">16</span>;i=i+<span class="number">1</span>)<span class="keyword">begin</span>: assign_value</span><br><span class="line">            <span class="keyword">assign</span> q_t[i+<span class="number">1</span>][<span class="number">17</span>:<span class="number">0</span>] = &#123;q[i*<span class="number">16</span>], q[i*<span class="number">16</span>+:<span class="number">16</span>], q[i*<span class="number">16</span>+<span class="number">15</span>]&#125;;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">//q_t 18*18 的第一行q_t[0]和最后一行q_t[17]单独赋值，由于这两行相当于原矩阵颠倒了后的值</span></span><br><span class="line">        <span class="keyword">assign</span> q_t[<span class="number">0</span>][<span class="number">17</span>:<span class="number">0</span>] = &#123;q[<span class="number">15</span>*<span class="number">16</span>], q[<span class="number">15</span>*<span class="number">16</span>+:<span class="number">16</span>], q[<span class="number">15</span>*<span class="number">16</span>+<span class="number">15</span>]&#125;;</span><br><span class="line">        <span class="keyword">assign</span> q_t[<span class="number">17</span>][<span class="number">17</span>:<span class="number">0</span>] = &#123;q[<span class="number">0</span>], q[<span class="number">0</span>*<span class="number">16</span>+:<span class="number">16</span>], q[<span class="number">0</span>*<span class="number">16</span>+<span class="number">15</span>]&#125;;</span><br><span class="line">    <span class="keyword">endgenerate</span> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//判断数量,</span></span><br><span class="line">    <span class="keyword">wire</span>[<span class="number">3</span>:<span class="number">0</span>] q_cnt[<span class="number">15</span>:<span class="number">0</span>][<span class="number">15</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">255</span>:<span class="number">0</span>] q_temp;</span><br><span class="line">    <span class="keyword">genvar</span> j,k;</span><br><span class="line">    <span class="keyword">generate</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;<span class="number">16</span>; j=j+<span class="number">1</span>) <span class="keyword">begin</span>:loop_out</span><br><span class="line">            <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;<span class="number">16</span>; k=k+<span class="number">1</span>) <span class="keyword">begin</span>:loop_in</span><br><span class="line">                <span class="comment">//依次计算每个位置的邻居数量q_cnt</span></span><br><span class="line">                <span class="keyword">assign</span> q_cnt[j][k] = q_t[j+<span class="number">1</span>][k] + q_t[j+<span class="number">1</span>][k+<span class="number">2</span>] + q_t[j][k] + q_t[j][k+<span class="number">2</span>] + q_t[j][k+<span class="number">1</span>] + q_t[j+<span class="number">2</span>][k] + q_t[j+<span class="number">2</span>][k+<span class="number">2</span>] + q_t[j+<span class="number">2</span>][k+<span class="number">1</span>];</span><br><span class="line">                <span class="comment">//利用三目运算符判断数量，决定下一时刻该位置的q值</span></span><br><span class="line">                <span class="keyword">assign</span> q_temp[j*<span class="number">16</span>+k] = (q_cnt[j][k]==<span class="number">4&#x27;d3</span>)? <span class="number">1&#x27;b1</span>: </span><br><span class="line">                                                            ((q_cnt[j][k]==<span class="number">4&#x27;b0010</span>)? q[j*<span class="number">16</span>+k] :</span><br><span class="line">                                                                                    <span class="number">1&#x27;b0</span>);</span><br><span class="line">            <span class="keyword">end</span> </span><br><span class="line">       <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endgenerate</span> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//上升沿赋值</span></span><br><span class="line">    <span class="keyword">integer</span> m;</span><br><span class="line">    <span class="keyword">always</span>@(<span class="keyword">posedge</span> clk)<span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (load) <span class="keyword">begin</span></span><br><span class="line">            q&lt;=data;</span><br><span class="line">        <span class="keyword">end</span> </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            q&lt;=q_temp;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;note info flat&quot;&gt;&lt;p&gt;纪念&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E7%B4%84%E7%BF%B0%C2%B7%E4%</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.esing.dev/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="Verilog" scheme="https://blog.esing.dev/tags/Verilog/"/>
    
    <category term="HDLBits" scheme="https://blog.esing.dev/tags/HDLBits/"/>
    
  </entry>
  
</feed>
